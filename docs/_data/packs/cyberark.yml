# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-20T08:34:31Z

"1.2":
  api:
    lang: "bash"
    filename: "hth-cyberark-1.02-create-safe-with-permissions.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/api/hth-cyberark-1.02-create-safe-with-permissions.sh"
    excerpts:
      api-create-safe:
        content: |
            # Create safe with restricted access via REST API
            curl -X POST "https://${PVWA_URL}/PasswordVault/API/Safes" \
            -H "Authorization: ${AUTH_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "safeName": "Windows-DomainAdmins",
              "description": "Domain Administrator credentials - requires approval",
              "olacEnabled": true,
              "managingCPM": "PasswordManager",
              "numberOfVersionsRetention": 10,
              "numberOfDaysRetention": 30
            }'
          
            # Add member with limited permissions
            curl -X POST "https://${PVWA_URL}/PasswordVault/API/Safes/Windows-DomainAdmins/Members" \
            -H "Authorization: ${AUTH_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "memberName": "WindowsAdmins",
              "memberType": "Group",
              "permissions": {
                "useAccounts": true,
                "retrieveAccounts": true,
                "listAccounts": true,
                "addAccounts": false,
                "updateAccountContent": false,
                "deleteAccounts": false,
                "manageSafe": false,
                "requestsAuthorizationLevel1": true
              }
            }'

"2.1":
  cli:
    lang: "ini"
    filename: "hth-cyberark-2.01-dbparm-encryption.ini"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/cli/hth-cyberark-2.01-dbparm-encryption.ini"
    excerpts:
      cli-dbparm-encryption:
        content: |
            [MAIN]
            EncryptionMethod=AES256
            ServerKeyAge=365
            BackupKeyAge=365

"3.1":
  cli:
    lang: "ini"
    filename: "hth-cyberark-3.01-api-rate-limiting.ini"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/cli/hth-cyberark-3.01-api-rate-limiting.ini"
    excerpts:
      cli-api-rate-limiting:
        content: |
            # In PVConfiguration.xml
            <WebService>
            <MaxConcurrentRequests>50</MaxConcurrentRequests>
            <RequestTimeoutSeconds>120</RequestTimeoutSeconds>
            <EnableRateLimiting>true</EnableRateLimiting>
            </WebService>
  sdk:
    lang: "python"
    filename: "hth-cyberark-3.01-secure-api-authentication.py"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/sdk/hth-cyberark-3.01-secure-api-authentication.py"
    excerpts:
      sdk-cert-auth:
        content: |
            # Secure CyberArk API authentication using certificate
            import requests
          
            PVWA_URL = "https://pvwa.company.com"
            CERT_FILE = "/path/to/client.crt"
            KEY_FILE = "/path/to/client.key"
            CA_FILE = "/path/to/ca.crt"
          
            def get_api_token():
              """Authenticate to CyberArk using certificate"""
              response = requests.post(
                  f"{PVWA_URL}/PasswordVault/API/Auth/CyberArk/Logon",
                  cert=(CERT_FILE, KEY_FILE),
                  verify=CA_FILE,
                  json={
                      "username": "APIUser",
                      "password": ""  # Certificate-based, no password
                  }
              )
              return response.text.strip('"')
          
            def get_credential(token, safe, account):
              """Retrieve credential securely"""
              response = requests.get(
                  f"{PVWA_URL}/PasswordVault/API/Accounts?filter=safeName eq {safe}",
                  headers={"Authorization": token},
                  cert=(CERT_FILE, KEY_FILE),
                  verify=CA_FILE
              )
              return response.json()

"3.3":
  api:
    lang: "bash"
    filename: "hth-cyberark-3.03-configure-external-secrets.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/api/hth-cyberark-3.03-configure-external-secrets.sh"
    excerpts:
      api-external-secrets:
        content: |
            # Configure Vault to retrieve from CyberArk
            vault write auth/approle/role/cyberark \
              token_policies="cyberark-read" \
              token_ttl=1h \
              token_max_ttl=4h
          
            # CyberArk Secrets Hub configuration
            # Sync secrets to Vault while maintaining CyberArk as source of truth

"4.1":
  cli:
    lang: "ini"
    filename: "hth-cyberark-4.01-session-timeouts.ini"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/cli/hth-cyberark-4.01-session-timeouts.ini"
    excerpts:
      cli-session-timeouts:
        content: |
            # Platform configuration
            MaxSessionDuration=480  # 8 hours maximum
            IdleSessionTimeout=30   # 30 minutes idle
            WarningBeforeTimeout=5  # 5 minute warning

"5.1":
  cli:
    lang: "ini"
    filename: "hth-cyberark-5.01-password-complexity.ini"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/cli/hth-cyberark-5.01-password-complexity.ini"
    excerpts:
      cli-password-complexity:
        content: |
            # Platform password policy
            MinLength=20
            RequireUppercase=true
            RequireLowercase=true
            RequireNumbers=true
            RequireSpecial=true
            ExcludedCharacters='"<>;

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-cyberark-5.02-monitor-rotation-failures.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/terraform/hth-cyberark-5.02-monitor-rotation-failures.tf"
    excerpts:
      terraform:
        content: |
            # Check for CPM password rotation failures
            resource "null_resource" "rotation_failure_check" {
            provisioner "local-exec" {
              command = <<-EOT
                curl -sk -X GET \
                  "${var.pvwa_url}/PasswordVault/API/Accounts?filter=cpmStatus eq failure" \
                  -H "Authorization: ${var.pvwa_auth_token}" \
                  -H "Content-Type: application/json" \
                  | python3 -c "
            import sys, json
            data = json.load(sys.stdin)
            accounts = data.get('value', [])
            failed = [a for a in accounts if a.get('secretManagement', {}).get('status') == 'failure']
            if failed:
              print(f'WARNING: {len(failed)} account(s) with rotation failures:')
              for acct in failed:
                  name = acct.get('name', 'unknown')
                  safe = acct.get('safeName', 'unknown')
                  reason = acct.get('secretManagement', {}).get('lastModifiedReason', 'unknown')
                  print(f'  - {name} in {safe}: {reason}')
              sys.exit(1)
            else:
              print('OK: No rotation failures detected')
            "
              EOT
            }
          
            triggers = {
              check_interval = timestamp()
            }
            }
          
            # Configure alerting for rotation failures
            resource "null_resource" "rotation_failure_alerting" {
            provisioner "local-exec" {
              command = <<-EOT
                curl -sk -X PUT \
                  "${var.pvwa_url}/PasswordVault/API/Configuration/Notifications" \
                  -H "Authorization: ${var.pvwa_auth_token}" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "settings": {
                      "notifyOnCPMFailure": true,
                      "notifyOnVerificationFailure": true,
                      "notifyOnReconcileFailure": true,
                      "failureNotificationRecipients": "security-team"
                    }
                  }'
              EOT
            }
          
            triggers = {
              notification_config = "enabled"
            }
            }
          
            # L2+: Configure automatic reconciliation on rotation failure
            resource "null_resource" "auto_reconcile_on_failure" {
            count = var.profile_level >= 2 ? 1 : 0
          
            provisioner "local-exec" {
              command = <<-EOT
                curl -sk -X PUT \
                  "${var.pvwa_url}/PasswordVault/API/Configuration/PlatformConfiguration" \
                  -H "Authorization: ${var.pvwa_auth_token}" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "settings": {
                      "autoReconcileOnFailure": true,
                      "maxReconcileAttempts": 3,
                      "reconcileRetryIntervalMinutes": 30
                    }
                  }'
              EOT
            }
          
            triggers = {
              profile_level = var.profile_level
            }
            }
  db:
    lang: "sql"
    filename: "hth-cyberark-5.02-rotation-failures.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/db/hth-cyberark-5.02-rotation-failures.sql"
    excerpts:
      db-rotation-failures:
        content: |
            -- Query for rotation failures (via SIEM or reporting)
            SELECT AccountName, SafeName, LastFailReason, LastFailDate
            FROM PasswordVault_Accounts
            WHERE CPMStatus = 'FAILED'
            ORDER BY LastFailDate DESC;

"6.1":
  terraform:
    lang: "hcl"
    filename: "hth-cyberark-6.01-comprehensive-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/terraform/hth-cyberark-6.01-comprehensive-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # Configure comprehensive audit logging
            resource "null_resource" "audit_logging_config" {
            provisioner "local-exec" {
              command = <<-EOT
                curl -sk -X PUT \
                  "${var.pvwa_url}/PasswordVault/API/Configuration/AuditSettings" \
                  -H "Authorization: ${var.pvwa_auth_token}" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "settings": {
                      "auditEnabled": true,
                      "logLogonEvents": true,
                      "logRetrieveEvents": true,
                      "logPasswordChangeEvents": true,
                      "logSafeModificationEvents": true,
                      "logPolicyChanges": true,
                      "retentionDays": ${var.audit_retention_days}
                    }
                  }'
              EOT
            }
          
            triggers = {
              retention_days = var.audit_retention_days
            }
            }
          
            # Configure SIEM log forwarding
            resource "null_resource" "siem_log_forwarding" {
            count = var.siem_server != "" ? 1 : 0
          
            provisioner "local-exec" {
              command = <<-EOT
                curl -sk -X PUT \
                  "${var.pvwa_url}/PasswordVault/API/Configuration/SyslogSettings" \
                  -H "Authorization: ${var.pvwa_auth_token}" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "settings": {
                      "syslogEnabled": true,
                      "syslogServer": "${var.siem_server}",
                      "syslogPort": ${var.siem_port},
                      "syslogProtocol": "TCP",
                      "syslogFormat": "CEF",
                      "sendRealtimeEvents": true
                    }
                  }'
              EOT
            }
          
            triggers = {
              siem_server = var.siem_server
              siem_port   = var.siem_port
            }
            }
          
            # L2+: Enable enhanced detection use cases
            resource "null_resource" "enhanced_detection" {
            count = var.profile_level >= 2 ? 1 : 0
          
            provisioner "local-exec" {
              command = <<-EOT
                curl -sk -X PUT \
                  "${var.pvwa_url}/PasswordVault/API/Configuration/AuditSettings" \
                  -H "Authorization: ${var.pvwa_auth_token}" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "settings": {
                      "detectMassRetrieval": true,
                      "massRetrievalThreshold": 20,
                      "massRetrievalWindowMinutes": 60,
                      "detectAfterHoursAccess": true,
                      "businessHoursStart": 6,
                      "businessHoursEnd": 20,
                      "detectFailedAuthSpike": true,
                      "failedAuthThreshold": 5,
                      "failedAuthWindowMinutes": 15,
                      "alertOnDetection": true
                    }
                  }'
              EOT
            }
          
            depends_on = [null_resource.audit_logging_config]
          
            triggers = {
              profile_level = var.profile_level
            }
            }
          
            # L3: Enable full forensic logging with immutable audit trail
            resource "null_resource" "forensic_logging" {
            count = var.profile_level >= 3 ? 1 : 0
          
            provisioner "local-exec" {
              command = <<-EOT
                curl -sk -X PUT \
                  "${var.pvwa_url}/PasswordVault/API/Configuration/AuditSettings" \
                  -H "Authorization: ${var.pvwa_auth_token}" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "settings": {
                      "immutableAuditTrail": true,
                      "logAllAPIRequests": true,
                      "logSessionKeystrokes": true,
                      "logClipboardEvents": true,
                      "retentionDays": 730,
                      "tamperDetection": true,
                      "hashVerification": true
                    }
                  }'
              EOT
            }
          
            depends_on = [null_resource.enhanced_detection]
          
            triggers = {
              profile_level = var.profile_level
            }
            }
  db:
    lang: "sql"
    filename: "hth-cyberark-6.01-audit-detection-queries.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/cyberark/db/hth-cyberark-6.01-audit-detection-queries.sql"
    excerpts:
      db-mass-retrieval:
        content: |
            SELECT UserName, COUNT(*) as RetrievalCount
            FROM AuditLog
            WHERE Action = 'Retrieve Password'
            AND Timestamp > DATEADD(hour, -1, GETDATE())
            GROUP BY UserName
            HAVING COUNT(*) > 20;
      db-after-hours-access:
        content: |
            SELECT *
            FROM AuditLog
            WHERE Action IN ('Logon', 'Retrieve Password')
            AND (DATEPART(hour, Timestamp) < 6 OR DATEPART(hour, Timestamp) > 20)
            AND DATEPART(dw, Timestamp) IN (1, 7);  -- Weekends
      db-failed-auth-spike:
        content: |
            SELECT UserName, SourceIP, COUNT(*) as FailedAttempts
            FROM AuditLog
            WHERE Action = 'Logon'
            AND Status = 'Failed'
            AND Timestamp > DATEADD(minute, -15, GETDATE())
            GROUP BY UserName, SourceIP
            HAVING COUNT(*) > 5;

