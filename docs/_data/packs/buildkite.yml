# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-18T20:45:36Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-1.01-configure-saml-sso.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-1.01-configure-saml-sso.tf"
    excerpts:
      terraform:
        content: |
            # SAML SSO is configured via the Buildkite UI, not Terraform.
            # This control requires:
            #   1. Enterprise or Business tier Buildkite plan
            #   2. SAML 2.0 compatible Identity Provider (Okta, Azure AD, etc.)
            #   3. Configuration at: Organization Settings > SSO
            #
            # After SSO is configured in the UI, enforce it for all members.
            # The buildkite_organization resource below ensures 2FA is active
            # as a complementary authentication control.
            #
            # Validation: Verify SSO enforcement via the Buildkite API
            # GET https://api.buildkite.com/v2/organizations/{org}/sso

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-1.02-enforce-two-factor-authentication.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-1.02-enforce-two-factor-authentication.tf"
    excerpts:
      terraform:
        content: |
            resource "buildkite_organization" "hardened" {
            enforce_2fa = var.enforce_2fa
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-2.01-configure-team-permissions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-2.01-configure-team-permissions.tf"
    excerpts:
      terraform:
        content: |
            # Create teams with least-privilege defaults
            resource "buildkite_team" "teams" {
            for_each = var.teams
          
            name                         = each.key
            description                  = each.value.description
            privacy                      = each.value.privacy
            default_team                 = each.value.default_team
            default_member_role          = each.value.default_member_role
            members_can_create_pipelines = each.value.members_can_create_pipelines
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-2.02-configure-pipeline-permissions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-2.02-configure-pipeline-permissions.tf"
    excerpts:
      terraform:
        content: |
            # Create pipelines with hardened defaults (L2+)
            resource "buildkite_pipeline" "pipelines" {
            for_each = var.profile_level >= 2 ? var.pipelines : {}
          
            name                       = each.key
            repository                 = each.value.repository
            description                = each.value.description
            default_branch             = each.value.default_branch
            branch_configuration       = each.value.branch_configuration
            skip_intermediate_builds   = each.value.skip_intermediate_builds
            cancel_intermediate_builds = each.value.cancel_intermediate_builds
            cluster_id                 = each.value.cluster_id
            default_timeout_in_minutes = each.value.default_timeout_in_minutes
            maximum_timeout_in_minutes = each.value.maximum_timeout_in_minutes
            allow_rebuilds             = each.value.allow_rebuilds
          
            # Restrict fork builds to prevent untrusted code execution
            provider_settings {
              build_pull_request_forks              = false
              publish_commit_status                 = true
              publish_commit_status_per_step        = true
              skip_builds_for_existing_commits      = true
              cancel_deleted_branch_builds          = true
              prefix_pull_request_fork_branch_names = true
            }
            }
          
            # Assign team access to pipelines with explicit permission levels
            resource "buildkite_pipeline_team" "access" {
            for_each = var.profile_level >= 2 ? var.pipeline_team_access : {}
          
            pipeline_id  = buildkite_pipeline.pipelines[each.value.pipeline_key].id
            team_id      = buildkite_team.teams[each.value.team_key].id
            access_level = each.value.access_level
            }

"2.3":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-2.03-limit-admin-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-2.03-limit-admin-access.tf"
    excerpts:
      terraform:
        content: |
            # Admin access is managed via the Buildkite UI, not Terraform.
            # This control requires:
            #   1. Limit organization owners/admins to 2-3 users
            #   2. Require SSO and 2FA for all admin accounts
            #   3. Review admin membership quarterly
            #
            # Validation: Query organization members via Buildkite GraphQL API
            #
            # query {
            #   organization(slug: "your-org") {
            #     members(first: 100, role: ADMIN) {
            #       edges {
            #         node {
            #           user {
            #             name
            #             email
            #           }
            #         }
            #       }
            #     }
            #   }
            # }
            #
            # Expected: No more than 3 admin users returned

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-3.01-configure-agent-tokens.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-3.01-configure-agent-tokens.tf"
    excerpts:
      terraform:
        content: |
            # Create scoped agent tokens per environment
            resource "buildkite_agent_token" "tokens" {
            for_each = var.agent_tokens
          
            description = each.value.description
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-3.02-configure-agent-clusters.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-3.02-configure-agent-clusters.tf"
    excerpts:
      terraform:
        content: |
            # Create isolated agent clusters per environment (L2+)
            resource "buildkite_cluster" "clusters" {
            for_each = var.profile_level >= 2 ? var.clusters : {}
          
            name        = each.key
            description = each.value.description
            color       = each.value.color
            emoji       = each.value.emoji
            }
          
            # Create cluster queues for workload routing (L2+)
            resource "buildkite_cluster_queue" "queues" {
            for_each = var.profile_level >= 2 ? var.cluster_queues : {}
          
            cluster_id  = buildkite_cluster.clusters[each.value.cluster_key].id
            key         = each.value.key
            description = each.value.description
            }

"3.3":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-3.03-secure-agent-infrastructure.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-3.03-secure-agent-infrastructure.tf"
    excerpts:
      terraform:
        content: |
            # Agent infrastructure hardening is managed outside the Buildkite provider.
            # This control requires:
            #   1. Use ephemeral agents (containers or auto-scaling instances)
            #   2. Minimize installed software on agent hosts
            #   3. Apply OS hardening (CIS benchmarks for the host OS)
            #   4. Restrict agent network access to required endpoints only
            #   5. Use private networks for agent-to-service communication
            #   6. Monitor agent traffic for anomalies
            #
            # Recommended infrastructure patterns:
            #   - AWS: buildkite/elastic-ci-stack-for-aws (CloudFormation/Terraform)
            #   - GCP: buildkite/elastic-ci-stack-for-gcp
            #   - Kubernetes: buildkite/agent-stack-k8s
            #
            # Agent configuration flags for hardening:
            #   --no-plugins          Disable third-party plugins
            #   --no-local-hooks      Disable repository-level hooks
            #   --no-command-eval      Disable arbitrary command evaluation
            #   --allowed-repositories Restrict which repos agents can checkout
            #
            # Example agent startup with hardened flags (L3):
            # buildkite-agent start \
            #   --no-plugins \
            #   --no-local-hooks \
            #   --no-command-eval \
            #   --allowed-repositories "git@github.com:your-org/*"

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-buildkite-4.01-configure-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/buildkite/terraform/hth-buildkite-4.01-configure-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # Restrict API access to known IP addresses (L3)
            # This limits which networks can query audit logs and other API endpoints
            resource "buildkite_organization" "api_restrictions" {
            count = var.profile_level >= 3 && length(var.allowed_api_ip_addresses) > 0 ? 1 : 0
          
            allowed_api_ip_addresses = var.allowed_api_ip_addresses
            }
          
            # Audit log monitoring is performed via the Buildkite API.
            # Key events to monitor:
            #   - User authentication (login/logout)
            #   - Pipeline changes (create/update/delete)
            #   - Permission modifications (team/member changes)
            #   - Agent token usage (create/revoke)
            #   - Organization setting changes
            #
            # Query audit events via GraphQL:
            #
            # query {
            #   organization(slug: "your-org") {
            #     auditEvents(first: 50) {
            #       edges {
            #         node {
            #           type
            #           occurredAt
            #           actor {
            #             name
            #           }
            #           subject {
            #             name
            #             type
            #           }
            #         }
            #       }
            #     }
            #   }
            # }

