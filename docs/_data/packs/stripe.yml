# AUTO-GENERATED by scripts/sync-packs-to-data.sh — do not edit manually
# Generated: 2026-02-19T19:40:05Z

"3.1":
  api:
    lang: "bash"
    filename: "hth-stripe-3.01-configure-api-key-security.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/stripe/api/hth-stripe-3.01-configure-api-key-security.sh"
    excerpts:
      api-audit-account-events:
        content: |
            # Monitor for account changes that may indicate key-related activity
            # NOTE: Stripe has NO api_key.* event types — use account.updated instead
            EVENTS=$(stripe_get "/events?type=account.updated&limit=10") || {
            fail "3.1 Unable to retrieve account events"
            increment_failed; summary; exit 0
            }
          
            EVENT_COUNT=$(echo "${EVENTS}" | jq '.data | length')
            info "3.1 Recent account update events: ${EVENT_COUNT}"
          
            if [ "${EVENT_COUNT}" -gt 0 ]; then
            info "3.1 Most recent account changes:"
            echo "${EVENTS}" | jq -r '.data[:5][] | "  - \(.created | todate): \(.type)"'
            fi
          
            pass "3.1 Account events audit complete — review API keys in Dashboard"
            increment_applied
  sigma:
    - lang: "yaml"
      filename: "hth-stripe-3.01-configure-api-key-security.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/stripe/siem/sigma/hth-stripe-3.01-configure-api-key-security.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    type: 'account.updated'
                condition: selection
              fields:
                - id
                - created
                - type
                - data.object.id
                - data.previous_attributes

"3.2":
  api:
    lang: "bash"
    filename: "hth-stripe-3.02-configure-webhook-security.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/stripe/api/hth-stripe-3.02-configure-webhook-security.sh"
    excerpts:
      api-configure-webhook:
        content: |
            # List existing webhooks and check for unsigned endpoints
            WEBHOOKS=$(stripe_get "/webhook_endpoints?limit=100") || {
            fail "3.2 Unable to retrieve webhook endpoints"
            increment_failed; summary; exit 0
            }
          
            TOTAL=$(echo "${WEBHOOKS}" | jq '.data | length')
            DISABLED=$(echo "${WEBHOOKS}" | jq '[.data[] | select(.status == "disabled")] | length')
            info "3.2 Total webhook endpoints: ${TOTAL}"
            info "3.2 Disabled endpoints: ${DISABLED}"
          
            if [ "${DISABLED}" -gt 0 ]; then
            warn "3.2 Disabled webhook endpoints found — review and remove unused:"
            echo "${WEBHOOKS}" | jq -r '.data[] | select(.status == "disabled") | "  - \(.url) (id: \(.id))"'
            fi
          
            # Create a SIEM webhook for security events if URL is provided
            if [ -n "${STRIPE_SIEM_WEBHOOK_URL:-}" ]; then
            EXISTING=$(echo "${WEBHOOKS}" | jq -r ".data[] | select(.url == \"${STRIPE_SIEM_WEBHOOK_URL}\") | .id")
            if [ -n "${EXISTING}" ]; then
              info "3.2 SIEM webhook already exists (id: ${EXISTING})"
            else
              info "3.2 Creating SIEM webhook for security events..."
              RESPONSE=$(stripe_post "/webhook_endpoints" "$(cat <<'PARAMS'
            url=${STRIPE_SIEM_WEBHOOK_URL}&\
            enabled_events[]=account.updated&\
            enabled_events[]=account.application.authorized&\
            enabled_events[]=account.application.deauthorized&\
            enabled_events[]=account.external_account.created&\
            enabled_events[]=account.external_account.deleted&\
            enabled_events[]=person.created&\
            enabled_events[]=person.updated&\
            enabled_events[]=person.deleted&\
            enabled_events[]=payment_method.attached&\
            enabled_events[]=payment_method.detached&\
            enabled_events[]=identity.verification_session.created&\
            enabled_events[]=identity.verification_session.verified&\
            enabled_events[]=capability.updated&\
            description=HTH Security Events SIEM Webhook
            PARAMS
              )") || {
                fail "3.2 Failed to create SIEM webhook"
                increment_failed; summary; exit 0
              }
              WEBHOOK_ID=$(echo "${RESPONSE}" | jq -r '.id')
              WEBHOOK_SECRET=$(echo "${RESPONSE}" | jq -r '.secret')
              pass "3.2 SIEM webhook created (id: ${WEBHOOK_ID})"
              info "3.2 Webhook signing secret: ${WEBHOOK_SECRET}"
              info "3.2 IMPORTANT: Store this secret securely for signature verification"
            fi
            fi
          
            pass "3.2 Webhook security audit complete"
            increment_applied
  sigma:
    - lang: "yaml"
      filename: "hth-stripe-3.02-configure-webhook-security.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/stripe/siem/sigma/hth-stripe-3.02-configure-webhook-security.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    request_method: 'DELETE'
                    request_path|startswith: '/v1/webhook_endpoints/'
                condition: selection
              fields:
                - timestamp
                - request_method
                - request_path
                - source_ip
                - api_key_id

"3.3":
  api:
    lang: "bash"
    filename: "hth-stripe-3.03-configure-restricted-keys.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/stripe/api/hth-stripe-3.03-configure-restricted-keys.sh"
    excerpts:
      api-validate-key-scope:
        content: |
            # Test if the current key has overly broad permissions
            # A restricted key should fail on resources it doesn't need
            info "3.3 Testing key permissions scope..."
          
            # Try to list customers (should fail if key is properly restricted)
            if stripe_get "/customers?limit=1" > /dev/null 2>&1; then
            warn "3.3 Current key can list customers — may be overly permissive"
            else
            pass "3.3 Current key cannot list customers — properly scoped"
            fi
          
            # Try to list payment intents
            if stripe_get "/payment_intents?limit=1" > /dev/null 2>&1; then
            warn "3.3 Current key can list payment intents — review if needed"
            else
            pass "3.3 Current key cannot list payment intents — properly scoped"
            fi
          
            # Try to list webhook endpoints (meta-permission check)
            if stripe_get "/webhook_endpoints?limit=1" > /dev/null 2>&1; then
            info "3.3 Current key has webhook read access"
            else
            info "3.3 Current key cannot list webhooks"
            fi
          
            pass "3.3 Key scope validation complete"
            increment_applied

