# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-18T20:47:31Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-1.1-enforce-phishing-resistant-mfa.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-1.1-enforce-phishing-resistant-mfa.tf"
    excerpts:
      terraform:
        content: |
          
            # Look up break-glass accounts to exclude from Conditional Access
            data "azuread_user" "break_glass" {
            count               = length(var.break_glass_account_upns)
            user_principal_name = var.break_glass_account_upns[count.index]
            }
          
            # Conditional Access policy: Require MFA for all users
            resource "azuread_conditional_access_policy" "require_mfa" {
            display_name = "HTH: Require MFA for all users"
            state        = var.mfa_policy_state
          
            conditions {
              users {
                included_users = ["All"]
                excluded_users = [for u in data.azuread_user.break_glass : u.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              client_app_types = ["all"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["mfa"]
            }
            }
          
            # L2+: Require phishing-resistant authentication strength (FIDO2, WHfB, CBA)
            resource "azuread_authentication_strength_policy" "phishing_resistant" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Phishing-Resistant MFA"
            description  = "Requires FIDO2 security keys, Windows Hello for Business, or certificate-based authentication"
          
            allowed_combinations = [
              "fido2",
              "windowsHelloForBusiness",
              "x509CertificateMultiFactor",
            ]
            }
          
            # L2+: Conditional Access policy requiring phishing-resistant MFA for admins
            resource "azuread_conditional_access_policy" "require_phishing_resistant_mfa" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Require phishing-resistant MFA for admins"
            state        = "enabled"
          
            conditions {
              users {
                included_roles = [
                  # Global Administrator
                  "62e90394-69f5-4237-9190-012177145e10",
                  # Security Administrator
                  "194ae4cb-b126-40b2-bd5b-6091b380977d",
                  # Privileged Role Administrator
                  "e8611ab8-c189-46e8-94e1-60213ab1f814",
                ]
                excluded_users = [for u in data.azuread_user.break_glass : u.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              client_app_types = ["all"]
            }
          
            grant_controls {
              operator                          = "OR"
              authentication_strength_policy_id = azuread_authentication_strength_policy.phishing_resistant[0].id
            }
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-1.2-block-legacy-authentication.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-1.2-block-legacy-authentication.tf"
    excerpts:
      terraform:
        content: |
          
            # Conditional Access policy: Block legacy authentication protocols
            # Blocks POP3, IMAP, SMTP AUTH, Basic Auth that bypass MFA
            resource "azuread_conditional_access_policy" "block_legacy_auth" {
            display_name = "HTH: Block legacy authentication"
            state        = var.legacy_auth_policy_state
          
            conditions {
              users {
                included_users = ["All"]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              # Target only legacy auth client types
              client_app_types = ["exchangeActiveSync", "other"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["block"]
            }
            }

"1.3":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-1.3-privileged-identity-management.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-1.3-privileged-identity-management.tf"
    excerpts:
      terraform:
        content: |
          
            # Look up the Global Administrator directory role
            data "azuread_directory_role_templates" "all" {}
          
            locals {
            # Global Administrator role template ID
            global_admin_template_id = "62e90394-69f5-4237-9190-012177145e10"
          
            # Filter PIM-eligible admin UPNs -- only applied at L2+
            pim_admin_count = var.profile_level >= 2 ? length(var.pim_eligible_admin_upns) : 0
            }
          
            # Look up users to assign as PIM-eligible admins
            data "azuread_user" "pim_admins" {
            count               = local.pim_admin_count
            user_principal_name = var.pim_eligible_admin_upns[count.index]
            }
          
            # Activate the Global Administrator directory role in the tenant
            resource "azuread_directory_role" "global_admin" {
            count = var.profile_level >= 2 ? 1 : 0
          
            template_id = local.global_admin_template_id
            }
          
            # Create eligible (not permanent) role assignments for Global Administrator
            # These require activation through PIM before use
            resource "azuread_directory_role_eligibility_schedule_request" "pim_global_admin" {
            count = local.pim_admin_count
          
            role_definition_id = "/providers/Microsoft.Authorization/roleDefinitions/${local.global_admin_template_id}"
            principal_id       = data.azuread_user.pim_admins[count.index].object_id
            directory_scope_id = "/"
            justification      = "HTH: PIM eligible assignment for just-in-time Global Admin access"
            }

"1.4":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-1.4-break-glass-emergency-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-1.4-break-glass-emergency-access.tf"
    excerpts:
      terraform:
        content: |
          
            locals {
            # Only create break-glass accounts if domain and passwords are provided
            create_break_glass = (
              var.break_glass_account_domain != "" &&
              length(var.break_glass_account_passwords) >= 2
            )
            }
          
            # Break-glass emergency access account 1
            # Cloud-only, excluded from all Conditional Access policies
            resource "azuread_user" "break_glass_01" {
            count = local.create_break_glass ? 1 : 0
          
            user_principal_name = "emergency-admin-01@${var.break_glass_account_domain}"
            display_name        = "Emergency Admin 01"
            password            = var.break_glass_account_passwords[0]
            account_enabled     = true
          
            # Prevent password expiry on emergency accounts
            disable_password_expiration = true
            disable_strong_password     = false
            }
          
            # Break-glass emergency access account 2
            resource "azuread_user" "break_glass_02" {
            count = local.create_break_glass ? 1 : 0
          
            user_principal_name = "emergency-admin-02@${var.break_glass_account_domain}"
            display_name        = "Emergency Admin 02"
            password            = var.break_glass_account_passwords[1]
            account_enabled     = true
          
            disable_password_expiration = true
            disable_strong_password     = false
            }
          
            # Activate Global Administrator role for break-glass assignment
            resource "azuread_directory_role" "global_admin_break_glass" {
            count = local.create_break_glass ? 1 : 0
          
            template_id = "62e90394-69f5-4237-9190-012177145e10"
            }
          
            # Assign Global Administrator to break-glass account 1
            resource "azuread_directory_role_assignment" "break_glass_01_admin" {
            count = local.create_break_glass ? 1 : 0
          
            role_id             = azuread_directory_role.global_admin_break_glass[0].template_id
            principal_object_id = azuread_user.break_glass_01[0].object_id
            }
          
            # Assign Global Administrator to break-glass account 2
            resource "azuread_directory_role_assignment" "break_glass_02_admin" {
            count = local.create_break_glass ? 1 : 0
          
            role_id             = azuread_directory_role.global_admin_break_glass[0].template_id
            principal_object_id = azuread_user.break_glass_02[0].object_id
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-2.1-configure-named-locations.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-2.1-configure-named-locations.tf"
    excerpts:
      terraform:
        content: |
          
            # Named location: Trusted corporate IP ranges
            resource "azuread_named_location" "corporate_network" {
            count = var.profile_level >= 2 && length(var.trusted_ip_ranges) > 0 ? 1 : 0
          
            display_name = "HTH: Corporate Network"
          
            ip {
              ip_ranges = var.trusted_ip_ranges
              trusted   = true
            }
            }
          
            # Named location: Blocked countries
            resource "azuread_named_location" "blocked_countries" {
            count = var.profile_level >= 2 && length(var.blocked_country_codes) > 0 ? 1 : 0
          
            display_name = "HTH: Blocked Countries"
          
            country {
              countries_and_regions                 = var.blocked_country_codes
              include_unknown_countries_and_regions = true
            }
            }
          
            # Conditional Access policy: Block sign-ins from high-risk countries
            resource "azuread_conditional_access_policy" "block_countries" {
            count = var.profile_level >= 2 && length(var.blocked_country_codes) > 0 ? 1 : 0
          
            display_name = "HTH: Block sign-ins from restricted countries"
            state        = "enabled"
          
            conditions {
              users {
                included_users = ["All"]
                excluded_users = [for u in data.azuread_user.break_glass : u.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              locations {
                included_locations = [azuread_named_location.blocked_countries[0].id]
              }
          
              client_app_types = ["all"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["block"]
            }
            }
          
            # L3: Require MFA from non-trusted locations (reduce MFA fatigue for trusted)
            resource "azuread_conditional_access_policy" "mfa_untrusted_locations" {
            count = var.profile_level >= 3 && length(var.trusted_ip_ranges) > 0 ? 1 : 0
          
            display_name = "HTH: Require MFA from non-trusted locations"
            state        = "enabled"
          
            conditions {
              users {
                included_users = ["All"]
                excluded_users = [for u in data.azuread_user.break_glass : u.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              locations {
                included_locations = ["All"]
                excluded_locations = [azuread_named_location.corporate_network[0].id]
              }
          
              client_app_types = ["all"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["mfa"]
            }
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-3.1-restrict-user-consent.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-3.1-restrict-user-consent.tf"
    excerpts:
      terraform:
        content: |
          
            # Look up current authorization policy to modify consent settings
            data "azuread_client_config" "current" {}
          
            # Disable user consent for all applications
            # Users must request admin approval for any third-party app access
            resource "azuread_auth_policy" "disable_user_consent" {
            display_name = "HTH: Disable User Consent"
          
            default_user_role_permissions {
              # Remove all permission grant policies -- disables user consent
              allowed_to_create_apps = false
            }
            }
          
            # Admin consent workflow: Configure designated reviewers for app requests
            resource "azuread_admin_consent_request_policy" "consent_workflow" {
            count = length(var.admin_consent_request_reviewers) > 0 ? 1 : 0
          
            is_enabled = true
            notify_reviewers = true
            reminders_enabled = true
            request_duration_in_days = 30
          
            dynamic "reviewer" {
              for_each = var.admin_consent_request_reviewers
              content {
                query      = "/users/${reviewer.value}"
                query_type = "MicrosoftGraph"
              }
            }
            }
          
            # L2+: Create app consent policy restricting to verified publishers only
            resource "azuread_service_principal" "msgraph" {
            count = var.profile_level >= 2 ? 1 : 0
          
            client_id    = "00000003-0000-0000-c000-000000000000" # Microsoft Graph
            use_existing = true
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-3.2-review-app-permissions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-3.2-review-app-permissions.tf"
    excerpts:
      terraform:
        content: |
          
            # Data source: Enumerate all enterprise applications (service principals)
            # Use this to audit existing app permissions
            data "azuread_service_principals" "all_enterprise_apps" {
            count        = var.profile_level >= 2 ? 1 : 0
            return_all   = true
            }
          
            # L2: Application registration restrictions
            # Prevent non-admin users from registering new applications
            resource "azuread_auth_policy" "restrict_app_registration" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Restrict Application Registration"
          
            default_user_role_permissions {
              allowed_to_create_apps = false
            }
            }
          
            # L3: Block applications without verified publisher
            resource "azuread_conditional_access_policy" "block_unverified_apps" {
            count = var.profile_level >= 3 ? 1 : 0
          
            display_name = "HTH: Block access from unverified publisher apps"
            state        = "enabledForReportingButNotEnforced"
          
            conditions {
              users {
                included_users = ["All"]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              client_app_types = ["all"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["block"]
            }
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-4.1-sensitivity-labels-dlp.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-4.1-sensitivity-labels-dlp.tf"
    excerpts:
      terraform:
        content: |
          
            # NOTE: Microsoft Purview sensitivity labels and DLP policies are not directly
            # manageable via the azuread Terraform provider. These must be configured via
            # Microsoft Graph API or PowerShell (Security & Compliance module).
            #
            # This file provisions the prerequisite Azure AD group structure for label
            # scoping and DLP policy targeting.
          
            # Group for users who should receive sensitivity labels
            resource "azuread_group" "sensitivity_label_users" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name     = "HTH: Sensitivity Label Users"
            description      = "Users scoped for Microsoft Purview sensitivity labels"
            security_enabled = true
            mail_enabled     = false
            }
          
            # Group for DLP policy scoping
            resource "azuread_group" "dlp_policy_scope" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name     = "HTH: DLP Policy Scope"
            description      = "Users and groups scoped for Data Loss Prevention policies"
            security_enabled = true
            mail_enabled     = false
            }
          
            # L3: Dedicated group for auto-labeling policy scope
            resource "azuread_group" "auto_labeling_scope" {
            count = var.profile_level >= 3 ? 1 : 0
          
            display_name     = "HTH: Auto-Labeling Scope"
            description      = "Users scoped for automatic sensitivity label application (E5 required)"
            security_enabled = true
            mail_enabled     = false
            }

"4.2":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-4.2-external-sharing-restrictions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-4.2-external-sharing-restrictions.tf"
    excerpts:
      terraform:
        content: |
          
            # NOTE: SharePoint Online sharing settings are managed through the Microsoft 365
            # admin APIs, not the azuread provider. Use the SPO PowerShell module or
            # Microsoft Graph API for direct configuration:
            #
            #   Set-SPOTenant -SharingCapability ExistingExternalUserSharingOnly
            #   Set-SPOTenant -RequireAcceptingAccountMatchInvitedAccount $true
            #   Set-SPOTenant -PreventExternalUsersFromResharing $true
            #
            # This file creates the Azure AD groups needed for conditional sharing policies.
          
            # Group for users authorized to share externally
            resource "azuread_group" "external_sharing_authorized" {
            display_name     = "HTH: External Sharing Authorized"
            description      = "Users permitted to share documents with external parties"
            security_enabled = true
            mail_enabled     = false
            }
          
            # Conditional Access: Restrict unmanaged device access to web-only
            # Prevents downloading/syncing sensitive data on personal devices
            resource "azuread_conditional_access_policy" "restrict_unmanaged_devices" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Restrict unmanaged device access"
            state        = "enabled"
          
            conditions {
              users {
                included_users = ["All"]
                excluded_users = [for u in data.azuread_user.break_glass : u.object_id]
              }
          
              applications {
                # SharePoint Online and OneDrive application IDs
                included_applications = [
                  "00000003-0000-0ff1-ce00-000000000000", # SharePoint Online
                ]
              }
          
              client_app_types = ["browser"]
            }
          
            session_controls {
              application_enforced_restrictions_enabled = true
            }
            }
          
            # L3: Block external sharing entirely except to allowed domains
            resource "azuread_group" "allowed_external_domains" {
            count = var.profile_level >= 3 && length(var.allowed_external_domains) > 0 ? 1 : 0
          
            display_name     = "HTH: Allowed External Domains"
            description      = "Reference group for external domain allow-list (domains: ${join(", ", var.allowed_external_domains)})"
            security_enabled = true
            mail_enabled     = false
            }

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-5.1-enable-unified-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-5.1-enable-unified-audit-logging.tf"
    excerpts:
      terraform:
        content: |
          
            # NOTE: Unified audit logging is managed through Exchange Online PowerShell,
            # not the azuread provider. Enable via:
            #
            #   Set-AdminAuditLogConfig -UnifiedAuditLogIngestionEnabled $true
            #   Get-Mailbox -ResultSize Unlimited | Set-Mailbox -AuditEnabled $true
            #
            # This file creates the Azure AD groups and Conditional Access signals needed
            # to support audit logging infrastructure and monitoring.
          
            # Security group for audit log reviewers (SIEM integration service accounts)
            resource "azuread_group" "audit_log_reviewers" {
            display_name     = "HTH: Audit Log Reviewers"
            description      = "Security team members and service accounts with audit log access"
            security_enabled = true
            mail_enabled     = false
            }
          
            # Group for mailbox auditing scope (users requiring enhanced auditing)
            resource "azuread_group" "enhanced_audit_scope" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name     = "HTH: Enhanced Audit Scope"
            description      = "Users with enhanced mailbox auditing (MailItemsAccessed, Send)"
            security_enabled = true
            mail_enabled     = false
            }
          
            # L2+: Application registration for SIEM integration
            resource "azuread_application" "siem_integration" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: SIEM Audit Log Integration"
          
            required_resource_access {
              # Microsoft Graph
              resource_app_id = "00000003-0000-0000-c000-000000000000"
          
              resource_access {
                # AuditLog.Read.All (Application)
                id   = "b0afded3-3588-46d8-8b3d-9842eff778da"
                type = "Role"
              }
          
              resource_access {
                # Directory.Read.All (Application)
                id   = "7ab1d382-f21e-4acd-a863-ba3e13f7da61"
                type = "Role"
              }
            }
          
            web {
              redirect_uris = []
            }
            }
          
            # Service principal for the SIEM integration app
            resource "azuread_service_principal" "siem_integration" {
            count = var.profile_level >= 2 ? 1 : 0
          
            client_id = azuread_application.siem_integration[0].client_id
            }

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-365-5.2-configure-security-alerts.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-365/terraform/hth-microsoft-365-5.2-configure-security-alerts.tf"
    excerpts:
      terraform:
        content: |
          
            # NOTE: Microsoft Defender for Office 365 alert policies are managed through
            # the Security & Compliance PowerShell module, not the azuread provider.
            #
            # This file provisions the Azure AD group structure needed for alert routing
            # and the Conditional Access policy for risky sign-in detection.
          
            # Security operations group for alert notification routing
            resource "azuread_group" "security_operations" {
            display_name     = "HTH: Security Operations"
            description      = "Security team members receiving Defender and audit alert notifications"
            security_enabled = true
            mail_enabled     = false
            }
          
            # L1: Conditional Access policy responding to sign-in risk
            # Requires Entra ID P2 for risk-based Conditional Access
            resource "azuread_conditional_access_policy" "risky_signin_mfa" {
            display_name = "HTH: Require MFA for risky sign-ins"
            state        = "enabled"
          
            conditions {
              users {
                included_users = ["All"]
                excluded_users = [for u in data.azuread_user.break_glass : u.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              sign_in_risk_levels = ["medium", "high"]
              client_app_types    = ["all"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["mfa"]
            }
            }
          
            # L2+: Block high-risk sign-ins entirely
            resource "azuread_conditional_access_policy" "block_high_risk_signin" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Block high-risk sign-ins"
            state        = "enabled"
          
            conditions {
              users {
                included_users = ["All"]
                excluded_users = [for u in data.azuread_user.break_glass : u.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              sign_in_risk_levels = ["high"]
              client_app_types    = ["all"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["block"]
            }
            }
          
            # L2+: Respond to user risk -- require password change for risky users
            resource "azuread_conditional_access_policy" "risky_user_remediation" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Require password change for risky users"
            state        = "enabled"
          
            conditions {
              users {
                included_users = ["All"]
                excluded_users = [for u in data.azuread_user.break_glass : u.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              user_risk_levels = ["high"]
              client_app_types = ["all"]
            }
          
            grant_controls {
              operator          = "AND"
              built_in_controls = ["mfa", "passwordChange"]
            }
            }

