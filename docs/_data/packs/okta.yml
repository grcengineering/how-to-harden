# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-19T16:51:42Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-okta-1.01-enforce-phishing-resistant-mfa.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-1.01-enforce-phishing-resistant-mfa.tf"
    excerpts:
      terraform:
        content: |
            # Enable FIDO2 (WebAuthn) as an authenticator
            resource "okta_authenticator" "fido2" {
            name   = "FIDO2 WebAuthn"
            key    = "webauthn"
            status = "ACTIVE"
            settings = jsonencode({
              userVerification = "REQUIRED"
              attachment       = "ANY"
            })
            }
          
            # Signon policy requiring phishing-resistant MFA for admins
            resource "okta_policy_signon" "phishing_resistant" {
            name        = "Phishing-Resistant MFA Policy"
            status      = "ACTIVE"
            description = "Requires FIDO2 for all admin access"
            priority    = 1
          
            groups_included = [var.admin_group_id]
            }
          
            # Rule enforcing FIDO2 on the phishing-resistant policy
            resource "okta_policy_rule_signon" "require_fido2" {
            policy_id          = okta_policy_signon.phishing_resistant.id
            name               = "Require FIDO2"
            status             = "ACTIVE"
            priority           = 1
            access             = "ALLOW"
            mfa_required       = true
            mfa_prompt         = "ALWAYS"
            primary_factor     = "PASSWORD_IDP_ANY_FACTOR"
            session_lifetime   = 120
            session_persistent = false
            }
  api:
    lang: "bash"
    filename: "hth-okta-1.01-enforce-phishing-resistant-mfa.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-1.01-enforce-phishing-resistant-mfa.sh"
    excerpts:
      api-create-policy:
        content: |
            # Create FIDO2 authenticator policy
            info "1.1 Creating phishing-resistant MFA policy..."
            POLICY_RESPONSE=$(okta_post "/api/v1/policies" '{
            "type": "ACCESS_POLICY",
            "name": "Phishing-Resistant MFA Policy",
            "description": "Requires FIDO2 for sensitive applications",
            "priority": 1,
            "conditions": {
              "people": {
                "groups": {
                  "include": ["EVERYONE"]
                }
              }
            }
            }') || {
            fail "1.1 Failed to create MFA policy"
            increment_failed
            summary
            exit 0
            }
          
            POLICY_ID=$(echo "${POLICY_RESPONSE}" | jq -r '.id // empty' 2>/dev/null || true)
      api-create-rule:
        content: |
            # Create policy rule requiring WebAuthn
            info "1.1 Creating policy rule requiring FIDO2..."
            okta_post "/api/v1/policies/${POLICY_ID}/rules" '{
              "name": "Require FIDO2",
              "priority": 1,
              "conditions": {
                "network": {
                  "connection": "ANYWHERE"
                }
              },
              "actions": {
                "signon": {
                  "access": "ALLOW",
                  "requireFactor": true,
                  "factorPromptMode": "ALWAYS",
                  "primaryFactor": "PASSWORD_IDP_ANY_FACTOR",
                  "factorLifetime": 0
                }
              }
            }' > /dev/null 2>&1 || warn "1.1 Policy rule creation returned non-zero (may already exist)"
  cli:
    lang: "text"
    filename: "hth-okta-1.01-enforce-phishing-resistant-mfa.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-1.01-enforce-phishing-resistant-mfa.txt"
    excerpts:
      cli-log-query-fido2-auth:
        content: |
            eventType eq "user.authentication.auth_via_mfa" AND debugContext.debugData.factor eq "FIDO2_WEBAUTHN"
  sigma:
    - lang: "yaml"
      filename: "hth-okta-1.01-enforce-phishing-resistant-mfa.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-1.01-enforce-phishing-resistant-mfa.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'user.authentication.auth_via_mfa'
                    debugContext.debugData.factor: 'FIDO2_WEBAUTHN'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - client.ipAddress
                - debugContext.debugData.factor
                - outcome.result
                - published

"1.2":
  api:
    lang: "bash"
    filename: "hth-okta-1.02-admin-role-separation.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-1.02-admin-role-separation.sh"
    excerpts:
      api-create-role:
        content: |
            # Create custom Help Desk Admin role
            info "1.2 Creating Help Desk Admin custom role..."
            okta_post "/api/v1/iam/roles" '{
            "label": "Help Desk Admin",
            "description": "Limited admin for password resets and account unlocks",
            "permissions": [
              "okta.users.read",
              "okta.users.credentials.resetPassword",
              "okta.users.lifecycle.unlock"
            ]
            }' > /dev/null 2>&1 && {
            pass "1.2 Help Desk Admin role created"
            increment_applied
            } || {
            fail "1.2 Failed to create Help Desk Admin role"
            increment_failed
            }

"1.4":
  api:
    lang: "bash"
    filename: "hth-okta-1.04-configure-password-policy.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-1.04-configure-password-policy.sh"
    excerpts:
      api-update-password-policy:
        content: |
            okta_put "/api/v1/policies/${POLICY_ID}" "{
              \"settings\": {
                \"password\": {
                  \"complexity\": {
                    \"minLength\": ${MIN_LENGTH},
                    \"minLowerCase\": 1,
                    \"minUpperCase\": 1,
                    \"minNumber\": 1,
                    \"minSymbol\": 1
                  },
                  \"age\": {
                    \"maxAgeDays\": ${MAX_AGE_DAYS},
                    \"minAgeMinutes\": ${MIN_AGE_MINUTES},
                    \"historyCount\": ${HISTORY_COUNT}
                  }
                }
              }
            }" > /dev/null 2>&1 && {
              updated=$((updated + 1))
            } || warn "1.4 Failed to update policy '${POLICY_NAME}'"

"1.5":
  api:
    lang: "bash"
    filename: "hth-okta-1.05-configure-account-lockout.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-1.05-configure-account-lockout.sh"
    excerpts:
      api-update-lockout-policy:
        content: |
            okta_put "/api/v1/policies/${POLICY_ID}" "{
              \"settings\": {
                \"password\": {
                  \"lockout\": {
                    \"maxAttempts\": ${LOCKOUT_THRESHOLD},
                    \"autoUnlockMinutes\": 30,
                    \"showLockoutFailures\": true
                  }
                }
              }
            }" > /dev/null 2>&1 && {
              updated=$((updated + 1))
            } || warn "1.5 Failed to update lockout for policy '${POLICY_NAME}'"

"1.9":
  terraform:
    lang: "hcl"
    filename: "hth-okta-1.09-audit-default-auth-policy.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-1.09-audit-default-auth-policy.tf"
    excerpts:
      terraform:
        content: |
            # Reference the immutable Default Authentication Policy
            data "okta_policy" "default_access" {
            name = "Default Policy"
            type = "ACCESS_POLICY"
            }
          
            # Custom catch-all policy to replace reliance on the default policy
            resource "okta_app_signon_policy" "mfa_required" {
            name        = "MFA Required - All Applications"
            description = "Enforces MFA for all applications - prevents fallthrough to default policy"
            }
          
            # Catch-all deny rule (lowest priority in custom policy)
            resource "okta_app_signon_policy_rule" "catch_all_deny" {
            policy_id          = okta_app_signon_policy.mfa_required.id
            name               = "Catch-All Deny"
            priority           = 99
            access             = "DENY"
            factor_mode        = "2FA"
            constraints        = []
            groups_excluded    = []
            groups_included    = ["EVERYONE"]
            network_connection = "ANYWHERE"
            }
          
            # MFA enforcement rule (higher priority than catch-all)
            resource "okta_app_signon_policy_rule" "require_mfa" {
            policy_id                   = okta_app_signon_policy.mfa_required.id
            name                        = "Require MFA"
            priority                    = 1
            access                      = "ALLOW"
            factor_mode                 = "2FA"
            groups_included             = ["EVERYONE"]
            network_connection          = "ANYWHERE"
            re_authentication_frequency = "PT2H"
            }
  api:
    lang: "bash"
    filename: "hth-okta-1.09-audit-default-auth-policy.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-1.09-audit-default-auth-policy.sh"
    excerpts:
      api-check-default-policy:
        content: |
            # Find the default policy (system=true)
            DEFAULT_POLICY_ID=$(okta_get "/api/v1/policies?type=ACCESS_POLICY" \
            | jq -r '.[] | select(.system == true and .name == "Default Policy") | .id' 2>/dev/null || true)
      api-list-policy-apps:
        content: |
            # List apps assigned to the default policy
            DEFAULT_APPS=$(okta_get "/api/v1/policies/${DEFAULT_POLICY_ID}/app" 2>/dev/null || echo "[]")
            APP_COUNT=$(echo "${DEFAULT_APPS}" | jq 'length' 2>/dev/null || echo "0")
  cli:
    lang: "text"
    filename: "hth-okta-1.09-audit-default-auth-policy.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-1.09-audit-default-auth-policy.txt"
    excerpts:
      cli-log-query-default-policy:
        content: |
            eventType eq "policy.evaluate_sign_on" AND debugContext.debugData.policyType eq "ACCESS_POLICY" AND target.displayName eq "Default Policy"
  db:
    lang: "sql"
    filename: "hth-okta-1.09-audit-default-auth-policy.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/db/hth-okta-1.09-audit-default-auth-policy.sql"
    excerpts:
      db-siem-default-policy-bypass:
        content: |
            -- Alert: Authentication via Default Policy (MFA bypass)
            SELECT actor.displayName, client.ipAddress, outcome.result, published
            FROM okta_system_log
            WHERE eventType = 'policy.evaluate_sign_on'
            AND debugContext.debugData.behaviors LIKE '%Default Policy%'
            ORDER BY published DESC
  sigma:
    - lang: "yaml"
      filename: "hth-okta-1.09-audit-default-auth-policy.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-1.09-audit-default-auth-policy.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'policy.evaluate_sign_on'
                    debugContext.debugData.policyType: 'ACCESS_POLICY'
                filter_default_policy:
                    target.displayName|contains: 'Default Policy'
                condition: selection and filter_default_policy
              fields:
                - actor.displayName
                - client.ipAddress
                - outcome.result
                - published

"1.10":
  terraform:
    lang: "hcl"
    filename: "hth-okta-1.10-harden-self-service-recovery.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-1.10-harden-self-service-recovery.tf"
    excerpts:
      terraform:
        content: |
            # Deactivate security question authenticator
            resource "okta_authenticator" "security_question" {
            name   = "Security Question"
            key    = "security_question"
            status = "INACTIVE"
            }
          
            # Configure phone authenticator -- remove recovery usage, keep for auth only
            resource "okta_authenticator" "phone" {
            name   = "Phone"
            key    = "phone_number"
            status = "ACTIVE"
            settings = jsonencode({
              allowedFor = "authentication"
            })
            }
          
            # Password policy with hardened recovery settings
            resource "okta_policy_password" "hardened_recovery" {
            name                     = "Hardened Password Policy"
            status                   = "ACTIVE"
            description              = "Password policy with restricted recovery methods"
            priority                 = 1
            password_min_length      = var.password_min_length
            password_min_lowercase   = 1
            password_min_uppercase   = 1
            password_min_number      = 1
            password_min_symbol      = 1
            password_max_age_days    = var.password_max_age_days
            password_min_age_minutes = 1440
            password_history_count   = var.password_history_count
            recovery_email_token     = 1
            email_recovery           = "ACTIVE"
            sms_recovery             = "INACTIVE"
            call_recovery            = "INACTIVE"
            question_recovery        = "INACTIVE"
          
            groups_included = [var.everyone_group_id]
            }
  api:
    lang: "bash"
    filename: "hth-okta-1.10-harden-self-service-recovery.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-1.10-harden-self-service-recovery.sh"
    excerpts:
      api-update-recovery-settings:
        content: |
            okta_put "/api/v1/policies/${POLICY_ID}" '{
              "settings": {
                "recovery": {
                  "factors": {
                    "okta_email": {
                      "status": "ACTIVE",
                      "properties": {
                        "recoveryToken": {
                          "tokenLifetimeMinutes": 10
                        }
                      }
                    },
                    "okta_sms": {
                      "status": "INACTIVE"
                    },
                    "okta_call": {
                      "status": "INACTIVE"
                    },
                    "recovery_question": {
                      "status": "INACTIVE"
                    }
                  }
                }
              }
            }' > /dev/null 2>&1 && {
              updated=$((updated + 1))
            } || warn "1.10 Failed to update recovery for policy '${POLICY_NAME}'"
      api-deactivate-security-question:
        content: |
            # Step 2: Deactivate Security Question authenticator
            info "1.10 Deactivating Security Question authenticator..."
            SECURITY_QUESTION_ID=$(okta_get "/api/v1/authenticators" \
            | jq -r '.[] | select(.key == "security_question") | .id' 2>/dev/null || true)
          
            if [ -n "${SECURITY_QUESTION_ID}" ]; then
            okta_post "/api/v1/authenticators/${SECURITY_QUESTION_ID}/lifecycle/deactivate" '{}' > /dev/null 2>&1 \
              && info "1.10 Security Question authenticator deactivated" \
              || warn "1.10 Security Question may already be inactive"
            fi
      api-update-phone-authenticator:
        content: |
            # Step 3: Update Phone authenticator to remove recovery usage
            info "1.10 Removing Phone authenticator from recovery..."
            PHONE_ID=$(okta_get "/api/v1/authenticators" \
            | jq -r '.[] | select(.key == "phone_number") | .id' 2>/dev/null || true)
          
            if [ -n "${PHONE_ID}" ]; then
            okta_put "/api/v1/authenticators/${PHONE_ID}" '{
              "name": "Phone",
              "settings": {
                "allowedFor": "authentication"
              }
            }' > /dev/null 2>&1 \
              && info "1.10 Phone authenticator restricted to authentication only" \
              || warn "1.10 Failed to update phone authenticator"
            fi
  cli:
    lang: "text"
    filename: "hth-okta-1.10-harden-self-service-recovery.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-1.10-harden-self-service-recovery.txt"
    excerpts:
      cli-log-query-recovery-untrusted:
        content: |
            eventType eq "user.account.reset_password" AND securityContext.isProxy eq true
  db:
    lang: "sql"
    filename: "hth-okta-1.10-harden-self-service-recovery.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/db/hth-okta-1.10-harden-self-service-recovery.sql"
    excerpts:
      db-siem-recovery-non-corporate-ip:
        content: |
            -- Alert: Password recovery from non-corporate IP
            SELECT actor.displayName, client.ipAddress, client.geographicalContext.city,
                 client.geographicalContext.country, outcome.result, published
            FROM okta_system_log
            WHERE eventType IN ('user.account.reset_password', 'user.credential.forgot_password')
            AND client.ipAddress NOT IN (SELECT ip FROM corporate_ip_ranges)
            ORDER BY published DESC
      db-siem-recovery-weak-factor:
        content: |
            -- Alert: SMS/Voice recovery attempt (should not occur after hardening)
            SELECT actor.displayName, client.ipAddress, outcome.result, published
            FROM okta_system_log
            WHERE eventType = 'user.account.reset_password'
            AND debugContext.debugData.factor IN ('SMS', 'CALL', 'QUESTION')
            ORDER BY published DESC
  sigma:
    - lang: "yaml"
      filename: "hth-okta-1.10-harden-self-service-recovery-b.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-1.10-harden-self-service-recovery-b.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'user.account.reset_password'
                    debugContext.debugData.factor:
                        - 'SMS'
                        - 'CALL'
                        - 'QUESTION'
                condition: selection
              fields:
                - actor.displayName
                - client.ipAddress
                - outcome.result
                - published
    - lang: "yaml"
      filename: "hth-okta-1.10-harden-self-service-recovery.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-1.10-harden-self-service-recovery.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'user.account.reset_password'
                        - 'user.credential.forgot_password'
                    securityContext.isProxy: true
                condition: selection
              fields:
                - actor.displayName
                - client.ipAddress
                - client.geographicalContext.city
                - client.geographicalContext.country
                - outcome.result
                - published

"1.11":
  terraform:
    lang: "hcl"
    filename: "hth-okta-1.11-enable-security-notifications.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-1.11-enable-security-notifications.tf"
    excerpts:
      terraform:
        content: |
            # Org-level configuration for end-user support
            resource "okta_org_configuration" "notifications" {
            end_user_support_help_url = var.support_url
          
            # End-user notification settings are managed via the org settings API.
            # Use the provisioners below for full control.
            }
          
            # Enable Suspicious Activity Reporting via API call
            # (Not all org-level settings are natively supported in Terraform)
            resource "null_resource" "enable_suspicious_activity_reporting" {
            provisioner "local-exec" {
              command = <<-EOT
                curl -s -X POST "https://${var.okta_domain}/api/v1/org/privacy/suspicious-activity-reporting" \
                  -H "Authorization: SSWS ${var.okta_api_token}" \
                  -H "Content-Type: application/json" \
                  -d '{"enabled": true}'
              EOT
            }
          
            triggers = {
              always_run = timestamp()
            }
            }
          
            # Enable all end-user notification types via API call
            resource "null_resource" "enable_end_user_notifications" {
            provisioner "local-exec" {
              command = <<-EOT
                curl -s -X PUT "https://${var.okta_domain}/api/v1/org/settings" \
                  -H "Authorization: SSWS ${var.okta_api_token}" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "endUserNotifications": {
                      "newSignOnNotification": {"enabled": true},
                      "authenticatorEnrolledNotification": {"enabled": true},
                      "authenticatorResetNotification": {"enabled": true},
                      "passwordChangedNotification": {"enabled": true},
                      "factorResetNotification": {"enabled": true}
                    }
                  }'
              EOT
            }
          
            triggers = {
              always_run = timestamp()
            }
            }
  api:
    lang: "bash"
    filename: "hth-okta-1.11-enable-security-notifications.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-1.11-enable-security-notifications.sh"
    excerpts:
      api-update-notifications:
        content: |
            # Enable all five end-user notification types
            info "1.11 Enabling all five notification types..."
            okta_put "/api/v1/org/settings" '{
            "endUserNotifications": {
              "newSignOnNotification": {
                "enabled": true
              },
              "authenticatorEnrolledNotification": {
                "enabled": true
              },
              "authenticatorResetNotification": {
                "enabled": true
              },
              "passwordChangedNotification": {
                "enabled": true
              },
              "factorResetNotification": {
                "enabled": true
              }
            }
            }' > /dev/null 2>&1 && {
            pass "1.11 All five end-user notification types enabled"
            } || {
            fail "1.11 Failed to enable end-user notifications"
            increment_failed
            summary
            exit 0
            }
      api-enable-suspicious-activity:
        content: |
            # Enable Suspicious Activity Reporting
            info "1.11 Enabling Suspicious Activity Reporting..."
            okta_post "/api/v1/org/privacy/suspicious-activity-reporting" '{
            "enabled": true
            }' > /dev/null 2>&1 && {
            pass "1.11 Suspicious Activity Reporting enabled"
            } || {
            warn "1.11 Suspicious Activity Reporting may already be enabled"
            }
  cli:
    lang: "text"
    filename: "hth-okta-1.11-enable-security-notifications.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-1.11-enable-security-notifications.txt"
    excerpts:
      cli-log-query-suspicious-activity:
        content: |
            eventType eq "user.account.report_suspicious_activity_by_enduser"
      cli-log-query-authenticator-changes:
        content: |
            eventType sw "user.mfa.factor" OR eventType eq "user.account.update_password"
  db:
    lang: "sql"
    filename: "hth-okta-1.11-enable-security-notifications.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/db/hth-okta-1.11-enable-security-notifications.sql"
    excerpts:
      db-siem-suspicious-activity-report:
        content: |
            -- HIGH PRIORITY: User reported suspicious activity
            SELECT actor.displayName, actor.alternateId, client.ipAddress,
                 client.geographicalContext.city, client.geographicalContext.country,
                 outcome.result, published
            FROM okta_system_log
            WHERE eventType = 'user.account.report_suspicious_activity_by_enduser'
            ORDER BY published DESC
      db-siem-authenticator-enrolled:
        content: |
            -- MEDIUM PRIORITY: Authenticator enrolled from unrecognized location
            -- (Correlate with new sign-on notifications)
            SELECT actor.displayName, target.displayName AS authenticator_type,
                 client.ipAddress, client.userAgent.rawUserAgent, published
            FROM okta_system_log
            WHERE eventType IN (
            'user.mfa.factor.activate',
            'user.mfa.factor.enroll',
            'system.mfa.factor.activate'
            )
            ORDER BY published DESC
  sigma:
    - lang: "yaml"
      filename: "hth-okta-1.11-enable-security-notifications-b.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-1.11-enable-security-notifications-b.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'user.mfa.factor.activate'
                        - 'user.mfa.factor.enroll'
                        - 'system.mfa.factor.activate'
                        - 'user.account.update_password'
                condition: selection
              fields:
                - actor.displayName
                - target.displayName
                - client.ipAddress
                - client.userAgent.rawUserAgent
                - published
    - lang: "yaml"
      filename: "hth-okta-1.11-enable-security-notifications.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-1.11-enable-security-notifications.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'user.account.report_suspicious_activity_by_enduser'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - client.ipAddress
                - client.geographicalContext.city
                - client.geographicalContext.country
                - outcome.result
                - published

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-okta-2.01-configure-network-zones.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-2.01-configure-network-zones.tf"
    excerpts:
      terraform:
        content: |
            # Corporate network zone with configurable CIDRs
            resource "okta_network_zone" "corporate" {
            count = length(var.corporate_gateway_cidrs) > 0 ? 1 : 0
          
            name     = "Corporate Network"
            type     = "IP"
            status   = "ACTIVE"
            gateways = var.corporate_gateway_cidrs
            }
          
            # IP blocklist zone
            resource "okta_network_zone" "blocklist" {
            count = length(var.blocked_ip_cidrs) > 0 ? 1 : 0
          
            name     = "Blocked IPs"
            type     = "IP"
            status   = "ACTIVE"
            usage    = "BLOCKLIST"
            gateways = var.blocked_ip_cidrs
            }
  api:
    lang: "bash"
    filename: "hth-okta-2.01-configure-network-zones.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-2.01-configure-network-zones.sh"
    excerpts:
      api-create-corporate-zone:
        content: |
            # Create Corporate Network zone
            # NOTE: Replace gateway CIDRs with your actual corporate IP ranges
            info "2.1 Creating Corporate Network zone..."
            ZONE_RESPONSE=$(okta_post "/api/v1/zones" '{
              "type": "IP",
              "name": "Corporate Network",
              "status": "ACTIVE",
              "gateways": [
                {"type": "CIDR", "value": "203.0.113.0/24"},
                {"type": "CIDR", "value": "198.51.100.0/24"}
              ]
            }' 2>/dev/null) && {
              ZONE_ID=$(echo "${ZONE_RESPONSE}" | jq -r '.id' 2>/dev/null || true)
              pass "2.1 Corporate Network zone created (ID: ${ZONE_ID})"
              warn "2.1 IMPORTANT: Update the zone with your actual corporate IP ranges"
            } || {
              fail "2.1 Failed to create Corporate Network zone"
            }
      api-create-anonymizer-zone:
        content: |
            info "2.1 Creating TOR/Anonymizer block zone..."
            okta_post "/api/v1/zones" '{
              "type": "DYNAMIC_V2",
              "name": "Blocked - TOR and Anonymizers",
              "status": "ACTIVE",
              "proxyType": "TorAnonymizer",
              "usage": "BLOCKLIST"
            }' > /dev/null 2>&1 && {
              pass "2.1 TOR/Anonymizer block zone created"
            } || {
              warn "2.1 Failed to create TOR block zone (may require Adaptive MFA license)"
            }

"2.3":
  terraform:
    lang: "hcl"
    filename: "hth-okta-2.03-block-anonymizers.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-2.03-block-anonymizers.tf"
    excerpts:
      terraform:
        content: |
            # Block anonymizing proxies and Tor exit nodes
            resource "okta_network_zone" "block_anonymizers" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name               = "Block Anonymizers"
            type               = "DYNAMIC_V2"
            status             = "ACTIVE"
            usage              = "BLOCKLIST"
            dynamic_proxy_type = "TorAnonymizer"
            }
          
            # Block traffic from high-risk countries
            resource "okta_network_zone" "block_countries" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name              = "Blocked Countries"
            type              = "DYNAMIC"
            status            = "ACTIVE"
            usage             = "BLOCKLIST"
            dynamic_locations = var.blocked_countries
            }
  api:
    lang: "bash"
    filename: "hth-okta-2.03-block-anonymizers.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-2.03-block-anonymizers.sh"
    excerpts:
      api-update-dynamic-zone:
        content: |
            # Activate the zone as a blocklist
            info "2.3 Activating DefaultEnhancedDynamicZone as blocklist..."
            okta_put "/api/v1/zones/${ZONE_ID}" '{
            "type": "DYNAMIC_V2",
            "name": "DefaultEnhancedDynamicZone",
            "status": "ACTIVE",
            "usage": "BLOCKLIST",
            "proxyType": "TorAnonymizer"
            }' > /dev/null 2>&1 && {
            pass "2.3 Enhanced Dynamic Zone activated with anonymizer blocking"
            increment_applied
            } || {
            fail "2.3 Failed to activate Enhanced Dynamic Zone"
            increment_failed
            }
  cli:
    lang: "text"
    filename: "hth-okta-2.03-block-anonymizers.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-2.03-block-anonymizers.txt"
    excerpts:
      cli-log-query-anonymizer-detection:
        content: |
            eventType eq "security.threat.detected" AND debugContext.debugData.threatSuspected eq "ANONYMIZER"
  sigma:
    - lang: "yaml"
      filename: "hth-okta-2.03-block-anonymizers.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-2.03-block-anonymizers.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'security.threat.detected'
                    debugContext.debugData.threatSuspected: 'ANONYMIZER'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - client.ipAddress
                - debugContext.debugData.threatSuspected
                - outcome.result
                - published

"3.1":
  api:
    lang: "bash"
    filename: "hth-okta-3.01-oauth-consent-policies.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-3.01-oauth-consent-policies.sh"
    excerpts:
      api-list-active-apps:
        content: |
            # List all active applications with OAuth/OIDC sign-on
            info "3.1 Listing active applications..."
            ACTIVE_APPS=$(okta_get "/api/v1/apps?filter=status%20eq%20%22ACTIVE%22&limit=200") || {
            fail "3.1 Failed to list active applications"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL_COUNT=$(echo "${ACTIVE_APPS}" | jq 'length' 2>/dev/null || echo "0")
            OAUTH_APPS=$(echo "${ACTIVE_APPS}" | jq '[.[] | select(.signOnMode == "OPENID_CONNECT" or .signOnMode == "OAUTH_2_0")]' 2>/dev/null || echo "[]")
            OAUTH_COUNT=$(echo "${OAUTH_APPS}" | jq 'length' 2>/dev/null || echo "0")
          
            info "3.1 Total active apps: ${TOTAL_COUNT}, OAuth/OIDC apps: ${OAUTH_COUNT}"
            echo "${OAUTH_APPS}" | jq -r '.[] | "  - \(.label // .name) (mode: \(.signOnMode), created: \(.created))"' 2>/dev/null || true
      api-list-auth-server-clients:
        content: |
            # Audit OAuth token clients on default authorization server
            info "3.1 Auditing OAuth clients on default authorization server..."
            AUTH_CLIENTS=$(okta_get "/api/v1/authorizationServers/default/clients" 2>/dev/null || echo "[]")
            CLIENT_COUNT=$(echo "${AUTH_CLIENTS}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${CLIENT_COUNT}" -gt 0 ]; then
            info "3.1 Found ${CLIENT_COUNT} OAuth client(s) on default auth server"
            echo "${AUTH_CLIENTS}" | jq -r '.[] | "  - \(.client_name // "unnamed") (ID: \(.client_id))"' 2>/dev/null || true
            else
            info "3.1 No OAuth clients on default authorization server"
            fi

"3.2":
  cli:
    lang: "text"
    filename: "hth-okta-3.02-harden-scim-provisioning-connectors.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-3.02-harden-scim-provisioning-connectors.txt"
    excerpts:
      cli-log-query-scim-events:
        content: |
            eventType eq "system.scim.user.create" OR eventType eq "system.scim.user.update"
  sigma:
    - lang: "yaml"
      filename: "hth-okta-3.02-harden-scim-provisioning-connectors.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-3.02-harden-scim-provisioning-connectors.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'system.scim.user.create'
                        - 'system.scim.user.update'
                condition: selection
              fields:
                - actor.displayName
                - target.displayName
                - target.type
                - eventType
                - client.ipAddress
                - published

"3.3":
  api:
    lang: "bash"
    filename: "hth-okta-3.03-oauth-app-allowlisting.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-3.03-oauth-app-allowlisting.sh"
    excerpts:
      api-list-oauth-apps:
        content: |
            # List all active OIDC/OAuth apps
            ACTIVE_APPS=$(okta_get "/api/v1/apps?filter=status%20eq%20%22ACTIVE%22&limit=200" 2>/dev/null || echo "[]")
            APP_IDS=$(echo "${ACTIVE_APPS}" | jq -r '.[] | select(.signOnMode == "OPENID_CONNECT" or .signOnMode == "OAUTH_2_0") | .id' 2>/dev/null || true)
      api-check-app-grants:
        content: |
            GRANTS=$(okta_get "/api/v1/apps/${APP_ID}/grants" 2>/dev/null || echo "[]")
            BROAD_SCOPES=$(echo "${GRANTS}" | jq -r '.[] | select(.scopeId | test("manage|write"; "i")) | .scopeId' 2>/dev/null || true)
      api-list-auth-server-clients:
        content: |
            # List OAuth clients on default authorization server
            info "3.3 Auditing default authorization server clients..."
            okta_get "/api/v1/authorizationServers/default/clients" 2>/dev/null \
            | jq -r '.[] | "  - \(.client_name // "unnamed") (ID: \(.client_id))"' 2>/dev/null || true
  cli:
    lang: "text"
    filename: "hth-okta-3.03-oauth-app-allowlisting.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-3.03-oauth-app-allowlisting.txt"
    excerpts:
      cli-log-query-oauth-consent:
        content: |
            eventType eq "app.oauth2.consent.grant" OR eventType eq "app.oauth2.as.consent.grant"
  sigma:
    - lang: "yaml"
      filename: "hth-okta-3.03-oauth-app-allowlisting.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-3.03-oauth-app-allowlisting.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'app.oauth2.consent.grant'
                        - 'app.oauth2.as.consent.grant'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - target.displayName
                - debugContext.debugData.requestedScopes
                - client.ipAddress
                - published

"3.4":
  terraform:
    lang: "hcl"
    filename: "hth-okta-3.04-govern-non-human-identities.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-3.04-govern-non-human-identities.tf"
    excerpts:
      terraform:
        content: |
            # OAuth 2.0 service app using client_credentials with private_key_jwt
            resource "okta_app_oauth" "service_automation" {
            label                      = "SVC - Automation API Access"
            type                       = "service"
            grant_types                = ["client_credentials"]
            response_types             = ["token"]
            token_endpoint_auth_method = "private_key_jwt"
            pkce_required              = false
          
            jwks {
              kty = "RSA"
              e   = var.service_app_public_key_e
              n   = var.service_app_public_key_n
            }
            }
          
            # Grant minimum-required API scopes to the service app
            resource "okta_app_oauth_api_scope" "users_read" {
            app_id = okta_app_oauth.service_automation.id
            issuer = "https://${var.okta_domain}"
            scopes = ["okta.users.read"]
            }
  api:
    lang: "bash"
    filename: "hth-okta-3.04-govern-non-human-identities.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-3.04-govern-non-human-identities.sh"
    excerpts:
      api-list-tokens:
        content: |
            # List all active API tokens
            info "3.4 Listing all active API tokens..."
            API_TOKENS=$(okta_get "/api/v1/api-tokens" 2>/dev/null || echo "[]")
            TOKEN_COUNT=$(echo "${API_TOKENS}" | jq 'length' 2>/dev/null || echo "0")
      api-list-service-apps:
        content: |
            # List service applications (OAuth client_credentials)
            info "3.4 Listing OAuth service applications..."
            SERVICE_APPS=$(okta_get "/api/v1/apps?filter=status%20eq%20%22ACTIVE%22&limit=200" 2>/dev/null \
            | jq '[.[] | select(.settings.oauthClient.grant_types? // [] | index("client_credentials"))]' 2>/dev/null || echo "[]")
            SVC_COUNT=$(echo "${SERVICE_APPS}" | jq 'length' 2>/dev/null || echo "0")
  cli:
    lang: "text"
    filename: "hth-okta-3.04-govern-non-human-identities.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-3.04-govern-non-human-identities.txt"
    excerpts:
      cli-log-query-api-token-events:
        content: |
            eventType eq "system.api_token.create" OR eventType eq "system.api_token.revoke" OR eventType eq "app.oauth2.token.grant"
  sigma:
    - lang: "yaml"
      filename: "hth-okta-3.04-govern-non-human-identities.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-3.04-govern-non-human-identities.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'system.api_token.create'
                        - 'system.api_token.revoke'
                        - 'app.oauth2.token.grant'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - eventType
                - target.displayName
                - client.ipAddress
                - published

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-okta-4.01-configure-session-timeouts.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-4.01-configure-session-timeouts.tf"
    excerpts:
      terraform:
        content: |
            # Global session policy with hardened timeout values
            resource "okta_policy_signon" "session_timeouts" {
            name        = "Hardened Session Timeouts"
            status      = "ACTIVE"
            description = "Session timeout configuration per HTH hardening guide"
            priority    = 3
            }
          
            resource "okta_policy_rule_signon" "session_timeout_rule" {
            policy_id          = okta_policy_signon.session_timeouts.id
            name               = "Enforce Session Timeouts"
            status             = "ACTIVE"
            priority           = 1
            access             = "ALLOW"
            mfa_required       = true
            mfa_prompt         = "SESSION"
            session_lifetime   = var.session_max_lifetime_minutes
            session_idle       = var.session_max_idle_minutes
            session_persistent = false
            }
  api:
    lang: "bash"
    filename: "hth-okta-4.01-configure-session-timeouts.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-4.01-configure-session-timeouts.sh"
    excerpts:
      api-check-session-policies:
        content: |
            # Get global session policies and report current settings
            POLICIES=$(okta_get "/api/v1/policies?type=OKTA_SIGN_ON") || {
            fail "4.1 Failed to retrieve global session policies"
            increment_failed
            summary
            exit 0
            }
          
            POLICY_COUNT=$(echo "${POLICIES}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${POLICY_COUNT}" -eq 0 ]; then
            warn "4.1 No global session policies found"
            increment_skipped
            summary
            exit 0
            fi
          
            for POLICY_ID in $(echo "${POLICIES}" | jq -r '.[].id' 2>/dev/null); do
            POLICY_NAME=$(echo "${POLICIES}" | jq -r ".[] | select(.id == \"${POLICY_ID}\") | .name" 2>/dev/null || echo "unknown")
            info "4.1 Reviewing session policy '${POLICY_NAME}' (${POLICY_ID})..."
          
            RULES=$(okta_get "/api/v1/policies/${POLICY_ID}/rules" 2>/dev/null || echo "[]")
            RULE_COUNT=$(echo "${RULES}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${RULE_COUNT}" -gt 0 ]; then
              echo "${RULES}" | jq -r '.[] | "  - Rule: \(.name), MaxLifetime: \(.actions.signon.session.maxSessionLifetimeMinutes // "default")min, MaxIdle: \(.actions.signon.session.maxSessionIdleMinutes // "default")min, Persistent: \(.actions.signon.session.usePersistentCookie // "default")"' 2>/dev/null || true
            fi
            done

"4.2":
  terraform:
    lang: "hcl"
    filename: "hth-okta-4.02-disable-session-persistence.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-4.02-disable-session-persistence.tf"
    excerpts:
      terraform:
        content: |
            # Global signon policy that disables persistent sessions
            # Prevents session cookies from surviving browser restarts
            resource "okta_policy_signon" "disable_session_persistence" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name        = "Disable Session Persistence"
            status      = "ACTIVE"
            description = "Disables Remember Me and persistent session cookies to reduce session hijacking risk"
            priority    = 2
            }
          
            # Rule enforcing non-persistent sessions with strict timeouts
            resource "okta_policy_rule_signon" "no_persistent_sessions" {
            count = var.profile_level >= 2 ? 1 : 0
          
            policy_id          = okta_policy_signon.disable_session_persistence[0].id
            name               = "No Persistent Sessions"
            status             = "ACTIVE"
            priority           = 1
            access             = "ALLOW"
            mfa_required       = true
            mfa_prompt         = "SESSION"
            session_lifetime   = 480
            session_idle       = 30
            session_persistent = false
            }
  api:
    lang: "bash"
    filename: "hth-okta-4.02-disable-session-persistence.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-4.02-disable-session-persistence.sh"
    excerpts:
      api-check-session-persistence:
        content: |
            POLICIES=$(okta_get "/api/v1/policies?type=OKTA_SIGN_ON") || {
            fail "4.2 Failed to retrieve global session policies"
            increment_failed
            summary
            exit 0
            }
          
            persistent_found=false
          
            for POLICY_ID in $(echo "${POLICIES}" | jq -r '.[].id' 2>/dev/null); do
            RULES=$(okta_get "/api/v1/policies/${POLICY_ID}/rules" 2>/dev/null || echo "[]")
            PERSISTENT=$(echo "${RULES}" | jq '[.[] | select(.actions.signon.session.usePersistentCookie == true)] | length' 2>/dev/null || echo "0")
          
            if [ "${PERSISTENT}" -gt 0 ]; then
              persistent_found=true
              POLICY_NAME=$(echo "${POLICIES}" | jq -r ".[] | select(.id == \"${POLICY_ID}\") | .name" 2>/dev/null || echo "unknown")
              warn "4.2 Found ${PERSISTENT} rule(s) with persistent sessions in policy '${POLICY_NAME}' (${POLICY_ID})"
            fi
            done

"4.3":
  api:
    lang: "bash"
    filename: "hth-okta-4.03-admin-session-security.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-4.03-admin-session-security.sh"
    excerpts:
      api-update-admin-sessions:
        content: |
            info "4.3 Updating admin session binding settings..."
            okta_put "/api/v1/org/settings" "{
            \"adminSessionASNBinding\": \"${asn_target}\",
            \"adminSessionIPBinding\": \"${ip_target}\"
            }" > /dev/null 2>&1 && {
            pass "4.3 Admin session security updated (ASN: ${asn_target}, IP: ${ip_target})"
            increment_applied
            } || {
            fail "4.3 Failed to update admin session settings"
            increment_failed
            }
  cli:
    lang: "text"
    filename: "hth-okta-4.03-admin-session-security.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-4.03-admin-session-security.txt"
    excerpts:
      cli-log-query-session-binding:
        content: |
            eventType eq "user.session.invalidate" AND debugContext.debugData.reason eq "ADMIN_SESSION_BINDING"
      cli-log-query-protected-actions:
        content: |
            eventType eq "system.protected_action.challenge" OR eventType eq "system.protected_action.success"
  sigma:
    - lang: "yaml"
      filename: "hth-okta-4.03-admin-session-security-b.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-4.03-admin-session-security-b.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'system.protected_action.challenge'
                        - 'system.protected_action.success'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - eventType
                - target.displayName
                - client.ipAddress
                - published
    - lang: "yaml"
      filename: "hth-okta-4.03-admin-session-security.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-4.03-admin-session-security.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'user.session.invalidate'
                filter_binding:
                    debugContext.debugData.reason: 'ADMIN_SESSION_BINDING'
                condition: selection and filter_binding
              fields:
                - actor.displayName
                - actor.alternateId
                - client.ipAddress
                - debugContext.debugData.reason
                - outcome.result
                - published

"5.1":
  api:
    lang: "bash"
    filename: "hth-okta-5.01-comprehensive-logging.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-5.01-comprehensive-logging.sh"
    excerpts:
      api-check-system-log:
        content: |
            # Verify System Log API is accessible and returning events
            info "5.1 Testing System Log API access..."
            LOG_RESPONSE=$(okta_get "/api/v1/logs?limit=1" 2>/dev/null || echo "[]")
            LOG_COUNT=$(echo "${LOG_RESPONSE}" | jq 'length' 2>/dev/null || echo "0")
      api-check-log-streams:
        content: |
            # Check for log streaming integrations
            info "5.1 Checking log streaming configuration..."
            LOG_STREAMS=$(okta_get "/api/v1/logStreams" 2>/dev/null || echo "[]")
            STREAM_COUNT=$(echo "${LOG_STREAMS}" | jq 'length' 2>/dev/null || echo "0")
  db:
    lang: "sql"
    filename: "hth-okta-5.01-comprehensive-logging.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/db/hth-okta-5.01-comprehensive-logging.sql"
    excerpts:
      db-siem-impossible-travel:
        content: |
            -- Detect impossible travel
            SELECT user, sourceIp, geo_country, timestamp
            FROM okta_logs
            WHERE eventType = 'user.authentication.sso'
            AND geo_country_change_within_1hr = true
      db-siem-brute-force:
        content: |
            -- Detect brute force
            SELECT user, count(*) as attempts
            FROM okta_logs
            WHERE eventType = 'user.authentication.failed'
            AND timestamp > now() - interval '5 minutes'
            GROUP BY user
            HAVING count(*) > 10
      db-siem-admin-role-changes:
        content: |
            -- Detect admin role changes
            SELECT actor, target, eventType, timestamp
            FROM okta_logs
            WHERE eventType LIKE 'system.role%'
            OR eventType LIKE 'group.user_membership%admin%'
  sigma:
    - lang: "yaml"
      filename: "hth-okta-5.01-comprehensive-logging-b.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-5.01-comprehensive-logging-b.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'user.session.start'
                    outcome.result: 'FAILURE'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - client.ipAddress
                - outcome.result
                - outcome.reason
                - published
    - lang: "yaml"
      filename: "hth-okta-5.01-comprehensive-logging-c.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-5.01-comprehensive-logging-c.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'user.authentication.sso'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - client.ipAddress
                - client.geographicalContext.country
                - client.geographicalContext.city
                - published
    - lang: "yaml"
      filename: "hth-okta-5.01-comprehensive-logging.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-5.01-comprehensive-logging.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType|startswith: 'system.role'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - target.displayName
                - eventType
                - client.ipAddress
                - published

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-okta-5.02-configure-threatinsight.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-5.02-configure-threatinsight.tf"
    excerpts:
      terraform:
        content: |
            # Enable ThreatInsight in block mode
            resource "okta_threat_policy" "threatinsight" {
            action = "block"
            }
  api:
    lang: "bash"
    filename: "hth-okta-5.02-configure-threatinsight.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-5.02-configure-threatinsight.sh"
    excerpts:
      api-create-threatinsight:
        content: |
            # Enable ThreatInsight with block action
            info "5.2 Setting ThreatInsight to block mode..."
            okta_post "/api/v1/threats/configuration" '{
            "action": "block"
            }' > /dev/null 2>&1 && {
            pass "5.2 ThreatInsight set to block mode"
            increment_applied
            summary
            exit 0
            } || true
      api-update-threatinsight:
        content: |
            # Try PUT instead (API may vary by Okta version)
            okta_put "/api/v1/threats/configuration" '{
            "action": "block"
            }' > /dev/null 2>&1 && {
            pass "5.2 ThreatInsight set to block mode"
            increment_applied
            } || {
            warn "5.2 Failed to configure ThreatInsight -- may require Adaptive MFA license"
            warn "5.2 Configure manually: Security > General > ThreatInsight > Block"
            increment_skipped
            }

"5.3":
  cli:
    lang: "text"
    filename: "hth-okta-5.03-enable-identity-threat-protection.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-5.03-enable-identity-threat-protection.txt"
    excerpts:
      cli-log-query-itp-threats:
        content: |
            eventType eq "security.threat.detected" OR eventType eq "security.session.risk_change"
  db:
    lang: "sql"
    filename: "hth-okta-5.03-enable-identity-threat-protection.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/db/hth-okta-5.03-enable-identity-threat-protection.sql"
    excerpts:
      db-siem-itp-high-risk:
        content: |
            SELECT actor.displayName, client.ipAddress, outcome.result,
                 debugContext.debugData.riskLevel, debugContext.debugData.riskReasons
            FROM okta_system_log
            WHERE eventType = 'security.threat.detected'
            AND debugContext.debugData.riskLevel IN ('HIGH', 'CRITICAL')
            ORDER BY published DESC
  sigma:
    - lang: "yaml"
      filename: "hth-okta-5.03-enable-identity-threat-protection.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-5.03-enable-identity-threat-protection.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection_event:
                    eventType:
                        - 'security.threat.detected'
                        - 'security.session.risk_change'
                selection_risk:
                    debugContext.debugData.riskLevel:
                        - 'HIGH'
                        - 'CRITICAL'
                condition: selection_event and selection_risk
              fields:
                - actor.displayName
                - client.ipAddress
                - outcome.result
                - debugContext.debugData.riskLevel
                - debugContext.debugData.riskReasons
                - published

"5.4":
  terraform:
    lang: "hcl"
    filename: "hth-okta-5.04-behavior-detection.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/terraform/hth-okta-5.04-behavior-detection.tf"
    excerpts:
      terraform:
        content: |
            # Behavior detection rule for new location sign-on
            resource "okta_behaviour" "new_location" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name                      = "New Location Sign-On"
            type                      = "ANOMALOUS_LOCATION"
            status                    = "ACTIVE"
            number_of_authentications  = 3
            location_granularity_type  = "CITY"
            }
          
            # Behavior detection rule for new device
            resource "okta_behaviour" "new_device" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name                      = "New Device Sign-On"
            type                      = "ANOMALOUS_DEVICE"
            status                    = "ACTIVE"
            number_of_authentications  = 3
            }
  api:
    lang: "bash"
    filename: "hth-okta-5.04-behavior-detection.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-5.04-behavior-detection.sh"
    excerpts:
      api-list-behaviors:
        content: |
            # List all configured behavior detection rules
            info "5.4 Listing current behavior detection rules..."
            BEHAVIORS=$(okta_get "/api/v1/behaviors" 2>/dev/null || echo "[]")
            BEHAVIOR_COUNT=$(echo "${BEHAVIORS}" | jq 'length' 2>/dev/null || echo "0")
      api-create-behavior-rule:
        content: |
            info "5.4 Creating new country detection rule..."
            okta_post "/api/v1/behaviors" '{
              "name": "New Country Detection",
              "type": "ANOMALOUS_LOCATION",
              "status": "ACTIVE",
              "settings": {
                "maxEventsUsedForEvaluation": 50
              }
            }' > /dev/null 2>&1 && {
              pass "5.4 New Country Detection behavior rule created"
            } || {
              warn "5.4 Failed to create behavior rule (may already exist with different name)"
            }
  cli:
    lang: "text"
    filename: "hth-okta-5.04-behavior-detection.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-5.04-behavior-detection.txt"
    excerpts:
      cli-log-query-behavior-detection:
        content: |
            eventType eq "security.behavior_detection.triggered"
  sigma:
    - lang: "yaml"
      filename: "hth-okta-5.04-behavior-detection.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-5.04-behavior-detection.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'security.behavior_detection.triggered'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - client.ipAddress
                - client.geographicalContext.city
                - client.geographicalContext.country
                - debugContext.debugData.behaviors
                - outcome.result
                - published

"5.5":
  api:
    lang: "bash"
    filename: "hth-okta-5.05-cross-tenant-impersonation.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-5.05-cross-tenant-impersonation.sh"
    excerpts:
      api-list-identity-providers:
        content: |
            # Audit all configured identity providers
            info "5.5 Listing all configured identity providers..."
            IDPS=$(okta_get "/api/v1/idps" 2>/dev/null || echo "[]")
            IDP_COUNT=$(echo "${IDPS}" | jq 'length' 2>/dev/null || echo "0")
      api-check-idp-discovery:
        content: |
            # Audit IDP discovery (routing) policies
            info "5.5 Auditing IDP discovery (routing) policies..."
            IDP_POLICIES=$(okta_get "/api/v1/policies?type=IDP_DISCOVERY" 2>/dev/null || echo "[]")
            IDP_POLICY_COUNT=$(echo "${IDP_POLICIES}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${IDP_POLICY_COUNT}" -gt 0 ]; then
            info "5.5 Found ${IDP_POLICY_COUNT} IDP discovery policy/policies:"
            echo "${IDP_POLICIES}" | jq -r '.[] | "  - \(.name) (status: \(.status), lastUpdated: \(.lastUpdated))"' 2>/dev/null || true
          
            # Get rules for each IDP discovery policy
            for POLICY_ID in $(echo "${IDP_POLICIES}" | jq -r '.[].id' 2>/dev/null); do
              info "5.5 Routing rules for policy ${POLICY_ID}:"
              okta_get "/api/v1/policies/${POLICY_ID}/rules" 2>/dev/null \
                | jq -r '.[] | "    - Rule: \(.name)"' 2>/dev/null || true
            done
            fi
      api-check-idp-events:
        content: |
            # Search system log for recent IdP lifecycle events (last 7 days)
            info "5.5 Checking for recent IdP lifecycle events (last 7 days)..."
            SINCE=$(date -d '7 days ago' -u +%Y-%m-%dT%H:%M:%S.000Z 2>/dev/null \
            || date -v-7d -u +%Y-%m-%dT%H:%M:%S.000Z 2>/dev/null || echo "")
          
            if [ -n "${SINCE}" ]; then
            IDP_EVENTS=$(okta_get "/api/v1/logs?filter=eventType+sw+%22system.idp.lifecycle%22&since=${SINCE}" 2>/dev/null || echo "[]")
            EVENT_COUNT=$(echo "${IDP_EVENTS}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${EVENT_COUNT}" -gt 0 ]; then
              warn "5.5 Found ${EVENT_COUNT} IdP lifecycle event(s) in the last 7 days -- INVESTIGATE IMMEDIATELY"
              echo "${IDP_EVENTS}" | jq -r '.[] | "  - \(.eventType): \(.actor.displayName) -> \(.target[0].displayName // "unknown") at \(.published)"' 2>/dev/null || true
            else
              pass "5.5 No IdP lifecycle events in the last 7 days"
            fi
            else
            warn "5.5 Unable to compute date range -- skipping log check"
            fi
  db:
    lang: "sql"
    filename: "hth-okta-5.05-cross-tenant-impersonation.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/db/hth-okta-5.05-cross-tenant-impersonation.sql"
    excerpts:
      db-siem-idp-created:
        content: |
            -- Alert: New Identity Provider Created (CRITICAL)
            SELECT actor.displayName, actor.alternateId, target[0].displayName,
                 target[0].type, client.ipAddress, published
            FROM okta_system_log
            WHERE eventType IN (
            'system.idp.lifecycle.create',
            'system.idp.lifecycle.activate'
            )
      db-siem-routing-rule-modified:
        content: |
            -- Alert: Routing Rule Modified (HIGH)
            SELECT actor.displayName, target[0].displayName, published
            FROM okta_system_log
            WHERE eventType IN ('policy.lifecycle.create', 'policy.lifecycle.update')
            AND debugContext.debugData.policyType = 'IDP_DISCOVERY'
  sigma:
    - lang: "yaml"
      filename: "hth-okta-5.05-cross-tenant-impersonation-b.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-5.05-cross-tenant-impersonation-b.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'policy.lifecycle.create'
                        - 'policy.lifecycle.update'
                filter_policy_type:
                    debugContext.debugData.policyType: 'IDP_DISCOVERY'
                condition: selection and filter_policy_type
              fields:
                - actor.displayName
                - target.displayName
                - client.ipAddress
                - published
    - lang: "yaml"
      filename: "hth-okta-5.05-cross-tenant-impersonation.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-5.05-cross-tenant-impersonation.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'system.idp.lifecycle.create'
                        - 'system.idp.lifecycle.activate'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - target.displayName
                - target.type
                - client.ipAddress
                - published

"6.1":
  api:
    lang: "bash"
    filename: "hth-okta-6.01-integration-risk-assessment.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-6.01-integration-risk-assessment.sh"
    excerpts:
      api-list-active-apps:
        content: |
            info "6.1 Fetching active applications..."
            ACTIVE_APPS=$(okta_get "/api/v1/apps?filter=status%20eq%20%22ACTIVE%22&limit=200" 2>/dev/null || echo "[]")
            TOTAL_APPS=$(echo "${ACTIVE_APPS}" | jq 'length' 2>/dev/null || echo "0")

"6.2":
  api:
    lang: "bash"
    filename: "hth-okta-6.02-common-integrations-controls.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-6.02-common-integrations-controls.sh"
    excerpts:
      api-list-oauth-apps:
        content: |
            info "6.2 Fetching active OAuth/OIDC applications..."
            ACTIVE_APPS=$(okta_get "/api/v1/apps?filter=status%20eq%20%22ACTIVE%22&limit=200" 2>/dev/null || echo "[]")
            OAUTH_APPS=$(echo "${ACTIVE_APPS}" | jq '[.[] | select(.signOnMode == "OPENID_CONNECT" or .signOnMode == "OAUTH_2_0")]' 2>/dev/null || echo "[]")
            OAUTH_COUNT=$(echo "${OAUTH_APPS}" | jq 'length' 2>/dev/null || echo "0")
      api-check-app-grants:
        content: |
            # Fetch grants for this application
            GRANTS=$(okta_get "/api/v1/apps/${APP_ID}/grants" 2>/dev/null || echo "[]")
            GRANT_COUNT=$(echo "${GRANTS}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${GRANT_COUNT}" -eq 0 ]; then
              info "6.2   ${APP_LABEL}: no explicit scope grants"
              continue
            fi
          
            # Extract all granted scope IDs
            SCOPE_LIST=$(echo "${GRANTS}" | jq -r '.[].scopeId // empty' 2>/dev/null || true)
      api-list-auth-server-clients:
        content: |
            # Check default authorization server
            AUTH_CLIENTS=$(okta_get "/api/v1/authorizationServers/default/clients" 2>/dev/null || echo "[]")
            DEFAULT_CLIENT_COUNT=$(echo "${AUTH_CLIENTS}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${DEFAULT_CLIENT_COUNT}" -gt 0 ]; then
            info "6.2 Default auth server has ${DEFAULT_CLIENT_COUNT} registered client(s):"
            echo "${AUTH_CLIENTS}" | jq -r \
              '.[] | "  - \(.client_name // "unnamed") (ID: \(.client_id))"' \
              2>/dev/null || true
            else
            info "6.2 No clients registered on default authorization server"
            fi
      api-list-auth-servers:
        content: |
            # List all custom authorization servers
            AUTH_SERVERS=$(okta_get "/api/v1/authorizationServers" 2>/dev/null || echo "[]")
            CUSTOM_SERVERS=$(echo "${AUTH_SERVERS}" | jq '[.[] | select(.name != "default")]' 2>/dev/null || echo "[]")
            CUSTOM_COUNT=$(echo "${CUSTOM_SERVERS}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${CUSTOM_COUNT}" -gt 0 ]; then
            info "6.2 Found ${CUSTOM_COUNT} custom authorization server(s):"
            echo "${CUSTOM_SERVERS}" | jq -r \
              '.[] | "  - \(.name) (ID: \(.id), audiences: \(.audiences // [] | join(", ")))"' \
              2>/dev/null || true
            fi

"7.1":
  cli:
    lang: "bash"
    filename: "hth-okta-7.01-sanitize-har-files.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-7.01-sanitize-har-files.sh"
    excerpts:
      cli-har-sanitize-script:
        content: |
            # har-sanitize.sh - Strip sensitive headers from HAR files
            # Usage: ./har-sanitize.sh input.har > sanitized.har
          
            INPUT_FILE="$1"
            if [ -z "$INPUT_FILE" ]; then
            echo "Usage: $0 <input.har>"
            exit 1
            fi
          
            jq '
            .log.entries[].request.headers |= map(
              if (.name | test("^(Cookie|Authorization|X-CSRF-Token|X-Okta-Session)$"; "i"))
              then .value = "[REDACTED]"
              else .
              end
            ) |
            .log.entries[].response.headers |= map(
              if (.name | test("^(Set-Cookie)$"; "i"))
              then .value = "[REDACTED]"
              else .
              end
            ) |
            .log.entries[].request.cookies |= map(.value = "[REDACTED]") |
            .log.entries[].response.cookies |= map(.value = "[REDACTED]")
            ' "$INPUT_FILE"

"7.3":
  api:
    lang: "bash"
    filename: "hth-okta-7.03-access-reviews.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-7.03-access-reviews.sh"
    excerpts:
      api-list-active-users:
        content: |
            info "7.3 Finding inactive users (no login in 90+ days)..."
            ACTIVE_USERS=$(okta_get "/api/v1/users?filter=status+eq+%22ACTIVE%22&limit=200" 2>/dev/null || echo "[]")
            TOTAL_ACTIVE=$(echo "${ACTIVE_USERS}" | jq 'length' 2>/dev/null || echo "0")
      api-check-super-admins:
        content: |
            # Try the IAM assignees endpoint first
            SUPER_ADMIN_COUNT=$(okta_get "/api/v1/iam/assignees/users?roleType=SUPER_ADMIN" 2>/dev/null \
            | jq 'length' 2>/dev/null || echo "unknown")
          
            if [ "${SUPER_ADMIN_COUNT}" != "unknown" ] && [ "${SUPER_ADMIN_COUNT}" -ge 0 ] 2>/dev/null; then
            if [ "${SUPER_ADMIN_COUNT}" -gt 5 ]; then
              warn "7.3 Super Admin count: ${SUPER_ADMIN_COUNT} (should be fewer than 5)"
            else
              pass "7.3 Super Admin count: ${SUPER_ADMIN_COUNT} (within recommended limit of < 5)"
            fi
            else
            warn "7.3 Unable to count Super Admin assignments via IAM API"
          
            # Fallback: enumerate users and check roles individually
            info "7.3 Attempting fallback Super Admin enumeration (checking first 50 users)..."
            super_count=0
            for USER_ID in $(echo "${ACTIVE_USERS}" | jq -r '.[].id' 2>/dev/null | head -50); do
              ROLES=$(okta_get "/api/v1/users/${USER_ID}/roles" 2>/dev/null || echo "[]")
              IS_SUPER=$(echo "${ROLES}" | jq '[.[] | select(.type == "SUPER_ADMIN")] | length' 2>/dev/null || echo "0")
              if [ "${IS_SUPER}" -gt 0 ]; then
                USER_LOGIN=$(echo "${ACTIVE_USERS}" | jq -r ".[] | select(.id == \"${USER_ID}\") | .profile.login" 2>/dev/null || echo "unknown")
                warn "7.3   Super Admin: ${USER_LOGIN}"
                super_count=$((super_count + 1))
              fi
            done
          
            SUPER_ADMIN_COUNT="${super_count}"
            if [ "${super_count}" -gt 5 ]; then
              warn "7.3 Found ${super_count} Super Admin(s) in first 50 users (should be < 5)"
            else
              pass "7.3 Found ${super_count} Super Admin(s) in first 50 users"
            fi
            fi
      api-list-admin-roles:
        content: |
            info "7.3 Listing admin role assignments..."
            ADMIN_ROLES=$(okta_get "/api/v1/iam/assignees/users" 2>/dev/null || echo "[]")
            ADMIN_COUNT=$(echo "${ADMIN_ROLES}" | jq 'length' 2>/dev/null || echo "0")
          
            if [ "${ADMIN_COUNT}" -gt 0 ]; then
            info "7.3 Found ${ADMIN_COUNT} admin role assignment(s)"
            echo "${ADMIN_ROLES}" | jq -r \
              '.[] | "  - User: \(.userId), Role: \(.role // .type // "unknown")"' \
              2>/dev/null || true
            fi

"7.4":
  cli:
    lang: "text"
    filename: "hth-okta-7.04-implement-change-management.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-7.04-implement-change-management.txt"
    excerpts:
      cli-terraform-plan-apply:
        content: |
            # Use okta/okta Terraform provider to manage config as code
            terraform plan -out=okta-changes.plan
            terraform apply okta-changes.plan
  sigma:
    - lang: "yaml"
      filename: "hth-okta-7.04-implement-change-management-b.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-7.04-implement-change-management-b.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'application.lifecycle.create'
                        - 'application.lifecycle.update'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - eventType
                - target.displayName
                - client.ipAddress
                - published
    - lang: "yaml"
      filename: "hth-okta-7.04-implement-change-management-c.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-7.04-implement-change-management-c.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'group.user_membership.add'
                        - 'group.user_membership.remove'
                condition: selection
              fields:
                - actor.displayName
                - eventType
                - target.displayName
                - client.ipAddress
                - published
    - lang: "yaml"
      filename: "hth-okta-7.04-implement-change-management-d.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-7.04-implement-change-management-d.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'zone.lifecycle.create'
                        - 'zone.lifecycle.update'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - eventType
                - target.displayName
                - client.ipAddress
                - published
    - lang: "yaml"
      filename: "hth-okta-7.04-implement-change-management-e.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-7.04-implement-change-management-e.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType:
                        - 'policy.lifecycle.create'
                        - 'policy.lifecycle.update'
                        - 'policy.lifecycle.delete'
                        - 'policy.rule.create'
                        - 'policy.rule.update'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - eventType
                - target.displayName
                - client.ipAddress
                - published
    - lang: "yaml"
      filename: "hth-okta-7.04-implement-change-management.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/siem/sigma/hth-okta-7.04-implement-change-management.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    eventType: 'system.role.create'
                condition: selection
              fields:
                - actor.displayName
                - actor.alternateId
                - eventType
                - target.displayName
                - client.ipAddress
                - published

"7.5":
  api:
    lang: "bash"
    filename: "hth-okta-7.05-identity-incident-response.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/api/hth-okta-7.05-identity-incident-response.sh"
    excerpts:
      api-ir-suspend-admin:
        content: |
            curl -X POST "https://${OKTA_DOMAIN}/api/v1/users/${USER_ID}/lifecycle/suspend" \
            -H "Authorization: SSWS ${OKTA_API_TOKEN}"
      api-ir-revoke-sessions:
        content: |
            curl -X DELETE "https://${OKTA_DOMAIN}/api/v1/users/${USER_ID}/sessions" \
            -H "Authorization: SSWS ${OKTA_API_TOKEN}"
      api-ir-audit-changes:
        content: |
            curl -s -X GET "https://${OKTA_DOMAIN}/api/v1/logs?filter=actor.id+eq+%22${USER_ID}%22&since=${INCIDENT_START}" \
            -H "Authorization: SSWS ${OKTA_API_TOKEN}" | jq '.[] | {eventType, target, published}'
      api-ir-deactivate-idp:
        content: |
            curl -X POST "https://${OKTA_DOMAIN}/api/v1/idps/${IDP_ID}/lifecycle/deactivate" \
            -H "Authorization: SSWS ${OKTA_API_TOKEN}"
      api-ir-delete-factor:
        content: |
            curl -X DELETE "https://${OKTA_DOMAIN}/api/v1/users/${USER_ID}/factors/${FACTOR_ID}" \
            -H "Authorization: SSWS ${OKTA_API_TOKEN}"

"8.5":
  cli:
    lang: "text"
    filename: "hth-okta-8.05-dod-warning-banner.txt"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/okta/cli/hth-okta-8.05-dod-warning-banner.txt"
    excerpts:
      cli-dod-banner-text:
        content: |
            You are accessing a U.S. Government (USG) Information System (IS) that is provided for USG-authorized use only.
          
            By using this IS (which includes any device attached to this IS), you consent to the following conditions:
          
            -The USG routinely intercepts and monitors communications on this IS for purposes including, but not limited to, penetration testing, COMSEC monitoring, network operations and defense, personnel misconduct (PM), law enforcement (LE), and counterintelligence (CI) investigations.
          
            -At any time, the USG may inspect and seize data stored on this IS.
          
            -Communications using, or data stored on, this IS are not private, are subject to routine monitoring, interception, and search, and may be disclosed or used for any USG-authorized purpose.
          
            -This IS includes security measures (e.g., authentication and access controls) to protect USG interests--not for your personal benefit or privacy.
          
            -Notwithstanding the above, using this IS does not constitute consent to PM, LE or CI investigative searching or monitoring of the content of privileged communications, or work product, related to personal representation or services by attorneys, psychotherapists, or clergy, and their assistants. Such communications and work product are private and confidential. See User Agreement for details.

