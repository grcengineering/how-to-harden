# AUTO-GENERATED by scripts/sync-packs-to-data.sh — do not edit manually
# Generated: 2026-02-21T17:31:53Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-1.01-enforce-mfa.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-1.01-enforce-mfa.tf"
    excerpts:
      terraform:
        content: |
            # Retrieve all users to audit 2SV enrollment status.
            # The googleworkspace provider does not expose a direct 2SV enforcement toggle;
            # enforcement is configured via Admin Console or GAM.  This data source lets
            # Terraform surface enrollment gaps so you can detect non-compliant users.
          
            data "googleworkspace_users" "all" {
            filter = "isEnrolledIn2Sv=false"
            }
          
            # Create a dedicated OU for users who must complete 2SV enrollment.
            # Moving users into this OU lets you apply stricter policies (e.g., security-
            # key-only) via Admin Console while tracking the OU in Terraform state.
            resource "googleworkspace_org_unit" "mfa_enforcement" {
            name                 = "MFA Enforcement"
            description          = "HTH 1.1 -- Users in this OU are subject to 2SV enforcement policies"
            parent_org_unit_path = var.target_org_unit_path
            }
          
            # Create an OU for Super Admins who require security-key-only 2SV (L3).
            resource "googleworkspace_org_unit" "super_admin_mfa" {
            count = var.profile_level >= 3 ? 1 : 0
          
            name                 = "Super Admins - Security Key Only"
            description          = "HTH 1.1 L3 -- Super Admins restricted to hardware security keys"
            parent_org_unit_path = var.target_org_unit_path
            }
          
            # Group for tracking users who have NOT enrolled in 2SV.
            # Membership is managed outside Terraform (via GAM or Admin SDK scripts) but
            # having the group in state ensures it exists and can be referenced by alerts.
            resource "googleworkspace_group" "mfa_not_enrolled" {
            email       = "mfa-not-enrolled@${var.primary_domain}"
            name        = "MFA Not Enrolled"
            description = "HTH 1.1 -- Users who have not yet enrolled in 2-Step Verification. Auto-populated by audit scripts."
            }
  cli:
    lang: "bash"
    filename: "hth-google-workspace-1.01-check-2sv-enrollment.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/cli/hth-google-workspace-1.01-check-2sv-enrollment.sh"
    excerpts:
      cli-check-2sv:
        content: |
            # List users not enrolled in 2SV
            gam print users query "isEnrolledIn2Sv=false"
          
            # Generate report of 2SV status
            gam report users parameters accounts:is_2sv_enrolled,accounts:is_2sv_enforced
          
            # Send reminder to users not enrolled
            gam print users query "isEnrolledIn2Sv=false" | \
            gam csv - gam user ~primaryEmail sendemail subject "MFA Enrollment Required" \
            message "Please enroll in 2-Step Verification within 7 days."
      cli-investigation-tool-2sv:
        content: |
            # Admin Console monitoring query for users without 2SV
            # Navigate to: Security → Investigation Tool
            # Event: Login
            # Filter: 2SV method = None, Login result = Success
  sdk:
    lang: "python"
    filename: "hth-google-workspace-1.01-check-2sv-enrollment.py"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/sdk/hth-google-workspace-1.01-check-2sv-enrollment.py"
    excerpts:
      sdk-check-2sv:
        content: |
            # Enable 2SV enforcement via Admin SDK
            from googleapiclient.discovery import build
            from google.oauth2 import service_account
          
            SCOPES = ['https://www.googleapis.com/auth/admin.directory.user']
            SERVICE_ACCOUNT_FILE = 'service-account.json'
          
            credentials = service_account.Credentials.from_service_account_file(
              SERVICE_ACCOUNT_FILE, scopes=SCOPES)
            credentials = credentials.with_subject('admin@yourdomain.com')
          
            service = build('admin', 'directory_v1', credentials=credentials)
          
            # Check 2SV enrollment status for users
            results = service.users().list(
              customer='my_customer',
              maxResults=100,
              orderBy='email',
              projection='full'
            ).execute()
          
            users = results.get('users', [])
            for user in users:
              email = user['primaryEmail']
              is_enrolled = user.get('isEnrolledIn2Sv', False)
              is_enforced = user.get('isEnforcedIn2Sv', False)
              print(f"{email}: Enrolled={is_enrolled}, Enforced={is_enforced}")

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-1.02-restrict-super-admin.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-1.02-restrict-super-admin.tf"
    excerpts:
      terraform:
        content: |
            # Create delegated admin roles following the principle of least privilege.
            # Super Admin accounts should be limited to 2-4; day-to-day admin tasks
            # should use these scoped roles instead.
          
            resource "googleworkspace_role" "user_admin" {
            name        = "HTH User Administrator"
            description = "HTH 1.2 -- Delegated role for user management (password resets, profile updates)"
          
            privileges {
              service_id = "00haapch16h1ysv"  # Admin SDK - Users
              privilege  = "USERS_RETRIEVE"
            }
            privileges {
              service_id = "00haapch16h1ysv"
              privilege  = "USERS_UPDATE"
            }
            privileges {
              service_id = "00haapch16h1ysv"
              privilege  = "USERS_ALIAS"
            }
            }
          
            resource "googleworkspace_role" "groups_admin" {
            name        = "HTH Groups Administrator"
            description = "HTH 1.2 -- Delegated role for group management (create, update, membership)"
          
            privileges {
              service_id = "00haapch16h1ysv"
              privilege  = "GROUPS_RETRIEVE"
            }
            privileges {
              service_id = "00haapch16h1ysv"
              privilege  = "GROUPS_UPDATE"
            }
            }
          
            resource "googleworkspace_role" "help_desk_admin" {
            name        = "HTH Help Desk Administrator"
            description = "HTH 1.2 -- Delegated role for help desk (password resets, view user info)"
          
            privileges {
              service_id = "00haapch16h1ysv"
              privilege  = "USERS_RETRIEVE"
            }
            privileges {
              service_id = "00haapch16h1ysv"
              privilege  = "USERS_UPDATE"
            }
            }
          
            # Create custom delegated roles from variable input
            resource "googleworkspace_role" "custom" {
            for_each = var.delegated_admin_roles
          
            name        = each.key
            description = each.value.description
          
            dynamic "privileges" {
              for_each = each.value.privileges
              content {
                service_id = privileges.value.service_id
                privilege  = privileges.value.privilege
              }
            }
            }
          
            # Create an OU for Super Admin accounts so security-key-only 2SV
            # can be applied at the OU level via Admin Console.
            resource "googleworkspace_org_unit" "super_admins" {
            name                 = "Super Admins"
            description          = "HTH 1.2 -- Dedicated OU for Super Admin accounts with security-key-only 2SV"
            parent_org_unit_path = var.target_org_unit_path
            }
          
            # Group for auditing Super Admin role holders.
            # Membership should be manually managed and kept to 2-4 accounts.
            resource "googleworkspace_group" "super_admin_audit" {
            email       = "super-admin-audit@${var.primary_domain}"
            name        = "Super Admin Audit"
            description = "HTH 1.2 -- Tracks Super Admin role holders. Should contain 2-4 members maximum."
            }
  cli:
    lang: "bash"
    filename: "hth-google-workspace-1.02-manage-admin-roles.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/cli/hth-google-workspace-1.02-manage-admin-roles.sh"
    excerpts:
      cli-manage-admin-roles:
        content: |
            # List all Super Admins
            gam print admins role "Super Admin"
          
            # Create delegated admin role
            gam create adminrole "Help Desk Admin" privileges \
            USERS_RETRIEVE,USERS_UPDATE,USERS_ALIAS
          
            # Assign delegated role
            gam create admin user helpdesk@domain.com role "Help Desk Admin"
          
            # Remove Super Admin from non-essential users
            gam delete admin user bob@domain.com role "Super Admin"

"1.3":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-1.03-configure-context-aware-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-1.03-configure-context-aware-access.tf"
    excerpts:
      terraform:
        content: |
            # Context-Aware Access requires Google Workspace Enterprise Standard/Plus
            # and uses Access Context Manager (part of BeyondCorp Enterprise).
          
            # Access policy -- one per organization.  If you already have an access
            # policy, import it rather than creating a new one.
            resource "google_access_context_manager_access_policy" "workspace" {
            count = var.profile_level >= 2 && var.organization_id != "" ? 1 : 0
          
            parent = "organizations/${var.organization_id}"
            title  = var.access_policy_name
            }
          
            # Access level: require managed device with Endpoint Verification,
            # disk encryption, and screen lock.
            resource "google_access_context_manager_access_level" "managed_device" {
            count = var.profile_level >= 2 && var.organization_id != "" ? 1 : 0
          
            parent = "accessPolicies/${google_access_context_manager_access_policy.workspace[0].name}"
            name   = "accessPolicies/${google_access_context_manager_access_policy.workspace[0].name}/accessLevels/hth_managed_device"
            title  = "HTH Managed Device"
          
            basic {
              conditions {
                device_policy {
                  require_screen_lock              = true
                  allowed_encryption_statuses      = ["ENCRYPTED"]
                  require_admin_approval           = false
                  require_corp_owned               = false
                  allowed_device_management_levels = ["BASIC", "COMPLETE"]
                }
              }
            }
            }
          
            # L3: Stricter access level requiring corporate-owned, fully managed devices
            resource "google_access_context_manager_access_level" "corp_device" {
            count = var.profile_level >= 3 && var.organization_id != "" ? 1 : 0
          
            parent = "accessPolicies/${google_access_context_manager_access_policy.workspace[0].name}"
            name   = "accessPolicies/${google_access_context_manager_access_policy.workspace[0].name}/accessLevels/hth_corp_device"
            title  = "HTH Corporate-Owned Device"
          
            basic {
              conditions {
                device_policy {
                  require_screen_lock              = true
                  allowed_encryption_statuses      = ["ENCRYPTED"]
                  require_admin_approval           = true
                  require_corp_owned               = true
                  allowed_device_management_levels = ["COMPLETE"]
                }
              }
            }
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-2.01-restrict-admin-ip-ranges.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-2.01-restrict-admin-ip-ranges.tf"
    excerpts:
      terraform:
        content: |
            # Restrict Admin Console access to known corporate IP ranges.
            # Uses Access Context Manager to create an IP-based access level that
            # can be applied to Admin Console and other sensitive applications.
          
            resource "google_access_context_manager_access_level" "admin_ip_allowlist" {
            count = var.profile_level >= 2 && length(var.admin_allowed_cidrs) > 0 && var.organization_id != "" ? 1 : 0
          
            parent = "accessPolicies/${google_access_context_manager_access_policy.workspace[0].name}"
            name   = "accessPolicies/${google_access_context_manager_access_policy.workspace[0].name}/accessLevels/hth_admin_ip_allowlist"
            title  = "HTH Admin Console IP Allowlist"
          
            basic {
              conditions {
                ip_subnetworks = var.admin_allowed_cidrs
              }
            }
            }
          
            # L3: Combine IP restriction with managed device requirement
            resource "google_access_context_manager_access_level" "admin_ip_and_device" {
            count = var.profile_level >= 3 && length(var.admin_allowed_cidrs) > 0 && var.organization_id != "" ? 1 : 0
          
            parent = "accessPolicies/${google_access_context_manager_access_policy.workspace[0].name}"
            name   = "accessPolicies/${google_access_context_manager_access_policy.workspace[0].name}/accessLevels/hth_admin_ip_and_device"
            title  = "HTH Admin Console IP + Device"
          
            basic {
              combining_function = "AND"
          
              conditions {
                ip_subnetworks = var.admin_allowed_cidrs
              }
          
              conditions {
                device_policy {
                  require_screen_lock              = true
                  allowed_encryption_statuses      = ["ENCRYPTED"]
                  require_corp_owned               = true
                  allowed_device_management_levels = ["COMPLETE"]
                }
              }
            }
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-3.01-enable-oauth-app-whitelisting.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-3.01-enable-oauth-app-whitelisting.tf"
    excerpts:
      terraform:
        content: |
            # The googleworkspace provider does not directly manage the OAuth app
            # allowlist/blocklist setting.  These resources create the organizational
            # infrastructure for OAuth governance:
            #
            # 1. A group to track approved apps and their owners
            # 2. An OU for users with restricted OAuth access
            # 3. Documentation of the manual Admin Console steps required
            #
            # Full API-level control requires GAM or the Admin SDK.
          
            # Group for OAuth app governance -- members are app owners/reviewers
            resource "googleworkspace_group" "oauth_reviewers" {
            email       = "oauth-app-reviewers@${var.primary_domain}"
            name        = "OAuth App Reviewers"
            description = "HTH 3.1 -- Members review and approve third-party OAuth app requests"
            }
          
            # Group to receive notifications about blocked OAuth app access attempts
            resource "googleworkspace_group" "oauth_blocked_alerts" {
            email       = "oauth-blocked-alerts@${var.primary_domain}"
            name        = "OAuth Blocked App Alerts"
            description = "HTH 3.1 -- Receives alerts when users attempt to authorize blocked OAuth apps"
            }
          
            # OU for users with strictly no third-party OAuth access (high-security users)
            resource "googleworkspace_org_unit" "oauth_restricted" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name                 = "OAuth Restricted Users"
            description          = "HTH 3.1 L2 -- Users in this OU cannot authorize any third-party OAuth apps"
            parent_org_unit_path = var.target_org_unit_path
            }
          
            # Retrieve the domain to verify it exists before creating domain-level resources
            data "googleworkspace_domain" "primary" {
            domain_name = var.primary_domain
            }
  cli:
    lang: "bash"
    filename: "hth-google-workspace-3.01-audit-oauth-apps.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/cli/hth-google-workspace-3.01-audit-oauth-apps.sh"
    excerpts:
      cli-audit-oauth:
        content: |
            # List all OAuth tokens in use
            gam all users print tokens
          
            # List apps with specific scopes
            gam all users print tokens scopes "https://mail.google.com/"
          
            # Revoke tokens for specific app
            gam all users deprovision token clientid 1234567890.apps.googleusercontent.com
          
            # Block unverified apps (via Admin SDK)
            # Note: Use Admin Console for comprehensive control
  sdk:
    lang: "python"
    filename: "hth-google-workspace-3.01-list-oauth-tokens.py"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/sdk/hth-google-workspace-3.01-list-oauth-tokens.py"
    excerpts:
      sdk-list-oauth-tokens:
        content: |
            # List OAuth tokens for a user
            from googleapiclient.discovery import build
          
            service = build('admin', 'directory_v1', credentials=credentials)
          
            tokens = service.tokens().list(userKey='user@domain.com').execute()
          
            for token in tokens.get('items', []):
              print(f"App: {token['displayText']}")
              print(f"Client ID: {token['clientId']}")
              print(f"Scopes: {token['scopes']}")
              print("---")

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-3.02-disable-less-secure-apps.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-3.02-disable-less-secure-apps.tf"
    excerpts:
      terraform:
        content: |
            # "Less Secure Apps" allow authentication with username/password only,
            # completely bypassing 2-Step Verification.  Google has deprecated this
            # feature but some legacy tenants may still have it enabled.
            #
            # The googleworkspace provider does not expose a direct toggle for the
            # organization-wide "Less Secure Apps" setting.  This control creates
            # the organizational structure to enforce the policy:
            #
            # 1. An OU for legacy app users who temporarily need access (with
            #    an expiration plan)
            # 2. A tracking group for audit and remediation
            #
            # Enforcement is done via:
            #   Admin Console > Security > Less secure apps > Disable access (Recommended)
            #
            # Or via GAM:
            #   gam ou / update less_secure_apps DISABLED
          
            # Tracking group for applications still requiring less-secure-app access.
            # This group should be empty -- any members represent technical debt.
            resource "googleworkspace_group" "legacy_app_tracking" {
            email       = "legacy-app-tracking@${var.primary_domain}"
            name        = "Legacy App Tracking"
            description = "HTH 3.2 -- Tracks applications requiring less-secure-app access. Target: zero members."
            }
          
            # Temporary OU for users who need transitional legacy app access.
            # Should be emptied and removed within 90 days.
            resource "googleworkspace_org_unit" "legacy_app_exception" {
            count = var.profile_level >= 1 ? 1 : 0
          
            name                 = "Legacy App Exceptions"
            description          = "HTH 3.2 -- Temporary OU for users needing legacy app access. Must be emptied within 90 days."
            parent_org_unit_path = var.target_org_unit_path
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-4.01-restrict-external-drive-sharing.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-4.01-restrict-external-drive-sharing.tf"
    excerpts:
      terraform:
        content: |
            # Restrict external sharing of Google Drive files.  The googleworkspace
            # provider does not directly manage Drive sharing settings (those are
            # configured in Admin Console > Apps > Drive and Docs > Sharing settings).
            #
            # This control creates the organizational infrastructure to support
            # sharing restrictions:
            #
            # 1. An OU for teams that need external collaboration (override at OU level)
            # 2. Groups for managing allowed external domains
            # 3. Audit tracking for files shared externally
          
            # OU for teams that require external Drive sharing (e.g., Sales, Partnerships)
            # These teams get slightly relaxed sharing settings while the rest of the
            # organization defaults to internal-only.
            resource "googleworkspace_org_unit" "external_sharing_allowed" {
            name                 = "External Sharing Allowed"
            description          = "HTH 4.1 -- Users in this OU may share Drive files with approved external domains"
            parent_org_unit_path = var.target_org_unit_path
            }
          
            # OU for highly sensitive teams with no external sharing whatsoever
            resource "googleworkspace_org_unit" "no_external_sharing" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name                 = "No External Sharing"
            description          = "HTH 4.1 L2 -- Users in this OU cannot share Drive files externally under any circumstances"
            parent_org_unit_path = var.target_org_unit_path
            }
          
            # Group for tracking external sharing exceptions and approvals
            resource "googleworkspace_group" "external_sharing_approvers" {
            email       = "external-sharing-approvers@${var.primary_domain}"
            name        = "External Sharing Approvers"
            description = "HTH 4.1 -- Members can approve external Drive sharing requests"
            }
          
            # Group for collecting external sharing audit notifications
            resource "googleworkspace_group" "external_sharing_audit" {
            email       = "external-sharing-audit@${var.primary_domain}"
            name        = "External Sharing Audit"
            description = "HTH 4.1 -- Receives notifications about external file sharing activity"
            }
  cli:
    lang: "bash"
    filename: "hth-google-workspace-4.01-audit-external-sharing.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/cli/hth-google-workspace-4.01-audit-external-sharing.sh"
    excerpts:
      cli-audit-sharing:
        content: |
            # Audit files shared externally
            gam all users print filelist query "visibility='anyoneWithLink' or visibility='anyoneCanFind'"
          
            # Find files shared with specific external domains
            gam all users print filelist query "sharedWithExternalUsers"
          
            # Generate sharing report
            gam report drive user all parameters doc_type,visibility,shared_with_user_accounts

"4.2":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-4.02-enable-dlp.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-4.02-enable-dlp.tf"
    excerpts:
      terraform:
        content: |
            # Google Workspace DLP uses the Cloud DLP API to detect sensitive data
            # in Drive, Chat, and other Workspace services.  DLP requires Google
            # Workspace Enterprise Standard or Plus.
            #
            # This creates a Cloud DLP inspect template with common PII detectors
            # and a job trigger for scheduled scanning.  The actual Workspace DLP
            # rules (block sharing, warn user) must be configured in:
            #   Admin Console > Security > Data protection > Manage Rules
          
            # DLP inspect template with common sensitive data detectors
            resource "google_data_loss_prevention_inspect_template" "workspace_pii" {
            count = var.profile_level >= 2 && var.gcp_project_id != "" ? 1 : 0
          
            parent       = "projects/${var.gcp_project_id}"
            display_name = "HTH Workspace PII Template"
            description  = "HTH 4.2 -- Detects PII (SSN, credit cards, email addresses) in Workspace content"
          
            inspect_config {
              info_types {
                name = "US_SOCIAL_SECURITY_NUMBER"
              }
              info_types {
                name = "CREDIT_CARD_NUMBER"
              }
              info_types {
                name = "EMAIL_ADDRESS"
              }
              info_types {
                name = "PHONE_NUMBER"
              }
              info_types {
                name = "US_PASSPORT"
              }
              info_types {
                name = "US_DRIVERS_LICENSE_NUMBER"
              }
          
              min_likelihood = "LIKELY"
          
              limits {
                max_findings_per_request = 100
              }
            }
            }
          
            # L3: Extended DLP template with financial and healthcare data types
            resource "google_data_loss_prevention_inspect_template" "workspace_regulated" {
            count = var.profile_level >= 3 && var.gcp_project_id != "" ? 1 : 0
          
            parent       = "projects/${var.gcp_project_id}"
            display_name = "HTH Workspace Regulated Data Template"
            description  = "HTH 4.2 L3 -- Detects regulated data (HIPAA, PCI) in Workspace content"
          
            inspect_config {
              info_types {
                name = "US_SOCIAL_SECURITY_NUMBER"
              }
              info_types {
                name = "CREDIT_CARD_NUMBER"
              }
              info_types {
                name = "CREDIT_CARD_TRACK_NUMBER"
              }
              info_types {
                name = "US_BANK_ROUTING_MICR"
              }
              info_types {
                name = "US_DEA_NUMBER"
              }
              info_types {
                name = "US_HEALTHCARE_NPI"
              }
              info_types {
                name = "IBAN_CODE"
              }
              info_types {
                name = "SWIFT_CODE"
              }
              info_types {
                name = "US_INDIVIDUAL_TAXPAYER_IDENTIFICATION_NUMBER"
              }
          
              min_likelihood = "POSSIBLE"
          
              limits {
                max_findings_per_request = 500
              }
            }
            }
          
            # Group for DLP incident notifications
            resource "googleworkspace_group" "dlp_incidents" {
            count = var.profile_level >= 2 ? 1 : 0
          
            email       = "dlp-incidents@${var.primary_domain}"
            name        = "DLP Incidents"
            description = "HTH 4.2 -- Receives notifications when DLP rules are triggered"
            }

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-google-workspace-5.01-enable-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/terraform/hth-google-workspace-5.01-enable-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # Google Workspace audit logs are enabled by default.  This control
            # ensures long-term retention via BigQuery export, creates alert
            # notification groups, and sets up the GCP infrastructure for log
            # analysis.
          
            # BigQuery dataset for long-term audit log retention
            resource "google_bigquery_dataset" "audit_logs" {
            count = var.gcp_project_id != "" ? 1 : 0
          
            dataset_id    = var.bigquery_dataset_id
            project       = var.gcp_project_id
            friendly_name = "Google Workspace Audit Logs"
            description   = "HTH 5.1 -- Long-term retention of Google Workspace audit logs"
            location      = "US"
          
            default_table_expiration_ms = var.log_retention_days * 24 * 60 * 60 * 1000
          
            labels = {
              purpose    = "security-audit"
              managed_by = "terraform"
              hth        = "5-01"
            }
            }
          
            # IAM binding to allow Workspace to write logs to BigQuery.
            # The Workspace service account must have BigQuery Data Editor access.
            resource "google_bigquery_dataset_iam_member" "workspace_writer" {
            count = var.gcp_project_id != "" ? 1 : 0
          
            dataset_id = google_bigquery_dataset.audit_logs[0].dataset_id
            project    = var.gcp_project_id
            role       = "roles/bigquery.dataEditor"
            member     = "serviceAccount:${var.service_account_email}"
            }
          
            # Group for security alert notifications
            resource "googleworkspace_group" "security_alerts" {
            email       = "security-alerts@${var.primary_domain}"
            name        = "Security Alerts"
            description = "HTH 5.1 -- Receives Google Workspace security alert notifications (suspicious login, gov attack, device compromise)"
            }
          
            # Group for admin audit notifications
            resource "googleworkspace_group" "admin_audit" {
            email       = "admin-audit@${var.primary_domain}"
            name        = "Admin Audit Notifications"
            description = "HTH 5.1 -- Receives notifications for admin actions (role changes, policy modifications)"
            }
          
            # L2: Create a dedicated service account for log analysis with read-only access
            resource "google_bigquery_dataset_iam_member" "analyst_reader" {
            count = var.profile_level >= 2 && var.gcp_project_id != "" ? 1 : 0
          
            dataset_id = google_bigquery_dataset.audit_logs[0].dataset_id
            project    = var.gcp_project_id
            role       = "roles/bigquery.dataViewer"
            member     = "group:security-alerts@${var.primary_domain}"
            }
          
            # L2: BigQuery view for failed login attempts (pre-built detection query)
            resource "google_bigquery_table" "failed_logins" {
            count = var.profile_level >= 2 && var.gcp_project_id != "" ? 1 : 0
          
            dataset_id = google_bigquery_dataset.audit_logs[0].dataset_id
            project    = var.gcp_project_id
            table_id   = "vw_failed_logins"
          
            view {
              query          = <<-SQL
                SELECT
                  actor.email,
                  COUNT(*) as failed_attempts,
                  ARRAY_AGG(DISTINCT ip_address IGNORE NULLS) as source_ips
                FROM `${var.gcp_project_id}.${var.bigquery_dataset_id}.login_logs`
                WHERE event_name = 'login_failure'
                  AND _PARTITIONTIME >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
                GROUP BY actor.email
                HAVING failed_attempts > 10
                ORDER BY failed_attempts DESC
              SQL
              use_legacy_sql = false
            }
          
            labels = {
              purpose    = "security-detection"
              managed_by = "terraform"
              hth        = "5-01"
            }
            }
          
            # L2: BigQuery view for external file sharing activity
            resource "google_bigquery_table" "external_sharing" {
            count = var.profile_level >= 2 && var.gcp_project_id != "" ? 1 : 0
          
            dataset_id = google_bigquery_dataset.audit_logs[0].dataset_id
            project    = var.gcp_project_id
            table_id   = "vw_external_sharing"
          
            view {
              query          = <<-SQL
                SELECT
                  actor.email,
                  doc_title,
                  target_user,
                  event_time
                FROM `${var.gcp_project_id}.${var.bigquery_dataset_id}.drive_logs`
                WHERE event_name = 'change_user_access'
                  AND target_user NOT LIKE '%@${var.primary_domain}'
                  AND _PARTITIONTIME >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 24 HOUR)
                ORDER BY event_time DESC
              SQL
              use_legacy_sql = false
            }
          
            labels = {
              purpose    = "security-detection"
              managed_by = "terraform"
              hth        = "5-01"
            }
            }
  cli:
    lang: "bash"
    filename: "hth-google-workspace-5.01-generate-audit-reports.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/cli/hth-google-workspace-5.01-generate-audit-reports.sh"
    excerpts:
      cli-audit-reports:
        content: |
            # Generate login report
            gam report login start -7d end today
          
            # Generate admin audit report
            gam report admin start -7d end today
          
            # Export Drive audit events
            gam report drive start -7d end today event download
          
            # Find suspicious logins
            gam report login filter "is_suspicious==True"
  db:
    lang: "sql"
    filename: "hth-google-workspace-5.01-bigquery-detection.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/google-workspace/db/hth-google-workspace-5.01-bigquery-detection.sql"
    excerpts:
      db-detect-failed-logins:
        content: |
            -- Find failed login attempts by user
            SELECT
            actor.email,
            COUNT(*) as failed_attempts
            FROM `project.dataset.login_logs`
            WHERE event_name = 'login_failure'
            AND _PARTITIONTIME >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
            GROUP BY actor.email
            HAVING failed_attempts > 10
            ORDER BY failed_attempts DESC;
      db-detect-external-sharing:
        content: |
            -- Find external file sharing
            SELECT
            actor.email,
            doc_title,
            target_user
            FROM `project.dataset.drive_logs`
            WHERE event_name = 'change_user_access'
            AND target_user NOT LIKE '%@yourdomain.com'
            AND _PARTITIONTIME >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 24 HOUR);

