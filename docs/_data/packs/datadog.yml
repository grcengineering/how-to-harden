# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-19T00:06:14Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-datadog-1.01-configure-saml-sso.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/datadog/terraform/hth-datadog-1.01-configure-saml-sso.tf"
    excerpts:
      terraform:
        content: |
            # Enable SAML SSO for the Datadog organization
            resource "datadog_organization_settings" "saml_sso" {
            name = "HTH Hardened Organization"
          
            settings {
              saml {
                enabled = true
              }
          
              saml_autocreate_users_domains {
                enabled = length(var.saml_autocreate_users_domains) > 0
                domains = var.saml_autocreate_users_domains
              }
          
              saml_idp_initiated_login {
                enabled = true
              }
            }
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-datadog-1.02-enable-saml-strict-mode.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/datadog/terraform/hth-datadog-1.02-enable-saml-strict-mode.tf"
    excerpts:
      terraform:
        content: |
            # Enforce SAML strict mode -- disables password and Google login
            # Only applied at profile level 2 (Hardened) and above
            resource "datadog_organization_settings" "saml_strict" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name = "HTH Hardened Organization"
          
            settings {
              saml {
                enabled = true
              }
          
              saml_strict_mode {
                enabled = var.saml_strict_mode_enabled
              }
          
              saml_autocreate_users_domains {
                enabled = length(var.saml_autocreate_users_domains) > 0
                domains = var.saml_autocreate_users_domains
              }
          
              saml_idp_initiated_login {
                enabled = true
              }
            }
            }

"1.3":
  terraform:
    lang: "hcl"
    filename: "hth-datadog-1.03-configure-session-security.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/datadog/terraform/hth-datadog-1.03-configure-session-security.tf"
    excerpts:
      terraform:
        content: |
            # Configure session security via security monitoring rule that detects
            # sessions exceeding the configured idle timeout.
            #
            # NOTE: Datadog does not expose session timeout as a direct Terraform resource.
            # Session duration is configured via Organization Settings in the UI.
            # This rule monitors for sessions that exceed the idle timeout threshold
            # and alerts the security team for investigation.
            resource "datadog_security_monitoring_rule" "session_idle_timeout_violation" {
            name    = "[HTH] Session Idle Timeout Violation Detected"
            enabled = true
            type    = "log_detection"
          
            message = <<-EOT
              ## Session Idle Timeout Violation
          
              A user session has been active beyond the configured idle timeout
              of ${var.session_idle_timeout_minutes} minutes.
          
              **Recommended Action:**
              - Review session in Organization Settings > Security
              - Verify idle timeout is set to ${var.session_idle_timeout_minutes} minutes
              - Investigate if the session was legitimately active
          
              **HTH Control:** 1.3 Configure Session Security
              **Profile Level:** L1 (Baseline)
          
              ${length(var.audit_alert_recipients) > 0 ? join(" ", var.audit_alert_recipients) : ""}
            EOT
          
            query {
              name            = "session_violation"
              query           = "source:audit @evt.name:session @duration:>${var.session_idle_timeout_minutes}m"
              aggregation     = "count"
              group_by_fields = ["@usr.email"]
            }
          
            case {
              name      = "Session idle timeout exceeded"
              status    = "medium"
              condition = "session_violation > 0"
            }
          
            options {
              detection_method       = "threshold"
              evaluation_window      = 900
              keep_alive             = 3600
              max_signal_duration    = 86400
              decrease_criticality_based_on_env = false
            }
          
            tags = ["source:hth", "control:1.3", "level:L1"]
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-datadog-2.01-configure-rbac.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/datadog/terraform/hth-datadog-2.01-configure-rbac.tf"
    excerpts:
      terraform:
        content: |
            # Look up the built-in Datadog Read Only role for reference
            data "datadog_role" "read_only" {
            filter = "Datadog Read Only Role"
            }
          
            # Look up the built-in Datadog Standard role for reference
            data "datadog_role" "standard" {
            filter = "Datadog Standard Role"
            }
          
            # Look up the built-in Datadog Admin role for reference
            data "datadog_role" "admin" {
            filter = "Datadog Admin Role"
            }
          
            # Create custom least-privilege roles from variable definitions
            resource "datadog_role" "custom" {
            for_each = var.custom_roles
          
            name = each.value.name
          
            dynamic "permission" {
              for_each = each.value.permissions
              content {
                id = permission.value
              }
            }
            }
          
            # Security monitoring rule: detect admin role assignments
            resource "datadog_security_monitoring_rule" "admin_role_assignment" {
            name    = "[HTH] Admin Role Assigned to User"
            enabled = true
            type    = "log_detection"
          
            message = <<-EOT
              ## Admin Role Assignment Detected
          
              A user has been assigned the Datadog Admin role. Admin access should
              be limited to 2-3 users per the principle of least privilege.
          
              **Recommended Action:**
              - Verify the assignment was authorized
              - Confirm the user requires full admin access
              - Consider using a custom role with fewer permissions
          
              **HTH Control:** 2.1 Configure Role-Based Access Control / 2.2 Limit Admin Access
              **Profile Level:** L1 (Baseline)
          
              ${length(var.audit_alert_recipients) > 0 ? join(" ", var.audit_alert_recipients) : ""}
            EOT
          
            query {
              name            = "admin_assignment"
              query           = "source:audit @evt.name:role @action:modified @role.name:\"Datadog Admin Role\""
              aggregation     = "count"
              group_by_fields = ["@usr.email"]
            }
          
            case {
              name      = "Admin role assigned"
              status    = "high"
              condition = "admin_assignment > 0"
            }
          
            options {
              detection_method       = "threshold"
              evaluation_window      = 300
              keep_alive             = 3600
              max_signal_duration    = 86400
              decrease_criticality_based_on_env = false
            }
          
            tags = ["source:hth", "control:2.1", "control:2.2", "level:L1"]
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-datadog-3.01-secure-api-keys.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/datadog/terraform/hth-datadog-3.01-secure-api-keys.tf"
    excerpts:
      terraform:
        content: |
            # Create purpose-specific API keys with descriptive names.
            # Each key should map to a single use case (e.g., prod-agent, staging-agent).
            resource "datadog_api_key" "managed" {
            for_each = toset(var.api_key_names)
          
            name = each.value
            }
          
            # Security monitoring rule: detect API key creation or deletion
            resource "datadog_security_monitoring_rule" "api_key_lifecycle" {
            name    = "[HTH] API Key Created or Deleted"
            enabled = true
            type    = "log_detection"
          
            message = <<-EOT
              ## API Key Lifecycle Event
          
              An API key was created or deleted. All API key changes should be
              authorized and documented per key management policy.
          
              **Recommended Action:**
              - Verify the change was authorized
              - Confirm the key name follows naming conventions
              - Update key inventory documentation
              - Ensure unused keys are revoked
          
              **HTH Control:** 3.1 Secure API Keys
              **Profile Level:** L1 (Baseline)
          
              ${length(var.audit_alert_recipients) > 0 ? join(" ", var.audit_alert_recipients) : ""}
            EOT
          
            query {
              name            = "api_key_change"
              query           = "source:audit @evt.name:api_key @action:(created OR deleted)"
              aggregation     = "count"
              group_by_fields = ["@usr.email"]
            }
          
            case {
              name      = "API key lifecycle event"
              status    = "medium"
              condition = "api_key_change > 0"
            }
          
            options {
              detection_method       = "threshold"
              evaluation_window      = 300
              keep_alive             = 3600
              max_signal_duration    = 86400
              decrease_criticality_based_on_env = false
            }
          
            tags = ["source:hth", "control:3.1", "level:L1"]
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-datadog-3.02-secure-application-keys.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/datadog/terraform/hth-datadog-3.02-secure-application-keys.tf"
    excerpts:
      terraform:
        content: |
            # Create purpose-specific application keys with descriptive names.
            # Application keys inherit the permissions of the user who creates them.
            # Use service accounts with limited roles for automation keys.
            resource "datadog_application_key" "managed" {
            for_each = toset(var.app_key_names)
          
            name = each.value
            }
          
            # Security monitoring rule: detect application key creation or deletion
            resource "datadog_security_monitoring_rule" "app_key_lifecycle" {
            name    = "[HTH] Application Key Created or Deleted"
            enabled = true
            type    = "log_detection"
          
            message = <<-EOT
              ## Application Key Lifecycle Event
          
              An application key was created or deleted. Application keys inherit
              the permissions of the creating user, so changes must be carefully
              controlled. Keys should be rotated every 90 days.
          
              **Recommended Action:**
              - Verify the change was authorized
              - Confirm the key is tied to an appropriate service account
              - Check that the owning user has minimal required permissions
              - Update key rotation schedule
          
              **HTH Control:** 3.2 Secure Application Keys
              **Profile Level:** L1 (Baseline)
          
              ${length(var.audit_alert_recipients) > 0 ? join(" ", var.audit_alert_recipients) : ""}
            EOT
          
            query {
              name            = "app_key_change"
              query           = "source:audit @evt.name:application_key @action:(created OR deleted)"
              aggregation     = "count"
              group_by_fields = ["@usr.email"]
            }
          
            case {
              name      = "Application key lifecycle event"
              status    = "medium"
              condition = "app_key_change > 0"
            }
          
            options {
              detection_method       = "threshold"
              evaluation_window      = 300
              keep_alive             = 3600
              max_signal_duration    = 86400
              decrease_criticality_based_on_env = false
            }
          
            tags = ["source:hth", "control:3.2", "level:L1"]
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-datadog-4.01-configure-audit-logs.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/datadog/terraform/hth-datadog-4.01-configure-audit-logs.tf"
    excerpts:
      terraform:
        content: |
            # Monitor for organization settings changes (security-critical events)
            resource "datadog_security_monitoring_rule" "org_settings_changed" {
            name    = "[HTH] Organization Settings Modified"
            enabled = true
            type    = "log_detection"
          
            message = <<-EOT
              ## Organization Settings Modified
          
              A change was detected to Datadog organization settings. This includes
              changes to authentication methods, security settings, and access controls.
          
              **Recommended Action:**
              - Review the specific setting that was changed
              - Verify the change was authorized via change management
              - Check if the change impacts security posture
              - Document in change log
          
              **HTH Control:** 4.1 Configure Audit Logs
              **Profile Level:** L1 (Baseline)
          
              ${length(var.audit_alert_recipients) > 0 ? join(" ", var.audit_alert_recipients) : ""}
            EOT
          
            query {
              name            = "org_change"
              query           = "source:audit @evt.name:org_settings @action:modified"
              aggregation     = "count"
              group_by_fields = ["@usr.email"]
            }
          
            case {
              name      = "Organization settings modified"
              status    = "high"
              condition = "org_change > 0"
            }
          
            options {
              detection_method       = "threshold"
              evaluation_window      = 300
              keep_alive             = 3600
              max_signal_duration    = 86400
              decrease_criticality_based_on_env = false
            }
          
            tags = ["source:hth", "control:4.1", "level:L1"]
            }
          
            # Monitor for user access changes (invitation, role change, removal)
            resource "datadog_security_monitoring_rule" "user_access_changed" {
            name    = "[HTH] User Access Modified"
            enabled = true
            type    = "log_detection"
          
            message = <<-EOT
              ## User Access Modified
          
              A user was invited, had their role changed, or was removed from the
              Datadog organization. User access changes should follow the principle
              of least privilege.
          
              **Recommended Action:**
              - Verify the user access change was authorized
              - Confirm the assigned role follows least privilege
              - Update user access inventory
              - Review if the user needs a custom role instead
          
              **HTH Control:** 4.1 Configure Audit Logs
              **Profile Level:** L1 (Baseline)
          
              ${length(var.audit_alert_recipients) > 0 ? join(" ", var.audit_alert_recipients) : ""}
            EOT
          
            query {
              name            = "user_change"
              query           = "source:audit @evt.name:user @action:(created OR modified OR deleted)"
              aggregation     = "count"
              group_by_fields = ["@usr.email"]
            }
          
            case {
              name      = "User access modified"
              status    = "medium"
              condition = "user_change > 0"
            }
          
            options {
              detection_method       = "threshold"
              evaluation_window      = 300
              keep_alive             = 3600
              max_signal_duration    = 86400
              decrease_criticality_based_on_env = false
            }
          
            tags = ["source:hth", "control:4.1", "level:L1"]
            }
          
            # L2: Monitor for SAML configuration changes
            resource "datadog_security_monitoring_rule" "saml_config_changed" {
            count   = var.profile_level >= 2 ? 1 : 0
            name    = "[HTH] SAML Configuration Modified"
            enabled = true
            type    = "log_detection"
          
            message = <<-EOT
              ## SAML Configuration Modified
          
              A change was detected to the SAML/SSO configuration. Unauthorized
              changes to SAML settings can enable authentication bypass attacks.
          
              **Recommended Action:**
              - Immediately verify the change was authorized
              - Check if SAML strict mode is still enabled
              - Verify IdP metadata has not been tampered with
              - Review login methods for unauthorized additions
          
              **HTH Control:** 4.1 Configure Audit Logs (SAML monitoring)
              **Profile Level:** L2 (Hardened)
          
              ${length(var.audit_alert_recipients) > 0 ? join(" ", var.audit_alert_recipients) : ""}
            EOT
          
            query {
              name            = "saml_change"
              query           = "source:audit @evt.name:saml @action:modified"
              aggregation     = "count"
              group_by_fields = ["@usr.email"]
            }
          
            case {
              name      = "SAML configuration modified"
              status    = "critical"
              condition = "saml_change > 0"
            }
          
            options {
              detection_method       = "threshold"
              evaluation_window      = 300
              keep_alive             = 3600
              max_signal_duration    = 86400
              decrease_criticality_based_on_env = false
            }
          
            tags = ["source:hth", "control:4.1", "level:L2"]
            }

