# AUTO-GENERATED by scripts/sync-packs-to-data.sh — do not edit manually
# Generated: 2026-02-19T16:51:36Z

"1.1":
  api:
    lang: "bash"
    filename: "hth-launchdarkly-1.01-enforce-sso-with-mfa.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/api/hth-launchdarkly-1.01-enforce-sso-with-mfa.sh"
    excerpts:
      api-audit-mfa-status:
        content: |
            # Audit all members for MFA enrollment
            MEMBERS=$(ld_get "/members?limit=100") || {
            fail "1.1 Unable to retrieve member list"
            increment_failed; summary; exit 0
            }
          
            TOTAL=$(echo "${MEMBERS}" | jq '.totalCount')
            NO_MFA=$(echo "${MEMBERS}" | jq '[.items[] | select(.mfa == false)] | length')
            info "1.1 Total members: ${TOTAL}, without MFA: ${NO_MFA}"
          
            if [ "${NO_MFA}" -gt 0 ]; then
            warn "1.1 Members without MFA:"
            echo "${MEMBERS}" | jq -r '.items[] | select(.mfa == false) | "  - \(.email) (role: \(.role))"'
            fail "1.1 ${NO_MFA} member(s) do not have MFA enabled"
            increment_failed
            else
            pass "1.1 All members have MFA enabled"
            increment_applied
            fi

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-launchdarkly-1.02-role-based-access-control.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/terraform/hth-launchdarkly-1.02-role-based-access-control.tf"
    excerpts:
      terraform:
        content: |
            # Production read-only role — least-privilege RBAC
            resource "launchdarkly_custom_role" "prod_readonly" {
            key              = "hth-prod-readonly"
            name             = "HTH Production Read-Only"
            description      = "View production flags without modification rights"
            base_permissions = "no_access"
          
            policy_statements {
              effect    = "allow"
              actions   = ["viewProject"]
              resources = ["proj/*"]
            }
          
            policy_statements {
              effect    = "deny"
              actions   = ["updateOn", "updateOff", "updateRules", "updateTargets", "updateFallthrough"]
              resources = ["proj/*:env/production:flag/*"]
            }
            }
          
            # Staging deployer role — write flags in staging only
            resource "launchdarkly_custom_role" "staging_deployer" {
            key              = "hth-staging-deployer"
            name             = "HTH Staging Deployer"
            description      = "Manage flags in staging, read-only in production"
            base_permissions = "no_access"
          
            policy_statements {
              effect    = "allow"
              actions   = ["viewProject"]
              resources = ["proj/*"]
            }
          
            policy_statements {
              effect    = "allow"
              actions   = ["*"]
              resources = ["proj/*:env/staging:flag/*"]
            }
          
            policy_statements {
              effect    = "deny"
              actions   = ["*"]
              resources = ["proj/*:env/production:flag/*"]
            }
            }
          
            # Scoped service token for CI/CD
            resource "launchdarkly_access_token" "cicd" {
            name          = "HTH CI/CD Pipeline"
            service_token = true
          
            inline_roles {
              effect    = "allow"
              actions   = ["updateOn", "updateOff"]
              resources = ["proj/${var.project_key}:env/staging:flag/*"]
            }
          
            inline_roles {
              effect    = "deny"
              actions   = ["*"]
              resources = ["proj/${var.project_key}:env/production:flag/*"]
            }
            }
  api:
    lang: "bash"
    filename: "hth-launchdarkly-1.02-role-based-access-control.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/api/hth-launchdarkly-1.02-role-based-access-control.sh"
    excerpts:
      api-create-custom-roles:
        content: |
            # Create a production read-only custom role
            EXISTING=$(ld_get "/roles" | jq -r '.items[].key') || true
          
            if echo "${EXISTING}" | grep -q "^hth-prod-readonly$"; then
            info "1.2 Role 'hth-prod-readonly' already exists"
            else
            info "1.2 Creating 'hth-prod-readonly' custom role..."
            RESPONSE=$(ld_post "/roles" '{
              "key": "hth-prod-readonly",
              "name": "HTH Production Read-Only",
              "description": "Read-only access to production environment",
              "basePermissions": "no_access",
              "policy": [
                {
                  "effect": "allow",
                  "actions": ["viewProject"],
                  "resources": ["proj/*"]
                },
                {
                  "effect": "deny",
                  "actions": ["updateOn", "updateOff", "updateRules", "updateTargets", "updateFallthrough"],
                  "resources": ["proj/*:env/production:flag/*"]
                }
              ]
            }') || {
              fail "1.2 Failed to create custom role"
              increment_failed; summary; exit 0
            }
            pass "1.2 Custom role 'hth-prod-readonly' created"
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-launchdarkly-1.02-role-based-access-control.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/siem/sigma/hth-launchdarkly-1.02-role-based-access-control.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    kind: 'member'
                    accesses.action: 'updateMemberRole'
                filter_admin:
                    title|contains: 'admin'
                condition: selection and filter_admin
              fields:
                - date
                - title
                - member.email
                - subject.name
                - accesses.resource

"2.1":
  api:
    lang: "bash"
    filename: "hth-launchdarkly-2.01-secure-sdk-keys.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/api/hth-launchdarkly-2.01-secure-sdk-keys.sh"
    excerpts:
      api-audit-sdk-keys:
        content: |
            # Check secure mode on all environments
            ENVIRONMENTS=$(ld_get "/projects/${LD_PROJECT_KEY}/environments") || {
            fail "2.1 Unable to retrieve environments"
            increment_failed; summary; exit 0
            }
          
            ENVS_WITHOUT_SECURE=$(echo "${ENVIRONMENTS}" | jq '[.items[] | select(.secureMode == false)] | length')
            TOTAL_ENVS=$(echo "${ENVIRONMENTS}" | jq '.items | length')
            info "2.1 Total environments: ${TOTAL_ENVS}"
          
            if [ "${ENVS_WITHOUT_SECURE}" -gt 0 ]; then
            warn "2.1 Environments without secure mode:"
            echo "${ENVIRONMENTS}" | jq -r '.items[] | select(.secureMode == false) | "  - \(.key)"'
            fi
          
            # Enable secure mode on production environment
            PROD_SECURE=$(echo "${ENVIRONMENTS}" | jq -r '.items[] | select(.key == "production") | .secureMode')
            if [ "${PROD_SECURE}" = "true" ]; then
            pass "2.1 Production environment has secure mode enabled"
            increment_applied
            else
            info "2.1 Enabling secure mode on production..."
            ld_semantic_patch "/projects/${LD_PROJECT_KEY}/environments/production" '{
              "comment": "HTH: Enable secure mode to prevent client-side SDK user impersonation",
              "instructions": [
                {"kind": "updateSecureMode", "value": true}
              ]
            }' || {
              fail "2.1 Failed to enable secure mode on production"
              increment_failed; summary; exit 0
            }
            pass "2.1 Secure mode enabled on production"
            increment_applied
            fi

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-launchdarkly-2.02-api-token-security.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/terraform/hth-launchdarkly-2.02-api-token-security.tf"
    excerpts:
      terraform:
        content: |
            # Scoped read-only token for monitoring
            resource "launchdarkly_access_token" "monitoring" {
            name          = "HTH Monitoring Read-Only"
            service_token = true
          
            inline_roles {
              effect    = "allow"
              actions   = ["viewProject"]
              resources = ["proj/*"]
            }
          
            inline_roles {
              effect    = "deny"
              actions   = ["createFlag", "deleteFlag", "updateOn", "updateOff"]
              resources = ["proj/*:env/*:flag/*"]
            }
            }
          
            # Scoped token for a specific project/environment
            resource "launchdarkly_access_token" "project_scoped" {
            name          = "HTH Project-Scoped Token"
            service_token = true
          
            inline_roles {
              effect    = "allow"
              actions   = ["viewProject", "updateOn", "updateOff"]
              resources = ["proj/${var.project_key}:env/${var.environment_key}:flag/*"]
            }
            }
  api:
    lang: "bash"
    filename: "hth-launchdarkly-2.02-api-token-security.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/api/hth-launchdarkly-2.02-api-token-security.sh"
    excerpts:
      api-audit-tokens:
        content: |
            # List all tokens and check for overly permissive ones
            TOKENS=$(ld_get "/tokens?showAll=true") || {
            fail "2.2 Unable to retrieve access tokens"
            increment_failed; summary; exit 0
            }
          
            TOTAL_TOKENS=$(echo "${TOKENS}" | jq '.items | length')
            ADMIN_TOKENS=$(echo "${TOKENS}" | jq '[.items[] | select(.role == "admin")] | length')
            NO_ROLE_TOKENS=$(echo "${TOKENS}" | jq '[.items[] | select(.role == "writer" or .role == "admin") | select(.serviceToken == true)] | length')
          
            info "2.2 Total tokens: ${TOTAL_TOKENS}"
            info "2.2 Admin-level tokens: ${ADMIN_TOKENS}"
            info "2.2 Service tokens with write/admin: ${NO_ROLE_TOKENS}"
          
            if [ "${ADMIN_TOKENS}" -gt 0 ]; then
            warn "2.2 Tokens with admin role (should use scoped roles instead):"
            echo "${TOKENS}" | jq -r '.items[] | select(.role == "admin") | "  - \(.name // "unnamed") (id: \(._id))"'
            fail "2.2 ${ADMIN_TOKENS} token(s) have admin role — scope down with custom roles"
            increment_failed
            else
            pass "2.2 No tokens with admin role"
            increment_applied
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-launchdarkly-2.02-api-token-security.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/siem/sigma/hth-launchdarkly-2.02-api-token-security.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    kind: 'token'
                    accesses.action: 'createToken'
                condition: selection
              fields:
                - date
                - title
                - member.email
                - target.name
                - accesses.resource

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-launchdarkly-3.01-environment-segmentation.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/terraform/hth-launchdarkly-3.01-environment-segmentation.tf"
    excerpts:
      terraform:
        content: |
            # Hardened production environment with approval workflows
            resource "launchdarkly_environment" "production" {
            key                  = "production"
            name                 = "Production"
            color                = "FF0000"
            project_key          = var.project_key
            require_comments     = true
            confirm_changes      = true
            secure_mode          = true
            critical             = true
            default_track_events = true
          
            approval_settings {
              required                   = true
              min_num_approvals          = 2
              can_review_own_request     = false
              can_apply_declined_changes = false
              required_approval_tags     = ["sensitive"]
              service_kind               = "launchdarkly"
            }
          
            tags = ["hth-hardened"]
            }
          
            # Staging environment — comments required, but no approval gate
            resource "launchdarkly_environment" "staging" {
            key              = "staging"
            name             = "Staging"
            color            = "FFA500"
            project_key      = var.project_key
            require_comments = true
            confirm_changes  = true
            secure_mode      = false
            critical         = false
            }
  api:
    lang: "bash"
    filename: "hth-launchdarkly-3.01-environment-segmentation.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/api/hth-launchdarkly-3.01-environment-segmentation.sh"
    excerpts:
      api-harden-environment:
        content: |
            # Enable require-comments, confirm-changes, and mark as critical
            CURRENT=$(ld_get "/projects/${LD_PROJECT_KEY}/environments/production") || {
            fail "3.1 Unable to retrieve production environment"
            increment_failed; summary; exit 0
            }
          
            REQUIRE_COMMENTS=$(echo "${CURRENT}" | jq -r '.requireComments')
            CONFIRM_CHANGES=$(echo "${CURRENT}" | jq -r '.confirmChanges')
            IS_CRITICAL=$(echo "${CURRENT}" | jq -r '.critical')
          
            INSTRUCTIONS="[]"
          
            if [ "${REQUIRE_COMMENTS}" != "true" ]; then
            INSTRUCTIONS=$(echo "${INSTRUCTIONS}" | jq '. + [{"kind": "updateRequireComments", "value": true}]')
            fi
            if [ "${CONFIRM_CHANGES}" != "true" ]; then
            INSTRUCTIONS=$(echo "${INSTRUCTIONS}" | jq '. + [{"kind": "updateConfirmChanges", "value": true}]')
            fi
            if [ "${IS_CRITICAL}" != "true" ]; then
            INSTRUCTIONS=$(echo "${INSTRUCTIONS}" | jq '. + [{"kind": "updateCritical", "value": true}]')
            fi
          
            if [ "$(echo "${INSTRUCTIONS}" | jq 'length')" -gt 0 ]; then
            info "3.1 Applying environment hardening..."
            PAYLOAD=$(jq -n --argjson inst "${INSTRUCTIONS}" '{
              "comment": "HTH: Harden production environment controls",
              "instructions": $inst
            }')
            ld_semantic_patch "/projects/${LD_PROJECT_KEY}/environments/production" "${PAYLOAD}" || {
              fail "3.1 Failed to update production environment"
              increment_failed; summary; exit 0
            }
            pass "3.1 Production environment hardened"
            increment_applied
            else
            pass "3.1 Production environment already hardened"
            increment_applied
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-launchdarkly-3.01-environment-segmentation.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/siem/sigma/hth-launchdarkly-3.01-environment-segmentation.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    kind: 'environment'
                    accesses.action:
                        - 'updateRequireComments'
                        - 'updateConfirmChanges'
                        - 'updateSecureMode'
                        - 'updateApprovalSettings'
                filter_production:
                    accesses.resource|contains: 'env/production'
                condition: selection and filter_production
              fields:
                - date
                - title
                - member.email
                - accesses.action
                - accesses.resource
                - previousVersion
                - currentVersion

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-launchdarkly-3.02-flag-security.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/terraform/hth-launchdarkly-3.02-flag-security.tf"
    excerpts:
      terraform:
        content: |
            # Example: Secure feature flag with restricted client-side exposure
            resource "launchdarkly_feature_flag" "secure_flag_example" {
            project_key    = var.project_key
            key            = "hth-example-secure-flag"
            name           = "HTH Example Secure Flag"
            description    = "Demonstrates HTH flag security best practices"
            variation_type = "boolean"
            temporary      = true
          
            # Restrict client-side SDK exposure
            client_side_availability {
              using_environment_id = false
              using_mobile_key     = false
            }
          
            # Assign a team maintainer for lifecycle ownership
            maintainer_team_key = var.maintainer_team_key
          
            tags = ["sensitive", "hth-managed"]
          
            variations {
              value       = true
              name        = "Enabled"
              description = "Feature is active"
            }
          
            variations {
              value       = false
              name        = "Disabled"
              description = "Feature is inactive"
            }
          
            defaults {
              on_variation  = 0
              off_variation = 1
            }
            }
  api:
    lang: "bash"
    filename: "hth-launchdarkly-3.02-flag-security.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/api/hth-launchdarkly-3.02-flag-security.sh"
    excerpts:
      api-audit-flag-security:
        content: |
            # Check for stale flags and unrestricted client-side exposure
            FLAGS=$(ld_get "/flags/${LD_PROJECT_KEY}?summary=true&limit=100") || {
            fail "3.2 Unable to retrieve flags"
            increment_failed; summary; exit 0
            }
          
            TOTAL_FLAGS=$(echo "${FLAGS}" | jq '.items | length')
            TEMP_FLAGS=$(echo "${FLAGS}" | jq '[.items[] | select(.temporary == true)] | length')
            CLIENT_EXPOSED=$(echo "${FLAGS}" | jq '[.items[] | select(.clientSideAvailability.usingEnvironmentId == true)] | length')
            NO_MAINTAINER=$(echo "${FLAGS}" | jq '[.items[] | select(._maintainer == null and ._maintainerTeam == null)] | length')
          
            info "3.2 Total flags: ${TOTAL_FLAGS}"
            info "3.2 Temporary flags: ${TEMP_FLAGS}"
            info "3.2 Client-side exposed: ${CLIENT_EXPOSED}"
            info "3.2 Without maintainer: ${NO_MAINTAINER}"
          
            if [ "${NO_MAINTAINER}" -gt 0 ]; then
            warn "3.2 ${NO_MAINTAINER} flag(s) have no assigned maintainer"
            fi
          
            if [ "${CLIENT_EXPOSED}" -gt 0 ]; then
            warn "3.2 ${CLIENT_EXPOSED} flag(s) exposed to client-side SDKs — review for sensitive data"
            fi
          
            pass "3.2 Flag security audit complete"
            increment_applied

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-launchdarkly-4.01-audit-log.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/terraform/hth-launchdarkly-4.01-audit-log.tf"
    excerpts:
      terraform:
        content: |
            # Splunk audit log subscription
            resource "launchdarkly_audit_log_subscription" "splunk" {
            integration_key = "splunk"
            name            = "HTH Splunk Audit Stream"
            on              = true
          
            config = {
              base_url = var.splunk_hec_url
              token    = var.splunk_hec_token
            }
          
            statements {
              effect    = "allow"
              actions   = ["*"]
              resources = ["proj/*"]
            }
          
            tags = ["hth", "siem"]
            }
          
            # Signed webhook for custom SIEM
            resource "launchdarkly_webhook" "siem" {
            name   = "HTH SIEM Webhook"
            url    = var.siem_webhook_url
            on     = true
            secret = var.webhook_signing_secret
          
            statements {
              effect    = "allow"
              actions   = ["*"]
              resources = ["proj/*"]
            }
          
            tags = ["hth", "siem"]
            }
  api:
    lang: "bash"
    filename: "hth-launchdarkly-4.01-audit-log.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/api/hth-launchdarkly-4.01-audit-log.sh"
    excerpts:
      api-configure-audit-webhook:
        content: |
            # Create a signed webhook for SIEM audit log streaming
            EXISTING=$(ld_get "/webhooks" | jq -r '.items[] | select(.name == "HTH SIEM Webhook") | ._id') || true
          
            if [ -n "${EXISTING}" ]; then
            info "4.1 SIEM webhook already exists (id: ${EXISTING})"
            pass "4.1 Audit log webhook configured"
            increment_applied
            else
            WEBHOOK_SECRET="${LD_WEBHOOK_SECRET:-$(openssl rand -hex 32)}"
            info "4.1 Creating signed webhook for SIEM..."
            RESPONSE=$(ld_post "/webhooks" "$(jq -n \
              --arg url "${LD_SIEM_WEBHOOK_URL}" \
              --arg secret "${WEBHOOK_SECRET}" \
              '{
                "name": "HTH SIEM Webhook",
                "url": $url,
                "sign": true,
                "secret": $secret,
                "on": true,
                "tags": ["hth", "siem"],
                "statements": [
                  {
                    "effect": "allow",
                    "actions": ["*"],
                    "resources": ["proj/*"]
                  }
                ]
              }'
            )") || {
              fail "4.1 Failed to create SIEM webhook"
              increment_failed; summary; exit 0
            }
            pass "4.1 SIEM webhook created"
            info "4.1 Webhook signing secret: ${WEBHOOK_SECRET}"
            increment_applied
            fi
  db:
    lang: "sql"
    filename: "hth-launchdarkly-4.01-detect-anomalies.sql"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/db/hth-launchdarkly-4.01-detect-anomalies.sql"
    excerpts:
      db-detect-anomalies:
        content: |
            -- Detect production flag changes
            SELECT user_email, flag_key, action
            FROM launchdarkly_audit_log
            WHERE environment = 'production'
            AND action IN ('updateFlag', 'toggleFlag')
            AND timestamp > NOW() - INTERVAL '24 hours';
          
            -- Detect bulk flag modifications
            SELECT user_email, COUNT(*) as changes
            FROM launchdarkly_audit_log
            WHERE action LIKE '%Flag%'
            AND timestamp > NOW() - INTERVAL '1 hour'
            GROUP BY user_email
            HAVING COUNT(*) > 10;
  sigma:
    - lang: "yaml"
      filename: "hth-launchdarkly-4.01-audit-log.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/launchdarkly/siem/sigma/hth-launchdarkly-4.01-audit-log.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection_webhook:
                    kind: 'webhook'
                    accesses.action:
                        - 'deleteWebhook'
                selection_integration:
                    kind: 'integration'
                    accesses.action:
                        - 'deleteIntegration'
                condition: selection_webhook or selection_integration
              fields:
                - date
                - title
                - member.email
                - target.name
                - accesses.resource

