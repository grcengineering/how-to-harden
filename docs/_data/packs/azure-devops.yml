# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-19T00:06:07Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-1.1-enforce-azure-ad-authentication.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-1.1-enforce-azure-ad-authentication.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Disable alternate authentication methods at the project level.
            # Azure AD connection and Conditional Access policies are configured in
            # the Azure Portal (Entra ID) -- not via the Azure DevOps provider.
            # This resource restricts project pipeline settings that weaken auth posture.
            # ---------------------------------------------------------------------------
          
            resource "azuredevops_project_features" "auth_hardening" {
            project_id = data.azuredevops_project.target.id
          
            features = {
              # Disable features that are not required to reduce attack surface
              "artifacts"    = "disabled"
              "testplans"    = "disabled"
              "boards"       = "enabled"
              "repositories" = "enabled"
              "pipelines"    = "enabled"
            }
            }
          
            # Look up the target project by name
            data "azuredevops_project" "target" {
            name = var.project_name
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-1.2-implement-project-level-security-groups.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-1.2-implement-project-level-security-groups.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Create a dedicated Security Reviewers group for approval gates.
            # Built-in groups (Project Administrators, Contributors, Build Administrators)
            # are managed via the Azure DevOps UI. This creates the custom group used
            # by service connection and environment approval controls.
            # ---------------------------------------------------------------------------
          
            resource "azuredevops_group" "security_reviewers" {
            scope        = data.azuredevops_project.target.id
            display_name = var.security_reviewers_group_name
            description  = "Security team members authorized to approve service connection usage and production deployments"
            }
          
            # Add members to the security reviewers group
            resource "azuredevops_group_membership" "security_reviewers" {
            count = length(var.security_reviewer_members) > 0 ? 1 : 0
          
            group   = azuredevops_group.security_reviewers.descriptor
            mode    = "add"
            members = [for upn in var.security_reviewer_members : data.azuredevops_users.reviewers[upn].users[*].descriptor[0]]
            }
          
            # Look up each reviewer user by principal name
            data "azuredevops_users" "reviewers" {
            for_each       = toset(var.security_reviewer_members)
            principal_name = each.value
            }

"1.3":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-1.3-configure-personal-access-token-policies.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-1.3-configure-personal-access-token-policies.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # PAT policies are managed at the organization level via the Azure DevOps
            # REST API or UI -- not through the Terraform provider. This resource
            # configures project pipeline settings to restrict token scope at the
            # project level, complementing organization-level PAT restrictions.
            # ---------------------------------------------------------------------------
          
            resource "azuredevops_project_pipeline_settings" "pat_restrictions" {
            project_id = data.azuredevops_project.target.id
          
            # Restrict pipeline job authorization scope to current project
            enforce_job_scope                    = true
            enforce_job_scope_for_release        = true
            enforce_referenced_repo_scoped_token = true
          
            # Restrict settable variables at queue time (L2+)
            enforce_settable_var = var.profile_level >= 2 ? true : false
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-2.1-migrate-to-workload-identity-federation.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-2.1-migrate-to-workload-identity-federation.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Create an Azure Resource Manager service connection using workload
            # identity federation (OIDC). This eliminates static secrets by using
            # short-lived, automatically rotated tokens. The service connection is
            # scoped to specific pipelines -- "grant access to all pipelines" is
            # disabled by default.
            # ---------------------------------------------------------------------------
          
            resource "azuredevops_serviceendpoint_azurerm" "workload_identity" {
            count = var.azure_subscription_id != "" ? 1 : 0
          
            project_id            = data.azuredevops_project.target.id
            service_endpoint_name = "${var.project_name}-oidc"
            description           = "Workload Identity Federation - no stored credentials"
          
            credentials {
              serviceprincipalid = var.service_principal_id
            }
          
            azurerm_spn_tenantid      = var.azure_tenant_id
            azurerm_subscription_id   = var.azure_subscription_id
            azurerm_subscription_name = var.azure_subscription_name
            }
          
            # Restrict service connection access to specific pipelines only
            resource "azuredevops_pipeline_authorization" "workload_identity" {
            count = var.azure_subscription_id != "" ? 1 : 0
          
            project_id  = data.azuredevops_project.target.id
            resource_id = azuredevops_serviceendpoint_azurerm.workload_identity[0].id
            type        = "endpoint"
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-2.2-audit-and-rotate-legacy-service-connections.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-2.2-audit-and-rotate-legacy-service-connections.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Legacy service connection auditing and rotation cannot be fully automated
            # via Terraform. This data source retrieves all service endpoints in the
            # project so they can be reviewed and output for audit purposes.
            #
            # Rotation workflow:
            #   1. Generate new credentials in the target service
            #   2. Update the service connection (manual or API)
            #   3. Verify pipeline functionality
            #   4. Revoke old credentials
            # ---------------------------------------------------------------------------
          
            data "azuredevops_serviceendpoint_azurerm" "existing" {
            for_each = toset(var.legacy_service_connection_ids)
          
            project_id            = data.azuredevops_project.target.id
            service_endpoint_id   = each.value
            }

"2.3":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-2.3-implement-service-connection-approval-gates.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-2.3-implement-service-connection-approval-gates.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Require approval before pipelines can use sensitive service connections.
            # This applies check_approval and check_branch_control to the workload
            # identity service connection. Only created at L2+ profile levels.
            # ---------------------------------------------------------------------------
          
            # Approval gate: require security team sign-off before service connection use
            resource "azuredevops_check_approval" "service_connection_approval" {
            count = var.profile_level >= 2 && var.azure_subscription_id != "" ? 1 : 0
          
            project_id           = data.azuredevops_project.target.id
            target_resource_id   = azuredevops_serviceendpoint_azurerm.workload_identity[0].id
            target_resource_type = "endpoint"
          
            requester_can_approve = false
            approvers             = var.service_connection_approvers
            }
          
            # Branch control: only allow service connection use from protected branches
            resource "azuredevops_check_branch_control" "service_connection_branch" {
            count = var.profile_level >= 2 && var.azure_subscription_id != "" ? 1 : 0
          
            project_id           = data.azuredevops_project.target.id
            target_resource_id   = azuredevops_serviceendpoint_azurerm.workload_identity[0].id
            target_resource_type = "endpoint"
          
            display_name                = "Branch Control - Protected Branches Only"
            allowed_branches            = "refs/heads/main,refs/heads/release/*"
            verify_branch_protection    = true
            ignore_unknown_protection_status = false
            }
          
            # Business hours check: restrict production deployments to business hours (L3)
            resource "azuredevops_check_business_hours" "service_connection_hours" {
            count = var.profile_level >= 3 && var.azure_subscription_id != "" ? 1 : 0
          
            project_id           = data.azuredevops_project.target.id
            target_resource_id   = azuredevops_serviceendpoint_azurerm.workload_identity[0].id
            target_resource_type = "endpoint"
          
            display_name = "Business Hours - Weekdays 09:00-17:00 UTC"
            time_zone    = "UTC"
          
            monday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            tuesday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            wednesday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            thursday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            friday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-3.1-implement-yaml-pipeline-security.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-3.1-implement-yaml-pipeline-security.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Pipeline settings for this control are consolidated in the
            # azuredevops_project_pipeline_settings resource defined in Control 1.3
            # (hth-azure-devops-1.3-configure-personal-access-token-policies.tf).
            #
            # The Terraform provider allows only one pipeline_settings resource per
            # project. The following settings from Control 1.3 implement this control:
            #
            #   enforce_job_scope                    = true   (L1)
            #   enforce_job_scope_for_release        = true   (L1)
            #   enforce_referenced_repo_scoped_token = true   (L1)
            #   enforce_settable_var                 = true   (L2+)
            #
            # Classic pipeline creation is disabled at the organization level via
            # the Azure DevOps UI:
            #   Organization Settings > Pipelines > Settings
            #     - Disable creation of classic build pipelines: Enable
            #     - Disable creation of classic release pipelines: Enable
            # ---------------------------------------------------------------------------
          
            # No additional resources -- see Control 1.3 for pipeline settings.

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-3.2-configure-pipeline-permissions-and-approvals.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-3.2-configure-pipeline-permissions-and-approvals.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Create deployment environments with approval gates. Production
            # environments require approval before pipeline deployment jobs can
            # proceed. Staging environments are created without approval for L1,
            # with approval added at L2+.
            # ---------------------------------------------------------------------------
          
            # Production environment with mandatory approval
            resource "azuredevops_environment" "production" {
            project_id  = data.azuredevops_project.target.id
            name        = var.production_environment_name
            description = "Production deployment environment - requires approval"
            }
          
            # Staging environment
            resource "azuredevops_environment" "staging" {
            project_id  = data.azuredevops_project.target.id
            name        = var.staging_environment_name
            description = "Staging deployment environment"
            }
          
            # Approval gate for production environment
            resource "azuredevops_check_approval" "production_approval" {
            count = length(var.deployment_approvers) > 0 ? 1 : 0
          
            project_id           = data.azuredevops_project.target.id
            target_resource_id   = azuredevops_environment.production.id
            target_resource_type = "environment"
          
            requester_can_approve = false
            approvers             = var.deployment_approvers
            }
          
            # Branch control for production: only deploy from main branch
            resource "azuredevops_check_branch_control" "production_branch" {
            project_id           = data.azuredevops_project.target.id
            target_resource_id   = azuredevops_environment.production.id
            target_resource_type = "environment"
          
            display_name                = "Branch Control - Main Branch Only"
            allowed_branches            = "refs/heads/main"
            verify_branch_protection    = true
            ignore_unknown_protection_status = false
            }
          
            # Business hours restriction for production (L3)
            resource "azuredevops_check_business_hours" "production_hours" {
            count = var.profile_level >= 3 ? 1 : 0
          
            project_id           = data.azuredevops_project.target.id
            target_resource_id   = azuredevops_environment.production.id
            target_resource_type = "environment"
          
            display_name = "Business Hours - Production Deployments Only"
            time_zone    = "UTC"
          
            monday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            tuesday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            wednesday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            thursday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            friday {
              start_time = "09:00"
              end_time   = "17:00"
            }
            }
          
            # Exclusive lock for production deployments (L2+) -- prevent concurrent deploys
            resource "azuredevops_check_exclusive_lock" "production_lock" {
            count = var.profile_level >= 2 ? 1 : 0
          
            project_id           = data.azuredevops_project.target.id
            target_resource_id   = azuredevops_environment.production.id
            target_resource_type = "environment"
            }

"3.3":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-3.3-secure-agent-pool-configuration.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-3.3-secure-agent-pool-configuration.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Create tiered agent pools with appropriate access restrictions.
            # Production and security agent pools are isolated from development
            # workloads. Pipeline authorization restricts which pipelines can use
            # each pool.
            #
            # Pool hierarchy:
            #   Azure Pipelines (Microsoft-hosted, ephemeral) -- built-in, not managed
            #   Production-Agents (self-hosted, restricted access)
            #   Security-Agents (isolated, scanning tools only) -- L2+
            # ---------------------------------------------------------------------------
          
            # Production agent pool -- restricted to production pipelines
            resource "azuredevops_agent_pool" "production" {
            name           = var.agent_pool_name
            auto_provision = false
            auto_update    = true
            }
          
            # Queue the production pool into the project
            resource "azuredevops_agent_queue" "production" {
            project_id    = data.azuredevops_project.target.id
            agent_pool_id = azuredevops_agent_pool.production.id
            }
          
            # Restrict production pool access -- do not auto-authorize all pipelines
            resource "azuredevops_pipeline_authorization" "production_pool" {
            project_id  = data.azuredevops_project.target.id
            resource_id = azuredevops_agent_queue.production.id
            type        = "queue"
            }
          
            # Security-isolated agent pool for scanning tools (L2+)
            resource "azuredevops_agent_pool" "security" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name           = var.security_agent_pool_name
            auto_provision = false
            auto_update    = true
            }
          
            resource "azuredevops_agent_queue" "security" {
            count = var.profile_level >= 2 ? 1 : 0
          
            project_id    = data.azuredevops_project.target.id
            agent_pool_id = azuredevops_agent_pool.security[0].id
            }
          
            resource "azuredevops_pipeline_authorization" "security_pool" {
            count = var.profile_level >= 2 ? 1 : 0
          
            project_id  = data.azuredevops_project.target.id
            resource_id = azuredevops_agent_queue.security[0].id
            type        = "queue"
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-4.1-configure-branch-policies.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-4.1-configure-branch-policies.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Implement branch policies on the default branch to enforce code review,
            # prevent direct pushes, and require build validation. Minimum reviewer
            # count scales with profile level (L1: 1, L2: 2, L3: 3).
            # ---------------------------------------------------------------------------
          
            # Require minimum number of reviewers for pull requests
            resource "azuredevops_branch_policy_min_reviewers" "main" {
            count = var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              reviewer_count                         = var.min_reviewer_count
              submitter_can_vote                     = false
              last_pusher_cannot_approve             = true
              allow_completion_with_rejects_or_waits = false
              on_push_reset_approved_votes           = true
          
              scope {
                repository_id  = var.repository_id
                repository_ref = var.default_branch
                match_type     = "Exact"
              }
            }
            }
          
            # Require comment resolution before merge
            resource "azuredevops_branch_policy_comment_resolution" "main" {
            count = var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              scope {
                repository_id  = var.repository_id
                repository_ref = var.default_branch
                match_type     = "Exact"
              }
            }
            }
          
            # Require linked work items
            resource "azuredevops_branch_policy_work_item_linking" "main" {
            count = var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              scope {
                repository_id  = var.repository_id
                repository_ref = var.default_branch
                match_type     = "Exact"
              }
            }
            }
          
            # Restrict merge types -- allow squash and rebase only (L2+)
            resource "azuredevops_branch_policy_merge_types" "main" {
            count = var.profile_level >= 2 && var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              allow_squash                  = true
              allow_rebase_and_fast_forward = true
              allow_basic_no_fast_forward   = false
              allow_rebase_with_merge       = false
          
              scope {
                repository_id  = var.repository_id
                repository_ref = var.default_branch
                match_type     = "Exact"
              }
            }
            }
          
            # Build validation -- require CI pipeline to pass before merge
            resource "azuredevops_branch_policy_build_validation" "main" {
            count = var.build_validation_definition_id > 0 && var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              display_name        = "CI Build Validation"
              build_definition_id = var.build_validation_definition_id
              valid_duration      = 720
              filename_patterns   = []
          
              scope {
                repository_id  = var.repository_id
                repository_ref = var.default_branch
                match_type     = "Exact"
              }
            }
            }
          
            # Auto-reviewers for pipeline YAML changes (L2+)
            resource "azuredevops_branch_policy_auto_reviewers" "pipeline_yaml" {
            count = var.profile_level >= 2 && var.repository_id != "" && length(var.pipeline_yaml_reviewers) > 0 ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              auto_reviewer_ids  = var.pipeline_yaml_reviewers
              submitter_can_vote = false
              message            = "Pipeline YAML changes require security team review"
              path_filters       = ["azure-pipelines.yml", "azure-pipelines/*.yml", ".azuredevops/*.yml"]
          
              scope {
                repository_id  = var.repository_id
                repository_ref = var.default_branch
                match_type     = "Exact"
              }
            }
            }
          
            # Auto-reviewers for Terraform changes (L2+)
            resource "azuredevops_branch_policy_auto_reviewers" "terraform" {
            count = var.profile_level >= 2 && var.repository_id != "" && length(var.pipeline_yaml_reviewers) > 0 ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              auto_reviewer_ids  = var.pipeline_yaml_reviewers
              submitter_can_vote = false
              message            = "Terraform changes require platform team review"
              path_filters       = ["terraform/*", "*.tf"]
          
              scope {
                repository_id  = var.repository_id
                repository_ref = var.default_branch
                match_type     = "Exact"
              }
            }
            }

"4.2":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-4.2-enable-credential-scanning.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-4.2-enable-credential-scanning.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Enable repository-level policies that block pushes containing secrets
            # or credentials. The azuredevops_repository_policy_check_credentials
            # resource prevents accidental secret commits at the Git layer.
            #
            # Microsoft Security DevOps pipeline scanning (MicrosoftSecurityDevOps@1)
            # is configured via YAML pipelines, not Terraform.
            # ---------------------------------------------------------------------------
          
            # Block pushes that contain credentials or secrets
            resource "azuredevops_repository_policy_check_credentials" "block_secrets" {
            count = var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              scope {
                repository_id = var.repository_id
              }
            }
            }
          
            # Enforce path length limits to prevent path traversal abuse (L2+)
            resource "azuredevops_repository_policy_max_path_length" "path_length" {
            count = var.profile_level >= 2 && var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              max_path_length = 260
          
              scope {
                repository_id = var.repository_id
              }
            }
            }
          
            # Enforce maximum file size to prevent binary blob abuse (L2+)
            resource "azuredevops_repository_policy_max_file_size" "file_size" {
            count = var.profile_level >= 2 && var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              max_file_size = 50
          
              scope {
                repository_id = var.repository_id
              }
            }
            }
          
            # Block reserved names in repository paths (L2+)
            resource "azuredevops_repository_policy_reserved_names" "reserved_names" {
            count = var.profile_level >= 2 && var.repository_id != "" ? 1 : 0
          
            project_id = data.azuredevops_project.target.id
            enabled    = true
            blocking   = true
          
            settings {
              scope {
                repository_id = var.repository_id
              }
            }
            }

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-5.1-secure-variable-groups.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-5.1-secure-variable-groups.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Create environment-specific variable groups with appropriate access
            # controls. Production secrets are linked to Azure Key Vault so that
            # secret values are never stored in Azure DevOps. Non-secret
            # configuration uses standard variable groups.
            #
            # Variable group hierarchy:
            #   production-secrets   (Key Vault linked)
            #   staging-secrets      (Key Vault linked or standard)
            #   shared-config        (non-secret configuration)
            # ---------------------------------------------------------------------------
          
            # Production secrets variable group linked to Azure Key Vault
            resource "azuredevops_variable_group" "production_secrets" {
            count = var.key_vault_name != "" ? 1 : 0
          
            project_id   = data.azuredevops_project.target.id
            name         = "production-secrets"
            description  = "Production secrets linked to Azure Key Vault - managed by HTH"
            allow_access = false
          
            key_vault {
              name                = var.key_vault_name
              service_endpoint_id = var.key_vault_service_connection_id
            }
          
            dynamic "variable" {
              for_each = var.key_vault_secrets
              content {
                name = variable.key
              }
            }
            }
          
            # Shared non-secret configuration variable group
            resource "azuredevops_variable_group" "shared_config" {
            project_id   = data.azuredevops_project.target.id
            name         = "shared-config"
            description  = "Shared non-secret configuration - managed by HTH"
            allow_access = false
          
            variable {
              name  = "ENVIRONMENT"
              value = "production"
            }
          
            variable {
              name  = "HTH_MANAGED"
              value = "true"
            }
            }
          
            # Restrict production secrets variable group to specific pipelines only
            resource "azuredevops_pipeline_authorization" "production_secrets" {
            count = var.key_vault_name != "" ? 1 : 0
          
            project_id  = data.azuredevops_project.target.id
            resource_id = azuredevops_variable_group.production_secrets[0].id
            type        = "variablegroup"
            }

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-5.2-use-runtime-parameters-for-secrets.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-5.2-use-runtime-parameters-for-secrets.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Runtime parameters are a YAML pipeline feature -- they cannot be
            # configured via Terraform. This control enforces the project-level
            # pipeline setting that restricts settable variables at queue time,
            # ensuring that only explicitly declared parameters can be set.
            #
            # The enforce_settable_var setting prevents unauthorized variable
            # injection during pipeline execution.
            #
            # NOTE: The actual runtime parameter YAML pattern is documented in the
            # guide and implemented in pipeline definitions, not infrastructure code.
            # ---------------------------------------------------------------------------
          
            # Approval gate for variable group access (L2+)
            resource "azuredevops_check_approval" "variable_group_approval" {
            count = var.profile_level >= 2 && var.key_vault_name != "" && length(var.deployment_approvers) > 0 ? 1 : 0
          
            project_id           = data.azuredevops_project.target.id
            target_resource_id   = azuredevops_variable_group.production_secrets[0].id
            target_resource_type = "variablegroup"
          
            requester_can_approve = false
            approvers             = var.deployment_approvers
            }

"6.1":
  terraform:
    lang: "hcl"
    filename: "hth-azure-devops-6.1-enable-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/azure-devops/terraform/hth-azure-devops-6.1-enable-audit-logging.tf"
    excerpts:
      terraform:
        content: |
          
            # ---------------------------------------------------------------------------
            # Azure DevOps audit logging is enabled by default at the organization
            # level and accessed via Organization Settings > Auditing. The Terraform
            # provider does not manage audit log configuration directly.
            #
            # This control creates a service hook to forward pipeline events to an
            # external endpoint for SIEM integration. Service connection changes,
            # permission changes, and pipeline modifications are captured.
            #
            # For full audit log export, use the Azure DevOps REST API:
            #   GET https://auditservice.dev.azure.com/{org}/_apis/audit/auditlog
            # ---------------------------------------------------------------------------
          
            # Service hook: forward pipeline run events to external webhook (L2+)
            resource "azuredevops_servicehook_permissions" "audit_hooks" {
            count = var.profile_level >= 2 ? 1 : 0
          
            project_id  = data.azuredevops_project.target.id
            principal   = azuredevops_group.security_reviewers.id
            permissions = {
              "ViewSubscriptions"   = "Allow"
              "EditSubscriptions"   = "Allow"
              "DeleteSubscriptions" = "Deny"
            }
            }

