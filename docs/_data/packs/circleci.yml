# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-20T08:34:25Z

"2.1":
  cli:
    lang: "yaml"
    filename: "hth-circleci-2.01-restrict-context-branches.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/cli/hth-circleci-2.01-restrict-context-branches.yml"
    excerpts:
      cli-restrict-context-branches:
        content: |
            # .circleci/config.yml
            workflows:
            deploy:
              jobs:
                - deploy_production:
                    context:
                      - production-secrets
                    filters:
                      branches:
                        only: main  # Only main branch can access production context

"2.2":
  cli:
    lang: "yaml"
    filename: "hth-circleci-2.02-minimize-env-var-exposure.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/cli/hth-circleci-2.02-minimize-env-var-exposure.yml"
    excerpts:
      cli-minimize-env-var-exposure:
        content: |
            # .circleci/config.yml
            jobs:
            build:
              docker:
                - image: cimg/base:2024.01
              steps:
                - run:
                    name: Build
                    # Only use environment variables when needed
                    command: |
                      # Don't echo secrets
                      # Don't pass secrets as command arguments (visible in ps)
                      ./build.sh

"2.3":
  api:
    lang: "bash"
    filename: "hth-circleci-2.03-oidc-iam-trust-policy.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/api/hth-circleci-2.03-oidc-iam-trust-policy.sh"
    excerpts:
      api-oidc-iam-trust-policy:
        content: |
            # AWS IAM Trust Policy for CircleCI OIDC
            cat <<'POLICY'
            {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Federated": "arn:aws:iam::123456789:oidc-provider/oidc.circleci.com/org/ORG_ID"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "oidc.circleci.com/org/ORG_ID:aud": "ORG_ID"
                  },
                  "StringLike": {
                    "oidc.circleci.com/org/ORG_ID:sub": "org/ORG_ID/project/*/user/*"
                  }
                }
              }
            ]
            }
            POLICY
  cli:
    lang: "yaml"
    filename: "hth-circleci-2.03-configure-oidc-authentication.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/cli/hth-circleci-2.03-configure-oidc-authentication.yml"
    excerpts:
      cli-oidc-authentication:
        content: |
            # .circleci/config.yml - AWS OIDC authentication
            jobs:
            deploy_to_aws:
              docker:
                - image: cimg/aws:2024.01
              steps:
                - run:
                    name: Configure AWS credentials via OIDC
                    command: |
                      # No static credentials needed
                      # CircleCI OIDC token is automatically available
                      aws sts assume-role-with-web-identity \
                        --role-arn arn:aws:iam::123456789:role/CircleCI-Deploy \
                        --role-session-name circleci-${CIRCLE_BUILD_NUM} \
                        --web-identity-token ${CIRCLE_OIDC_TOKEN} \
                        --duration-seconds 3600

"3.1":
  cli:
    lang: "yaml"
    filename: "hth-circleci-3.01-restrict-pipeline-triggers.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/cli/hth-circleci-3.01-restrict-pipeline-triggers.yml"
    excerpts:
      cli-restrict-pipeline-triggers:
        content: |
            # .circleci/config.yml
            workflows:
            build_and_test:
              jobs:
                - build
                - test:
                    requires:
                      - build
          
            deploy:
              jobs:
                - deploy_staging:
                    filters:
                      branches:
                        only: develop
                - approve_production:
                    type: approval
                    requires:
                      - deploy_staging
                    filters:
                      branches:
                        only: main
                - deploy_production:
                    requires:
                      - approve_production
                    filters:
                      branches:
                        only: main

"3.2":
  cli:
    lang: "yaml"
    filename: "hth-circleci-3.02-pipeline-security-scanning.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/cli/hth-circleci-3.02-pipeline-security-scanning.yml"
    excerpts:
      cli-pipeline-security-scanning:
        content: |
            # .circleci/config.yml
            jobs:
            security_scan:
              docker:
                - image: cimg/base:2024.01
              steps:
                - checkout
                - run:
                    name: Dependency vulnerability scan
                    command: |
                      # Install and run dependency scanner
                      npm audit --audit-level=high
                      # Or use Snyk, OWASP Dependency-Check, etc.
                - run:
                    name: Secret detection
                    command: |
                      # Detect secrets in code
                      trufflehog filesystem . --only-verified
                - run:
                    name: SAST scan
                    command: |
                      # Static analysis
                      semgrep --config=auto .
          
            workflows:
            security:
              jobs:
                - security_scan:
                    # Run on all branches
                    filters:
                      branches:
                        ignore: []

"3.3":
  cli:
    lang: "yaml"
    filename: "hth-circleci-3.03-secure-docker-images.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/cli/hth-circleci-3.03-secure-docker-images.yml"
    excerpts:
      cli-secure-docker-images:
        content: |
            # .circleci/config.yml
            jobs:
            build:
              docker:
                # Good: Use CircleCI convenience images with specific version
                - image: cimg/node:20.10.0
                # Better: Pin to digest for immutability
                - image: cimg/node@sha256:abc123...
          
                # Bad: Never use :latest
                # - image: node:latest
          
              steps:
                - checkout
                - run: npm ci  # Use ci instead of install for reproducibility

"4.1":
  api:
    lang: "bash"
    filename: "hth-circleci-4.01-runner-security-setup.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/api/hth-circleci-4.01-runner-security-setup.sh"
    excerpts:
      api-runner-security-setup:
        content: |
            # Runner machine hardening
            # - Run as non-root user
            # - Enable audit logging
            # - Network isolation
            # - Ephemeral storage
          
            # Example Docker runner setup
            docker run -d \
            --name circleci-runner \
            --security-opt no-new-privileges \
            --read-only \
            --tmpfs /tmp \
            -e CIRCLECI_RESOURCE_CLASS="company/secure-runner" \
            -e CIRCLECI_RUNNER_API_AUTH_TOKEN="${RUNNER_TOKEN}" \
            circleci/runner:latest
  cli:
    lang: "yaml"
    filename: "hth-circleci-4.01-runner-isolation.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/cli/hth-circleci-4.01-runner-isolation.yml"
    excerpts:
      cli-runner-isolation:
        content: |
            # Runner configuration
            resource_class: company/secure-runner
          
            # Use dedicated runners for production deployments
            jobs:
            deploy_production:
              machine:
                image: ubuntu-2204:current
              resource_class: company/production-runner

"5.1":
  api:
    lang: "bash"
    filename: "hth-circleci-5.01-export-audit-logs.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/circleci/api/hth-circleci-5.01-export-audit-logs.sh"
    excerpts:
      api-export-audit-logs:
        content: |
            # CircleCI API - Export audit logs
            curl -X GET "https://circleci.com/api/v2/organization/${ORG_ID}/audit-log?start-time=${START}" \
            -H "Circle-Token: ${API_TOKEN}" \
            | jq '.items[]'

