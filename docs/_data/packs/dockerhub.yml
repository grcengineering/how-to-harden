# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-18T04:05:05Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-dockerhub-1.01-enforce-mfa-and-sso.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/dockerhub/terraform/hth-dockerhub-1.01-enforce-mfa-and-sso.tf"
    excerpts:
      terraform:
        content: |
            # Configure SAML SSO for Docker Hub organization (Business plan required).
            # MFA enforcement is configured at the IdP level via SAML SSO;
            # Docker Hub does not expose a direct MFA toggle via Terraform.
            # This resource enforces SSO-based authentication for all org members.
            resource "docker_org_setting" "enforce_sso" {
            count = var.enforce_sso ? 1 : 0
          
            org_name = var.dockerhub_organization
            setting  = "sso"
            value    = "enforced"
            }
          
            # Validate SSO configuration via API using a null_resource provisioner.
            # This checks that MFA is enforced at the organization level.
            resource "null_resource" "verify_mfa_enforcement" {
            triggers = {
              org_name = var.dockerhub_organization
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Docker Hub MFA & SSO Verification ==="
                echo "Organization: ${var.dockerhub_organization}"
                echo ""
                echo "Manual verification required:"
                echo "  1. Navigate to: https://hub.docker.com/orgs/${var.dockerhub_organization}/settings/security"
                echo "  2. Confirm MFA is enforced for all members"
                echo "  3. Confirm SSO is configured (if Business plan)"
                echo ""
                echo "API check (requires authenticated session):"
                curl -sf -H "Authorization: Bearer ${var.dockerhub_token}" \
                  "https://hub.docker.com/v2/orgs/${var.dockerhub_organization}/settings" \
                  | python3 -c "
            import sys, json
            try:
              data = json.load(sys.stdin)
              print(f'  SSO enabled: {data.get(\"sso_enabled\", \"unknown\")}')
              print(f'  MFA required: {data.get(\"require_mfa\", \"unknown\")}')
            except:
              print('  Could not parse response (manual verification needed)')
            " 2>/dev/null || echo "  API check skipped (verify manually)"
              EOT
            }
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-dockerhub-1.02-implement-access-tokens.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/dockerhub/terraform/hth-dockerhub-1.02-implement-access-tokens.tf"
    excerpts:
      terraform:
        content: |
            # Create a scoped read-only access token for CI/CD pipeline pulls.
            # Access tokens replace password-based authentication for automation.
            resource "docker_hub_access_token" "ci_cd_readonly" {
            token_label = var.ci_cd_token_description
            scopes      = var.ci_cd_token_scopes
            is_active   = true
            }
          
            # Create a scoped read/write access token for build pipelines.
            # This token should be rotated monthly per the hardening guide.
            resource "docker_hub_access_token" "build_readwrite" {
            token_label = var.build_token_description
            scopes      = var.build_token_scopes
            is_active   = true
            }
          
            # Reminder for token rotation policy enforcement.
            # Docker Hub does not support automatic token expiration via API;
            # rotation must be enforced through operational procedures.
            resource "null_resource" "token_rotation_reminder" {
            triggers = {
              quarterly_check = formatdate("YYYY-QQ", timestamp())
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Docker Hub Access Token Rotation Reminder ==="
                echo ""
                echo "Token rotation schedule:"
                echo "  CI/CD pull tokens:  Rotate quarterly"
                echo "  Build/push tokens:  Rotate monthly"
                echo ""
                echo "Steps to rotate:"
                echo "  1. Create new token at: Account Settings > Security > Access Tokens"
                echo "  2. Update CI/CD pipeline secrets with new token value"
                echo "  3. Verify pipelines work with new token"
                echo "  4. Revoke the old token"
                echo ""
                echo "API endpoint for token management:"
                echo "  POST https://hub.docker.com/v2/access-tokens"
                echo "  DELETE https://hub.docker.com/v2/access-tokens/{uuid}"
              EOT
            }
          
            lifecycle {
              ignore_changes = [triggers]
            }
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-dockerhub-2.01-enable-docker-scout.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/dockerhub/terraform/hth-dockerhub-2.01-enable-docker-scout.tf"
    excerpts:
      terraform:
        content: |
            # Enable Docker Scout vulnerability scanning for organization repositories.
            # Scout provides SBOM analysis, CVE detection, and remediation recommendations.
            resource "docker_hub_repository_scout" "org_repos" {
            for_each = var.repositories
          
            namespace  = var.dockerhub_organization
            repository = each.key
            enabled    = true
            }
          
            # Automated Scout scan verification using local-exec.
            # Runs docker scout CLI to validate scanning is operational.
            resource "null_resource" "scout_scan_verification" {
            for_each = var.repositories
          
            triggers = {
              repository = each.key
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Docker Scout Verification: ${var.dockerhub_organization}/${each.key} ==="
                echo ""
                echo "Run these commands to verify Scout is active:"
                echo "  docker scout recommendations ${var.dockerhub_organization}/${each.key}:latest"
                echo "  docker scout cves ${var.dockerhub_organization}/${each.key}:latest"
                echo "  docker scout quickview ${var.dockerhub_organization}/${each.key}:latest"
                echo ""
                echo "For CI/CD integration, add to your pipeline:"
                echo "  docker scout cves --exit-code --only-severity critical,high \\"
                echo "    ${var.dockerhub_organization}/${each.key}:\$TAG"
              EOT
            }
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-dockerhub-2.02-image-signing-content-trust.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/dockerhub/terraform/hth-dockerhub-2.02-image-signing-content-trust.tf"
    excerpts:
      terraform:
        content: |
            # Docker Content Trust (DCT) enforcement for image signing.
            # Only applied at L2+ profile levels.
            # DCT uses Notary to cryptographically sign images at push time.
            resource "null_resource" "content_trust_setup" {
            count = var.profile_level >= 2 ? 1 : 0
          
            triggers = {
              organization = var.dockerhub_organization
              enabled      = var.enable_content_trust
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Docker Content Trust (DCT) Setup ==="
                echo ""
                echo "Enable DCT globally in your environment:"
                echo "  export DOCKER_CONTENT_TRUST=1"
                echo ""
                echo "Initialize signing for each repository:"
                echo "  docker trust key generate ${var.dockerhub_organization}"
                echo "  docker trust signer add --key ${var.dockerhub_organization}.pub ${var.dockerhub_organization} ${var.dockerhub_organization}/<repo>:latest"
                echo ""
                echo "Sign and push an image:"
                echo "  DOCKER_CONTENT_TRUST=1 docker push ${var.dockerhub_organization}/<repo>:latest"
                echo ""
                echo "Verify signatures:"
                echo "  docker trust inspect --pretty ${var.dockerhub_organization}/<repo>:latest"
                echo ""
                echo "CI/CD enforcement:"
                echo "  Set DOCKER_CONTENT_TRUST=1 in pipeline environment"
                echo "  Unsigned images will be rejected on pull"
              EOT
            }
            }
          
            # L3: Enforce Sigstore/Cosign signing for maximum security environments.
            # Cosign provides keyless signing via OIDC identity for stronger provenance.
            resource "null_resource" "cosign_signing_setup" {
            count = var.profile_level >= 3 ? 1 : 0
          
            triggers = {
              organization = var.dockerhub_organization
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Sigstore/Cosign Image Signing (L3 Maximum Security) ==="
                echo ""
                echo "Install cosign:"
                echo "  go install github.com/sigstore/cosign/v2/cmd/cosign@latest"
                echo ""
                echo "Keyless signing (OIDC-based):"
                echo "  cosign sign ${var.dockerhub_organization}/<repo>:latest"
                echo ""
                echo "Key-pair signing:"
                echo "  cosign generate-key-pair"
                echo "  cosign sign --key cosign.key ${var.dockerhub_organization}/<repo>:latest"
                echo ""
                echo "Verify in CI/CD:"
                echo "  cosign verify --key cosign.pub ${var.dockerhub_organization}/<repo>:latest"
                echo ""
                echo "SLSA provenance attestation:"
                echo "  cosign attest --predicate provenance.json ${var.dockerhub_organization}/<repo>:latest"
              EOT
            }
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-dockerhub-3.01-private-repository-configuration.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/dockerhub/terraform/hth-dockerhub-3.01-private-repository-configuration.tf"
    excerpts:
      terraform:
        content: |
            # Create repositories with private visibility by default.
            # Private repositories prevent unauthorized access to container images.
            resource "docker_hub_repository" "managed" {
            for_each = var.repositories
          
            namespace   = var.dockerhub_organization
            name        = each.key
            description = each.value.description
            private     = each.value.visibility == "private" ? true : false
            }
          
            # Configure team-based access to repositories.
            # Individual user permissions are avoided in favor of team-based RBAC.
            resource "docker_hub_repository_team_permission" "team_access" {
            for_each = var.team_repository_permissions
          
            org_name   = var.dockerhub_organization
            team_name  = each.key
            permission = each.value.permission
            }
          
            # Quarterly permission audit reminder.
            # Repository permissions should be reviewed quarterly per the hardening guide.
            resource "null_resource" "repository_audit_reminder" {
            triggers = {
              quarterly_check = formatdate("YYYY-QQ", timestamp())
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Docker Hub Repository Permission Audit ==="
                echo ""
                echo "Quarterly audit checklist:"
                echo "  1. Review all repository visibility settings"
                echo "  2. Verify team-based access (no individual permissions)"
                echo "  3. Remove unused or stale repositories"
                echo "  4. Check for repositories that should be private"
                echo ""
                echo "API audit command:"
                echo "  curl -s -H 'Authorization: Bearer <token>' \\"
                echo "    'https://hub.docker.com/v2/repositories/${var.dockerhub_organization}/?page_size=100' \\"
                echo "    | jq '.results[] | {name, is_private, last_updated}'"
              EOT
            }
          
            lifecycle {
              ignore_changes = [triggers]
            }
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-dockerhub-3.02-prevent-secret-exposure.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/dockerhub/terraform/hth-dockerhub-3.02-prevent-secret-exposure.tf"
    excerpts:
      terraform:
        content: |
            # Secret exposure prevention via CI/CD pipeline scanning.
            # Docker Hub images are scanned before push using local-exec hooks.
            # In 2024, researchers found 10,456 images exposing secrets on Docker Hub.
          
            # Pre-push secret scanning hook.
            # Integrates with CI/CD to scan images for embedded secrets before pushing.
            resource "null_resource" "secret_scanning_pipeline" {
            triggers = {
              organization = var.dockerhub_organization
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Docker Image Secret Scanning Setup ==="
                echo ""
                echo "Add these steps to your CI/CD pipeline BEFORE docker push:"
                echo ""
                echo "Option 1: Docker Scout (built-in):"
                echo "  docker scout cves --only-package-type gem,npm,pip <image>"
                echo ""
                echo "Option 2: Trivy (open source):"
                echo "  trivy image --scanners secret <image>"
                echo ""
                echo "Option 3: Trufflehog:"
                echo "  trufflehog docker --image <image>"
                echo ""
                echo "Dockerfile best practices:"
                echo "  - Use multi-stage builds to exclude build-time secrets"
                echo "  - Use --mount=type=secret for build arguments"
                echo "  - Never use ENV for credentials"
                echo "  - Add .dockerignore with: .env, *.pem, *.key, credentials.*"
                echo ""
                echo "Example secure Dockerfile pattern:"
                echo "  # syntax=docker/dockerfile:1"
                echo "  FROM golang:1.22 AS builder"
                echo "  RUN --mount=type=secret,id=api_key ./configure"
                echo "  FROM gcr.io/distroless/static-debian12"
                echo "  COPY --from=builder /app /app"
              EOT
            }
            }
          
            # L2+: Automated Dockerfile linting for secret patterns.
            resource "null_resource" "dockerfile_lint_setup" {
            count = var.profile_level >= 2 ? 1 : 0
          
            triggers = {
              organization = var.dockerhub_organization
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Dockerfile Security Linting (L2 Hardened) ==="
                echo ""
                echo "Add hadolint to CI/CD pipeline:"
                echo "  docker run --rm -i hadolint/hadolint < Dockerfile"
                echo ""
                echo "Key rules enforced:"
                echo "  DL3000 - Use absolute WORKDIR"
                echo "  DL3001 - No invalid CMD instructions"
                echo "  DL3002 - Do not switch to root USER"
                echo "  DL3003 - Use WORKDIR instead of cd"
                echo "  DL3006 - Always tag the version of an image"
                echo "  DL3007 - Do not use latest tag"
                echo "  DL3009 - Delete apt-get lists after install"
                echo "  DL4006 - Set SHELL option -o pipefail"
              EOT
            }
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-dockerhub-4.01-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/dockerhub/terraform/hth-dockerhub-4.01-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # Docker Hub audit log configuration and SIEM integration.
            # Audit logs track push/pull activity, permission changes, and access events.
          
            # Enable audit log export to external SIEM via webhook (Business plan).
            resource "docker_hub_org_setting" "audit_log_export" {
            count = var.audit_log_export_enabled ? 1 : 0
          
            org_name = var.dockerhub_organization
            setting  = "audit_log_export"
            value    = "enabled"
            }
          
            # Configure webhook for audit log forwarding to SIEM.
            resource "docker_hub_webhook" "audit_siem_forwarder" {
            count = var.audit_log_export_enabled && var.siem_webhook_url != "" ? 1 : 0
          
            namespace    = var.dockerhub_organization
            name         = "hth-audit-siem-forwarder"
            webhook_url  = var.siem_webhook_url
            expect_final_callback = false
          
            webhook_events = [
              "push",
              "delete",
              "repo_create",
              "repo_delete",
              "team_member_add",
              "team_member_remove",
              "org_member_add",
              "org_member_remove",
            ]
            }
          
            # Audit log monitoring queries and detection rules.
            resource "null_resource" "audit_detection_rules" {
            triggers = {
              organization = var.dockerhub_organization
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Docker Hub Audit Log Detection Rules ==="
                echo ""
                echo "Detection 1: Unusual push activity (>10 pushes/hour)"
                echo "  SQL:"
                echo "  SELECT user, repository, COUNT(*) as push_count"
                echo "  FROM docker_audit_log"
                echo "  WHERE action = 'push'"
                echo "    AND timestamp > NOW() - INTERVAL '1 hour'"
                echo "  GROUP BY user, repository"
                echo "  HAVING COUNT(*) > 10;"
                echo ""
                echo "Detection 2: Push from unknown IP"
                echo "  Monitor for push events from IPs not in known CI/CD ranges"
                echo ""
                echo "Detection 3: Repository visibility changes"
                echo "  Alert on any private-to-public visibility change"
                echo ""
                echo "Detection 4: New organization member additions"
                echo "  Alert on org_member_add events for review"
                echo ""
                echo "API endpoint for audit logs (Business plan):"
                echo "  GET https://hub.docker.com/v2/auditlogs/${var.dockerhub_organization}/"
              EOT
            }
            }
          
            # L2+: Enhanced monitoring with anomaly detection thresholds.
            resource "null_resource" "enhanced_monitoring" {
            count = var.profile_level >= 2 ? 1 : 0
          
            triggers = {
              organization = var.dockerhub_organization
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "=== Enhanced Docker Hub Monitoring (L2 Hardened) ==="
                echo ""
                echo "Additional detection rules for L2+:"
                echo ""
                echo "  1. Image pull anomaly: Alert when pull count exceeds 3x baseline"
                echo "  2. Off-hours push: Alert on pushes outside business hours"
                echo "  3. Token creation: Alert on new access token creation"
                echo "  4. Permission escalation: Alert on team permission changes"
                echo "  5. Failed authentication: Alert on >5 failed logins in 10 minutes"
                echo ""
                echo "Recommended SIEM correlation rules:"
                echo "  - Correlate Docker Hub events with CI/CD pipeline logs"
                echo "  - Cross-reference push source IPs with known infrastructure"
                echo "  - Alert on push events without corresponding CI/CD job"
              EOT
            }
            }

