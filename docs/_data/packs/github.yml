# AUTO-GENERATED by scripts/sync-packs-to-data.sh — do not edit manually
# Generated: 2026-02-20T08:34:36Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-github-1.01-enforce-2fa-for-org-members.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.01-enforce-2fa-for-org-members.tf"
    excerpts:
      terraform:
        content: |
            resource "github_organization_settings" "security" {
            billing_email                      = var.github_organization
            two_factor_requirement             = true
            }
  api:
    lang: "bash"
    filename: "hth-github-1.01-enforce-2fa-for-org-members.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.01-enforce-2fa-for-org-members.sh"
    excerpts:
      api-enforce-2fa:
        content: |
            # Enable two-factor authentication requirement for the organization
            info "1.01 Enabling 2FA requirement for org ${GITHUB_ORG}..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "two_factor_requirement_enabled": true
            }') || {
            fail "1.01 Failed to enable 2FA requirement -- may require owner permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-1.01-enforce-2fa-for-org-members.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.01-enforce-2fa-for-org-members.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.disable_two_factor_requirement'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-github-1.02-restrict-default-repository-permissions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.02-restrict-default-repository-permissions.tf"
    excerpts:
      terraform:
        content: |
            resource "github_organization_settings" "permissions" {
            billing_email                      = var.github_organization
            default_repository_permission      = "read"
            }
  api:
    lang: "bash"
    filename: "hth-github-1.02-restrict-default-repository-permissions.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.02-restrict-default-repository-permissions.sh"
    excerpts:
      api-set-default-permissions:
        content: |
            # Restrict default repository permission to read-only
            info "1.02 Setting default repository permission to 'read'..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "default_repository_permission": "read"
            }') || {
            fail "1.02 Failed to set default repository permission"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-1.02-restrict-default-repository-permissions.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.02-restrict-default-repository-permissions.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.update_default_repository_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.3":
  terraform:
    lang: "hcl"
    filename: "hth-github-1.03-restrict-repository-creation.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.03-restrict-repository-creation.tf"
    excerpts:
      terraform:
        content: |
            resource "github_organization_settings" "repo_creation" {
            billing_email                           = var.github_organization
            members_can_create_public_repositories  = false
            }
  api:
    lang: "bash"
    filename: "hth-github-1.03-restrict-repository-creation.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.03-restrict-repository-creation.sh"
    excerpts:
      api-disable-public-repos:
        content: |
            # Disable member ability to create public repositories
            info "1.03 Disabling public repository creation..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "members_can_create_public_repositories": false
            }') || {
            fail "1.03 Failed to disable public repository creation"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-1.03-restrict-repository-creation.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.03-restrict-repository-creation.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.update_member_repository_creation_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.4":
  terraform:
    lang: "hcl"
    filename: "hth-github-1.04-disable-private-fork-creation.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.04-disable-private-fork-creation.tf"
    excerpts:
      terraform:
        content: |
            resource "github_organization_settings" "forking" {
            billing_email                           = var.github_organization
            members_can_fork_private_repositories   = false
            }
  api:
    lang: "bash"
    filename: "hth-github-1.04-disable-private-fork-creation.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.04-disable-private-fork-creation.sh"
    excerpts:
      api-disable-private-forking:
        content: |
            # Disable member ability to fork private repositories
            info "1.04 Disabling private repository forking..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "members_can_fork_private_repositories": false
            }') || {
            fail "1.04 Failed to disable private repository forking"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-1.04-disable-private-fork-creation.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.04-disable-private-fork-creation.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.update_member_repository_forking_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.5":
  terraform:
    lang: "hcl"
    filename: "hth-github-1.05-require-commit-signoff.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.05-require-commit-signoff.tf"
    excerpts:
      terraform:
        content: |
            resource "github_organization_settings" "commit_signoff" {
            billing_email                      = var.github_organization
            web_commit_signoff_required        = true
            }
  api:
    lang: "bash"
    filename: "hth-github-1.05-require-commit-signoff.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.05-require-commit-signoff.sh"
    excerpts:
      api-require-signoff:
        content: |
            # Enable web commit sign-off requirement at the organization level
            info "1.05 Enabling web commit sign-off requirement..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "web_commit_signoff_required": true
            }') || {
            fail "1.05 Failed to enable web commit sign-off requirement"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-1.05-require-commit-signoff.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.05-require-commit-signoff.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.update_default_repository_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.6":
  terraform:
    lang: "hcl"
    filename: "hth-github-1.06-restrict-org-member-repository-deletion.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.06-restrict-org-member-repository-deletion.tf"
    excerpts:
      terraform:
        content: |
            resource "github_organization_settings" "repo_deletion" {
            billing_email                      = var.github_organization
            default_repository_permission      = "read"
            members_can_create_repositories    = false
            }
  api:
    lang: "bash"
    filename: "hth-github-1.06-restrict-org-member-repository-deletion.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.06-restrict-org-member-repository-deletion.sh"
    excerpts:
      api-restrict-repo-deletion:
        content: |
            # Restrict repository creation and set default permission to read-only
            info "1.06 Restricting repository creation and default permissions..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "default_repository_permission": "read",
            "members_can_create_repositories": false
            }') || {
            fail "1.06 Failed to restrict repository creation and permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-1.06-restrict-org-member-repository-deletion.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.06-restrict-org-member-repository-deletion.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repo.destroy'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.7":
  api:
    lang: "bash"
    filename: "hth-github-1.07-configure-ip-allow-list.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.07-configure-ip-allow-list.sh"
    excerpts:
      api-configure-ip-allowlist:
        content: |
            # List current IP allow list entries
            info "1.07 Listing IP allow list entries for ${GITHUB_ORG}..."
            ENTRIES=$(gh_get "/orgs/${GITHUB_ORG}/ip-allow-list") || {
            fail "1.07 Unable to retrieve IP allow list"
            increment_failed
            summary
            exit 0
            }
            echo "${ENTRIES}" | jq '.[] | {name: .name, value: .value, is_active: .is_active}'
          
            # Add IP range (idempotent — checks if already exists)
            add_ip_entry() {
            local name="$1" value="$2"
            local existing
            existing=$(echo "${ENTRIES}" | jq -r --arg v "${value}" '.[] | select(.value == $v) | .id')
            if [ -n "${existing}" ]; then
              pass "1.07 IP entry '${name}' (${value}) already exists"
              return
            fi
            gh_post "/orgs/${GITHUB_ORG}/ip-allow-list" "{
              \"name\": \"${name}\",
              \"value\": \"${value}\",
              \"is_active\": true
            }" || {
              fail "1.07 Failed to add IP entry '${name}' (${value})"
              return
            }
            pass "1.07 Added IP entry '${name}' (${value})"
            }

"1.8":
  api:
    lang: "bash"
    filename: "hth-github-1.08-audit-admin-access.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.08-audit-admin-access.sh"
    excerpts:
      api-audit-admins:
        content: |
            # List organization admins
            info "1.08 Listing organization admins for ${GITHUB_ORG}..."
            ADMINS=$(gh_get "/orgs/${GITHUB_ORG}/members?role=admin") || {
            fail "1.08 Unable to retrieve admin list"
            increment_failed
            summary
            exit 0
            }
          
            ADMIN_COUNT=$(echo "${ADMINS}" | jq '. | length')
            echo "${ADMINS}" | jq -r '.[].login'
            info "1.08 Found ${ADMIN_COUNT} admin(s)"
          
            # Audit admin actions in audit log
            info "1.08 Checking recent admin role changes..."
            gh_get "/orgs/${GITHUB_ORG}/audit-log?phrase=action:org.update_member" \
            | jq '.[] | {actor: .actor, action: .action, created_at: .created_at}'

"1.9":
  api:
    lang: "bash"
    filename: "hth-github-1.09-monitor-2fa-compliance.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.09-monitor-2fa-compliance.sh"
    excerpts:
      api-monitor-2fa-compliance:
        content: |
            # Daily check for non-compliant members
            gh api /orgs/{org}/members?filter=2fa_disabled --jq 'length'
            # Expected: 0
            # If > 0, alert security team

"1.10":
  api:
    lang: "bash"
    filename: "hth-github-1.10-verify-saml-sso-status.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.10-verify-saml-sso-status.sh"
    excerpts:
      api-verify-saml-sso:
        content: |
            # Enable SAML SSO (requires Enterprise Cloud)
            # Configuration done via GitHub web UI + IdP
            # API can verify status:
          
            gh api /orgs/{org} --jq '.saml_identity_provider'

"1.11":
  api:
    lang: "bash"
    filename: "hth-github-1.11-monitor-admin-privilege-escalation.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.11-monitor-admin-privilege-escalation.sh"
    excerpts:
      api-monitor-privilege-escalation:
        content: |
            # Monitor for privilege escalation
            gh api /orgs/{org}/audit-log?phrase=action:org.update_member_role \
            --jq '.[] | select(.role == "admin") | {actor: .actor, user: .user, created_at: .created_at}'

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-github-2.01-enable-secret-scanning.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.01-enable-secret-scanning.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden_secrets" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_push_protection {
                status = "enabled"
              }
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-2.01-enable-secret-scanning.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.01-enable-secret-scanning.sh"
    excerpts:
      api-enable-secret-scanning:
        content: |
            # Enable secret scanning and push protection on the repository
            info "2.01 Enabling secret scanning and push protection..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning": { "status": "enabled" },
              "secret_scanning_push_protection": { "status": "enabled" }
            }
            }') || {
            fail "2.01 Failed to enable secret scanning -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-2.01-enable-secret-scanning.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.01-enable-secret-scanning.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repository_secret_scanning.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-github-2.02-enable-dependabot-security-updates.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.02-enable-dependabot-security-updates.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden_dependabot" {
            name               = var.repository_name
            vulnerability_alerts = true
            }
  api:
    lang: "bash"
    filename: "hth-github-2.02-enable-dependabot-security-updates.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.02-enable-dependabot-security-updates.sh"
    excerpts:
      api-enable-dependabot:
        content: |
            # Enable Dependabot vulnerability alerts and security updates
            info "2.02 Enabling vulnerability alerts and Dependabot security updates..."
            curl -sf -X PUT "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" || {
            fail "2.02 Failed to enable vulnerability alerts"
            increment_failed
            summary
            exit 0
            }
          
            curl -sf -X PUT "${GH_API}/repos/${GITHUB_ORG}/${REPO}/automated-security-fixes" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" || {
            fail "2.02 Failed to enable Dependabot security updates"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-2.02-enable-dependabot-security-updates.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.02-enable-dependabot-security-updates.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repository_vulnerability_alert.dismiss'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"2.3":
  terraform:
    lang: "hcl"
    filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.03-enable-secret-scanning-non-provider-patterns.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden_non_provider" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_non_provider_patterns {
                status = "enabled"
              }
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.03-enable-secret-scanning-non-provider-patterns.sh"
    excerpts:
      api-enable-non-provider-patterns:
        content: |
            # Enable secret scanning for non-provider patterns (generic secrets, passwords, keys)
            info "2.03 Enabling non-provider pattern scanning..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning_non_provider_patterns": { "status": "enabled" }
            }
            }') || {
            fail "2.03 Failed to enable non-provider patterns -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.03-enable-secret-scanning-non-provider-patterns.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection_pattern_delete:
                    action: 'repository_secret_scanning_custom_pattern.delete'
                selection_scanning_disable:
                    action: 'repository_secret_scanning.disable'
                condition: selection_pattern_delete or selection_scanning_disable
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"2.4":
  terraform:
    lang: "hcl"
    filename: "hth-github-2.04-enable-secret-scanning-validity-checks.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.04-enable-secret-scanning-validity-checks.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden_validity" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_validity_checks {
                status = "enabled"
              }
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-2.04-enable-secret-scanning-validity-checks.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.04-enable-secret-scanning-validity-checks.sh"
    excerpts:
      api-enable-validity-checks:
        content: |
            # Enable secret scanning validity checks to verify if detected secrets are still active
            info "2.04 Enabling secret scanning validity checks..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning_validity_checks": { "status": "enabled" }
            }
            }') || {
            fail "2.04 Failed to enable validity checks -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-2.04-enable-secret-scanning-validity-checks.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.04-enable-secret-scanning-validity-checks.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repository_secret_scanning.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"2.5":
  api:
    lang: "bash"
    filename: "hth-github-2.05-configure-org-rulesets.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.05-configure-org-rulesets.sh"
    excerpts:
      api-create-ruleset:
        content: |
            # Create organization ruleset via API
            info "2.05 Creating production branch protection ruleset..."
            RESPONSE=$(gh_post "/orgs/${GITHUB_ORG}/rulesets" '{
            "name": "Production Branch Protection",
            "enforcement": "active",
            "target": "branch",
            "conditions": {
              "ref_name": {
                "include": ["refs/heads/main", "refs/heads/master", "refs/heads/release/*"],
                "exclude": []
              }
            },
            "rules": [
              {"type": "deletion"},
              {"type": "non_fast_forward"},
              {"type": "pull_request", "parameters": {"required_approving_review_count": 2, "dismiss_stale_reviews_on_push": true, "require_code_owner_review": true}},
              {"type": "required_signatures"}
            ]
            }') || {
            fail "2.05 Failed to create ruleset -- may already exist or require admin permissions"
            increment_failed
            summary
            exit 0
            }
          
            # List existing rulesets
            info "2.05 Current rulesets:"
            gh_get "/orgs/${GITHUB_ORG}/rulesets" \
            | jq '.[] | {name: .name, enforcement: .enforcement}'

"2.7":
  api:
    lang: "bash"
    filename: "hth-github-2.07-monitor-security-alerts.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.07-monitor-security-alerts.sh"
    excerpts:
      api-list-dependabot-alerts:
        content: |
            # List critical/high severity alerts
            gh api /orgs/{org}/dependabot/alerts --jq '.[] | select(.severity == "critical" or .severity == "high") | {repo: .repository.name, package: .security_advisory.package.name, severity: .severity}'
      api-list-secret-scanning-alerts:
        content: |
            # List active secret alerts
            gh api /orgs/{org}/secret-scanning/alerts?state=open --jq '.[] | {repo: .repository.name, secret_type: .secret_type, created_at: .created_at}'

"2.8":
  cli:
    lang: "bash"
    filename: "hth-github-2.08-configure-commit-signing.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-2.08-configure-commit-signing.sh"
    excerpts:
      cli-configure-commit-signing:
        content: |
            # Configure Git to sign commits with SSH key
            git config --global gpg.format ssh
            git config --global user.signingkey ~/.ssh/id_ed25519.pub
            git config --global commit.gpgsign true
          
            # Configure Git to sign commits with GPG key
            git config --global user.signingkey YOUR_GPG_KEY_ID
            git config --global commit.gpgsign true
          
            # Verify a signed commit
            git log --show-signature -1

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-github-3.01-enable-branch-protection-on-default-branch.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.01-enable-branch-protection-on-default-branch.tf"
    excerpts:
      terraform:
        content: |
            resource "github_branch_protection" "main" {
            repository_id = var.repository_id
            pattern       = "main"
            enforce_admins = true
          
            required_pull_request_reviews {
              required_approving_review_count = 1
              dismiss_stale_reviews           = true
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-3.01-enable-branch-protection-on-default-branch.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.01-enable-branch-protection-on-default-branch.sh"
    excerpts:
      api-enable-branch-protection:
        content: |
            # Enable branch protection with required reviews, dismiss stale, and enforce admins
            info "3.01 Enabling branch protection on '${DEFAULT_BRANCH}'..."
            RESPONSE=$(gh_put "/repos/${GITHUB_ORG}/${REPO}/branches/${DEFAULT_BRANCH}/protection" '{
            "required_status_checks": null,
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true
            },
            "restrictions": null
            }') || {
            fail "3.01 Failed to enable branch protection"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-3.01-enable-branch-protection-on-default-branch.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.01-enable-branch-protection-on-default-branch.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'protected_branch.destroy'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-github-3.02-restrict-actions-to-verified-creators.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.02-restrict-actions-to-verified-creators.tf"
    excerpts:
      terraform:
        content: |
            resource "github_actions_repository_permissions" "how_to_harden_actions" {
            repository      = var.repository_name
            enabled         = true
            allowed_actions = "selected"
          
            allowed_actions_config {
              github_owned_allowed = true
              verified_allowed     = true
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-3.02-restrict-actions-to-verified-creators.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.02-restrict-actions-to-verified-creators.sh"
    excerpts:
      api-restrict-actions:
        content: |
            # Restrict GitHub Actions to only selected (verified) creators
            info "3.02 Restricting Actions to selected creators..."
            RESPONSE=$(gh_put "/repos/${GITHUB_ORG}/${REPO}/actions/permissions" '{
            "enabled": true,
            "allowed_actions": "selected"
            }') || {
            fail "3.02 Failed to restrict Actions permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-3.02-restrict-actions-to-verified-creators.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.02-restrict-actions-to-verified-creators.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repo.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"3.3":
  terraform:
    lang: "hcl"
    filename: "hth-github-3.03-pin-actions-to-sha.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.03-pin-actions-to-sha.tf"
    excerpts:
      terraform:
        content: |
            # NOTE: SHA pinning is enforced at the workflow file level, not via a dedicated
            # Terraform resource. This control restricts allowed actions to "selected" so
            # that only explicitly approved actions (pinned to SHA in workflow YAML) can run.
            resource "github_actions_repository_permissions" "how_to_harden_sha_pinning" {
            repository      = var.repository_name
            enabled         = true
            allowed_actions = "selected"
            }
  api:
    lang: "bash"
    filename: "hth-github-3.03-pin-actions-to-sha.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.03-pin-actions-to-sha.sh"
    excerpts:
      api-audit-sha-pinning:
        content: |
            # Audit: Check workflow files for actions not pinned to full SHA
            # Note: SHA pinning cannot be enforced via API -- workflows must be manually updated
            # Recommended tool: npx pin-github-action .github/workflows/*.yml
            info "3.03 Retrieving workflow files..."
            WORKFLOWS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/.github/workflows" 2>/dev/null) || {
            warn "3.03 No .github/workflows directory found -- no workflows to audit"
            increment_applied
            summary
            exit 0
            }
          
            WORKFLOW_COUNT=$(echo "${WORKFLOWS}" | jq '. | length' 2>/dev/null || echo "0")
            info "3.03 Found ${WORKFLOW_COUNT} workflow file(s)"
          
            if [ "${WORKFLOW_COUNT}" = "0" ]; then
            pass "3.03 No workflow files found -- nothing to pin"
            increment_applied
            summary
            exit 0
            fi
          
            # Check each workflow for tag-based action references (not SHA-pinned)
            UNPINNED=0
            for NAME in $(echo "${WORKFLOWS}" | jq -r '.[].name' 2>/dev/null); do
            CONTENT=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/.github/workflows/${NAME}" \
              | jq -r '.content // empty' 2>/dev/null | base64 -d 2>/dev/null || true)
            if [ -n "${CONTENT}" ]; then
              # Look for uses: owner/action@v* or @tag patterns (not 40-char SHA)
              TAG_REFS=$(echo "${CONTENT}" | grep -cE 'uses:\s+\S+@v[0-9]' 2>/dev/null || true)
              if [ "${TAG_REFS}" -gt 0 ] 2>/dev/null; then
                warn "3.03 ${NAME}: ${TAG_REFS} action(s) pinned to tag instead of SHA"
                UNPINNED=$((UNPINNED + TAG_REFS))
              fi
            fi
            done
  sigma:
    - lang: "yaml"
      filename: "hth-github-3.03-pin-actions-to-sha.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.03-pin-actions-to-sha.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repo.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"3.4":
  terraform:
    lang: "hcl"
    filename: "hth-github-3.04-restrict-org-actions-permissions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.04-restrict-org-actions-permissions.tf"
    excerpts:
      terraform:
        content: |
            # NOTE: The github_actions_organization_permissions resource controls which
            # Actions are allowed to run across the entire organization. This restricts
            # all repositories to only GitHub-owned and Marketplace-verified actions.
            resource "github_actions_organization_permissions" "hardened" {
            allowed_actions = "selected"
            enabled_repositories = "all"
          
            allowed_actions_config {
              github_owned_allowed = true
              verified_allowed     = true
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-3.04-restrict-org-actions-permissions.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.04-restrict-org-actions-permissions.sh"
    excerpts:
      api-restrict-org-actions:
        content: |
            # Restrict organization-level GitHub Actions to selected (verified) creators only
            info "3.04 Restricting org-level Actions to selected creators..."
            RESPONSE=$(gh_put "/orgs/${GITHUB_ORG}/actions/permissions" '{
            "enabled_repositories": "all",
            "allowed_actions": "selected"
            }') || {
            fail "3.04 Failed to restrict org Actions permissions"
            increment_failed
            summary
            exit 0
            }
  cli:
    lang: "yaml"
    filename: "hth-github-3.04-workflow-permissions-template.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-3.04-workflow-permissions-template.yml"
    excerpts:
      cli-workflow-permissions-template:
        content: |
            name: CI
          
            on: [push, pull_request]
          
            permissions:
            contents: read       # Read code
            pull-requests: write # Comment on PRs (if needed)
            # Omit permissions not needed
          
            jobs:
            test:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744
                - run: npm test
  sigma:
    - lang: "yaml"
      filename: "hth-github-3.04-restrict-org-actions-permissions.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.04-restrict-org-actions-permissions.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"3.5":
  terraform:
    lang: "hcl"
    filename: "hth-github-3.05-enable-code-scanning-default-setup.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.05-enable-code-scanning-default-setup.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden_code_scanning" {
            name = var.repository_name
          
            security_and_analysis {
              advanced_security {
                status = "enabled"
              }
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-3.05-enable-code-scanning-default-setup.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.05-enable-code-scanning-default-setup.sh"
    excerpts:
      api-enable-code-scanning:
        content: |
            # Enable CodeQL code scanning with the default query suite
            info "3.05 Enabling code scanning default setup..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}/code-scanning/default-setup" '{
            "state": "configured",
            "query_suite": "default"
            }') || {
            fail "3.05 Failed to enable code scanning -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
  cli:
    lang: "yaml"
    filename: "hth-github-3.05-codeql-advanced-workflow.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-3.05-codeql-advanced-workflow.yml"
    excerpts:
      cli-codeql-advanced-workflow:
        content: |
            name: "CodeQL"
            on:
            push:
              branches: [ "main" ]
            pull_request:
              branches: [ "main" ]
            schedule:
              - cron: '0 0 * * 1'
          
            jobs:
            analyze:
              name: Analyze
              runs-on: ubuntu-latest
              permissions:
                actions: read
                contents: read
                security-events: write
          
              strategy:
                fail-fast: false
                matrix:
                  language: [ 'javascript', 'python' ]
          
              steps:
              - name: Checkout repository
                uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
          
              - name: Initialize CodeQL
                uses: github/codeql-action/init@v3
                with:
                  languages: ${{ matrix.language }}
                  queries: security-extended
          
              - name: Autobuild
                uses: github/codeql-action/autobuild@v3
          
              - name: Perform CodeQL Analysis
                uses: github/codeql-action/analyze@v3
  sigma:
    - lang: "yaml"
      filename: "hth-github-3.05-enable-code-scanning-default-setup.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.05-enable-code-scanning-default-setup.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repository_code_scanning_default_setup.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"3.6":
  terraform:
    lang: "hcl"
    filename: "hth-github-3.06-require-codeowners-file.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.06-require-codeowners-file.tf"
    excerpts:
      terraform:
        content: |
            # NOTE: The CODEOWNERS file itself must be committed to the repository
            # (e.g., .github/CODEOWNERS). This Terraform resource enforces that
            # pull requests require approval from designated code owners before merge.
            resource "github_branch_protection" "main_codeowners" {
            repository_id = var.repository_id
            pattern       = "main"
          
            required_pull_request_reviews {
              require_code_owner_reviews = true
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-3.06-require-codeowners-file.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.06-require-codeowners-file.sh"
    excerpts:
      api-audit-codeowners:
        content: |
            # Audit: Check for CODEOWNERS file in standard locations
            # Note: CODEOWNERS must be committed to the repo -- cannot be created via API
            FOUND=false
          
            for LOCATION in ".github/CODEOWNERS" "CODEOWNERS" "docs/CODEOWNERS"; do
            CONTENT=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/${LOCATION}" 2>/dev/null) || continue
            HAS_NAME=$(echo "${CONTENT}" | jq -r 'has("name")' 2>/dev/null || echo "false")
            if [ "${HAS_NAME}" = "true" ]; then
              pass "3.06 CODEOWNERS file found at ${LOCATION}"
              FOUND=true
              break
            fi
            done
  sigma:
    - lang: "yaml"
      filename: "hth-github-3.06-require-codeowners-file.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.06-require-codeowners-file.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'protected_branch.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"3.7":
  terraform:
    lang: "hcl"
    filename: "hth-github-3.07-require-signed-commits.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.07-require-signed-commits.tf"
    excerpts:
      terraform:
        content: |
            resource "github_branch_protection" "main_signed" {
            repository_id          = var.repository_id
            pattern                = "main"
            require_signed_commits = true
            }
  api:
    lang: "bash"
    filename: "hth-github-3.07-require-signed-commits.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.07-require-signed-commits.sh"
    excerpts:
      api-audit-signed-commits:
        content: |
            # Audit: Check recent commits for GPG/SSH signature verification
            # Note: Commit signing is per-developer; enforcement is via branch protection rules
            info "3.07 Checking recent commit signatures..."
            COMMITS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/commits?per_page=10") || {
            fail "3.07 Unable to retrieve commits for ${GITHUB_ORG}/${REPO}"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL=$(echo "${COMMITS}" | jq '. | length' 2>/dev/null || echo "0")
            VERIFIED=$(echo "${COMMITS}" | jq '[.[] | select(.commit.verification.verified == true)] | length' 2>/dev/null || echo "0")
            UNVERIFIED=$((TOTAL - VERIFIED))
          
            info "3.07 Checked ${TOTAL} recent commits: ${VERIFIED} signed, ${UNVERIFIED} unsigned"
          
            # Check if branch protection enforces signed commits
            REPO_META=$(gh_get "/repos/${GITHUB_ORG}/${REPO}") || true
            DEFAULT_BRANCH=$(echo "${REPO_META}" | jq -r '.default_branch // "main"' 2>/dev/null)
          
            SIGNATURE_REQUIRED="false"
            PROTECTION=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/branches/${DEFAULT_BRANCH}/protection/required_signatures" 2>/dev/null) && {
            SIGNATURE_REQUIRED=$(echo "${PROTECTION}" | jq -r '.enabled // false' 2>/dev/null || echo "false")
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-3.07-require-signed-commits.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.07-require-signed-commits.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'protected_branch.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"3.8":
  api:
    lang: "bash"
    filename: "hth-github-3.08-audit-workflow-actions.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.08-audit-workflow-actions.sh"
    excerpts:
      api-audit-actions:
        content: |
            # Scan all org repos for non-allowed actions
            info "3.08 Scanning org workflows for unapproved actions..."
            REPOS=$(gh_get "/orgs/${GITHUB_ORG}/repos?per_page=100" | jq -r '.[].name') || {
            fail "3.08 Unable to list repositories"
            increment_failed
            summary
            exit 0
            }
          
            for repo in ${REPOS}; do
            WORKFLOWS=$(gh_get "/repos/${GITHUB_ORG}/${repo}/actions/workflows" \
              | jq -r '.workflows[].path' 2>/dev/null) || continue
            for workflow in ${WORKFLOWS}; do
              CONTENT=$(gh_get "/repos/${GITHUB_ORG}/${repo}/contents/${workflow}" \
                | jq -r '.content' 2>/dev/null | base64 -d 2>/dev/null) || continue
              UNAPPROVED=$(echo "${CONTENT}" | grep -oP 'uses:\s+\K[^\s]+' \
                | grep -v '^actions/' | grep -v '^github/' || true)
              if [ -n "${UNAPPROVED}" ]; then
                warn "3.08 ${repo}/${workflow}: ${UNAPPROVED}"
              fi
            done
            done

"3.9":
  api:
    lang: "bash"
    filename: "hth-github-3.09-configure-runner-groups.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.09-configure-runner-groups.sh"
    excerpts:
      api-configure-runners:
        content: |
            # List runner groups
            info "3.09 Listing runner groups for ${GITHUB_ORG}..."
            GROUPS=$(gh_get "/orgs/${GITHUB_ORG}/actions/runner-groups") || {
            fail "3.09 Unable to retrieve runner groups"
            increment_failed
            summary
            exit 0
            }
            echo "${GROUPS}" | jq '.runner_groups[] | {name: .name, id: .id, visibility: .visibility}'
          
            # Create a runner group with restricted repository access
            info "3.09 Creating production runner group..."
            gh_post "/orgs/${GITHUB_ORG}/actions/runner-groups" '{
            "name": "production-runners",
            "visibility": "selected",
            "allows_public_repositories": false
            }' || {
            warn "3.09 Failed to create runner group -- may already exist"
            }
          
            # List runners in a group
            GROUP_ID=$(echo "${GROUPS}" | jq -r '.runner_groups[] | select(.name == "production-runners") | .id')
            if [ -n "${GROUP_ID}" ]; then
            gh_get "/orgs/${GITHUB_ORG}/actions/runner-groups/${GROUP_ID}/runners" \
              | jq '.runners[] | {name: .name, status: .status}'
            fi

"3.10":
  sdk:
    lang: "python"
    filename: "hth-github-3.10-bulk-branch-protection.py"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/sdk/hth-github-3.10-bulk-branch-protection.py"
    excerpts:
      sdk-bulk-protect:
        content: |
            from github import Github
            import os
          
            g = Github(os.environ['GITHUB_TOKEN'])
            org = g.get_organization(os.environ.get('GITHUB_ORG', 'your-org'))
          
            PROTECTED_BRANCHES = ['main', 'master', 'production', 'release']
          
            for repo in org.get_repos():
              print(f"Processing: {repo.name}")
          
              for branch_name in PROTECTED_BRANCHES:
                  try:
                      branch = repo.get_branch(branch_name)
          
                      # Apply protection
                      branch.edit_protection(
                          strict=True,
                          contexts=["ci/test"],
                          enforce_admins=True,
                          dismiss_stale_reviews=True,
                          require_code_owner_reviews=True,
                          required_approving_review_count=1
                      )
          
                      print(f"  Protected: {branch_name}")
                  except Exception as e:
                      print(f"  Skipped {branch_name}: {e}")

"3.11":
  cli:
    lang: "yaml"
    filename: "hth-github-3.11-dependabot-actions-config.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-3.11-dependabot-actions-config.yml"
    excerpts:
      cli-dependabot-actions:
        content: |
            version: 2
            updates:
            - package-ecosystem: "github-actions"
              directory: "/"
              schedule:
                interval: "weekly"

"3.13":
  cli:
    lang: "yaml"
    filename: "hth-github-3.13-pin-actions-examples.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-3.13-pin-actions-examples.yml"
    excerpts:
      cli-pin-actions-bad-example:
        content: |
            # Bad: Tag can be repointed
            - uses: actions/checkout@v3  # Tag can be repointed
      cli-pin-actions-good-example:
        content: |
            # Good: SHA is immutable
            - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744  # SHA

"3.14":
  cli:
    lang: "yaml"
    filename: "hth-github-3.14-workflow-permission-examples.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-3.14-workflow-permission-examples.yml"
    excerpts:
      cli-workflow-explicit-permissions:
        content: |
            # .github/workflows/ci.yml
          
            name: CI
          
            on: [push, pull_request]
          
            permissions:
            contents: read       # Read code
            pull-requests: write # Comment on PRs (if needed)
            # Omit permissions not needed
          
            jobs:
            test:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744
                - run: npm test
      cli-permissions-read-only:
        content: |
            permissions:
            contents: read
      cli-permissions-build-test-pr:
        content: |
            permissions:
            contents: read
            pull-requests: write
            statuses: write
      cli-permissions-release-publish:
        content: |
            permissions:
            contents: write      # Create releases
            packages: write      # Publish to GitHub Packages
            id-token: write      # OIDC token for signing
      cli-permissions-security-scanning:
        content: |
            permissions:
            contents: read
            security-events: write  # Upload SARIF results

"3.15":
  api:
    lang: "bash"
    filename: "hth-github-3.15-audit-workflow-permissions.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.15-audit-workflow-permissions.sh"
    excerpts:
      api-audit-workflow-permissions:
        content: |
            # Find workflows with 'write-all' or missing permissions
            find .github/workflows -name "*.yml" -exec grep -L "permissions:" {} \;

"3.16":
  api:
    lang: "bash"
    filename: "hth-github-3.16-workflow-approval-contributors.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.16-workflow-approval-contributors.sh"
    excerpts:
      api-workflow-approval-contributors:
        content: |
            # This setting is per-repository, configured via UI
            # Can be enforced via organization policy requiring repos to enable it

"3.17":
  cli:
    lang: "yaml"
    filename: "hth-github-3.17-ephemeral-runner-config.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-3.17-ephemeral-runner-config.yml"
    excerpts:
      cli-ephemeral-runner-config:
        content: |
            # .github/workflows/deploy.yml
            jobs:
            deploy:
              runs-on: [self-hosted, production, ephemeral]
              environment: production
              steps:
                - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744
                - run: ./deploy.sh

"3.18":
  api:
    lang: "bash"
    filename: "hth-github-3.18-pin-actions-automation.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.18-pin-actions-automation.sh"
    excerpts:
      api-pin-actions-automation:
        content: |
            # Use https://github.com/mheap/pin-github-action
            npx pin-github-action .github/workflows/*.yml

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-github-4.01-enable-vulnerability-alerts.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-4.01-enable-vulnerability-alerts.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden_vuln_alerts" {
            name               = var.repository_name
            vulnerability_alerts = true
            }
  api:
    lang: "bash"
    filename: "hth-github-4.01-enable-vulnerability-alerts.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.01-enable-vulnerability-alerts.sh"
    excerpts:
      api-check-vulnerability-alerts:
        content: |
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X GET \
            "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28")
      api-enable-vulnerability-alerts:
        content: |
            # Enable Dependabot vulnerability alerts on the repository
            info "4.01 Enabling vulnerability alerts..."
            ENABLE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
            "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28")
  sigma:
    - lang: "yaml"
      filename: "hth-github-4.01-enable-vulnerability-alerts.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.01-enable-vulnerability-alerts.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repository_vulnerability_alerts.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"4.2":
  api:
    lang: "bash"
    filename: "hth-github-4.02-review-open-dependabot-alerts.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.02-review-open-dependabot-alerts.sh"
    excerpts:
      api-audit-dependabot-alerts:
        content: |
            # Audit: Check for critical and high severity open Dependabot alerts
            info "4.02 Checking critical Dependabot alerts..."
            CRITICAL_ALERTS=$(gh_get "/orgs/${GITHUB_ORG}/dependabot/alerts?state=open&severity=critical&per_page=100" 2>/dev/null) || {
            warn "4.02 Unable to query Dependabot alerts (may require security_events scope)"
            CRITICAL_ALERTS="[]"
            }
            CRITICAL_COUNT=$(echo "${CRITICAL_ALERTS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "4.02 Checking high severity Dependabot alerts..."
            HIGH_ALERTS=$(gh_get "/orgs/${GITHUB_ORG}/dependabot/alerts?state=open&severity=high&per_page=100" 2>/dev/null) || {
            warn "4.02 Unable to query high severity Dependabot alerts"
            HIGH_ALERTS="[]"
            }
            HIGH_COUNT=$(echo "${HIGH_ALERTS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "4.02 Open alerts -- Critical: ${CRITICAL_COUNT}, High: ${HIGH_COUNT}"
          
            # List affected repositories for critical alerts
            if [ "${CRITICAL_COUNT}" -gt 0 ]; then
            warn "4.02 Repositories with critical alerts:"
            echo "${CRITICAL_ALERTS}" | jq -r '.[].repository.full_name' 2>/dev/null | sort -u | while read -r REPO_NAME; do
              COUNT=$(echo "${CRITICAL_ALERTS}" | jq -r "[.[] | select(.repository.full_name == \"${REPO_NAME}\")] | length" 2>/dev/null)
              warn "4.02   ${REPO_NAME}: ${COUNT} critical alert(s)"
            done
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-github-4.02-review-open-dependabot-alerts.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.02-review-open-dependabot-alerts.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repository_vulnerability_alert.dismiss'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"4.3":
  api:
    lang: "bash"
    filename: "hth-github-4.03-audit-deploy-keys.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.03-audit-deploy-keys.sh"
    excerpts:
      api-audit-deploy-keys:
        content: |
            # Audit: Check for deploy keys with write access (read_only == false)
            KEYS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/keys") || {
            fail "4.03 Unable to retrieve deploy keys for ${GITHUB_ORG}/${REPO}"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL_KEYS=$(echo "${KEYS}" | jq '. | length' 2>/dev/null || echo "0")
            WRITE_KEYS=$(echo "${KEYS}" | jq '[.[] | select(.read_only == false)] | length' 2>/dev/null || echo "0")
            READ_KEYS=$((TOTAL_KEYS - WRITE_KEYS))
          
            info "4.03 Found ${TOTAL_KEYS} deploy key(s): ${READ_KEYS} read-only, ${WRITE_KEYS} read-write"
          
            # List write-access keys for review
            if [ "${WRITE_KEYS}" -gt 0 ]; then
            warn "4.03 Deploy keys with WRITE access (review required):"
            echo "${KEYS}" | jq -r '.[] | select(.read_only == false) | "  ID: \(.id) | Title: \(.title) | Created: \(.created_at)"' 2>/dev/null
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-github-4.03-audit-deploy-keys.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.03-audit-deploy-keys.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'deploy_key.create'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"4.4":
  api:
    lang: "bash"
    filename: "hth-github-4.04-audit-oauth-apps.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.04-audit-oauth-apps.sh"
    excerpts:
      api-list-oauth-apps:
        content: |
            # List organization authorized OAuth apps
            info "4.04 Listing authorized OAuth apps for ${GITHUB_ORG}..."
            APPS=$(gh_get "/orgs/${GITHUB_ORG}/installations") || {
            warn "4.04 Unable to retrieve app list (may require admin scope)"
            }
            echo "${APPS}" | jq '.installations[] | {app: .app_slug, permissions: .permissions, created_at: .created_at}'
          
            # NOTE: The /applications endpoint was deprecated by GitHub in 2019.
            # Use the Admin Console (Settings > OAuth Apps) to review personal OAuth authorizations.

"4.5":
  cli:
    lang: "yaml"
    filename: "hth-github-4.05-dependency-review-workflow.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-4.05-dependency-review-workflow.yml"
    excerpts:
      cli-dependency-review:
        content: |
            name: Dependency Review
          
            on: [pull_request]
          
            permissions:
            contents: read
            pull-requests: write
          
            jobs:
            dependency-review:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744
          
                - name: Dependency Review
                  uses: actions/dependency-review-action@c74b580d73376b7750d3d2a50bfb8adc2c937507
                  with:
                    fail-on-severity: moderate
                    deny-licenses: GPL-2.0, GPL-3.0

"4.6":
  sdk:
    lang: "python"
    filename: "hth-github-4.06-audit-oauth-apps.py"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/sdk/hth-github-4.06-audit-oauth-apps.py"
    excerpts:
      sdk-audit-oauth-apps:
        content: |
            from github import Github
            import os
          
            g = Github(os.environ['GITHUB_TOKEN'])
            org = g.get_organization('your-org')
          
            print("Authorized OAuth Apps:")
            print("=" * 60)
          
            # Note: GitHub API doesn't provide full OAuth app list
            # This must be done via UI or GraphQL API
            # Placeholder for manual review tracking
          
            apps = [
              {"name": "CircleCI", "last_used": "2025-12-01", "keep": True},
              {"name": "Old-CI-Tool", "last_used": "2023-06-15", "keep": False},
            ]
          
            for app in apps:
              status = "Keep" if app["keep"] else "Revoke"
              print(f"{status}: {app['name']} (last used: {app['last_used']})")

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.01-disable-wiki-on-non-documentation-repos.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden_wiki" {
            name     = var.repository_name
            has_wiki = false
            }
  api:
    lang: "bash"
    filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.01-disable-wiki-on-non-documentation-repos.sh"
    excerpts:
      api-disable-wiki:
        content: |
            # Disable wiki on the repository
            info "5.01 Disabling wiki on ${REPO}..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
              "has_wiki": false
            }') || {
              fail "5.01 Failed to disable wiki on ${REPO}"
              increment_failed
              summary
              exit 0
            }
      api-disable-wiki-bulk:
        content: |
            # Disable wiki on all repositories that have it enabled
            for REPO_NAME in ${REPOS_WITH_WIKI}; do
            info "5.01 Disabling wiki on ${REPO_NAME}..."
            gh_patch "/repos/${GITHUB_ORG}/${REPO_NAME}" '{"has_wiki": false}' > /dev/null 2>&1 && {
              pass "5.01 Wiki disabled on ${REPO_NAME}"
            } || {
              warn "5.01 Failed to disable wiki on ${REPO_NAME}"
            }
            done
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.01-disable-wiki-on-non-documentation-repos.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repo.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-github-5.02-enable-delete-branch-on-merge.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.02-enable-delete-branch-on-merge.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden" {
            name                   = var.repository_name
            delete_branch_on_merge = true
            }
  api:
    lang: "bash"
    filename: "hth-github-5.02-enable-delete-branch-on-merge.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.02-enable-delete-branch-on-merge.sh"
    excerpts:
      api-enable-delete-branch-on-merge:
        content: |
            # Enable automatic branch deletion after pull request merge
            info "5.02 Enabling delete branch on merge..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "delete_branch_on_merge": true
            }') || {
            fail "5.02 Failed to enable delete branch on merge"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.02-enable-delete-branch-on-merge.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.02-enable-delete-branch-on-merge.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repo.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.3":
  api:
    lang: "bash"
    filename: "hth-github-5.03-audit-org-webhooks.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.03-audit-org-webhooks.sh"
    excerpts:
      api-audit-webhooks:
        content: |
            # Audit: Check all org webhooks for insecure HTTP URLs and missing secrets
            HOOKS=$(gh_get "/orgs/${GITHUB_ORG}/hooks") || {
            fail "5.03 Unable to retrieve org webhooks (may require admin:org_hook scope)"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL_HOOKS=$(echo "${HOOKS}" | jq '. | length' 2>/dev/null || echo "0")
            info "5.03 Found ${TOTAL_HOOKS} organization webhook(s)"
          
            ISSUES=0
          
            if [ "${TOTAL_HOOKS}" -gt 0 ]; then
            # Check for HTTP (non-HTTPS) webhook URLs
            HTTP_HOOKS=$(echo "${HOOKS}" | jq '[.[] | select(.config.url | test("^http://"))] | length' 2>/dev/null || echo "0")
            if [ "${HTTP_HOOKS}" -gt 0 ]; then
              fail "5.03 ${HTTP_HOOKS} webhook(s) use insecure HTTP (should use HTTPS)"
              echo "${HOOKS}" | jq -r '.[] | select(.config.url | test("^http://")) | "  ID: \(.id) | URL: \(.config.url)"' 2>/dev/null
              ISSUES=$((ISSUES + HTTP_HOOKS))
            fi
          
            # Check for webhooks without secrets configured
            NO_SECRET=$(echo "${HOOKS}" | jq '[.[] | select(.config.secret == null or .config.secret == "")] | length' 2>/dev/null || echo "0")
            if [ "${NO_SECRET}" -gt 0 ]; then
              warn "5.03 ${NO_SECRET} webhook(s) have no secret configured"
              echo "${HOOKS}" | jq -r '.[] | select(.config.secret == null or .config.secret == "") | "  ID: \(.id) | URL: \(.config.url)"' 2>/dev/null
              ISSUES=$((ISSUES + NO_SECRET))
            fi
          
            # List all webhooks for review
            info "5.03 All webhooks:"
            echo "${HOOKS}" | jq -r '.[] | "  ID: \(.id) | URL: \(.config.url) | Active: \(.active) | Events: \(.events | join(", "))"' 2>/dev/null
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.03-audit-org-webhooks.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.03-audit-org-webhooks.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'hook.create'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.4":
  api:
    lang: "bash"
    filename: "hth-github-5.04-audit-outside-collaborators.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.04-audit-outside-collaborators.sh"
    excerpts:
      api-audit-outside-collaborators:
        content: |
            # Audit: List all outside collaborators in the organization
            COLLABORATORS=$(gh_get "/orgs/${GITHUB_ORG}/outside_collaborators?per_page=100") || {
            fail "5.04 Unable to retrieve outside collaborators (may require members:read scope)"
            increment_failed
            summary
            exit 0
            }
          
            COLLAB_COUNT=$(echo "${COLLABORATORS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "5.04 Found ${COLLAB_COUNT} outside collaborator(s)"
          
            if [ "${COLLAB_COUNT}" -gt 0 ]; then
            warn "5.04 Outside collaborators with repository access:"
            echo "${COLLABORATORS}" | jq -r '.[] | "  Login: \(.login) | ID: \(.id) | Site Admin: \(.site_admin)"' 2>/dev/null
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.04-audit-outside-collaborators.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.04-audit-outside-collaborators.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.add_outside_collaborator'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.5":
  terraform:
    lang: "hcl"
    filename: "hth-github-5.05-protect-deployment-environments.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.05-protect-deployment-environments.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository_environment" "production" {
            environment = "production"
            repository  = var.repository_name
          
            reviewers {
              teams = [var.security_team_id]
            }
          
            deployment_branch_policy {
              protected_branches     = true
              custom_branch_policies = false
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-5.05-protect-deployment-environments.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.05-protect-deployment-environments.sh"
    excerpts:
      api-audit-environments:
        content: |
            # Audit: Check all deployment environments for protection rules
            ENVS_DATA=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/environments") || {
            warn "5.05 Unable to retrieve environments (may not exist or require admin access)"
            increment_applied
            summary
            exit 0
            }
          
            ENVS=$(echo "${ENVS_DATA}" | jq -r '.environments // []')
            ENV_COUNT=$(echo "${ENVS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "5.05 Found ${ENV_COUNT} deployment environment(s)"
          
            if [ "${ENV_COUNT}" = "0" ]; then
            pass "5.05 No deployment environments configured (nothing to protect)"
            increment_applied
            summary
            exit 0
            fi
          
            UNPROTECTED=0
            for ENV_NAME in $(echo "${ENVS}" | jq -r '.[].name' 2>/dev/null); do
            RULES_COUNT=$(echo "${ENVS}" | jq "[.[] | select(.name == \"${ENV_NAME}\") | .protection_rules // [] | length] | add // 0" 2>/dev/null || echo "0")
            if [ "${RULES_COUNT}" = "0" ]; then
              warn "5.05 Environment '${ENV_NAME}' has no protection rules"
              UNPROTECTED=$((UNPROTECTED + 1))
            else
              pass "5.05 Environment '${ENV_NAME}' has ${RULES_COUNT} protection rule(s)"
            fi
            done
      api-protect-environments:
        content: |
            # Add protection rules to unprotected deployment environments
            for ENV_NAME in $(echo "${ENVS}" | jq -r '.[].name' 2>/dev/null); do
            RULES_COUNT=$(echo "${ENVS}" | jq "[.[] | select(.name == \"${ENV_NAME}\") | .protection_rules // [] | length] | add // 0" 2>/dev/null || echo "0")
            if [ "${RULES_COUNT}" = "0" ]; then
              info "5.05 Adding protection rules to environment '${ENV_NAME}'..."
              gh_put "/repos/${GITHUB_ORG}/${REPO}/environments/${ENV_NAME}" '{
                "deployment_branch_policy": {
                  "protected_branches": true,
                  "custom_branch_policies": false
                }
              }' > /dev/null 2>&1 && {
                pass "5.05 Protection added to environment '${ENV_NAME}'"
              } || {
                warn "5.05 Failed to add protection to environment '${ENV_NAME}'"
              }
            fi
            done
  cli:
    lang: "yaml"
    filename: "hth-github-5.05-deployment-secrets-workflow.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-5.05-deployment-secrets-workflow.yml"
    excerpts:
      cli-deployment-secrets-workflow:
        content: |
            name: Deploy
          
            on:
            push:
              branches: [main]
          
            jobs:
            deploy:
              runs-on: ubuntu-latest
              environment: production  # Requires approval to run
              steps:
                - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744
                - name: Deploy
                  env:
                    API_KEY: ${{ secrets.PROD_API_KEY }}
                  run: |
                    # Secret is available in $API_KEY env var
                    # NOT visible in logs
                    deploy.sh
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.05-protect-deployment-environments.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.05-protect-deployment-environments.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection_update:
                    action: 'environment.update_protection_rules'
                selection_delete:
                    action: 'environment.delete'
                condition: selection_update or selection_delete
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.6":
  api:
    lang: "bash"
    filename: "hth-github-5.06-configure-oidc.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.06-configure-oidc.sh"
    excerpts:
      api-configure-oidc-trust-policy:
        content: |
            # AWS IAM OIDC Trust Policy
            # Create this as the trust policy for your deployment role
            cat <<'POLICY'
            {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Federated": "arn:aws:iam::123456789012:oidc-provider/token.actions.githubusercontent.com"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com",
                    "token.actions.githubusercontent.com:sub": "repo:your-org/your-repo:ref:refs/heads/main"
                  }
                }
              }
            ]
            }
            POLICY
  cli:
    lang: "yaml"
    filename: "hth-github-5.06-oidc-deploy-workflow.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-5.06-oidc-deploy-workflow.yml"
    excerpts:
      cli-oidc-deploy-workflow:
        content: |
            name: Deploy to AWS
          
            on:
            push:
              branches: [main]
          
            permissions:
            id-token: write  # Required for OIDC
            contents: read
          
            jobs:
            deploy:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744
          
                - name: Configure AWS Credentials
                  uses: aws-actions/configure-aws-credentials@010d0da01d0b5a38af31e9c3470dbfdabdecca3a
                  with:
                    role-to-assume: arn:aws:iam::123456789012:role/GitHubActionsRole
                    aws-region: us-east-1
                    # No long-lived credentials needed!
          
                - name: Deploy
                  run: |
                    aws s3 sync ./build s3://my-bucket/

"5.7":
  api:
    lang: "bash"
    filename: "hth-github-5.07-configure-audit-log-streaming.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.07-configure-audit-log-streaming.sh"
    excerpts:
      api-configure-streaming:
        content: |
            # Enable audit log streaming via API (Enterprise Cloud)
            info "5.07 Configuring audit log streaming for ${GITHUB_ORG}..."
            STREAM_RESPONSE=$(gh_post "/orgs/${GITHUB_ORG}/audit-log/streams" "{
            \"enabled\": true,
            \"stream_type\": \"Splunk\",
            \"vendor_specific\": {
              \"domain\": \"${SPLUNK_HEC_ENDPOINT:-https://splunk.example.com:8088}\",
              \"token\": \"${SPLUNK_HEC_TOKEN:-YOUR_HEC_TOKEN}\"
            }
            }") || {
            fail "5.07 Failed to configure audit log streaming"
            increment_failed
            summary
            exit 0
            }
            pass "5.07 Audit log streaming configured"

"5.8":
  api:
    lang: "bash"
    filename: "hth-github-5.08-apply-security-configuration.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.08-apply-security-configuration.sh"
    excerpts:
      api-apply-security-config:
        content: |
            # List available security configurations
            info "5.08 Listing security configurations for ${GITHUB_ORG}..."
            CONFIGS=$(gh_get "/orgs/${GITHUB_ORG}/code-security/configurations") || {
            fail "5.08 Unable to retrieve security configurations"
            increment_failed
            summary
            exit 0
            }
            echo "${CONFIGS}" | jq '.[] | {name: .name, id: .id, target_type: .target_type}'
          
            # Apply configuration to all repositories
            CONFIG_ID=$(echo "${CONFIGS}" | jq -r '.[0].id // empty')
            if [ -n "${CONFIG_ID}" ]; then
            info "5.08 Applying configuration ${CONFIG_ID} to all repositories..."
            gh_post "/orgs/${GITHUB_ORG}/code-security/configurations/${CONFIG_ID}/attach" '{"scope": "all"}' || {
              fail "5.08 Failed to apply security configuration"
              increment_failed
              summary
              exit 0
            }
            pass "5.08 Security configuration applied to all repositories"
            fi

"5.9":
  api:
    lang: "bash"
    filename: "hth-github-5.09-monitor-secret-access.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.09-monitor-secret-access.sh"
    excerpts:
      api-track-secret-rotation:
        content: |
            gh secret list --json name,updatedAt
      api-audit-secret-access:
        content: |
            # Check audit log for secret access
            gh api /orgs/{org}/audit-log?phrase=secrets.read

"6.1":
  api:
    lang: "bash"
    filename: "hth-github-6.01-manual-dependency-review.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-6.01-manual-dependency-review.sh"
    excerpts:
      api-manual-dependency-review:
        content: |
            # Manual dependency review
            gh api /repos/{owner}/{repo}/dependency-graph/compare/main...feature-branch
      api-check-pr-vulnerabilities:
        content: |
            # Check PR for new vulnerabilities
            gh pr view 123 --json reviews

"6.2":
  cli:
    lang: "bash"
    filename: "hth-github-6.02-pin-dependencies-by-ecosystem.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/cli/hth-github-6.02-pin-dependencies-by-ecosystem.sh"
    excerpts:
      cli-pin-npm:
        content: |
            # Commit package-lock.json (contains hashes)
            git add package-lock.json
          
            # Verify integrity on install
            npm ci --audit
      cli-pin-python:
        content: |
            # Generate requirements with hashes
            pip-compile --generate-hashes requirements.in > requirements.txt
          
            # Install with verification
            pip install --require-hashes -r requirements.txt
      cli-pin-go:
        content: |
            # go.sum contains hashes automatically
            go mod verify
      cli-pin-docker:
        content: |
            # Bad: tag can change
            # FROM node:18
          
            # Good: digest is immutable
            # FROM node:18@sha256:a1b2c3d4...

"7.1":
  db:
    lang: "spl"
    filename: "hth-github-7.01-splunk-detection-queries.spl"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/db/hth-github-7.01-splunk-detection-queries.spl"
    excerpts:
      db-splunk-unusual-member-additions:
        content: |
            index=github action=org.add_member
          
            | stats count by actor, user
            | where count > 5
      db-splunk-unusual-repo-cloning:
        content: |
            index=github action=git.clone
          
            | stats dc(repo) as unique_repos by actor
            | where unique_repos > 50
      db-splunk-secret-scanning-dismissed:
        content: |
            index=github action=secret_scanning.dismiss_alert
          
            | table _time, actor, repo, alert_id
      db-splunk-branch-protection-removed:
        content: |
            index=github action=protected_branch.destroy
          
            | table _time, actor, repo, branch

