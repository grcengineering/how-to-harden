# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
            # Disable member ability to fork private repositories
            info "1.04 Disabling private repository forking..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "members_can_fork_private_repositories": false
            }') || {
            fail "1.04 Failed to disable private repository forking"
            increment_failed
            summary
            exit 0
            }
# Generated: 2026-02-18T20:46:23Z
  sigma:

    - lang: "yaml"
      filename: "hth-github-1.04-disable-private-fork-creation.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.04-disable-private-fork-creation.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.update_member_repository_forking_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.5":
  terraform:
    lang: "hcl"
    filename: "hth-github-1.05-require-commit-signoff.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.05-require-commit-signoff.tf"
    excerpts:
      terraform:
        content: |
            resource "github_organization_settings" "commit_signoff" {
            billing_email                      = var.github_organization
            web_commit_signoff_required        = true
            }
  api:
    lang: "bash"
    filename: "hth-github-1.05-require-commit-signoff.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.05-require-commit-signoff.sh"
    excerpts:
      api-require-signoff:
        content: |
            # Enable web commit sign-off requirement at the organization level
            info "1.05 Enabling web commit sign-off requirement..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "web_commit_signoff_required": true
            }') || {
            fail "1.05 Failed to enable web commit sign-off requirement"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-1.05-require-commit-signoff.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.05-require-commit-signoff.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.update_default_repository_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.6":
  terraform:
    lang: "hcl"
    filename: "hth-github-1.06-restrict-org-member-repository-deletion.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.06-restrict-org-member-repository-deletion.tf"
    excerpts:
      terraform:
        content: |
            resource "github_organization_settings" "repo_deletion" {
            billing_email                      = var.github_organization
            default_repository_permission      = "read"
            members_can_create_repositories    = false
            }
  api:
    lang: "bash"
    filename: "hth-github-1.06-restrict-org-member-repository-deletion.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.06-restrict-org-member-repository-deletion.sh"
    excerpts:
      api-restrict-repo-deletion:
        content: |
            # Restrict repository creation and set default permission to read-only
            info "1.06 Restricting repository creation and default permissions..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "default_repository_permission": "read",
            "members_can_create_repositories": false
            }') || {
            fail "1.06 Failed to restrict repository creation and permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-1.06-restrict-org-member-repository-deletion.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.06-restrict-org-member-repository-deletion.yml"
      excerpts:
        detection:
          content: |
"1.1":
              detection:
                selection:
                    action: 'repo.destroy'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
  terraform:

"2.1":
    lang: "hcl"
    filename: "hth-github-1.01-enforce-2fa-for-org-members.tf"
  terraform:
    lang: "hcl"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.01-enforce-2fa-for-org-members.tf"
    excerpts:
    filename: "hth-github-2.01-enable-secret-scanning.tf"
      terraform:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.01-enable-secret-scanning.tf"
        content: |
    excerpts:
      terraform:
            resource "github_organization_settings" "security" {
            billing_email                      = var.github_organization
            two_factor_requirement             = true
            }
  api:
        content: |
    lang: "bash"
            resource "github_repository" "how_to_harden_secrets" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_push_protection {
                status = "enabled"
              }
            }
            }
    filename: "hth-github-1.01-enforce-2fa-for-org-members.sh"
  api:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.01-enforce-2fa-for-org-members.sh"
    lang: "bash"
    filename: "hth-github-2.01-enable-secret-scanning.sh"
    excerpts:
      api-enforce-2fa:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.01-enable-secret-scanning.sh"
        content: |
    excerpts:
            # Enable two-factor authentication requirement for the organization
            info "1.01 Enabling 2FA requirement for org ${GITHUB_ORG}..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "two_factor_requirement_enabled": true
            }') || {
            fail "1.01 Failed to enable 2FA requirement -- may require owner permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
      api-enable-secret-scanning:
    - lang: "yaml"
        content: |
      filename: "hth-github-1.01-enforce-2fa-for-org-members.yml"
            # Enable secret scanning and push protection on the repository
            info "2.01 Enabling secret scanning and push protection..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning": { "status": "enabled" },
              "secret_scanning_push_protection": { "status": "enabled" }
            }
            }') || {
            fail "2.01 Failed to enable secret scanning -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.01-enforce-2fa-for-org-members.yml"
  sigma:
    - lang: "yaml"
      excerpts:
      filename: "hth-github-2.01-enable-secret-scanning.yml"
        detection:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.01-enable-secret-scanning.yml"
          content: |
      excerpts:
              detection:
                selection:
                    action: 'org.disable_two_factor_requirement'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
        detection:

"1.2":
          content: |
  terraform:
              detection:
                selection:
                    action: 'repository_secret_scanning.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
    lang: "hcl"

"2.2":
    filename: "hth-github-1.02-restrict-default-repository-permissions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.02-restrict-default-repository-permissions.tf"
  terraform:
    lang: "hcl"
    excerpts:
    filename: "hth-github-2.02-enable-dependabot-security-updates.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.02-enable-dependabot-security-updates.tf"
      terraform:
        content: |
    excerpts:
      terraform:
            resource "github_organization_settings" "permissions" {
            billing_email                      = var.github_organization
            default_repository_permission      = "read"
            }
        content: |
  api:
    lang: "bash"
            resource "github_repository" "how_to_harden_dependabot" {
            name               = var.repository_name
            vulnerability_alerts = true
            }
    filename: "hth-github-1.02-restrict-default-repository-permissions.sh"
  api:
    lang: "bash"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.02-restrict-default-repository-permissions.sh"
    excerpts:
    filename: "hth-github-2.02-enable-dependabot-security-updates.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.02-enable-dependabot-security-updates.sh"
      api-set-default-permissions:
    excerpts:
        content: |
      api-enable-dependabot:
            # Restrict default repository permission to read-only
            info "1.02 Setting default repository permission to 'read'..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "default_repository_permission": "read"
            }') || {
            fail "1.02 Failed to set default repository permission"
            increment_failed
            summary
            exit 0
            }
        content: |
  sigma:
    - lang: "yaml"
            # Enable Dependabot vulnerability alerts and security updates
            info "2.02 Enabling vulnerability alerts and Dependabot security updates..."
            curl -sf -X PUT "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" || {
            fail "2.02 Failed to enable vulnerability alerts"
            increment_failed
            summary
            exit 0
            }
          
            curl -sf -X PUT "${GH_API}/repos/${GITHUB_ORG}/${REPO}/automated-security-fixes" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" || {
            fail "2.02 Failed to enable Dependabot security updates"
            increment_failed
            summary
            exit 0
            }
      filename: "hth-github-1.02-restrict-default-repository-permissions.yml"
  sigma:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.02-restrict-default-repository-permissions.yml"
    - lang: "yaml"
      excerpts:
      filename: "hth-github-2.02-enable-dependabot-security-updates.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.02-enable-dependabot-security-updates.yml"
      excerpts:
        detection:
          content: |
        detection:
              detection:
                selection:
                    action: 'org.update_default_repository_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
          content: |

"1.3":
              detection:
                selection:
                    action: 'repository_vulnerability_alert.dismiss'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

  terraform:
"2.3":
    lang: "hcl"
    filename: "hth-github-1.03-restrict-repository-creation.tf"
  terraform:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.03-restrict-repository-creation.tf"
    lang: "hcl"
    filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.tf"
    excerpts:
      terraform:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.03-enable-secret-scanning-non-provider-patterns.tf"
    excerpts:
        content: |
      terraform:
            resource "github_organization_settings" "repo_creation" {
            billing_email                           = var.github_organization
            members_can_create_public_repositories  = false
            }
        content: |
  api:
    lang: "bash"
            resource "github_repository" "how_to_harden_non_provider" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_non_provider_patterns {
                status = "enabled"
              }
            }
            }
  api:
    filename: "hth-github-1.03-restrict-repository-creation.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.03-restrict-repository-creation.sh"
    lang: "bash"
    filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.sh"
    excerpts:
      api-disable-public-repos:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.03-enable-secret-scanning-non-provider-patterns.sh"
    excerpts:
        content: |
      api-enable-non-provider-patterns:
            # Disable member ability to create public repositories
            info "1.03 Disabling public repository creation..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "members_can_create_public_repositories": false
            }') || {
            fail "1.03 Failed to disable public repository creation"
            increment_failed
            summary
            exit 0
            }
        content: |
  sigma:
    - lang: "yaml"
            # Enable secret scanning for non-provider patterns (generic secrets, passwords, keys)
            info "2.03 Enabling non-provider pattern scanning..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning_non_provider_patterns": { "status": "enabled" }
            }
            }') || {
            fail "2.03 Failed to enable non-provider patterns -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
      filename: "hth-github-1.03-restrict-repository-creation.yml"
  sigma:
    - lang: "yaml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.03-restrict-repository-creation.yml"
      excerpts:
      filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.03-enable-secret-scanning-non-provider-patterns.yml"
      excerpts:
        detection:
          content: |
        detection:
              detection:
                selection:
                    action: 'org.update_member_repository_creation_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

          content: |
"1.4":
              detection:
                selection_pattern_delete:
                    action: 'repository_secret_scanning_custom_pattern.delete'
                selection_scanning_disable:
                    action: 'repository_secret_scanning.disable'
                condition: selection_pattern_delete or selection_scanning_disable
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
  terraform:

"2.4":
    lang: "hcl"
  terraform:
    filename: "hth-github-1.04-disable-private-fork-creation.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.04-disable-private-fork-creation.tf"
    lang: "hcl"
    excerpts:
    filename: "hth-github-2.04-enable-secret-scanning-validity-checks.tf"
      terraform:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.04-enable-secret-scanning-validity-checks.tf"
    excerpts:
        content: |
            resource "github_organization_settings" "forking" {
            billing_email                           = var.github_organization
            members_can_fork_private_repositories   = false
            }
  api:
      terraform:
        content: |
    lang: "bash"
    filename: "hth-github-1.04-disable-private-fork-creation.sh"
            resource "github_repository" "how_to_harden_validity" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_validity_checks {
                status = "enabled"
              }
            }
            }
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.04-disable-private-fork-creation.sh"
  api:
    excerpts:
    lang: "bash"
    filename: "hth-github-2.04-enable-secret-scanning-validity-checks.sh"
      api-disable-private-forking:
        content: |
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.04-enable-secret-scanning-validity-checks.sh"
    excerpts:
            # Disable member ability to fork private repositories
            info "1.04 Disabling private repository forking..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "members_can_fork_private_repositories": false
            }') || {
            fail "1.04 Failed to disable private repository forking"
            increment_failed
            summary
            exit 0
            }
  sigma:
      api-enable-validity-checks:
        content: |
    - lang: "yaml"
      filename: "hth-github-1.04-disable-private-fork-creation.yml"
            # Enable secret scanning validity checks to verify if detected secrets are still active
            info "2.04 Enabling secret scanning validity checks..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning_validity_checks": { "status": "enabled" }
            }
            }') || {
            fail "2.04 Failed to enable validity checks -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.04-disable-private-fork-creation.yml"
  sigma:
    - lang: "yaml"
      excerpts:
      filename: "hth-github-2.04-enable-secret-scanning-validity-checks.yml"
        detection:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.04-enable-secret-scanning-validity-checks.yml"
          content: |
      excerpts:
              detection:
                selection:
                    action: 'org.update_member_repository_forking_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
        detection:

          content: |
"1.5":
  terraform:
              detection:
                selection:
                    action: 'repository_secret_scanning.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
    lang: "hcl"

    filename: "hth-github-1.05-require-commit-signoff.tf"
"3.1":
  terraform:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.05-require-commit-signoff.tf"
    lang: "hcl"
    excerpts:
    filename: "hth-github-3.01-enable-branch-protection-on-default-branch.tf"
      terraform:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.01-enable-branch-protection-on-default-branch.tf"
        content: |
    excerpts:
            resource "github_organization_settings" "commit_signoff" {
            billing_email                      = var.github_organization
            web_commit_signoff_required        = true
            }
      terraform:
  api:
        content: |
    lang: "bash"
    filename: "hth-github-1.05-require-commit-signoff.sh"
            resource "github_branch_protection" "main" {
            repository_id = var.repository_id
            pattern       = "main"
            enforce_admins = true
          
            required_pull_request_reviews {
              required_approving_review_count = 1
              dismiss_stale_reviews           = true
            }
            }
  api:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.05-require-commit-signoff.sh"
    lang: "bash"
    excerpts:
    filename: "hth-github-3.01-enable-branch-protection-on-default-branch.sh"
      api-require-signoff:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.01-enable-branch-protection-on-default-branch.sh"
        content: |
    excerpts:
      api-enable-branch-protection:
            # Enable web commit sign-off requirement at the organization level
            info "1.05 Enabling web commit sign-off requirement..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "web_commit_signoff_required": true
            }') || {
            fail "1.05 Failed to enable web commit sign-off requirement"
            increment_failed
            summary
            exit 0
            }
        content: |
  sigma:
    - lang: "yaml"
            # Enable branch protection with required reviews, dismiss stale, and enforce admins
            info "3.01 Enabling branch protection on '${DEFAULT_BRANCH}'..."
            RESPONSE=$(gh_put "/repos/${GITHUB_ORG}/${REPO}/branches/${DEFAULT_BRANCH}/protection" '{
            "required_status_checks": null,
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true
            },
            "restrictions": null
            }') || {
            fail "3.01 Failed to enable branch protection"
            increment_failed
            summary
            exit 0
            }
  sigma:
      filename: "hth-github-1.05-require-commit-signoff.yml"
    - lang: "yaml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.05-require-commit-signoff.yml"
      filename: "hth-github-3.01-enable-branch-protection-on-default-branch.yml"
      excerpts:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.01-enable-branch-protection-on-default-branch.yml"
      excerpts:
        detection:
          content: |
        detection:
          content: |
              detection:
                selection:
                    action: 'org.update_default_repository_permission'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

              detection:
                selection:
                    action: 'protected_branch.destroy'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"1.6":
  terraform:
"3.2":
    lang: "hcl"
  terraform:
    lang: "hcl"
    filename: "hth-github-1.06-restrict-org-member-repository-deletion.tf"
    filename: "hth-github-3.02-restrict-actions-to-verified-creators.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-1.06-restrict-org-member-repository-deletion.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.02-restrict-actions-to-verified-creators.tf"
    excerpts:
      terraform:
    excerpts:
      terraform:
        content: |
        content: |
            resource "github_organization_settings" "repo_deletion" {
            billing_email                      = var.github_organization
            default_repository_permission      = "read"
            members_can_create_repositories    = false
            }
  api:
            resource "github_actions_repository_permissions" "how_to_harden_actions" {
            repository      = var.repository_name
            enabled         = true
            allowed_actions = "selected"
          
            allowed_actions_config {
              github_owned_allowed = true
              verified_allowed     = true
            }
            }
  api:
    lang: "bash"
    lang: "bash"
    filename: "hth-github-1.06-restrict-org-member-repository-deletion.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-1.06-restrict-org-member-repository-deletion.sh"
    filename: "hth-github-3.02-restrict-actions-to-verified-creators.sh"
    excerpts:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.02-restrict-actions-to-verified-creators.sh"
    excerpts:
      api-restrict-repo-deletion:
      api-restrict-actions:
        content: |
        content: |
            # Restrict repository creation and set default permission to read-only
            info "1.06 Restricting repository creation and default permissions..."
            RESPONSE=$(gh_patch "/orgs/${GITHUB_ORG}" '{
            "default_repository_permission": "read",
            "members_can_create_repositories": false
            }') || {
            fail "1.06 Failed to restrict repository creation and permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
            # Restrict GitHub Actions to only selected (verified) creators
            info "3.02 Restricting Actions to selected creators..."
            RESPONSE=$(gh_put "/repos/${GITHUB_ORG}/${REPO}/actions/permissions" '{
            "enabled": true,
            "allowed_actions": "selected"
            }') || {
            fail "3.02 Failed to restrict Actions permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
    - lang: "yaml"
      filename: "hth-github-1.06-restrict-org-member-repository-deletion.yml"
      filename: "hth-github-3.02-restrict-actions-to-verified-creators.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-1.06-restrict-org-member-repository-deletion.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.02-restrict-actions-to-verified-creators.yml"
      excerpts:
      excerpts:
        detection:
        detection:
          content: |
          content: |
              detection:
                selection:
                    action: 'repo.destroy'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
              detection:
                selection:
                    action: 'repo.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at


"2.1":
"3.3":
  terraform:
  terraform:
    lang: "hcl"
    lang: "hcl"
    filename: "hth-github-2.01-enable-secret-scanning.tf"
    filename: "hth-github-3.03-pin-actions-to-sha.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.01-enable-secret-scanning.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.03-pin-actions-to-sha.tf"
    excerpts:
    excerpts:
      terraform:
        content: |
      terraform:
        content: |
            resource "github_repository" "how_to_harden_secrets" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_push_protection {
                status = "enabled"
              }
            }
            }
  api:
            # NOTE: SHA pinning is enforced at the workflow file level, not via a dedicated
            # Terraform resource. This control restricts allowed actions to "selected" so
            # that only explicitly approved actions (pinned to SHA in workflow YAML) can run.
            resource "github_actions_repository_permissions" "how_to_harden_sha_pinning" {
            repository      = var.repository_name
            enabled         = true
            allowed_actions = "selected"
            }
    lang: "bash"
  api:
    filename: "hth-github-2.01-enable-secret-scanning.sh"
    lang: "bash"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.01-enable-secret-scanning.sh"
    filename: "hth-github-3.03-pin-actions-to-sha.sh"
    excerpts:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.03-pin-actions-to-sha.sh"
    excerpts:
      api-enable-secret-scanning:
        content: |
      api-audit-sha-pinning:
        content: |
            # Enable secret scanning and push protection on the repository
            info "2.01 Enabling secret scanning and push protection..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning": { "status": "enabled" },
              "secret_scanning_push_protection": { "status": "enabled" }
            }
            }') || {
            fail "2.01 Failed to enable secret scanning -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
  sigma:
            # Audit: Check workflow files for actions not pinned to full SHA
            # Note: SHA pinning cannot be enforced via API -- workflows must be manually updated
            # Recommended tool: npx pin-github-action .github/workflows/*.yml
            info "3.03 Retrieving workflow files..."
            WORKFLOWS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/.github/workflows" 2>/dev/null) || {
            warn "3.03 No .github/workflows directory found -- no workflows to audit"
            increment_applied
            summary
            exit 0
            }
          
            WORKFLOW_COUNT=$(echo "${WORKFLOWS}" | jq '. | length' 2>/dev/null || echo "0")
            info "3.03 Found ${WORKFLOW_COUNT} workflow file(s)"
          
            if [ "${WORKFLOW_COUNT}" = "0" ]; then
            pass "3.03 No workflow files found -- nothing to pin"
            increment_applied
            summary
            exit 0
            fi
          
            # Check each workflow for tag-based action references (not SHA-pinned)
            UNPINNED=0
            for NAME in $(echo "${WORKFLOWS}" | jq -r '.[].name' 2>/dev/null); do
            CONTENT=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/.github/workflows/${NAME}" \
              | jq -r '.content // empty' 2>/dev/null | base64 -d 2>/dev/null || true)
            if [ -n "${CONTENT}" ]; then
              # Look for uses: owner/action@v* or @tag patterns (not 40-char SHA)
              TAG_REFS=$(echo "${CONTENT}" | grep -cE 'uses:\s+\S+@v[0-9]' 2>/dev/null || true)
              if [ "${TAG_REFS}" -gt 0 ] 2>/dev/null; then
                warn "3.03 ${NAME}: ${TAG_REFS} action(s) pinned to tag instead of SHA"
                UNPINNED=$((UNPINNED + TAG_REFS))
              fi
            fi
            done
  sigma:
    - lang: "yaml"
    - lang: "yaml"
      filename: "hth-github-2.01-enable-secret-scanning.yml"
      filename: "hth-github-3.03-pin-actions-to-sha.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.01-enable-secret-scanning.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.03-pin-actions-to-sha.yml"
      excerpts:
      excerpts:
        detection:
        detection:
          content: |
          content: |
              detection:
                selection:
                    action: 'repository_secret_scanning.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

              detection:
                selection:
                    action: 'repo.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
"2.2":

  terraform:
"3.4":
    lang: "hcl"
  terraform:
    filename: "hth-github-2.02-enable-dependabot-security-updates.tf"
    lang: "hcl"
    filename: "hth-github-3.04-restrict-org-actions-permissions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.02-enable-dependabot-security-updates.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.04-restrict-org-actions-permissions.tf"
    excerpts:
    excerpts:
      terraform:
      terraform:
        content: |
        content: |
            resource "github_repository" "how_to_harden_dependabot" {
            name               = var.repository_name
            vulnerability_alerts = true
            }
  api:
            # NOTE: The github_actions_organization_permissions resource controls which
            # Actions are allowed to run across the entire organization. This restricts
            # all repositories to only GitHub-owned and Marketplace-verified actions.
            resource "github_actions_organization_permissions" "hardened" {
            allowed_actions = "selected"
            enabled_repositories = "all"
          
            allowed_actions_config {
              github_owned_allowed = true
              verified_allowed     = true
            }
            }
    lang: "bash"
  api:
    filename: "hth-github-2.02-enable-dependabot-security-updates.sh"
    lang: "bash"
    filename: "hth-github-3.04-restrict-org-actions-permissions.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.02-enable-dependabot-security-updates.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.04-restrict-org-actions-permissions.sh"
    excerpts:
      api-enable-dependabot:
    excerpts:
      api-restrict-org-actions:
        content: |
        content: |
            # Enable Dependabot vulnerability alerts and security updates
            info "2.02 Enabling vulnerability alerts and Dependabot security updates..."
            curl -sf -X PUT "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" || {
            fail "2.02 Failed to enable vulnerability alerts"
            increment_failed
            summary
            exit 0
            }
          
            curl -sf -X PUT "${GH_API}/repos/${GITHUB_ORG}/${REPO}/automated-security-fixes" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" || {
            fail "2.02 Failed to enable Dependabot security updates"
            increment_failed
            summary
            exit 0
            }
  sigma:
            # Restrict organization-level GitHub Actions to selected (verified) creators only
            info "3.04 Restricting org-level Actions to selected creators..."
            RESPONSE=$(gh_put "/orgs/${GITHUB_ORG}/actions/permissions" '{
            "enabled_repositories": "all",
            "allowed_actions": "selected"
            }') || {
            fail "3.04 Failed to restrict org Actions permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-2.02-enable-dependabot-security-updates.yml"
    - lang: "yaml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.02-enable-dependabot-security-updates.yml"
      filename: "hth-github-3.04-restrict-org-actions-permissions.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.04-restrict-org-actions-permissions.yml"
      excerpts:
      excerpts:
        detection:
        detection:
          content: |
          content: |
              detection:
                selection:
                    action: 'repository_vulnerability_alert.dismiss'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

              detection:
                selection:
                    action: 'org.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
"2.3":

"3.5":
  terraform:
    lang: "hcl"
  terraform:
    lang: "hcl"
    filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.tf"
    filename: "hth-github-3.05-enable-code-scanning-default-setup.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.03-enable-secret-scanning-non-provider-patterns.tf"
    excerpts:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.05-enable-code-scanning-default-setup.tf"
      terraform:
    excerpts:
        content: |
      terraform:
        content: |
            resource "github_repository" "how_to_harden_non_provider" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_non_provider_patterns {
                status = "enabled"
              }
            }
            }
  api:
            resource "github_repository" "how_to_harden_code_scanning" {
            name = var.repository_name
          
            security_and_analysis {
              advanced_security {
                status = "enabled"
              }
            }
            }
    lang: "bash"
  api:
    filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.sh"
    lang: "bash"
    filename: "hth-github-3.05-enable-code-scanning-default-setup.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.03-enable-secret-scanning-non-provider-patterns.sh"
    excerpts:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.05-enable-code-scanning-default-setup.sh"
    excerpts:
      api-enable-non-provider-patterns:
        content: |
      api-enable-code-scanning:
        content: |
            # Enable secret scanning for non-provider patterns (generic secrets, passwords, keys)
            info "2.03 Enabling non-provider pattern scanning..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning_non_provider_patterns": { "status": "enabled" }
            }
            }') || {
            fail "2.03 Failed to enable non-provider patterns -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
  sigma:
            # Enable CodeQL code scanning with the default query suite
            info "3.05 Enabling code scanning default setup..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}/code-scanning/default-setup" '{
            "state": "configured",
            "query_suite": "default"
            }') || {
            fail "3.05 Failed to enable code scanning -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
    - lang: "yaml"
  sigma:
      filename: "hth-github-2.03-enable-secret-scanning-non-provider-patterns.yml"
    - lang: "yaml"
      filename: "hth-github-3.05-enable-code-scanning-default-setup.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.03-enable-secret-scanning-non-provider-patterns.yml"
      excerpts:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.05-enable-code-scanning-default-setup.yml"
      excerpts:
        detection:
        detection:
          content: |
          content: |
              detection:
                selection_pattern_delete:
                    action: 'repository_secret_scanning_custom_pattern.delete'
                selection_scanning_disable:
                    action: 'repository_secret_scanning.disable'
                condition: selection_pattern_delete or selection_scanning_disable
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

              detection:
                selection:
                    action: 'repository_code_scanning_default_setup.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
"2.4":

  terraform:
"3.6":
  terraform:
    lang: "hcl"
    lang: "hcl"
    filename: "hth-github-2.04-enable-secret-scanning-validity-checks.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-2.04-enable-secret-scanning-validity-checks.tf"
    filename: "hth-github-3.06-require-codeowners-file.tf"
    excerpts:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.06-require-codeowners-file.tf"
    excerpts:
      terraform:
      terraform:
        content: |
        content: |
            # NOTE: The CODEOWNERS file itself must be committed to the repository
            # (e.g., .github/CODEOWNERS). This Terraform resource enforces that
            # pull requests require approval from designated code owners before merge.
            resource "github_branch_protection" "main_codeowners" {
            repository_id = var.repository_id
            pattern       = "main"
          
            required_pull_request_reviews {
              require_code_owner_reviews = true
            }
            }
            resource "github_repository" "how_to_harden_validity" {
            name = var.repository_name
          
            security_and_analysis {
              secret_scanning {
                status = "enabled"
              }
              secret_scanning_validity_checks {
                status = "enabled"
              }
            }
            }
  api:
  api:
    lang: "bash"
    lang: "bash"
    filename: "hth-github-3.06-require-codeowners-file.sh"
    filename: "hth-github-2.04-enable-secret-scanning-validity-checks.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.06-require-codeowners-file.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-2.04-enable-secret-scanning-validity-checks.sh"
    excerpts:
    excerpts:
      api-enable-validity-checks:
      api-audit-codeowners:
        content: |
        content: |
            # Audit: Check for CODEOWNERS file in standard locations
            # Note: CODEOWNERS must be committed to the repo -- cannot be created via API
            FOUND=false
          
            for LOCATION in ".github/CODEOWNERS" "CODEOWNERS" "docs/CODEOWNERS"; do
            CONTENT=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/${LOCATION}" 2>/dev/null) || continue
            HAS_NAME=$(echo "${CONTENT}" | jq -r 'has("name")' 2>/dev/null || echo "false")
            if [ "${HAS_NAME}" = "true" ]; then
              pass "3.06 CODEOWNERS file found at ${LOCATION}"
              FOUND=true
              break
            fi
            done
            # Enable secret scanning validity checks to verify if detected secrets are still active
            info "2.04 Enabling secret scanning validity checks..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "security_and_analysis": {
              "secret_scanning_validity_checks": { "status": "enabled" }
            }
            }') || {
            fail "2.04 Failed to enable validity checks -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
  sigma:
  sigma:
    - lang: "yaml"
    - lang: "yaml"
      filename: "hth-github-2.04-enable-secret-scanning-validity-checks.yml"
      filename: "hth-github-3.06-require-codeowners-file.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-2.04-enable-secret-scanning-validity-checks.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.06-require-codeowners-file.yml"
      excerpts:
      excerpts:
        detection:
        detection:
          content: |
          content: |
              detection:
                selection:
                    action: 'protected_branch.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
              detection:
                selection:
                    action: 'repository_secret_scanning.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at


"3.7":
"3.1":
  terraform:
  terraform:
    lang: "hcl"
    lang: "hcl"
    filename: "hth-github-3.01-enable-branch-protection-on-default-branch.tf"
    filename: "hth-github-3.07-require-signed-commits.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.07-require-signed-commits.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.01-enable-branch-protection-on-default-branch.tf"
    excerpts:
    excerpts:
      terraform:
      terraform:
        content: |
        content: |
            resource "github_branch_protection" "main_signed" {
            repository_id          = var.repository_id
            pattern                = "main"
            require_signed_commits = true
            }
            resource "github_branch_protection" "main" {
            repository_id = var.repository_id
            pattern       = "main"
            enforce_admins = true
          
            required_pull_request_reviews {
              required_approving_review_count = 1
              dismiss_stale_reviews           = true
            }
            }
  api:
  api:
    lang: "bash"
    lang: "bash"
    filename: "hth-github-3.01-enable-branch-protection-on-default-branch.sh"
    filename: "hth-github-3.07-require-signed-commits.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.01-enable-branch-protection-on-default-branch.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.07-require-signed-commits.sh"
    excerpts:
    excerpts:
      api-enable-branch-protection:
      api-audit-signed-commits:
        content: |
        content: |
            # Audit: Check recent commits for GPG/SSH signature verification
            # Note: Commit signing is per-developer; enforcement is via branch protection rules
            info "3.07 Checking recent commit signatures..."
            COMMITS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/commits?per_page=10") || {
            fail "3.07 Unable to retrieve commits for ${GITHUB_ORG}/${REPO}"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL=$(echo "${COMMITS}" | jq '. | length' 2>/dev/null || echo "0")
            VERIFIED=$(echo "${COMMITS}" | jq '[.[] | select(.commit.verification.verified == true)] | length' 2>/dev/null || echo "0")
            UNVERIFIED=$((TOTAL - VERIFIED))
          
            info "3.07 Checked ${TOTAL} recent commits: ${VERIFIED} signed, ${UNVERIFIED} unsigned"
          
            # Check if branch protection enforces signed commits
            REPO_META=$(gh_get "/repos/${GITHUB_ORG}/${REPO}") || true
            DEFAULT_BRANCH=$(echo "${REPO_META}" | jq -r '.default_branch // "main"' 2>/dev/null)
          
            SIGNATURE_REQUIRED="false"
            PROTECTION=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/branches/${DEFAULT_BRANCH}/protection/required_signatures" 2>/dev/null) && {
            SIGNATURE_REQUIRED=$(echo "${PROTECTION}" | jq -r '.enabled // false' 2>/dev/null || echo "false")
            }
            # Enable branch protection with required reviews, dismiss stale, and enforce admins
            info "3.01 Enabling branch protection on '${DEFAULT_BRANCH}'..."
            RESPONSE=$(gh_put "/repos/${GITHUB_ORG}/${REPO}/branches/${DEFAULT_BRANCH}/protection" '{
            "required_status_checks": null,
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true
            },
            "restrictions": null
            }') || {
            fail "3.01 Failed to enable branch protection"
            increment_failed
            summary
            exit 0
            }
  sigma:
  sigma:
    - lang: "yaml"
    - lang: "yaml"
      filename: "hth-github-3.01-enable-branch-protection-on-default-branch.yml"
      filename: "hth-github-3.07-require-signed-commits.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.07-require-signed-commits.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.01-enable-branch-protection-on-default-branch.yml"
      excerpts:
      excerpts:
        detection:
        detection:
          content: |
          content: |
              detection:
                selection:
                    action: 'protected_branch.destroy'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
              detection:
                selection:
                    action: 'protected_branch.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at


"3.2":
"4.1":
  terraform:
  terraform:
    lang: "hcl"
    lang: "hcl"
    filename: "hth-github-3.02-restrict-actions-to-verified-creators.tf"
    filename: "hth-github-4.01-enable-vulnerability-alerts.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.02-restrict-actions-to-verified-creators.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-4.01-enable-vulnerability-alerts.tf"
    excerpts:
    excerpts:
      terraform:
      terraform:
        content: |
        content: |
            resource "github_repository" "how_to_harden_vuln_alerts" {
            name               = var.repository_name
            vulnerability_alerts = true
            }
            resource "github_actions_repository_permissions" "how_to_harden_actions" {
            repository      = var.repository_name
            enabled         = true
            allowed_actions = "selected"
          
            allowed_actions_config {
              github_owned_allowed = true
              verified_allowed     = true
            }
            }
  api:
  api:
    lang: "bash"
    lang: "bash"
    filename: "hth-github-4.01-enable-vulnerability-alerts.sh"
    filename: "hth-github-3.02-restrict-actions-to-verified-creators.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.01-enable-vulnerability-alerts.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.02-restrict-actions-to-verified-creators.sh"
    excerpts:
    excerpts:
      api-restrict-actions:
        content: |
      api-check-vulnerability-alerts:
        content: |
            # Restrict GitHub Actions to only selected (verified) creators
            info "3.02 Restricting Actions to selected creators..."
            RESPONSE=$(gh_put "/repos/${GITHUB_ORG}/${REPO}/actions/permissions" '{
            "enabled": true,
            "allowed_actions": "selected"
            }') || {
            fail "3.02 Failed to restrict Actions permissions"
            increment_failed
            summary
            exit 0
            }
  sigma:
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X GET \
            "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28")
    - lang: "yaml"
      api-enable-vulnerability-alerts:
      filename: "hth-github-3.02-restrict-actions-to-verified-creators.yml"
        content: |
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.02-restrict-actions-to-verified-creators.yml"
            # Enable Dependabot vulnerability alerts on the repository
            info "4.01 Enabling vulnerability alerts..."
            ENABLE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
            "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28")
      excerpts:
  sigma:
        detection:
    - lang: "yaml"
          content: |
      filename: "hth-github-4.01-enable-vulnerability-alerts.yml"
              detection:
                selection:
                    action: 'repo.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.01-enable-vulnerability-alerts.yml"
      excerpts:
"3.3":
        detection:
  terraform:
    lang: "hcl"
          content: |
    filename: "hth-github-3.03-pin-actions-to-sha.tf"
              detection:
                selection:
                    action: 'repository_vulnerability_alerts.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.03-pin-actions-to-sha.tf"

    excerpts:
"4.2":
  api:
    lang: "bash"
      terraform:
        content: |
    filename: "hth-github-4.02-review-open-dependabot-alerts.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.02-review-open-dependabot-alerts.sh"
            # NOTE: SHA pinning is enforced at the workflow file level, not via a dedicated
            # Terraform resource. This control restricts allowed actions to "selected" so
            # that only explicitly approved actions (pinned to SHA in workflow YAML) can run.
            resource "github_actions_repository_permissions" "how_to_harden_sha_pinning" {
            repository      = var.repository_name
            enabled         = true
            allowed_actions = "selected"
            }
    excerpts:
  api:
    lang: "bash"
    filename: "hth-github-3.03-pin-actions-to-sha.sh"
      api-audit-dependabot-alerts:
        content: |
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.03-pin-actions-to-sha.sh"
    excerpts:
            # Audit: Check for critical and high severity open Dependabot alerts
            info "4.02 Checking critical Dependabot alerts..."
            CRITICAL_ALERTS=$(gh_get "/orgs/${GITHUB_ORG}/dependabot/alerts?state=open&severity=critical&per_page=100" 2>/dev/null) || {
            warn "4.02 Unable to query Dependabot alerts (may require security_events scope)"
            CRITICAL_ALERTS="[]"
            }
            CRITICAL_COUNT=$(echo "${CRITICAL_ALERTS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "4.02 Checking high severity Dependabot alerts..."
            HIGH_ALERTS=$(gh_get "/orgs/${GITHUB_ORG}/dependabot/alerts?state=open&severity=high&per_page=100" 2>/dev/null) || {
            warn "4.02 Unable to query high severity Dependabot alerts"
            HIGH_ALERTS="[]"
            }
            HIGH_COUNT=$(echo "${HIGH_ALERTS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "4.02 Open alerts -- Critical: ${CRITICAL_COUNT}, High: ${HIGH_COUNT}"
          
            # List affected repositories for critical alerts
            if [ "${CRITICAL_COUNT}" -gt 0 ]; then
            warn "4.02 Repositories with critical alerts:"
            echo "${CRITICAL_ALERTS}" | jq -r '.[].repository.full_name' 2>/dev/null | sort -u | while read -r REPO_NAME; do
              COUNT=$(echo "${CRITICAL_ALERTS}" | jq -r "[.[] | select(.repository.full_name == \"${REPO_NAME}\")] | length" 2>/dev/null)
              warn "4.02   ${REPO_NAME}: ${COUNT} critical alert(s)"
            done
            fi
      api-audit-sha-pinning:
  sigma:
    - lang: "yaml"
        content: |
      filename: "hth-github-4.02-review-open-dependabot-alerts.yml"
            # Audit: Check workflow files for actions not pinned to full SHA
            # Note: SHA pinning cannot be enforced via API -- workflows must be manually updated
            # Recommended tool: npx pin-github-action .github/workflows/*.yml
            info "3.03 Retrieving workflow files..."
            WORKFLOWS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/.github/workflows" 2>/dev/null) || {
            warn "3.03 No .github/workflows directory found -- no workflows to audit"
            increment_applied
            summary
            exit 0
            }
          
            WORKFLOW_COUNT=$(echo "${WORKFLOWS}" | jq '. | length' 2>/dev/null || echo "0")
            info "3.03 Found ${WORKFLOW_COUNT} workflow file(s)"
          
            if [ "${WORKFLOW_COUNT}" = "0" ]; then
            pass "3.03 No workflow files found -- nothing to pin"
            increment_applied
            summary
            exit 0
            fi
          
            # Check each workflow for tag-based action references (not SHA-pinned)
            UNPINNED=0
            for NAME in $(echo "${WORKFLOWS}" | jq -r '.[].name' 2>/dev/null); do
            CONTENT=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/.github/workflows/${NAME}" \
              | jq -r '.content // empty' 2>/dev/null | base64 -d 2>/dev/null || true)
            if [ -n "${CONTENT}" ]; then
              # Look for uses: owner/action@v* or @tag patterns (not 40-char SHA)
              TAG_REFS=$(echo "${CONTENT}" | grep -cE 'uses:\s+\S+@v[0-9]' 2>/dev/null || true)
              if [ "${TAG_REFS}" -gt 0 ] 2>/dev/null; then
                warn "3.03 ${NAME}: ${TAG_REFS} action(s) pinned to tag instead of SHA"
                UNPINNED=$((UNPINNED + TAG_REFS))
              fi
            fi
            done
  sigma:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.02-review-open-dependabot-alerts.yml"
      excerpts:
    - lang: "yaml"
        detection:
      filename: "hth-github-3.03-pin-actions-to-sha.yml"
          content: |
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.03-pin-actions-to-sha.yml"
      excerpts:
              detection:
                selection:
                    action: 'repository_vulnerability_alert.dismiss'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
        detection:

          content: |
"4.3":
  api:
              detection:
                selection:
                    action: 'repo.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
    lang: "bash"

"3.4":
    filename: "hth-github-4.03-audit-deploy-keys.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.03-audit-deploy-keys.sh"
  terraform:
    lang: "hcl"
    excerpts:
    filename: "hth-github-3.04-restrict-org-actions-permissions.tf"
      api-audit-deploy-keys:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.04-restrict-org-actions-permissions.tf"
        content: |
    excerpts:
            # Audit: Check for deploy keys with write access (read_only == false)
            KEYS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/keys") || {
            fail "4.03 Unable to retrieve deploy keys for ${GITHUB_ORG}/${REPO}"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL_KEYS=$(echo "${KEYS}" | jq '. | length' 2>/dev/null || echo "0")
            WRITE_KEYS=$(echo "${KEYS}" | jq '[.[] | select(.read_only == false)] | length' 2>/dev/null || echo "0")
            READ_KEYS=$((TOTAL_KEYS - WRITE_KEYS))
          
            info "4.03 Found ${TOTAL_KEYS} deploy key(s): ${READ_KEYS} read-only, ${WRITE_KEYS} read-write"
          
            # List write-access keys for review
            if [ "${WRITE_KEYS}" -gt 0 ]; then
            warn "4.03 Deploy keys with WRITE access (review required):"
            echo "${KEYS}" | jq -r '.[] | select(.read_only == false) | "  ID: \(.id) | Title: \(.title) | Created: \(.created_at)"' 2>/dev/null
            fi
      terraform:
  sigma:
    - lang: "yaml"
        content: |
      filename: "hth-github-4.03-audit-deploy-keys.yml"
            # NOTE: The github_actions_organization_permissions resource controls which
            # Actions are allowed to run across the entire organization. This restricts
            # all repositories to only GitHub-owned and Marketplace-verified actions.
            resource "github_actions_organization_permissions" "hardened" {
            allowed_actions = "selected"
            enabled_repositories = "all"
          
            allowed_actions_config {
              github_owned_allowed = true
              verified_allowed     = true
            }
            }
  api:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.03-audit-deploy-keys.yml"
      excerpts:
    lang: "bash"
    filename: "hth-github-3.04-restrict-org-actions-permissions.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.04-restrict-org-actions-permissions.sh"
        detection:
    excerpts:
          content: |
              detection:
                selection:
                    action: 'deploy_key.create'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

      api-restrict-org-actions:
        content: |
"5.1":
  terraform:
            # Restrict organization-level GitHub Actions to selected (verified) creators only
            info "3.04 Restricting org-level Actions to selected creators..."
            RESPONSE=$(gh_put "/orgs/${GITHUB_ORG}/actions/permissions" '{
            "enabled_repositories": "all",
            "allowed_actions": "selected"
            }') || {
            fail "3.04 Failed to restrict org Actions permissions"
            increment_failed
            summary
            exit 0
            }
    lang: "hcl"
  sigma:
    filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.tf"
    - lang: "yaml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.01-disable-wiki-on-non-documentation-repos.tf"
      filename: "hth-github-3.04-restrict-org-actions-permissions.yml"
    excerpts:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.04-restrict-org-actions-permissions.yml"
      excerpts:
      terraform:
        content: |
        detection:
          content: |
            resource "github_repository" "how_to_harden_wiki" {
            name     = var.repository_name
            has_wiki = false
            }
  api:
              detection:
                selection:
                    action: 'org.actions_enabled'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
    lang: "bash"

    filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.sh"
"3.5":
  terraform:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.01-disable-wiki-on-non-documentation-repos.sh"
    excerpts:
    lang: "hcl"
    filename: "hth-github-3.05-enable-code-scanning-default-setup.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.05-enable-code-scanning-default-setup.tf"
      api-disable-wiki:
        content: |
    excerpts:
            # Disable wiki on the repository
            info "5.01 Disabling wiki on ${REPO}..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
              "has_wiki": false
            }') || {
              fail "5.01 Failed to disable wiki on ${REPO}"
              increment_failed
              summary
              exit 0
            }
      terraform:
      api-disable-wiki-bulk:
        content: |
        content: |
            # Disable wiki on all repositories that have it enabled
            for REPO_NAME in ${REPOS_WITH_WIKI}; do
            info "5.01 Disabling wiki on ${REPO_NAME}..."
            gh_patch "/repos/${GITHUB_ORG}/${REPO_NAME}" '{"has_wiki": false}' > /dev/null 2>&1 && {
              pass "5.01 Wiki disabled on ${REPO_NAME}"
            } || {
              warn "5.01 Failed to disable wiki on ${REPO_NAME}"
            }
            done
            resource "github_repository" "how_to_harden_code_scanning" {
            name = var.repository_name
          
            security_and_analysis {
              advanced_security {
                status = "enabled"
              }
            }
            }
  api:
  sigma:
    - lang: "yaml"
    lang: "bash"
      filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.yml"
    filename: "hth-github-3.05-enable-code-scanning-default-setup.sh"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.01-disable-wiki-on-non-documentation-repos.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.05-enable-code-scanning-default-setup.sh"
      excerpts:
    excerpts:
      api-enable-code-scanning:
        detection:
        content: |
          content: |
            # Enable CodeQL code scanning with the default query suite
            info "3.05 Enabling code scanning default setup..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}/code-scanning/default-setup" '{
            "state": "configured",
            "query_suite": "default"
            }') || {
            fail "3.05 Failed to enable code scanning -- may require GHAS license"
            increment_failed
            summary
            exit 0
            }
              detection:
                selection:
                    action: 'repo.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

  sigma:
"5.2":
    - lang: "yaml"
      filename: "hth-github-3.05-enable-code-scanning-default-setup.yml"
  terraform:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.05-enable-code-scanning-default-setup.yml"
    lang: "hcl"
      excerpts:
    filename: "hth-github-5.02-enable-delete-branch-on-merge.tf"
        detection:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.02-enable-delete-branch-on-merge.tf"
          content: |
    excerpts:
      terraform:
              detection:
                selection:
                    action: 'repository_code_scanning_default_setup.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

        content: |
"3.6":
            resource "github_repository" "how_to_harden" {
            name                   = var.repository_name
            delete_branch_on_merge = true
            }
  terraform:
  api:
    lang: "bash"
    lang: "hcl"
    filename: "hth-github-5.02-enable-delete-branch-on-merge.sh"
    filename: "hth-github-3.06-require-codeowners-file.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.02-enable-delete-branch-on-merge.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.06-require-codeowners-file.tf"
    excerpts:
    excerpts:
      api-enable-delete-branch-on-merge:
      terraform:
        content: |
        content: |
            # Enable automatic branch deletion after pull request merge
            info "5.02 Enabling delete branch on merge..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "delete_branch_on_merge": true
            }') || {
            fail "5.02 Failed to enable delete branch on merge"
            increment_failed
            summary
            exit 0
            }
            # NOTE: The CODEOWNERS file itself must be committed to the repository
            # (e.g., .github/CODEOWNERS). This Terraform resource enforces that
            # pull requests require approval from designated code owners before merge.
            resource "github_branch_protection" "main_codeowners" {
            repository_id = var.repository_id
            pattern       = "main"
          
            required_pull_request_reviews {
              require_code_owner_reviews = true
            }
            }
  api:
  sigma:
    - lang: "yaml"
    lang: "bash"
      filename: "hth-github-5.02-enable-delete-branch-on-merge.yml"
    filename: "hth-github-3.06-require-codeowners-file.sh"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.02-enable-delete-branch-on-merge.yml"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.06-require-codeowners-file.sh"
    excerpts:
      excerpts:
      api-audit-codeowners:
        detection:
          content: |
        content: |
            # Audit: Check for CODEOWNERS file in standard locations
            # Note: CODEOWNERS must be committed to the repo -- cannot be created via API
            FOUND=false
          
            for LOCATION in ".github/CODEOWNERS" "CODEOWNERS" "docs/CODEOWNERS"; do
            CONTENT=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/contents/${LOCATION}" 2>/dev/null) || continue
            HAS_NAME=$(echo "${CONTENT}" | jq -r 'has("name")' 2>/dev/null || echo "false")
            if [ "${HAS_NAME}" = "true" ]; then
              pass "3.06 CODEOWNERS file found at ${LOCATION}"
              FOUND=true
              break
            fi
            done
              detection:
                selection:
                    action: 'repo.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
  sigma:

    - lang: "yaml"
"5.3":
  api:
      filename: "hth-github-3.06-require-codeowners-file.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.06-require-codeowners-file.yml"
    lang: "bash"
      excerpts:
    filename: "hth-github-5.03-audit-org-webhooks.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.03-audit-org-webhooks.sh"
        detection:
    excerpts:
          content: |
      api-audit-webhooks:
              detection:
                selection:
                    action: 'protected_branch.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
        content: |

"3.7":
            # Audit: Check all org webhooks for insecure HTTP URLs and missing secrets
            HOOKS=$(gh_get "/orgs/${GITHUB_ORG}/hooks") || {
            fail "5.03 Unable to retrieve org webhooks (may require admin:org_hook scope)"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL_HOOKS=$(echo "${HOOKS}" | jq '. | length' 2>/dev/null || echo "0")
            info "5.03 Found ${TOTAL_HOOKS} organization webhook(s)"
          
            ISSUES=0
          
            if [ "${TOTAL_HOOKS}" -gt 0 ]; then
            # Check for HTTP (non-HTTPS) webhook URLs
            HTTP_HOOKS=$(echo "${HOOKS}" | jq '[.[] | select(.config.url | test("^http://"))] | length' 2>/dev/null || echo "0")
            if [ "${HTTP_HOOKS}" -gt 0 ]; then
              fail "5.03 ${HTTP_HOOKS} webhook(s) use insecure HTTP (should use HTTPS)"
              echo "${HOOKS}" | jq -r '.[] | select(.config.url | test("^http://")) | "  ID: \(.id) | URL: \(.config.url)"' 2>/dev/null
              ISSUES=$((ISSUES + HTTP_HOOKS))
            fi
          
            # Check for webhooks without secrets configured
            NO_SECRET=$(echo "${HOOKS}" | jq '[.[] | select(.config.secret == null or .config.secret == "")] | length' 2>/dev/null || echo "0")
            if [ "${NO_SECRET}" -gt 0 ]; then
              warn "5.03 ${NO_SECRET} webhook(s) have no secret configured"
              echo "${HOOKS}" | jq -r '.[] | select(.config.secret == null or .config.secret == "") | "  ID: \(.id) | URL: \(.config.url)"' 2>/dev/null
              ISSUES=$((ISSUES + NO_SECRET))
            fi
          
            # List all webhooks for review
            info "5.03 All webhooks:"
            echo "${HOOKS}" | jq -r '.[] | "  ID: \(.id) | URL: \(.config.url) | Active: \(.active) | Events: \(.events | join(", "))"' 2>/dev/null
            fi
  terraform:
  sigma:
    lang: "hcl"
    - lang: "yaml"
      filename: "hth-github-5.03-audit-org-webhooks.yml"
    filename: "hth-github-3.07-require-signed-commits.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-3.07-require-signed-commits.tf"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.03-audit-org-webhooks.yml"
      excerpts:
    excerpts:
        detection:
      terraform:
        content: |
          content: |
              detection:
                selection:
                    action: 'hook.create'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
            resource "github_branch_protection" "main_signed" {
            repository_id          = var.repository_id
            pattern                = "main"
            require_signed_commits = true
            }
  api:

"5.4":
    lang: "bash"
  api:
    filename: "hth-github-3.07-require-signed-commits.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-3.07-require-signed-commits.sh"
    lang: "bash"
    excerpts:
    filename: "hth-github-5.04-audit-outside-collaborators.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.04-audit-outside-collaborators.sh"
    excerpts:
      api-audit-signed-commits:
        content: |
      api-audit-outside-collaborators:
            # Audit: Check recent commits for GPG/SSH signature verification
            # Note: Commit signing is per-developer; enforcement is via branch protection rules
            info "3.07 Checking recent commit signatures..."
            COMMITS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/commits?per_page=10") || {
            fail "3.07 Unable to retrieve commits for ${GITHUB_ORG}/${REPO}"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL=$(echo "${COMMITS}" | jq '. | length' 2>/dev/null || echo "0")
            VERIFIED=$(echo "${COMMITS}" | jq '[.[] | select(.commit.verification.verified == true)] | length' 2>/dev/null || echo "0")
            UNVERIFIED=$((TOTAL - VERIFIED))
          
            info "3.07 Checked ${TOTAL} recent commits: ${VERIFIED} signed, ${UNVERIFIED} unsigned"
          
            # Check if branch protection enforces signed commits
            REPO_META=$(gh_get "/repos/${GITHUB_ORG}/${REPO}") || true
            DEFAULT_BRANCH=$(echo "${REPO_META}" | jq -r '.default_branch // "main"' 2>/dev/null)
          
            SIGNATURE_REQUIRED="false"
            PROTECTION=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/branches/${DEFAULT_BRANCH}/protection/required_signatures" 2>/dev/null) && {
            SIGNATURE_REQUIRED=$(echo "${PROTECTION}" | jq -r '.enabled // false' 2>/dev/null || echo "false")
            }
        content: |
  sigma:
    - lang: "yaml"
            # Audit: List all outside collaborators in the organization
            COLLABORATORS=$(gh_get "/orgs/${GITHUB_ORG}/outside_collaborators?per_page=100") || {
            fail "5.04 Unable to retrieve outside collaborators (may require members:read scope)"
            increment_failed
            summary
            exit 0
            }
          
            COLLAB_COUNT=$(echo "${COLLABORATORS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "5.04 Found ${COLLAB_COUNT} outside collaborator(s)"
          
            if [ "${COLLAB_COUNT}" -gt 0 ]; then
            warn "5.04 Outside collaborators with repository access:"
            echo "${COLLABORATORS}" | jq -r '.[] | "  Login: \(.login) | ID: \(.id) | Site Admin: \(.site_admin)"' 2>/dev/null
            fi
      filename: "hth-github-3.07-require-signed-commits.yml"
  sigma:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-3.07-require-signed-commits.yml"
    - lang: "yaml"
      filename: "hth-github-5.04-audit-outside-collaborators.yml"
      excerpts:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.04-audit-outside-collaborators.yml"
        detection:
      excerpts:
          content: |
        detection:
              detection:
                selection:
                    action: 'protected_branch.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
          content: |

"4.1":
              detection:
                selection:
                    action: 'org.add_outside_collaborator'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

  terraform:
    lang: "hcl"
"5.5":
    filename: "hth-github-4.01-enable-vulnerability-alerts.tf"
  terraform:
    lang: "hcl"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-4.01-enable-vulnerability-alerts.tf"
    filename: "hth-github-5.05-protect-deployment-environments.tf"
    excerpts:
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.05-protect-deployment-environments.tf"
      terraform:
    excerpts:
        content: |
      terraform:
            resource "github_repository" "how_to_harden_vuln_alerts" {
            name               = var.repository_name
            vulnerability_alerts = true
            }
        content: |
  api:
    lang: "bash"
            resource "github_repository_environment" "production" {
            environment = "production"
            repository  = var.repository_name
          
            reviewers {
              teams = [var.security_team_id]
            }
          
            deployment_branch_policy {
              protected_branches     = true
              custom_branch_policies = false
            }
            }
  api:
    filename: "hth-github-4.01-enable-vulnerability-alerts.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.01-enable-vulnerability-alerts.sh"
    lang: "bash"
    excerpts:
    filename: "hth-github-5.05-protect-deployment-environments.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.05-protect-deployment-environments.sh"
    excerpts:
      api-check-vulnerability-alerts:
        content: |
      api-audit-environments:
        content: |
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X GET \
            "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28")
      api-enable-vulnerability-alerts:
            # Audit: Check all deployment environments for protection rules
            ENVS_DATA=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/environments") || {
            warn "5.05 Unable to retrieve environments (may not exist or require admin access)"
            increment_applied
            summary
            exit 0
            }
          
            ENVS=$(echo "${ENVS_DATA}" | jq -r '.environments // []')
            ENV_COUNT=$(echo "${ENVS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "5.05 Found ${ENV_COUNT} deployment environment(s)"
          
            if [ "${ENV_COUNT}" = "0" ]; then
            pass "5.05 No deployment environments configured (nothing to protect)"
            increment_applied
            summary
            exit 0
            fi
          
            UNPROTECTED=0
            for ENV_NAME in $(echo "${ENVS}" | jq -r '.[].name' 2>/dev/null); do
            RULES_COUNT=$(echo "${ENVS}" | jq "[.[] | select(.name == \"${ENV_NAME}\") | .protection_rules // [] | length] | add // 0" 2>/dev/null || echo "0")
            if [ "${RULES_COUNT}" = "0" ]; then
              warn "5.05 Environment '${ENV_NAME}' has no protection rules"
              UNPROTECTED=$((UNPROTECTED + 1))
            else
              pass "5.05 Environment '${ENV_NAME}' has ${RULES_COUNT} protection rule(s)"
            fi
            done
      api-protect-environments:
        content: |
        content: |
            # Enable Dependabot vulnerability alerts on the repository
            info "4.01 Enabling vulnerability alerts..."
            ENABLE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
            "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
            -H "${AUTH_HEADER}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28")
  sigma:
            # Add protection rules to unprotected deployment environments
            for ENV_NAME in $(echo "${ENVS}" | jq -r '.[].name' 2>/dev/null); do
            RULES_COUNT=$(echo "${ENVS}" | jq "[.[] | select(.name == \"${ENV_NAME}\") | .protection_rules // [] | length] | add // 0" 2>/dev/null || echo "0")
            if [ "${RULES_COUNT}" = "0" ]; then
              info "5.05 Adding protection rules to environment '${ENV_NAME}'..."
              gh_put "/repos/${GITHUB_ORG}/${REPO}/environments/${ENV_NAME}" '{
                "deployment_branch_policy": {
                  "protected_branches": true,
                  "custom_branch_policies": false
                }
              }' > /dev/null 2>&1 && {
                pass "5.05 Protection added to environment '${ENV_NAME}'"
              } || {
                warn "5.05 Failed to add protection to environment '${ENV_NAME}'"
              }
            fi
            done
  sigma:
    - lang: "yaml"
    - lang: "yaml"
      filename: "hth-github-4.01-enable-vulnerability-alerts.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.01-enable-vulnerability-alerts.yml"
      filename: "hth-github-5.05-protect-deployment-environments.yml"
      excerpts:
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.05-protect-deployment-environments.yml"
        detection:
      excerpts:
          content: |
        detection:
          content: |
              detection:
                selection:
                    action: 'repository_vulnerability_alerts.disable'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

              detection:
                selection_update:
                    action: 'environment.update_protection_rules'
                selection_delete:
                    action: 'environment.delete'
                condition: selection_update or selection_delete
              fields:
                - actor
                - action
                - org
                - repo
                - created_at
"4.2":

  api:
    lang: "bash"
    filename: "hth-github-4.02-review-open-dependabot-alerts.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.02-review-open-dependabot-alerts.sh"
    excerpts:
      api-audit-dependabot-alerts:
        content: |
            # Audit: Check for critical and high severity open Dependabot alerts
            info "4.02 Checking critical Dependabot alerts..."
            CRITICAL_ALERTS=$(gh_get "/orgs/${GITHUB_ORG}/dependabot/alerts?state=open&severity=critical&per_page=100" 2>/dev/null) || {
            warn "4.02 Unable to query Dependabot alerts (may require security_events scope)"
            CRITICAL_ALERTS="[]"
            }
            CRITICAL_COUNT=$(echo "${CRITICAL_ALERTS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "4.02 Checking high severity Dependabot alerts..."
            HIGH_ALERTS=$(gh_get "/orgs/${GITHUB_ORG}/dependabot/alerts?state=open&severity=high&per_page=100" 2>/dev/null) || {
            warn "4.02 Unable to query high severity Dependabot alerts"
            HIGH_ALERTS="[]"
            }
            HIGH_COUNT=$(echo "${HIGH_ALERTS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "4.02 Open alerts -- Critical: ${CRITICAL_COUNT}, High: ${HIGH_COUNT}"
          
            # List affected repositories for critical alerts
            if [ "${CRITICAL_COUNT}" -gt 0 ]; then
            warn "4.02 Repositories with critical alerts:"
            echo "${CRITICAL_ALERTS}" | jq -r '.[].repository.full_name' 2>/dev/null | sort -u | while read -r REPO_NAME; do
              COUNT=$(echo "${CRITICAL_ALERTS}" | jq -r "[.[] | select(.repository.full_name == \"${REPO_NAME}\")] | length" 2>/dev/null)
              warn "4.02   ${REPO_NAME}: ${COUNT} critical alert(s)"
            done
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-github-4.02-review-open-dependabot-alerts.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.02-review-open-dependabot-alerts.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repository_vulnerability_alert.dismiss'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"4.3":
  api:
    lang: "bash"
    filename: "hth-github-4.03-audit-deploy-keys.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-4.03-audit-deploy-keys.sh"
    excerpts:
      api-audit-deploy-keys:
        content: |
            # Audit: Check for deploy keys with write access (read_only == false)
            KEYS=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/keys") || {
            fail "4.03 Unable to retrieve deploy keys for ${GITHUB_ORG}/${REPO}"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL_KEYS=$(echo "${KEYS}" | jq '. | length' 2>/dev/null || echo "0")
            WRITE_KEYS=$(echo "${KEYS}" | jq '[.[] | select(.read_only == false)] | length' 2>/dev/null || echo "0")
            READ_KEYS=$((TOTAL_KEYS - WRITE_KEYS))
          
            info "4.03 Found ${TOTAL_KEYS} deploy key(s): ${READ_KEYS} read-only, ${WRITE_KEYS} read-write"
          
            # List write-access keys for review
            if [ "${WRITE_KEYS}" -gt 0 ]; then
            warn "4.03 Deploy keys with WRITE access (review required):"
            echo "${KEYS}" | jq -r '.[] | select(.read_only == false) | "  ID: \(.id) | Title: \(.title) | Created: \(.created_at)"' 2>/dev/null
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-github-4.03-audit-deploy-keys.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-4.03-audit-deploy-keys.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'deploy_key.create'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.01-disable-wiki-on-non-documentation-repos.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden_wiki" {
            name     = var.repository_name
            has_wiki = false
            }
  api:
    lang: "bash"
    filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.01-disable-wiki-on-non-documentation-repos.sh"
    excerpts:
      api-disable-wiki:
        content: |
            # Disable wiki on the repository
            info "5.01 Disabling wiki on ${REPO}..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
              "has_wiki": false
            }') || {
              fail "5.01 Failed to disable wiki on ${REPO}"
              increment_failed
              summary
              exit 0
            }
      api-disable-wiki-bulk:
        content: |
            # Disable wiki on all repositories that have it enabled
            for REPO_NAME in ${REPOS_WITH_WIKI}; do
            info "5.01 Disabling wiki on ${REPO_NAME}..."
            gh_patch "/repos/${GITHUB_ORG}/${REPO_NAME}" '{"has_wiki": false}' > /dev/null 2>&1 && {
              pass "5.01 Wiki disabled on ${REPO_NAME}"
            } || {
              warn "5.01 Failed to disable wiki on ${REPO_NAME}"
            }
            done
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.01-disable-wiki-on-non-documentation-repos.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.01-disable-wiki-on-non-documentation-repos.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repo.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-github-5.02-enable-delete-branch-on-merge.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.02-enable-delete-branch-on-merge.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository" "how_to_harden" {
            name                   = var.repository_name
            delete_branch_on_merge = true
            }
  api:
    lang: "bash"
    filename: "hth-github-5.02-enable-delete-branch-on-merge.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.02-enable-delete-branch-on-merge.sh"
    excerpts:
      api-enable-delete-branch-on-merge:
        content: |
            # Enable automatic branch deletion after pull request merge
            info "5.02 Enabling delete branch on merge..."
            RESPONSE=$(gh_patch "/repos/${GITHUB_ORG}/${REPO}" '{
            "delete_branch_on_merge": true
            }') || {
            fail "5.02 Failed to enable delete branch on merge"
            increment_failed
            summary
            exit 0
            }
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.02-enable-delete-branch-on-merge.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.02-enable-delete-branch-on-merge.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'repo.update'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.3":
  api:
    lang: "bash"
    filename: "hth-github-5.03-audit-org-webhooks.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.03-audit-org-webhooks.sh"
    excerpts:
      api-audit-webhooks:
        content: |
            # Audit: Check all org webhooks for insecure HTTP URLs and missing secrets
            HOOKS=$(gh_get "/orgs/${GITHUB_ORG}/hooks") || {
            fail "5.03 Unable to retrieve org webhooks (may require admin:org_hook scope)"
            increment_failed
            summary
            exit 0
            }
          
            TOTAL_HOOKS=$(echo "${HOOKS}" | jq '. | length' 2>/dev/null || echo "0")
            info "5.03 Found ${TOTAL_HOOKS} organization webhook(s)"
          
            ISSUES=0
          
            if [ "${TOTAL_HOOKS}" -gt 0 ]; then
            # Check for HTTP (non-HTTPS) webhook URLs
            HTTP_HOOKS=$(echo "${HOOKS}" | jq '[.[] | select(.config.url | test("^http://"))] | length' 2>/dev/null || echo "0")
            if [ "${HTTP_HOOKS}" -gt 0 ]; then
              fail "5.03 ${HTTP_HOOKS} webhook(s) use insecure HTTP (should use HTTPS)"
              echo "${HOOKS}" | jq -r '.[] | select(.config.url | test("^http://")) | "  ID: \(.id) | URL: \(.config.url)"' 2>/dev/null
              ISSUES=$((ISSUES + HTTP_HOOKS))
            fi
          
            # Check for webhooks without secrets configured
            NO_SECRET=$(echo "${HOOKS}" | jq '[.[] | select(.config.secret == null or .config.secret == "")] | length' 2>/dev/null || echo "0")
            if [ "${NO_SECRET}" -gt 0 ]; then
              warn "5.03 ${NO_SECRET} webhook(s) have no secret configured"
              echo "${HOOKS}" | jq -r '.[] | select(.config.secret == null or .config.secret == "") | "  ID: \(.id) | URL: \(.config.url)"' 2>/dev/null
              ISSUES=$((ISSUES + NO_SECRET))
            fi
          
            # List all webhooks for review
            info "5.03 All webhooks:"
            echo "${HOOKS}" | jq -r '.[] | "  ID: \(.id) | URL: \(.config.url) | Active: \(.active) | Events: \(.events | join(", "))"' 2>/dev/null
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.03-audit-org-webhooks.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.03-audit-org-webhooks.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'hook.create'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.4":
  api:
    lang: "bash"
    filename: "hth-github-5.04-audit-outside-collaborators.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.04-audit-outside-collaborators.sh"
    excerpts:
      api-audit-outside-collaborators:
        content: |
            # Audit: List all outside collaborators in the organization
            COLLABORATORS=$(gh_get "/orgs/${GITHUB_ORG}/outside_collaborators?per_page=100") || {
            fail "5.04 Unable to retrieve outside collaborators (may require members:read scope)"
            increment_failed
            summary
            exit 0
            }
          
            COLLAB_COUNT=$(echo "${COLLABORATORS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "5.04 Found ${COLLAB_COUNT} outside collaborator(s)"
          
            if [ "${COLLAB_COUNT}" -gt 0 ]; then
            warn "5.04 Outside collaborators with repository access:"
            echo "${COLLABORATORS}" | jq -r '.[] | "  Login: \(.login) | ID: \(.id) | Site Admin: \(.site_admin)"' 2>/dev/null
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.04-audit-outside-collaborators.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.04-audit-outside-collaborators.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    action: 'org.add_outside_collaborator'
                condition: selection
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

"5.5":
  terraform:
    lang: "hcl"
    filename: "hth-github-5.05-protect-deployment-environments.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/terraform/hth-github-5.05-protect-deployment-environments.tf"
    excerpts:
      terraform:
        content: |
            resource "github_repository_environment" "production" {
            environment = "production"
            repository  = var.repository_name
          
            reviewers {
              teams = [var.security_team_id]
            }
          
            deployment_branch_policy {
              protected_branches     = true
              custom_branch_policies = false
            }
            }
  api:
    lang: "bash"
    filename: "hth-github-5.05-protect-deployment-environments.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/api/hth-github-5.05-protect-deployment-environments.sh"
    excerpts:
      api-audit-environments:
        content: |
            # Audit: Check all deployment environments for protection rules
            ENVS_DATA=$(gh_get "/repos/${GITHUB_ORG}/${REPO}/environments") || {
            warn "5.05 Unable to retrieve environments (may not exist or require admin access)"
            increment_applied
            summary
            exit 0
            }
          
            ENVS=$(echo "${ENVS_DATA}" | jq -r '.environments // []')
            ENV_COUNT=$(echo "${ENVS}" | jq '. | length' 2>/dev/null || echo "0")
          
            info "5.05 Found ${ENV_COUNT} deployment environment(s)"
          
            if [ "${ENV_COUNT}" = "0" ]; then
            pass "5.05 No deployment environments configured (nothing to protect)"
            increment_applied
            summary
            exit 0
            fi
          
            UNPROTECTED=0
            for ENV_NAME in $(echo "${ENVS}" | jq -r '.[].name' 2>/dev/null); do
            RULES_COUNT=$(echo "${ENVS}" | jq "[.[] | select(.name == \"${ENV_NAME}\") | .protection_rules // [] | length] | add // 0" 2>/dev/null || echo "0")
            if [ "${RULES_COUNT}" = "0" ]; then
              warn "5.05 Environment '${ENV_NAME}' has no protection rules"
              UNPROTECTED=$((UNPROTECTED + 1))
            else
              pass "5.05 Environment '${ENV_NAME}' has ${RULES_COUNT} protection rule(s)"
            fi
            done
      api-protect-environments:
        content: |
            # Add protection rules to unprotected deployment environments
            for ENV_NAME in $(echo "${ENVS}" | jq -r '.[].name' 2>/dev/null); do
            RULES_COUNT=$(echo "${ENVS}" | jq "[.[] | select(.name == \"${ENV_NAME}\") | .protection_rules // [] | length] | add // 0" 2>/dev/null || echo "0")
            if [ "${RULES_COUNT}" = "0" ]; then
              info "5.05 Adding protection rules to environment '${ENV_NAME}'..."
              gh_put "/repos/${GITHUB_ORG}/${REPO}/environments/${ENV_NAME}" '{
                "deployment_branch_policy": {
                  "protected_branches": true,
                  "custom_branch_policies": false
                }
              }' > /dev/null 2>&1 && {
                pass "5.05 Protection added to environment '${ENV_NAME}'"
              } || {
                warn "5.05 Failed to add protection to environment '${ENV_NAME}'"
              }
            fi
            done
  sigma:
    - lang: "yaml"
      filename: "hth-github-5.05-protect-deployment-environments.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/github/siem/sigma/hth-github-5.05-protect-deployment-environments.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection_update:
                    action: 'environment.update_protection_rules'
                selection_delete:
                    action: 'environment.delete'
                condition: selection_update or selection_delete
              fields:
                - actor
                - action
                - org
                - repo
                - created_at

