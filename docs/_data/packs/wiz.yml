# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-18T04:08:24Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-wiz-1.01-enforce-sso-with-mfa.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/wiz/terraform/hth-wiz-1.01-enforce-sso-with-mfa.tf"
    excerpts:
      terraform:
        content: |
            # Configure SAML SSO identity provider for Wiz console access
            resource "wiz_saml_idp" "corporate_sso" {
            count = var.saml_login_url != "" ? 1 : 0
          
            name                       = var.saml_idp_name
            login_url                  = var.saml_login_url
            certificate                = var.saml_certificate
            issuer_url                 = var.saml_issuer_url != "" ? var.saml_issuer_url : var.saml_login_url
            logout_url                 = var.saml_logout_url != "" ? var.saml_logout_url : null
            use_provider_managed_roles = false
            allow_manual_role_override = false
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-wiz-1.02-implement-rbac.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/wiz/terraform/hth-wiz-1.02-implement-rbac.tf"
    excerpts:
      terraform:
        content: |
            # Map SAML groups to Wiz roles with least-privilege access
            # Role strategy:
            #   - Admin:            Full platform access (limit to 2-3 users)
            #   - Security Analyst: View issues, run queries, NO settings
            #   - Developer:        View assigned projects only
            #   - Auditor:          Read-only access, reports
            #   - Integration:      API access for specific use cases
            resource "wiz_saml_group_mapping" "rbac" {
            count = var.saml_idp_id != "" && length(var.rbac_group_mappings) > 0 ? 1 : 0
          
            saml_idp_id = var.saml_idp_id
          
            dynamic "group_mapping" {
              for_each = var.rbac_group_mappings
              content {
                provider_group_id = group_mapping.value.provider_group_id
                role              = group_mapping.value.role
                projects          = length(group_mapping.value.projects) > 0 ? group_mapping.value.projects : null
              }
            }
            }
          
            # Create project-based access boundaries for team segregation
            resource "wiz_project" "team_projects" {
            for_each = var.profile_level >= 1 ? toset(["security", "development", "audit"]) : toset([])
          
            name        = "hth-${each.key}"
            description = "HTH hardened project for ${each.key} team - least-privilege boundary"
          
            risk_profile {
              business_impact = each.key == "security" ? "HBI" : "MBI"
            }
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-wiz-2.01-secure-cloud-connector-configuration.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/wiz/terraform/hth-wiz-2.01-secure-cloud-connector-configuration.tf"
    excerpts:
      terraform:
        content: |
            # AWS connector with least-privilege IAM role (read-only)
            # The IAM role referenced here should grant only:
            #   ec2:Describe*, s3:GetBucketLocation, s3:GetBucketPolicy,
            #   s3:ListAllMyBuckets, iam:GetAccountSummary, iam:ListRoles
            # with an external ID condition on the trust policy.
            resource "wiz_connector_aws" "hardened" {
            count = var.aws_connector_role_arn != "" ? 1 : 0
          
            name    = var.aws_connector_name
            enabled = true
          
            auth_params = jsonencode({
              "customerRoleARN" = var.aws_connector_role_arn
            })
          
            extra_config = jsonencode({
              "optedInRegions"       = var.aws_connector_regions
              "excludedAccounts"     = var.aws_connector_excluded_accounts
              "skipOrganizationScan" = false
            })
            }
          
            # GCP connector with Viewer role (read-only, organization-level)
            resource "wiz_connector_gcp" "hardened" {
            count = var.gcp_connector_organization_id != "" ? 1 : 0
          
            name    = var.gcp_connector_name
            enabled = true
          
            auth_params = jsonencode({
              "isManagedIdentity" = true
              "organization_id"   = var.gcp_connector_organization_id
            })
          
            extra_config = jsonencode({
              "projects"              = []
              "excludedProjects"      = var.gcp_connector_excluded_projects
              "includedFolders"       = []
              "excludedFolders"       = []
              "auditLogMonitorEnabled" = true
            })
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-wiz-2.02-connector-credential-rotation.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/wiz/terraform/hth-wiz-2.02-connector-credential-rotation.tf"
    excerpts:
      terraform:
        content: |
            # Credential rotation monitoring control
            # Detects cloud connectors with credentials that have not been rotated
            # within the organization's rotation policy window.
            #
            # Rotation schedule:
            #   AWS:   External ID rotation annually
            #   Azure: App registration secret rotation quarterly
            #   GCP:   Service account key rotation quarterly
            resource "wiz_control" "connector_credential_rotation" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name        = "HTH: Connector Credential Rotation Monitoring"
            description = "Detects cloud connectors with stale credentials that require rotation per HTH hardening guide section 2.2"
            severity    = "HIGH"
            enabled     = true
            project_id  = "*"
          
            resolution_recommendation = "Rotate connector credentials according to schedule: AWS External ID annually, Azure app secret quarterly, GCP service account key quarterly. See https://howtoharden.com/guides/wiz/#22-connector-credential-rotation"
          
            query = jsonencode({
              type = [
                "CLOUD_ACCOUNT"
              ]
              select = true
              where = {
                status = {
                  EQUALS = [
                    "CONNECTED"
                  ]
                }
              }
            })
          
            scope_query = jsonencode({
              type = [
                "SUBSCRIPTION"
              ]
              select = true
            })
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-wiz-3.01-service-account-management.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/wiz/terraform/hth-wiz-3.01-service-account-management.tf"
    excerpts:
      terraform:
        content: |
            # Create purpose-specific service accounts with minimum scopes
            # Each integration gets its own account with only required permissions:
            #   SIEM:       read:issues, read:vulnerabilities
            #   Ticketing:  read:issues
            #   Automation: Specific to use case
            resource "wiz_service_account" "integration" {
            for_each = { for sa in var.service_accounts : sa.name => sa }
          
            name   = each.value.name
            type   = "THIRD_PARTY"
            scopes = each.value.scopes
          
            # Detect external credential rotation and force resource recreation
            recreate_if_rotated = true
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-wiz-3.02-api-access-monitoring.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/wiz/terraform/hth-wiz-3.02-api-access-monitoring.tf"
    excerpts:
      terraform:
        content: |
            # Scheduled report for API access audit
            # Runs at the configured interval to detect anomalous API usage patterns
            # such as unusual query volumes, new source IPs, or off-hours access.
            resource "wiz_report_graph_query" "api_access_audit" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name               = var.api_audit_report_name
            project_id         = "*"
            run_interval_hours = var.api_audit_interval_hours
          
            query = jsonencode({
              type = [
                "USER_ACCOUNT"
              ]
              select = true
              where = {
                type = {
                  EQUALS = [
                    "SERVICE"
                  ]
                }
              }
            })
            }
          
            # Control to detect service accounts with overly broad scopes
            resource "wiz_control" "overprivileged_service_accounts" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name        = "HTH: Overprivileged Service Accounts"
            description = "Detects Wiz service accounts with administrative or overly broad API scopes per HTH hardening guide section 3.2"
            severity    = "MEDIUM"
            enabled     = true
            project_id  = "*"
          
            resolution_recommendation = "Review and reduce service account scopes to the minimum required for each integration. See https://howtoharden.com/guides/wiz/#32-api-access-monitoring"
          
            query = jsonencode({
              type = [
                "USER_ACCOUNT"
              ]
              select = true
              where = {
                type = {
                  EQUALS = [
                    "SERVICE"
                  ]
                }
                isAdmin = {
                  EQUALS = true
                }
              }
            })
          
            scope_query = jsonencode({
              type = [
                "SUBSCRIPTION"
              ]
              select = true
            })
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-wiz-4.01-configure-data-export-controls.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/wiz/terraform/hth-wiz-4.01-configure-data-export-controls.tf"
    excerpts:
      terraform:
        content: |
            # Project-based data export boundary
            # Restricts bulk export of security findings and vulnerability data
            # by isolating sensitive findings into a controlled project with
            # limited membership and Admin-only export permissions.
            resource "wiz_project" "data_export_restricted" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name        = var.data_export_project_name
            description = "HTH hardened project with restricted data export permissions. Bulk export limited to Admin role only."
          
            risk_profile {
              business_impact    = "HBI"
              has_exposed_api    = "NO"
              stores_data        = "YES"
              is_regulated       = "YES"
              sensitive_data_types = ["PII", "FINANCIAL"]
              regulatory_standards = ["SOC", "NIST"]
            }
            }
          
            # Control to detect unauthorized large data exports
            resource "wiz_control" "data_export_monitoring" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name        = "HTH: Unauthorized Data Export Detection"
            description = "Detects large or unauthorized exports of security findings and vulnerability data per HTH hardening guide section 4.1"
            severity    = "HIGH"
            enabled     = true
            project_id  = "*"
          
            resolution_recommendation = "Review export activity. Limit bulk export to Admin role only. Configure report sharing with expiration and restrict to internal-only distribution. See https://howtoharden.com/guides/wiz/#41-configure-data-export-controls"
          
            query = jsonencode({
              type = [
                "USER_ACCOUNT"
              ]
              select = true
              where = {
                isAdmin = {
                  EQUALS = false
                }
              }
            })
          
            scope_query = jsonencode({
              type = [
                "SUBSCRIPTION"
              ]
              select = true
            })
            }

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-wiz-5.01-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/wiz/terraform/hth-wiz-5.01-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # Scheduled audit log report for SIEM export
            # Captures authentication events, configuration changes, and API access
            # at regular intervals for correlation and alerting.
            resource "wiz_report_graph_query" "audit_log" {
            name               = var.audit_report_name
            project_id         = "*"
            run_interval_hours = var.audit_report_interval_hours
          
            query = jsonencode({
              type = [
                "USER_ACCOUNT"
              ]
              select = true
              where = {
                status = {
                  EQUALS = [
                    "ACTIVE"
                  ]
                }
              }
            })
            }
          
            # Dedicated service account for SIEM integration (read-only audit access)
            resource "wiz_service_account" "siem_export" {
            name   = "hth-siem-audit-export"
            type   = "THIRD_PARTY"
            scopes = ["read:issues", "read:vulnerabilities"]
          
            recreate_if_rotated = true
            }
          
            # Control to detect unusual data access patterns
            resource "wiz_control" "unusual_data_access" {
            name        = "HTH: Unusual Data Access Pattern Detection"
            description = "Detects unusual query volumes or access patterns that may indicate compromised credentials or insider threats per HTH hardening guide section 5.1"
            severity    = "MEDIUM"
            enabled     = true
            project_id  = "*"
          
            resolution_recommendation = "Investigate the user or service account activity. Review source IPs, query volume, and timing. Correlate with SIEM alerts. See https://howtoharden.com/guides/wiz/#51-audit-logging"
          
            query = jsonencode({
              type = [
                "USER_ACCOUNT"
              ]
              select = true
              where = {
                status = {
                  EQUALS = [
                    "ACTIVE"
                  ]
                }
              }
            })
          
            scope_query = jsonencode({
              type = [
                "SUBSCRIPTION"
              ]
              select = true
            })
            }

