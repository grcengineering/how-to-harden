# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-17T19:27:09Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-hashicorp-vault-1.01-implement-least-privilege-auth-methods.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/hashicorp-vault/terraform/hth-hashicorp-vault-1.01-implement-least-privilege-auth-methods.tf"
    excerpts:
      terraform:
        content: |
            # --- OIDC Auth Method (preferred for human users) ---
            resource "vault_jwt_auth_backend" "oidc" {
            description        = "OIDC authentication for human users"
            path               = "oidc"
            type               = "oidc"
            oidc_discovery_url = var.oidc_discovery_url
            oidc_client_id     = var.oidc_client_id
            oidc_client_secret = var.oidc_client_secret
            default_role       = "default"
          
            tune {
              default_lease_ttl  = "1h"
              max_lease_ttl      = "4h"
              token_type         = "default-service"
            }
            }
          
            resource "vault_jwt_auth_backend_role" "oidc_default" {
            backend        = vault_jwt_auth_backend.oidc.path
            role_name      = "default"
            role_type      = "oidc"
            token_policies = ["default"]
            user_claim     = "email"
            groups_claim   = "groups"
          
            allowed_redirect_uris = var.oidc_redirect_uris
          
            token_ttl     = 3600
            token_max_ttl = 14400
            }
          
            # --- AppRole Auth Method (for CI/CD and automation) ---
            resource "vault_auth_backend" "approle" {
            type        = "approle"
            path        = "approle"
            description = "AppRole authentication for CI/CD pipelines and automation"
          
            tune {
              default_lease_ttl = "30m"
              max_lease_ttl     = "1h"
            }
            }
          
            resource "vault_approle_auth_backend_role" "ci_cd" {
            backend        = vault_auth_backend.approle.path
            role_name      = "ci-cd"
            token_policies = ["ci-cd-read"]
          
            token_ttl          = 1800
            token_max_ttl      = 3600
            secret_id_num_uses = 1
            secret_id_ttl      = 600
            token_num_uses     = 10
            }
          
            # --- Kubernetes Auth Method (for workloads running in K8s) ---
            resource "vault_auth_backend" "kubernetes" {
            type        = "kubernetes"
            path        = "kubernetes"
            description = "Kubernetes authentication for in-cluster workloads"
          
            tune {
              default_lease_ttl = "15m"
              max_lease_ttl     = "1h"
            }
            }
          
            resource "vault_kubernetes_auth_backend_config" "k8s" {
            backend            = vault_auth_backend.kubernetes.path
            kubernetes_host    = var.kubernetes_host
            kubernetes_ca_cert = var.kubernetes_ca_cert
            issuer             = var.kubernetes_issuer
            }
  api:
    lang: "bash"
    filename: "hth-hashicorp-vault-1.01-implement-least-privilege-auth-methods.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/hashicorp-vault/api/hth-hashicorp-vault-1.01-implement-least-privilege-auth-methods.sh"
    excerpts:
      api-configure-auth:
        content: |
            # Check for root token usage (critical finding)
            info "1.1 Checking for root token usage..."
            TOKEN_INFO=$(vault_get "/auth/token/lookup-self" 2>/dev/null || echo '{}')
            TOKEN_POLICIES=$(echo "${TOKEN_INFO}" | jq -r '.data.policies // [] | join(",")' 2>/dev/null || echo "")
          
            if echo "${TOKEN_POLICIES}" | grep -q "root"; then
            fail "1.1 CRITICAL: Current token has root policy -- rotate to a scoped admin token immediately"
            warn "1.1 Root tokens should only be used for break-glass emergency procedures"
            increment_failed
            else
            pass "1.1 Current token does not use root policy"
            fi
          
            # List all enabled auth methods
            info "1.1 Listing enabled auth methods..."
            AUTH_METHODS=$(vault_get "/sys/auth" 2>/dev/null || echo '{}')
            AUTH_PATHS=$(echo "${AUTH_METHODS}" | jq -r '.data // . | to_entries[] | select(.value.type?) | "\(.key) (\(.value.type))"' 2>/dev/null || true)
          
            if [ -n "${AUTH_PATHS}" ]; then
            pass "1.1 Enabled auth methods:"
            echo "${AUTH_PATHS}" | while read -r line; do
              echo "  - ${line}"
            done
            else
            fail "1.1 Could not retrieve auth methods -- check token permissions"
            increment_failed
            fi
          
            # Verify OIDC is configured (preferred for human users)
            info "1.1 Checking for OIDC auth method..."
            OIDC_ENABLED=$(echo "${AUTH_METHODS}" | jq -r '.data // . | to_entries[] | select(.value.type == "oidc") | .key' 2>/dev/null || true)
          
            if [ -n "${OIDC_ENABLED}" ]; then
            pass "1.1 OIDC auth method enabled at path: ${OIDC_ENABLED}"
          
            # Verify OIDC configuration is complete
            OIDC_CONFIG=$(vault_get "/auth/oidc/config" 2>/dev/null || echo '{}')
            OIDC_DISCOVERY=$(echo "${OIDC_CONFIG}" | jq -r '.data.oidc_discovery_url // empty' 2>/dev/null || true)
          
            if [ -n "${OIDC_DISCOVERY}" ]; then
              pass "1.1 OIDC discovery URL configured: ${OIDC_DISCOVERY}"
            else
              warn "1.1 OIDC auth method enabled but discovery URL not configured"
            fi
            else
            warn "1.1 OIDC auth method not enabled -- recommended for human user authentication"
            warn "1.1 Enable with: vault auth enable oidc"
            fi
          
            # Check for deprecated or insecure auth methods
            info "1.1 Checking for deprecated auth methods..."
            USERPASS_ENABLED=$(echo "${AUTH_METHODS}" | jq -r '.data // . | to_entries[] | select(.value.type == "userpass") | .key' 2>/dev/null || true)
          
            if [ -n "${USERPASS_ENABLED}" ]; then
            warn "1.1 Userpass auth method detected at: ${USERPASS_ENABLED}"
            warn "1.1 Consider migrating to OIDC for stronger authentication guarantees"
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-hashicorp-vault-1.01-implement-least-privilege-auth-methods.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/hashicorp-vault/siem/sigma/hth-hashicorp-vault-1.01-implement-least-privilege-auth-methods.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection_root_token:
                    auth.policies|contains: 'root'
                selection_auth_changes:
                    request.path|startswith: 'sys/auth'
                    request.operation:
                        - 'update'
                        - 'delete'
                condition: selection_root_token or selection_auth_changes
              fields:
                - auth.display_name
                - auth.policies
                - request.path
                - request.operation
                - request.remote_address
                - time

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-hashicorp-vault-1.02-implement-granular-policies.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/hashicorp-vault/terraform/hth-hashicorp-vault-1.02-implement-granular-policies.tf"
    excerpts:
      terraform:
        content: |
            # --- Base read-only policy for all authenticated users ---
            resource "vault_policy" "base_read" {
            name   = "base-read"
            policy = <<-EOT
              # Allow lookup of own token capabilities
              path "sys/capabilities-self" {
                capabilities = ["update"]
              }
          
              # Allow reading own identity
              path "auth/token/lookup-self" {
                capabilities = ["read"]
              }
          
              # Allow renewing own token
              path "auth/token/renew-self" {
                capabilities = ["update"]
              }
          
              # Deny access to root-level system paths
              path "sys/raw/*" {
                capabilities = ["deny"]
              }
          
              path "sys/seal" {
                capabilities = ["deny"]
              }
            EOT
            }
          
            # --- Team-scoped policy (per-team secret paths) ---
            resource "vault_policy" "team_secrets" {
            for_each = var.team_names
          
            name   = "team-${each.value}-secrets"
            policy = <<-EOT
              # Read and write secrets under team namespace
              path "secret/data/teams/${each.value}/*" {
                capabilities = ["create", "read", "update", "delete", "list"]
              }
          
              path "secret/metadata/teams/${each.value}/*" {
                capabilities = ["list", "read", "delete"]
              }
          
              # Deny cross-team access
              path "secret/data/teams/*" {
                capabilities = ["deny"]
              }
            EOT
            }
          
            # --- CI/CD read-only policy (AppRole consumers) ---
            resource "vault_policy" "ci_cd_read" {
            name   = "ci-cd-read"
            policy = <<-EOT
              # Read-only access to application secrets
              path "secret/data/apps/+/config" {
                capabilities = ["read"]
              }
          
              # Read dynamic database credentials
              path "database/creds/*" {
                capabilities = ["read"]
              }
          
              # Read PKI certificates
              path "pki/issue/*" {
                capabilities = ["read", "update"]
              }
          
              # Deny all write operations on secret engines
              path "secret/data/*" {
                capabilities = ["deny"]
              }
            EOT
            }
          
            # --- Admin policy (Vault operators) ---
            resource "vault_policy" "admin" {
            name   = "vault-admin"
            policy = <<-EOT
              # Manage auth methods
              path "sys/auth/*" {
                capabilities = ["create", "read", "update", "delete", "list", "sudo"]
              }
          
              # Manage policies
              path "sys/policies/*" {
                capabilities = ["create", "read", "update", "delete", "list"]
              }
          
              # Manage secret engines
              path "sys/mounts/*" {
                capabilities = ["create", "read", "update", "delete", "list"]
              }
          
              # Read audit configuration
              path "sys/audit*" {
                capabilities = ["read", "list", "sudo"]
              }
          
              # Manage identity entities and groups
              path "identity/*" {
                capabilities = ["create", "read", "update", "delete", "list"]
              }
          
              # Deny seal/unseal (requires root or auto-unseal)
              path "sys/seal" {
                capabilities = ["deny"]
              }
          
              path "sys/raw/*" {
                capabilities = ["deny"]
              }
            EOT
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-hashicorp-vault-2.01-use-dynamic-secrets.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/hashicorp-vault/terraform/hth-hashicorp-vault-2.01-use-dynamic-secrets.tf"
    excerpts:
      terraform:
        content: |
            # --- Database secrets engine mount ---
            resource "vault_mount" "database" {
            path        = "database"
            type        = "database"
            description = "Dynamic database credential generation"
          
            default_lease_ttl_seconds = 1800
            max_lease_ttl_seconds     = 3600
            }
          
            # --- PostgreSQL connection configuration ---
            resource "vault_database_secret_backend_connection" "postgres" {
            backend       = vault_mount.database.path
            name          = "postgres-app"
            allowed_roles = ["app-readonly", "app-readwrite"]
          
            postgresql {
              connection_url = var.postgres_connection_url
              username       = var.postgres_admin_username
              password       = var.postgres_admin_password
            }
          
            verify_connection = true
            }
          
            # --- Read-only dynamic role ---
            resource "vault_database_secret_backend_role" "app_readonly" {
            backend     = vault_mount.database.path
            name        = "app-readonly"
            db_name     = vault_database_secret_backend_connection.postgres.name
          
            default_ttl = 1800
            max_ttl     = 3600
          
            creation_statements = [
              "CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';",
              "GRANT SELECT ON ALL TABLES IN SCHEMA public TO \"{{name}}\";",
            ]
          
            revocation_statements = [
              "REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM \"{{name}}\";",
              "DROP ROLE IF EXISTS \"{{name}}\";",
            ]
            }
          
            # --- Read-write dynamic role ---
            resource "vault_database_secret_backend_role" "app_readwrite" {
            backend     = vault_mount.database.path
            name        = "app-readwrite"
            db_name     = vault_database_secret_backend_connection.postgres.name
          
            default_ttl = 900
            max_ttl     = 1800
          
            creation_statements = [
              "CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';",
              "GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO \"{{name}}\";",
            ]
          
            revocation_statements = [
              "REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM \"{{name}}\";",
              "DROP ROLE IF EXISTS \"{{name}}\";",
            ]
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-hashicorp-vault-4.01-enable-comprehensive-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/hashicorp-vault/terraform/hth-hashicorp-vault-4.01-enable-comprehensive-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # --- File audit device (local persistent log) ---
            resource "vault_audit" "file" {
            type        = "file"
            path        = "file"
            description = "File-based audit log for local retention"
          
            options = {
              file_path = var.audit_file_path
              log_raw   = "false"
              hmac_accessor = "true"
              mode      = "0600"
            }
            }
          
            # --- Syslog audit device (centralized log forwarding) ---
            resource "vault_audit" "syslog" {
            type        = "syslog"
            path        = "syslog"
            description = "Syslog audit device for SIEM integration"
          
            options = {
              tag      = "vault-audit"
              facility = "AUTH"
              log_raw  = "false"
            }
            }
          
            # --- Socket audit device (real-time log streaming, L2+) ---
            resource "vault_audit" "socket" {
            count       = var.profile_level >= 2 ? 1 : 0
            type        = "socket"
            path        = "socket"
            description = "Socket audit device for real-time log streaming"
          
            options = {
              address     = var.audit_socket_address
              socket_type = "tcp"
              log_raw     = "false"
            }
            }
  api:
    lang: "bash"
    filename: "hth-hashicorp-vault-4.01-enable-comprehensive-audit-logging.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/hashicorp-vault/api/hth-hashicorp-vault-4.01-enable-comprehensive-audit-logging.sh"
    excerpts:
      api-enable-audit:
        content: |
            # Enable file audit device
            if [ -n "${FILE_ENABLED}" ]; then
            pass "4.1 File audit device already enabled"
            else
            info "4.1 Enabling file audit device..."
            vault_put "/sys/audit/file" '{
              "type": "file",
              "description": "File-based audit log for local retention",
              "options": {
                "file_path": "/var/log/vault/audit.log",
                "log_raw": false,
                "hmac_accessor": true,
                "mode": "0600"
              }
            }' > /dev/null 2>&1 && pass "4.1 File audit device enabled" \
              || { fail "4.1 Failed to enable file audit device"; increment_failed; }
            fi
          
            # Enable syslog audit device
            if [ -n "${SYSLOG_ENABLED}" ]; then
            pass "4.1 Syslog audit device already enabled"
            else
            info "4.1 Enabling syslog audit device..."
            vault_put "/sys/audit/syslog" '{
              "type": "syslog",
              "description": "Syslog audit device for SIEM integration",
              "options": {
                "tag": "vault-audit",
                "facility": "AUTH",
                "log_raw": false
              }
            }' > /dev/null 2>&1 && pass "4.1 Syslog audit device enabled" \
              || { fail "4.1 Failed to enable syslog audit device"; increment_failed; }
            fi
  sigma:
    - lang: "yaml"
      filename: "hth-hashicorp-vault-4.01-enable-comprehensive-audit-logging.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/hashicorp-vault/siem/sigma/hth-hashicorp-vault-4.01-enable-comprehensive-audit-logging.yml"
      excerpts:
        detection:
          content: |
              detection:
                selection:
                    request.path|startswith: 'sys/audit'
                    request.operation:
                        - 'delete'
                condition: selection
              fields:
                - auth.display_name
                - auth.policies
                - request.path
                - request.operation
                - request.remote_address
                - time

