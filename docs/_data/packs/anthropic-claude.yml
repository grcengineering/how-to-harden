# AUTO-GENERATED by scripts/sync-packs-to-data.sh — do not edit manually
# Generated: 2026-02-21T16:43:51Z

"1.1":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-1.01-enforce-sso.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-1.01-enforce-sso.sh"
    excerpts:
      api-validate-sso:
        content: |
            # Validate SSO enforcement by listing org members and checking for
            # users who may not have authenticated via SSO.
            # Note: The Admin API does not expose SSO status directly.
            # This audit lists all members so you can cross-reference with your IdP.
            info "Listing all organization members for SSO cross-reference audit..."
            MEMBERS=$(anthropic_list_all "/v1/organizations/users") || {
            fail "1.1 Failed to list organization users"
            summary; exit 0
            }
          
            MEMBER_COUNT=$(echo "${MEMBERS}" | jq 'length')
            info "Found ${MEMBER_COUNT} organization members"
          
            echo "${MEMBERS}" | jq -r '.[] | "\(.name)\t\(.email)\t\(.role)"' | \
            column -t -s $'\t' -N "NAME,EMAIL,ROLE"
          
            pass "1.1 Member list retrieved — cross-reference with IdP to verify SSO coverage"

"1.2":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-1.02-enforce-least-privilege-roles.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-1.02-enforce-least-privilege-roles.sh"
    excerpts:
      api-audit-roles:
        content: |
            # Audit organization member roles — flag users with admin or billing roles
            info "Auditing organization member roles..."
            MEMBERS=$(anthropic_list_all "/v1/organizations/users") || {
            fail "1.2 Failed to list organization users"
            summary; exit 0
            }
          
            # Count by role
            ADMIN_COUNT=$(echo "${MEMBERS}" | jq '[.[] | select(.role == "admin")] | length')
            BILLING_COUNT=$(echo "${MEMBERS}" | jq '[.[] | select(.role == "billing")] | length')
            DEVELOPER_COUNT=$(echo "${MEMBERS}" | jq '[.[] | select(.role == "developer")] | length')
            USER_COUNT=$(echo "${MEMBERS}" | jq '[.[] | select(.role == "user")] | length')
            TOTAL=$(echo "${MEMBERS}" | jq 'length')
          
            info "Role distribution: admin=${ADMIN_COUNT}, billing=${BILLING_COUNT}, developer=${DEVELOPER_COUNT}, user=${USER_COUNT}, total=${TOTAL}"
          
            # Flag excessive admin count
            if [[ "${ADMIN_COUNT}" -gt 3 ]]; then
            warn "1.2 ${ADMIN_COUNT} users have admin role — review for least privilege"
            echo "Admins:"
            echo "${MEMBERS}" | jq -r '.[] | select(.role == "admin") | "  \(.name) <\(.email)>"'
            else
            pass "1.2 Admin count (${ADMIN_COUNT}) is within recommended limit (<=3)"
            fi
      api-downgrade-role:
        content: |
            # Downgrade a user from a privileged role to 'user' or 'developer'
            # Usage: Set USER_ID and TARGET_ROLE before running
            if [[ -n "${USER_ID:-}" && -n "${TARGET_ROLE:-}" ]]; then
            info "Updating user ${USER_ID} to role '${TARGET_ROLE}'..."
            anthropic_post "/v1/organizations/users/${USER_ID}" \
              "{\"role\": \"${TARGET_ROLE}\"}" || {
              fail "1.2 Failed to update user role"
              summary; exit 0
            }
            pass "1.2 User ${USER_ID} updated to role '${TARGET_ROLE}'"
            fi

"1.3":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-1.03-protect-admin-api-keys.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-1.03-protect-admin-api-keys.sh"
    excerpts:
      api-audit-admin-keys:
        content: |
            # Admin API keys (sk-ant-admin...) can only be created in the Console.
            # This script cannot list admin keys — it validates that the current
            # admin key works, and audits all standard API keys for hygiene.
            info "Validating admin key by retrieving organization info..."
            ORG_INFO=$(anthropic_get "/v1/organizations/me") || {
            fail "1.3 Admin key is invalid or expired"
            summary; exit 0
            }
          
            ORG_NAME=$(echo "${ORG_INFO}" | jq -r '.name')
            ORG_TYPE=$(echo "${ORG_INFO}" | jq -r '.type')
            info "Organization: ${ORG_NAME} (type: ${ORG_TYPE})"
            pass "1.3 Admin API key is valid and active"

"2.1":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-2.01-scope-api-keys-to-workspaces.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-2.01-scope-api-keys-to-workspaces.sh"
    excerpts:
      api-audit-keys:
        content: |
            # List all API keys across the organization, grouped by workspace
            info "Auditing API keys across all workspaces..."
            API_KEYS=$(anthropic_list_all "/v1/organizations/api_keys?status=active") || {
            fail "2.1 Failed to list API keys"
            summary; exit 0
            }
          
            KEY_COUNT=$(echo "${API_KEYS}" | jq 'length')
            info "Found ${KEY_COUNT} active API keys"
          
            # Group by workspace
            echo "${API_KEYS}" | jq -r 'group_by(.workspace_id) | .[] |
            "Workspace: \(.[0].workspace_id)\n" +
            ([ .[] | "  Key: \(.name // "unnamed") | Status: \(.status) | Created: \(.created_at)" ] | join("\n"))
            '
          
            # Flag unnamed keys
            UNNAMED=$(echo "${API_KEYS}" | jq '[.[] | select(.name == null or .name == "")] | length')
            if [[ "${UNNAMED}" -gt 0 ]]; then
            warn "2.1 ${UNNAMED} API keys have no name — add descriptive names for auditability"
            else
            pass "2.1 All API keys have descriptive names"
            fi
          
            # Flag keys in default workspace
            DEFAULT_WS_KEYS=$(echo "${API_KEYS}" | jq '[.[] | select(.workspace_id == null)] | length')
            if [[ "${DEFAULT_WS_KEYS}" -gt 0 ]]; then
            warn "2.1 ${DEFAULT_WS_KEYS} keys are in the default workspace — consider scoping to dedicated workspaces"
            fi
      api-disable-key:
        content: |
            # Disable an API key by setting status to inactive
            # Usage: Set KEY_ID before running
            if [[ -n "${KEY_ID:-}" ]]; then
            info "Disabling API key ${KEY_ID}..."
            anthropic_post "/v1/organizations/api_keys/${KEY_ID}" \
              '{"status": "inactive"}' || {
              fail "2.1 Failed to disable API key"
              summary; exit 0
            }
            pass "2.1 API key ${KEY_ID} disabled"
            fi

"2.2":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-2.02-rotate-api-keys-regularly.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-2.02-rotate-api-keys-regularly.sh"
    excerpts:
      api-find-stale-keys:
        content: |
            # Identify API keys that have not been rotated within 90 days
            info "Checking for stale API keys (>90 days since creation)..."
            API_KEYS=$(anthropic_list_all "/v1/organizations/api_keys?status=active") || {
            fail "2.2 Failed to list API keys"
            summary; exit 0
            }
          
            CUTOFF=$(date -d '90 days ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || \
                   date -v-90d '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null)
          
            STALE_KEYS=$(echo "${API_KEYS}" | jq --arg cutoff "${CUTOFF}" \
            '[.[] | select(.created_at < $cutoff)]')
            STALE_COUNT=$(echo "${STALE_KEYS}" | jq 'length')
          
            if [[ "${STALE_COUNT}" -gt 0 ]]; then
            warn "2.2 ${STALE_COUNT} API keys are older than 90 days:"
            echo "${STALE_KEYS}" | jq -r '.[] | "  \(.name // "unnamed") | Created: \(.created_at) | Workspace: \(.workspace_id)"'
            else
            pass "2.2 All API keys are within 90-day rotation window"
            fi
      api-archive-old-key:
        content: |
            # Archive an old API key after rotation
            # Usage: Set OLD_KEY_ID before running
            if [[ -n "${OLD_KEY_ID:-}" ]]; then
            info "Archiving old API key ${OLD_KEY_ID}..."
            anthropic_post "/v1/organizations/api_keys/${OLD_KEY_ID}" \
              '{"status": "archived"}' || {
              fail "2.2 Failed to archive API key"
              summary; exit 0
            }
            pass "2.2 API key ${OLD_KEY_ID} archived"
            fi

"3.1":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-3.01-segment-workspaces.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-3.01-segment-workspaces.sh"
    excerpts:
      api-list-workspaces:
        content: |
            # List all workspaces and their configuration
            info "Listing all workspaces..."
            WORKSPACES=$(anthropic_list_all "/v1/organizations/workspaces") || {
            fail "3.1 Failed to list workspaces"
            summary; exit 0
            }
          
            WS_COUNT=$(echo "${WORKSPACES}" | jq 'length')
            info "Found ${WS_COUNT} workspaces (limit: 100 per organization)"
          
            echo "${WORKSPACES}" | jq -r '.[] |
            "  \(.display_name) | ID: \(.id) | Geo: \(.settings.workspace_geo // "default") | Archived: \(.archived_at // "no")"'
          
            pass "3.1 Workspace inventory complete"
      api-create-workspace:
        content: |
            # Create a new workspace for environment segmentation
            # Usage: Set WS_NAME and optionally WS_GEO before running
            if [[ -n "${WS_NAME:-}" ]]; then
            BODY="{\"name\": \"${WS_NAME}\"}"
            if [[ -n "${WS_GEO:-}" ]]; then
              BODY=$(echo "${BODY}" | jq --arg geo "${WS_GEO}" '. + {settings: {workspace_geo: $geo}}')
            fi
            info "Creating workspace '${WS_NAME}'..."
            RESULT=$(anthropic_post "/v1/organizations/workspaces" "${BODY}") || {
              fail "3.1 Failed to create workspace"
              summary; exit 0
            }
            NEW_ID=$(echo "${RESULT}" | jq -r '.id')
            pass "3.1 Workspace created: ${NEW_ID}"
            fi

"3.2":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-3.02-manage-workspace-membership.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-3.02-manage-workspace-membership.sh"
    excerpts:
      api-audit-workspace-members:
        content: |
            # Audit membership for a specific workspace
            # Usage: Set WORKSPACE_ID before running
            WORKSPACE_ID="${WORKSPACE_ID:-}"
            if [[ -z "${WORKSPACE_ID}" ]]; then
            info "Listing all workspaces to select for audit..."
            WORKSPACES=$(anthropic_list_all "/v1/organizations/workspaces") || {
              fail "3.2 Failed to list workspaces"
              summary; exit 0
            }
            echo "${WORKSPACES}" | jq -r '.[] | "  \(.id)\t\(.display_name)"' | column -t -s $'\t'
            info "Set WORKSPACE_ID=<id> and re-run to audit a specific workspace"
            summary; exit 0
            fi
          
            info "Auditing members of workspace ${WORKSPACE_ID}..."
            MEMBERS=$(anthropic_list_all "/v1/organizations/workspaces/${WORKSPACE_ID}/members") || {
            fail "3.2 Failed to list workspace members"
            summary; exit 0
            }
          
            MEMBER_COUNT=$(echo "${MEMBERS}" | jq 'length')
            info "Workspace has ${MEMBER_COUNT} members"
          
            # List members with roles
            echo "${MEMBERS}" | jq -r '.[] | "  \(.user_id)\t\(.workspace_role)"' | \
            column -t -s $'\t' -N "USER_ID,ROLE"
          
            # Flag workspace admins
            ADMIN_COUNT=$(echo "${MEMBERS}" | jq '[.[] | select(.workspace_role == "workspace_admin")] | length')
            if [[ "${ADMIN_COUNT}" -gt 2 ]]; then
            warn "3.2 ${ADMIN_COUNT} workspace admins found — review for least privilege"
            else
            pass "3.2 Workspace admin count (${ADMIN_COUNT}) is appropriate"
            fi
      api-remove-workspace-member:
        content: |
            # Remove a user from a workspace
            # Usage: Set WORKSPACE_ID and REMOVE_USER_ID before running
            if [[ -n "${REMOVE_USER_ID:-}" ]]; then
            info "Removing user ${REMOVE_USER_ID} from workspace ${WORKSPACE_ID}..."
            anthropic_delete "/v1/organizations/workspaces/${WORKSPACE_ID}/members/${REMOVE_USER_ID}" || {
              fail "3.2 Failed to remove workspace member"
              summary; exit 0
            }
            pass "3.2 User ${REMOVE_USER_ID} removed from workspace"
            fi

"4.1":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-4.01-enforce-data-residency.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-4.01-enforce-data-residency.sh"
    excerpts:
      api-audit-data-residency:
        content: |
            # Audit data residency settings across all workspaces
            info "Auditing data residency configuration per workspace..."
            WORKSPACES=$(anthropic_list_all "/v1/organizations/workspaces") || {
            fail "4.1 Failed to list workspaces"
            summary; exit 0
            }
          
            echo "${WORKSPACES}" | jq -r '.[] | {
            name: .display_name,
            id: .id,
            workspace_geo: (.settings.workspace_geo // "not set"),
            default_inference_geo: (.settings.default_inference_geo // "not set"),
            allowed_inference_geos: (.settings.allowed_inference_geos // ["not restricted"])
            } | "  \(.name) | Geo: \(.workspace_geo) | Default Inference: \(.default_inference_geo) | Allowed: \(.allowed_inference_geos | join(", "))"'
          
            # Flag workspaces without data residency configured
            UNCONFIGURED=$(echo "${WORKSPACES}" | jq '[.[] | select(
            .settings.workspace_geo == null or .settings.workspace_geo == ""
            )] | length')
          
            if [[ "${UNCONFIGURED}" -gt 0 ]]; then
            warn "4.1 ${UNCONFIGURED} workspaces have no explicit data residency setting"
            else
            pass "4.1 All workspaces have data residency configured"
            fi
      api-restrict-inference-geo:
        content: |
            # Restrict a workspace to US-only inference
            # Usage: Set WORKSPACE_ID before running
            if [[ -n "${WORKSPACE_ID:-}" ]]; then
            info "Restricting workspace ${WORKSPACE_ID} to US-only inference..."
            anthropic_post "/v1/organizations/workspaces/${WORKSPACE_ID}" '{
              "settings": {
                "default_inference_geo": "us",
                "allowed_inference_geos": ["us"]
              }
            }' || {
              fail "4.1 Failed to update workspace data residency"
              summary; exit 0
            }
            pass "4.1 Workspace ${WORKSPACE_ID} restricted to US-only inference"
            fi

"5.1":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-5.01-monitor-usage-and-costs.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-5.01-monitor-usage-and-costs.sh"
    excerpts:
      api-usage-report:
        content: |
            # Generate a daily usage report for the past 7 days, grouped by workspace
            START_DATE=$(date -d '7 days ago' '+%Y-%m-%dT00:00:00Z' 2>/dev/null || \
                       date -v-7d '+%Y-%m-%dT00:00:00Z' 2>/dev/null)
            END_DATE=$(date '+%Y-%m-%dT23:59:59Z')
          
            info "Fetching usage report from ${START_DATE} to ${END_DATE}..."
            USAGE=$(anthropic_get "/v1/organizations/usage_report/messages?start_time=${START_DATE}&end_time=${END_DATE}&group_by=workspace&bucket_width=1d") || {
            fail "5.1 Failed to fetch usage report"
            summary; exit 0
            }
          
            echo "${USAGE}" | jq -r '.data[] | "  \(.workspace_id // "default") | Input: \(.input_tokens) | Output: \(.output_tokens) | Date: \(.bucket_start_time)"'
            pass "5.1 Usage report retrieved"
      api-cost-report:
        content: |
            # Generate a cost report for the past 30 days, grouped by workspace
            COST_START=$(date -d '30 days ago' '+%Y-%m-%dT00:00:00Z' 2>/dev/null || \
                       date -v-30d '+%Y-%m-%dT00:00:00Z' 2>/dev/null)
          
            info "Fetching cost report from ${COST_START}..."
            COST=$(anthropic_get "/v1/organizations/cost_report?start_time=${COST_START}&end_time=${END_DATE}&group_by=workspace") || {
            fail "5.1 Failed to fetch cost report"
            summary; exit 0
            }
          
            echo "${COST}" | jq -r '.data[] | "  \(.workspace_id // "default") | Cost: $\(.cost_usd) | Date: \(.bucket_start_time)"'
            pass "5.1 Cost report retrieved"

"5.2":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-5.02-configure-spend-limits.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-5.02-configure-spend-limits.sh"
    excerpts:
      api-cost-anomaly:
        content: |
            # Check for cost anomalies — alert if any workspace exceeds a threshold
            THRESHOLD_USD="${THRESHOLD_USD:-1000}"
            PERIOD_DAYS="${PERIOD_DAYS:-7}"
          
            START_DATE=$(date -d "${PERIOD_DAYS} days ago" '+%Y-%m-%dT00:00:00Z' 2>/dev/null || \
                       date -v-"${PERIOD_DAYS}"d '+%Y-%m-%dT00:00:00Z' 2>/dev/null)
            END_DATE=$(date '+%Y-%m-%dT23:59:59Z')
          
            info "Checking for workspaces exceeding \$${THRESHOLD_USD} in the past ${PERIOD_DAYS} days..."
            COST=$(anthropic_get "/v1/organizations/cost_report?start_time=${START_DATE}&end_time=${END_DATE}&group_by=workspace") || {
            fail "5.2 Failed to fetch cost report"
            summary; exit 0
            }
          
            # Aggregate cost per workspace
            OVER_THRESHOLD=$(echo "${COST}" | jq --argjson threshold "${THRESHOLD_USD}" '
            [.data | group_by(.workspace_id)[] |
             {workspace: .[0].workspace_id, total: ([.[].cost_usd] | add)} |
             select(.total > $threshold)]')
          
            ALERT_COUNT=$(echo "${OVER_THRESHOLD}" | jq 'length')
            if [[ "${ALERT_COUNT}" -gt 0 ]]; then
            warn "5.2 ${ALERT_COUNT} workspace(s) exceed \$${THRESHOLD_USD} threshold:"
            echo "${OVER_THRESHOLD}" | jq -r '.[] | "  \(.workspace) — $\(.total)"'
            else
            pass "5.2 No workspaces exceed \$${THRESHOLD_USD} threshold in ${PERIOD_DAYS}-day window"
            fi

"6.1":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-6.01-audit-pending-invites.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-6.01-audit-pending-invites.sh"
    excerpts:
      api-audit-invites:
        content: |
            # List all pending invites and identify stale ones
            info "Listing all organization invites..."
            INVITES=$(anthropic_list_all "/v1/organizations/invites") || {
            fail "6.1 Failed to list invites"
            summary; exit 0
            }
          
            TOTAL=$(echo "${INVITES}" | jq 'length')
            PENDING=$(echo "${INVITES}" | jq '[.[] | select(.status == "pending")] | length')
            EXPIRED=$(echo "${INVITES}" | jq '[.[] | select(.status == "expired")] | length')
            ACCEPTED=$(echo "${INVITES}" | jq '[.[] | select(.status == "accepted")] | length')
          
            info "Invites: total=${TOTAL}, pending=${PENDING}, expired=${EXPIRED}, accepted=${ACCEPTED}"
          
            if [[ "${PENDING}" -gt 0 ]]; then
            warn "6.1 ${PENDING} pending invites found — review for stale or unauthorized invitations:"
            echo "${INVITES}" | jq -r '.[] | select(.status == "pending") |
              "  \(.email) | Role: \(.role) | Created: \(.created_at) | Expires: \(.expires_at)"'
            else
            pass "6.1 No pending invites"
            fi
      api-revoke-invite:
        content: |
            # Revoke a specific pending invite
            # Usage: Set INVITE_ID before running
            if [[ -n "${INVITE_ID:-}" ]]; then
            info "Revoking invite ${INVITE_ID}..."
            anthropic_delete "/v1/organizations/invites/${INVITE_ID}" || {
              fail "6.1 Failed to revoke invite"
              summary; exit 0
            }
            pass "6.1 Invite ${INVITE_ID} revoked"
            fi

"7.1":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-7.01-deploy-managed-settings.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-7.01-deploy-managed-settings.sh"
    excerpts:
      validate-managed-settings:
        content: |
            # Detect OS and check for managed-settings.json in the correct path
            case "$(uname -s)" in
            Darwin)
              MANAGED_PATH="/Library/Application Support/ClaudeCode/managed-settings.json"
              ;;
            Linux)
              MANAGED_PATH="/etc/claude-code/managed-settings.json"
              ;;
            MINGW*|MSYS*|CYGWIN*)
              MANAGED_PATH="C:\\Program Files\\ClaudeCode\\managed-settings.json"
              ;;
            *)
              warn "7.1 Unknown OS — cannot determine managed-settings.json path"
              summary; exit 0
              ;;
            esac
          
            info "Checking for managed-settings.json at: ${MANAGED_PATH}"
          
            if [[ ! -f "${MANAGED_PATH}" ]]; then
            fail "7.1 managed-settings.json not found — MDM deployment may not be configured"
            summary; exit 0
            fi
          
            pass "7.1 managed-settings.json exists at ${MANAGED_PATH}"
          
            # Validate JSON structure
            if ! jq empty "${MANAGED_PATH}" 2>/dev/null; then
            fail "7.1 managed-settings.json is not valid JSON"
            summary; exit 0
            fi
          
            pass "7.1 managed-settings.json is valid JSON"
          
            # Check critical security settings
            BYPASS_DISABLED=$(jq -r '(.permissions.disableBypassPermissionsMode // .disableBypassPermissionsMode // "not set")' "${MANAGED_PATH}")
            MANAGED_PERMS_ONLY=$(jq -r '.allowManagedPermissionRulesOnly // "not set"' "${MANAGED_PATH}")
            MANAGED_HOOKS_ONLY=$(jq -r '.allowManagedHooksOnly // "not set"' "${MANAGED_PATH}")
            DEFAULT_MODE=$(jq -r '.permissions.defaultMode // "not set"' "${MANAGED_PATH}")
          
            info "Security settings:"
            info "  disableBypassPermissionsMode: ${BYPASS_DISABLED}"
            info "  allowManagedPermissionRulesOnly: ${MANAGED_PERMS_ONLY}"
            info "  allowManagedHooksOnly: ${MANAGED_HOOKS_ONLY}"
            info "  permissions.defaultMode: ${DEFAULT_MODE}"
          
            if [[ "${BYPASS_DISABLED}" == "disable" ]]; then
            pass "7.1 Bypass permissions mode is disabled"
            else
            warn "7.1 disableBypassPermissionsMode is not set to 'disable'"
            fi
          
            if [[ "${MANAGED_PERMS_ONLY}" == "true" ]]; then
            pass "7.1 Only managed permission rules are enforced"
            else
            warn "7.1 allowManagedPermissionRulesOnly is not enabled"
            fi
          
            # Check for deny rules
            DENY_COUNT=$(jq '.permissions.deny // [] | length' "${MANAGED_PATH}" 2>/dev/null || echo 0)
            info "  Deny rules configured: ${DENY_COUNT}"
            if [[ "${DENY_COUNT}" -gt 0 ]]; then
            jq -r '.permissions.deny[]' "${MANAGED_PATH}" 2>/dev/null | while read -r rule; do
              info "    - ${rule}"
            done
            pass "7.1 Deny rules are configured (${DENY_COUNT} rules)"
            else
            warn "7.1 No deny rules configured — consider adding restrictions"
            fi
      managed-settings-baseline:
        content: |
            # L1 Baseline — managed-settings.json
            # Prevents bypass mode and locks down plugin marketplaces.
            # Deploy to:
            #   macOS:   /Library/Application Support/ClaudeCode/managed-settings.json
            #   Linux:   /etc/claude-code/managed-settings.json
            #   Windows: C:\Program Files\ClaudeCode\managed-settings.json
            cat << 'BASELINE'
            {
            "$schema": "https://json.schemastore.org/claude-code-settings.json",
            "permissions": {
              "disableBypassPermissionsMode": "disable"
            },
            "strictKnownMarketplaces": []
            }
            BASELINE
      managed-settings-hardened:
        content: |
            # L2 Hardened — managed-settings.json
            # Disables bypass, enforces managed-only permissions and hooks,
            # blocks web access, and requires confirmation for all Bash commands.
            cat << 'HARDENED'
            {
            "$schema": "https://json.schemastore.org/claude-code-settings.json",
            "permissions": {
              "disableBypassPermissionsMode": "disable",
              "defaultMode": "default",
              "deny": [
                "Read(./.env)",
                "Read(./.env.*)",
                "Read(./secrets/**)",
                "Bash(curl *)",
                "Bash(wget *)",
                "Bash(rm -rf *)",
                "WebSearch",
                "WebFetch"
              ],
              "ask": [
                "Bash"
              ]
            },
            "allowManagedPermissionRulesOnly": true,
            "allowManagedHooksOnly": true,
            "strictKnownMarketplaces": []
            }
            HARDENED
      managed-settings-maximum:
        content: |
            # L3 Maximum Security — managed-settings.json
            # Full lockdown with OS-level bash sandboxing, network restrictions,
            # managed-only permissions and hooks, and no plugin marketplaces.
            cat << 'MAXIMUM'
            {
            "$schema": "https://json.schemastore.org/claude-code-settings.json",
            "permissions": {
              "disableBypassPermissionsMode": "disable",
              "defaultMode": "default",
              "deny": [
                "Read(./.env)",
                "Read(./.env.*)",
                "Read(./secrets/**)",
                "Read(./credentials/**)",
                "Bash(curl *)",
                "Bash(wget *)",
                "Bash(rm -rf *)",
                "Bash(ssh *)",
                "Bash(scp *)",
                "WebSearch",
                "WebFetch"
              ],
              "ask": [
                "Bash"
              ]
            },
            "allowManagedPermissionRulesOnly": true,
            "allowManagedHooksOnly": true,
            "strictKnownMarketplaces": [],
            "sandbox": {
              "enabled": true,
              "autoAllowBashIfSandboxed": false,
              "allowUnsandboxedCommands": false,
              "excludedCommands": [],
              "network": {
                "allowUnixSockets": [],
                "allowAllUnixSockets": false,
                "allowLocalBinding": false,
                "allowedDomains": [],
                "httpProxyPort": null,
                "socksProxyPort": null
              },
              "enableWeakerNestedSandbox": false
            }
            }
            MAXIMUM

"7.2":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-7.02-restrict-permissions.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-7.02-restrict-permissions.sh"
    excerpts:
      permission-deny-rules:
        content: |
            # Example permission deny rules for managed-settings.json
            # Deny rules always take precedence over allow and ask rules.
            # Rule syntax: "Tool" or "Tool(specifier)" with glob patterns.
            #   * matches files in a single directory
            #   ** matches recursively across directories
            cat << 'DENY_RULES'
            {
            "permissions": {
              "deny": [
                "Read(./.env)",
                "Read(./.env.*)",
                "Read(./secrets/**)",
                "Read(./credentials/**)",
                "Read(~/.ssh/**)",
                "Read(~/.aws/**)",
                "Bash(curl *)",
                "Bash(wget *)",
                "Bash(rm -rf *)",
                "Bash(ssh *)",
                "Bash(scp *)",
                "Bash(nc *)",
                "Bash(base64 *)",
                "WebSearch",
                "WebFetch"
              ],
              "ask": [
                "Bash",
                "Bash(git push *)",
                "Bash(git commit *)",
                "Bash(docker *)",
                "Bash(kubectl *)"
              ],
              "allow": [
                "Bash(npm run *)",
                "Bash(npm test)",
                "Bash(git status)",
                "Bash(git diff *)",
                "Bash(git log *)",
                "Bash(ls *)",
                "Bash(cat package.json)",
                "Read",
                "Edit"
              ]
            }
            }
            DENY_RULES
      permission-enforcement:
        content: |
            # Enforce managed-only permission rules
            # When allowManagedPermissionRulesOnly is true, user and project
            # settings cannot define allow, ask, or deny rules — only rules
            # from managed settings apply.
            cat << 'ENFORCEMENT'
            {
            "permissions": {
              "disableBypassPermissionsMode": "disable",
              "defaultMode": "default"
            },
            "allowManagedPermissionRulesOnly": true,
            "allowManagedHooksOnly": true,
            "disableAllHooks": false
            }
            ENFORCEMENT
      sandbox-config:
        content: |
            # OS-level bash sandbox configuration (L3 — Maximum Security)
            # Sandboxing provides filesystem and network isolation for Bash commands.
            # Platform support:
            #   macOS:     Seatbelt (built-in, no install needed)
            #   Linux/WSL2: bubblewrap (apt install bubblewrap socat)
            #   Windows:   Not yet supported
            cat << 'SANDBOX'
            {
            "sandbox": {
              "enabled": true,
              "autoAllowBashIfSandboxed": false,
              "allowUnsandboxedCommands": false,
              "excludedCommands": [
                "docker"
              ],
              "network": {
                "allowUnixSockets": [],
                "allowAllUnixSockets": false,
                "allowLocalBinding": false,
                "allowedDomains": [
                  "*.npmjs.org",
                  "registry.npmjs.org",
                  "github.com"
                ],
                "httpProxyPort": null,
                "socksProxyPort": null
              },
              "enableWeakerNestedSandbox": false
            }
            }
            SANDBOX

"7.3":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-7.03-control-mcp-access.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-7.03-control-mcp-access.sh"
    excerpts:
      managed-mcp-config:
        content: |
            # managed-mcp.json — exclusive MCP server control
            # When this file exists at the system path, it takes exclusive control:
            # users cannot add, modify, or use any MCP servers not defined here.
            # Deploy alongside managed-settings.json at the same OS-specific path:
            #   macOS:   /Library/Application Support/ClaudeCode/managed-mcp.json
            #   Linux:   /etc/claude-code/managed-mcp.json
            #   Windows: C:\Program Files\ClaudeCode\managed-mcp.json
            #
            # Note: Server-managed settings cannot distribute MCP server configs —
            # this file must be deployed via MDM, Group Policy, or Ansible.
            cat << 'MANAGED_MCP'
            {
            "mcpServers": {
              "approved-github": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-github"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                }
              },
              "approved-postgres": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-postgres"],
                "env": {
                  "DATABASE_URL": "${APPROVED_DB_URL}"
                }
              }
            }
            }
            MANAGED_MCP
      mcp-allowlist-denylist:
        content: |
            # MCP server allowlist/denylist via managed-settings.json
            # Use this when you want guardrails without exclusive MCP control.
            # Deny rules always take precedence over allow rules.
            # An empty allowedMcpServers array blocks ALL MCP servers.
            cat << 'MCP_LISTS'
            {
            "allowedMcpServers": [
              {"serverName": "github"},
              {"serverName": "memory"},
              {"serverName": "postgres"}
            ],
            "deniedMcpServers": [
              {"serverName": "filesystem"},
              {"serverName": "shell"},
              {"serverName": "puppeteer"}
            ],
            "enableAllProjectMcpServers": false
            }
            MCP_LISTS

"7.4":
  api:
    lang: "bash"
    filename: "hth-anthropic-claude-7.04-monitor-claude-code-usage.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/anthropic-claude/api/hth-anthropic-claude-7.04-monitor-claude-code-usage.sh"
    excerpts:
      api-claude-code-analytics:
        content: |
            # Fetch per-user Claude Code analytics for a given day
            # Usage: Set REPORT_DATE (YYYY-MM-DD) or defaults to yesterday
            REPORT_DATE="${REPORT_DATE:-$(date -d 'yesterday' '+%Y-%m-%d' 2>/dev/null || \
                                        date -v-1d '+%Y-%m-%d' 2>/dev/null)}"
          
            info "Fetching Claude Code analytics for ${REPORT_DATE}..."
            ANALYTICS=$(anthropic_get "/v1/organizations/usage_report/claude_code?starting_at=${REPORT_DATE}&limit=100") || {
            fail "7.4 Failed to fetch Claude Code analytics"
            summary; exit 0
            }
          
            RECORD_COUNT=$(echo "${ANALYTICS}" | jq '.data | length')
            info "Found ${RECORD_COUNT} user records for ${REPORT_DATE}"
          
            # Per-user summary
            echo "${ANALYTICS}" | jq -r '.data[] | [
            (.actor.email_address // .actor.api_key_name // "unknown"),
            (.terminal_type // "n/a"),
            (.core_metrics.num_sessions // 0),
            (.core_metrics.commits_by_claude_code // 0),
            (.core_metrics.pull_requests_by_claude_code // 0),
            (.core_metrics.lines_of_code.added // 0),
            (.core_metrics.lines_of_code.removed // 0)
            ] | @tsv' | column -t -s $'\t' -N "USER,TERMINAL,SESSIONS,COMMITS,PRS,LOC_ADD,LOC_DEL"
          
            pass "7.4 Claude Code analytics retrieved"
      api-tool-acceptance:
        content: |
            # Analyze tool acceptance rates — low acceptance may indicate
            # overly permissive settings or developer friction
            info "Analyzing tool acceptance rates..."
            echo "${ANALYTICS}" | jq -r '.data[] |
            .actor.email_address as $user |
            .tool_actions // {} | to_entries[] |
            [$user, .key, (.value.accepted // 0), (.value.rejected // 0),
             (if ((.value.accepted // 0) + (.value.rejected // 0)) > 0
              then ((.value.accepted // 0) * 100 / ((.value.accepted // 0) + (.value.rejected // 0)) | floor | tostring) + "%"
              else "n/a" end)] | @tsv' | column -t -s $'\t' -N "USER,TOOL,ACCEPTED,REJECTED,RATE"
          
            # Flag users with low acceptance rates (below 70%)
            LOW_ACCEPTANCE=$(echo "${ANALYTICS}" | jq '[.data[] |
            .actor.email_address as $user |
            .tool_actions // {} | to_entries[] |
            {user: $user, tool: .key, accepted: (.value.accepted // 0), rejected: (.value.rejected // 0)} |
            select((.accepted + .rejected) > 5) |
            select((.accepted / (.accepted + .rejected)) < 0.7)]')
          
            LOW_COUNT=$(echo "${LOW_ACCEPTANCE}" | jq 'length')
            if [[ "${LOW_COUNT}" -gt 0 ]]; then
            warn "7.4 ${LOW_COUNT} user/tool combinations have <70% acceptance rate — review permission configuration"
            else
            pass "7.4 All tool acceptance rates are healthy (>=70%)"
            fi
      api-cost-by-model:
        content: |
            # Cost breakdown by model across all Claude Code users
            info "Cost breakdown by model:"
            echo "${ANALYTICS}" | jq -r '[.data[].model_breakdown[]? |
            {model: .model, cost: ((.estimated_cost.amount // 0) / 100)}] |
            group_by(.model) | .[] |
            {model: .[0].model, total_cost: ([.[].cost] | add | . * 100 | round / 100)} |
            "  \(.model): $\(.total_cost)"'
          
            # Total cost for the day
            TOTAL_COST=$(echo "${ANALYTICS}" | jq '[.data[].model_breakdown[]?.estimated_cost.amount // 0] | add // 0 | . / 100 | . * 100 | round / 100')
            info "Total Claude Code cost for ${REPORT_DATE}: \$${TOTAL_COST}"
            pass "7.4 Cost analysis complete"

