# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-17T04:21:50Z

"1.3":
  api:
    lang: "bash"
    filename: "hth-qualys-1.03-implement-rbac.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/qualys/api/hth-qualys-1.03-implement-rbac.sh"
    excerpts:
      api-audit-user-roles:
        content: |
          # Fetch all users and audit role assignments
          # Qualys v2 user list returns XML with USER_LIST/USER elements
          USER_XML=$(ql_get "/auth/user/?action=list" 2>/dev/null) || {
            fail "1.3 Failed to retrieve user list (requires Manager role)"
            increment_failed
            summary
            exit 1
          }
          
          # Count users by role type
          TOTAL_USERS=$(echo "${USER_XML}" | xml_count "USER")
          MANAGER_COUNT=$(echo "${USER_XML}" | grep -c "<USER_ROLE>Manager</USER_ROLE>" || echo "0")
          ADMIN_COUNT=$(echo "${USER_XML}" | grep -c "<USER_ROLE>Unit Manager</USER_ROLE>" || echo "0")
          READER_COUNT=$(echo "${USER_XML}" | grep -c "<USER_ROLE>Reader</USER_ROLE>" || echo "0")
          SCANNER_COUNT=$(echo "${USER_XML}" | grep -c "<USER_ROLE>Scanner</USER_ROLE>" || echo "0")
          
          info "1.3 Total users: ${TOTAL_USERS}"
          info "1.3 Managers: ${MANAGER_COUNT} | Unit Managers: ${ADMIN_COUNT}"
          info "1.3 Scanners: ${SCANNER_COUNT} | Readers: ${READER_COUNT}"
          
          # Flag if more than 3 Manager-level accounts exist
          if [ "${MANAGER_COUNT}" -gt 3 ]; then
            warn "1.3 ${MANAGER_COUNT} Manager accounts detected -- review for least-privilege"
            warn "1.3 Best practice: limit Manager role to 2-3 accounts maximum"
          fi
      api-list-admin-users:
        content: |
          # List all users with Manager or Unit Manager roles for review
          info "1.3 Privileged users requiring review:"
          echo "${USER_XML}" | grep -B5 -A5 "<USER_ROLE>Manager</USER_ROLE>" \
            | grep -oP "<USER_LOGIN>\K[^<]+" | while read -r login; do
              warn "1.3   Manager: ${login}"
            done
          echo "${USER_XML}" | grep -B5 -A5 "<USER_ROLE>Unit Manager</USER_ROLE>" \
            | grep -oP "<USER_LOGIN>\K[^<]+" | while read -r login; do
              warn "1.3   Unit Manager: ${login}"
            done
  sigma:
    - lang: "yaml"
      filename: "hth-qualys-1.03-admin-role-assigned.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/qualys/siem/sigma/hth-qualys-1.03-admin-role-assigned.yml"
      excerpts:
        detection:
          content: |
            detection:
                selection_create:
                    Action: 'User Created'
                selection_modify:
                    Action: 'User Role Modified'
                selection_role:
                    Details|contains:
                        - 'Manager'
                        - 'Unit Manager'
                condition: (selection_create or selection_modify) and selection_role
            fields:
                - Date
                - User
                - Action
                - Details
                - UserLogin

"2.1":
  sigma:
    - lang: "yaml"
      filename: "hth-qualys-2.01-scan-credential-modified.yml"
      source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/qualys/siem/sigma/hth-qualys-2.01-scan-credential-modified.yml"
      excerpts:
        detection:
          content: |
            detection:
                selection:
                    Action|contains:
                        - 'Credential Created'
                        - 'Credential Updated'
                        - 'Credential Deleted'
                        - 'Authentication Record Created'
                        - 'Authentication Record Updated'
                        - 'Authentication Record Deleted'
                condition: selection
            fields:
                - Date
                - User
                - Action
                - Details

"2.2":
  api:
    lang: "bash"
    filename: "hth-qualys-2.02-configure-scan-options.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/qualys/api/hth-qualys-2.02-configure-scan-options.sh"
    excerpts:
      api-audit-scan-profiles:
        content: |
          # List all scan option profiles and check for hardened configuration
          PROFILES_XML=$(ql_get "/scan/option_profile/?action=list" 2>/dev/null) || {
            fail "2.2 Failed to retrieve scan option profiles"
            increment_failed
            summary
            exit 1
          }
          
          PROFILE_COUNT=$(echo "${PROFILES_XML}" | xml_count "OPTION_PROFILE")
          info "2.2 Found ${PROFILE_COUNT} scan option profile(s)"
          
          # Check each profile for vulnerability detection settings
          # A hardened profile should have:
          #   - TCP and UDP scanning enabled
          #   - Authentication scanning enabled
          #   - All port ranges covered (1-65535)
          echo "${PROFILES_XML}" | grep -oP "<TITLE>\K[^<]+" | while read -r title; do
            info "2.2   Profile: ${title}"
          done
      api-audit-active-scans:
        content: |
          # List recent scans to verify scanning is active and not stale
          SCANS_XML=$(ql_get "/scan/?action=list" 2>/dev/null) || {
            warn "2.2 Failed to retrieve scan list"
            SCANS_XML=""
          }
          
          if [ -n "${SCANS_XML}" ]; then
            SCAN_COUNT=$(echo "${SCANS_XML}" | xml_count "SCAN")
            info "2.2 Found ${SCAN_COUNT} scan(s) in history"
          
            # Check for scans in the last 30 days
            RECENT_SCANS=$(echo "${SCANS_XML}" | grep -c "<STATUS>Finished</STATUS>" || echo "0")
            if [ "${RECENT_SCANS}" -gt 0 ]; then
              pass "2.2 ${RECENT_SCANS} completed scan(s) found"
            else
              warn "2.2 No recently completed scans -- verify scan scheduling"
            fi
          fi

"4.1":
  api:
    lang: "bash"
    filename: "hth-qualys-4.01-configure-asset-discovery.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/qualys/api/hth-qualys-4.01-configure-asset-discovery.sh"
    excerpts:
      api-audit-asset-inventory:
        content: |
          # Retrieve asset host list and check inventory health
          HOSTS_XML=$(ql_get "/asset/host/?action=list&truncation_limit=0" 2>/dev/null) || {
            fail "4.1 Failed to retrieve host list"
            increment_failed
            summary
            exit 1
          }
          
          TOTAL_HOSTS=$(echo "${HOSTS_XML}" | xml_count "HOST")
          info "4.1 Total hosts in inventory: ${TOTAL_HOSTS}"
          
          # Check for hosts with no last scan date (never scanned)
          UNSCANNED=$(echo "${HOSTS_XML}" | grep -c "<LAST_VULN_SCAN_DATETIME/>" || echo "0")
          if [ "${UNSCANNED}" -gt 0 ]; then
            warn "4.1 ${UNSCANNED} host(s) have never been vulnerability scanned"
          else
            pass "4.1 All hosts have been scanned at least once"
          fi
      api-audit-asset-tags:
        content: |
          # Use v3 API to check asset tagging for organization
          TAGS_JSON=$(ql_v3_get "/get/am/tag" 2>/dev/null) || {
            warn "4.1 Failed to retrieve asset tags (v3 API)"
            TAGS_JSON=""
          }
          
          if [ -n "${TAGS_JSON}" ]; then
            TAG_COUNT=$(echo "${TAGS_JSON}" | grep -oP '"count"\s*:\s*\K[0-9]+' | head -1 || echo "0")
            info "4.1 Asset tags defined: ${TAG_COUNT}"
            if [ "${TAG_COUNT}" -lt 1 ]; then
              warn "4.1 No asset tags defined -- create tags to organize assets by environment/criticality"
            else
              pass "4.1 Asset tagging is configured (${TAG_COUNT} tag(s))"
            fi
          fi
      api-check-host-detections:
        content: |
          # Check for hosts with active detections to verify scanning coverage
          DETECTIONS_XML=$(ql_get "/asset/host/vm/detection/?action=list&truncation_limit=10" 2>/dev/null) || {
            warn "4.1 Failed to retrieve host detections"
            DETECTIONS_XML=""
          }
          
          if [ -n "${DETECTIONS_XML}" ]; then
            DETECTION_COUNT=$(echo "${DETECTIONS_XML}" | xml_count "DETECTION")
            info "4.1 Sample detection count: ${DETECTION_COUNT}"
            if [ "${DETECTION_COUNT}" -gt 0 ]; then
              pass "4.1 Vulnerability detections present -- scanning is active"
            else
              warn "4.1 No detections found -- verify scanner appliances are functioning"
            fi
          fi

"4.2":
  api:
    lang: "bash"
    filename: "hth-qualys-4.02-configure-cloud-connectors.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/qualys/api/hth-qualys-4.02-configure-cloud-connectors.sh"
    excerpts:
      api-audit-cloud-connectors:
        content: |
          # Search for cloud assets via the v3 Asset Management API
          # Cloud connectors (AWS, Azure, GCP) sync assets automatically
          CLOUD_ASSETS=$(ql_v3_post "/search/am/asset" '{
            "filters": [
              {
                "field": "sourceCategory",
                "operator": "IN",
                "value": "cloud"
              }
            ],
            "preferences": {
              "startFromOffset": 0,
              "limitResults": 10
            }
          }' 2>/dev/null) || {
            warn "4.2 Failed to query cloud assets (v3 API)"
            CLOUD_ASSETS=""
          }
          
          if [ -n "${CLOUD_ASSETS}" ]; then
            CLOUD_COUNT=$(echo "${CLOUD_ASSETS}" | grep -oP '"count"\s*:\s*\K[0-9]+' | head -1 || echo "0")
            info "4.2 Cloud-sourced assets: ${CLOUD_COUNT}"
          
            if [ "${CLOUD_COUNT}" -gt 0 ]; then
              pass "4.2 Cloud connectors are active (${CLOUD_COUNT} assets synced)"
            else
              warn "4.2 No cloud assets found -- configure AWS/Azure/GCP connectors"
            fi
          fi
      api-audit-connector-activity:
        content: |
          # Check activity log for recent connector sync events
          ACTIVITY_XML=$(ql_get "/activity_log/?action=list&truncation_limit=50" 2>/dev/null) || {
            warn "4.2 Failed to retrieve activity log"
            ACTIVITY_XML=""
          }
          
          if [ -n "${ACTIVITY_XML}" ]; then
            # Look for cloud connector-related activity
            CONNECTOR_EVENTS=$(echo "${ACTIVITY_XML}" | grep -ci "connector\|cloud\|aws\|azure\|gcp" || echo "0")
            info "4.2 Cloud connector activity events (last 50): ${CONNECTOR_EVENTS}"
          
            if [ "${CONNECTOR_EVENTS}" -gt 0 ]; then
              pass "4.2 Recent cloud connector activity detected"
            else
              warn "4.2 No recent cloud connector activity -- verify connectors are scheduled"
            fi
          fi
      api-check-unscanned-cloud:
        content: |
          # Identify cloud assets that have not been scanned
          UNSCANNED_CLOUD=$(ql_v3_post "/search/am/asset" '{
            "filters": [
              {
                "field": "sourceCategory",
                "operator": "IN",
                "value": "cloud"
              },
              {
                "field": "lastVulnScan",
                "operator": "NONE",
                "value": ""
              }
            ],
            "preferences": {
              "startFromOffset": 0,
              "limitResults": 10
            }
          }' 2>/dev/null) || {
            UNSCANNED_CLOUD=""
          }
          
          if [ -n "${UNSCANNED_CLOUD}" ]; then
            UNSCANNED_COUNT=$(echo "${UNSCANNED_CLOUD}" | grep -oP '"count"\s*:\s*\K[0-9]+' | head -1 || echo "0")
            if [ "${UNSCANNED_COUNT}" -gt 0 ]; then
              warn "4.2 ${UNSCANNED_COUNT} cloud asset(s) have not been vulnerability scanned"
            else
              pass "4.2 All cloud assets have been scanned"
            fi
          fi

