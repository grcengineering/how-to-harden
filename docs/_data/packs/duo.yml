# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-19T19:38:54Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-duo-1.1-secure-admin-panel-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-1.1-secure-admin-panel-access.tf"
    excerpts:
      terraform:
        content: |
            # Audit admin accounts and enforce role-based access via Duo Admin API
            resource "null_resource" "duo_audit_admins" {
            triggers = {
              run_always = timestamp()
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 1.1: Auditing Admin Accounts ==="
                echo "Fetching admin list from Duo Admin API..."
          
                # Build signed request to Duo Admin API
                DATE=$(date -u +"%a, %d %b %Y %H:%M:%S -0000")
                API_HOST="${var.duo_api_hostname}"
          
                # List all administrators
                curl -s -X GET \
                  "https://$${API_HOST}/admin/v1/admins" \
                  -d "account_id=" \
                  | python3 -c "
            import sys, json
            data = json.load(sys.stdin)
            admins = data.get('response', [])
            owners = [a for a in admins if a.get('role') == 'Owner']
            print(f'Total admins: {len(admins)}')
            print(f'Owner accounts: {len(owners)}')
            if len(owners) > ${var.admin_role_limit_owners}:
              print(f'WARNING: {len(owners)} Owner accounts exceeds recommended limit of ${var.admin_role_limit_owners}')
            for a in admins:
              print(f\"  - {a.get('name')} ({a.get('email')}): role={a.get('role')}\")
            " 2>/dev/null || echo "Note: Duo Admin API audit requires valid credentials. Configure duo_api_hostname, duo_integration_key, and duo_secret_key."
          
                echo "=== Admin audit complete ==="
              EOT
            }
            }
          
            # Verify admin MFA requirement via Duo Admin API
            resource "null_resource" "duo_enforce_admin_mfa" {
            triggers = {
              run_always = timestamp()
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 1.1: Verifying Admin MFA Requirement ==="
                echo "Admin MFA should be enforced in Duo Admin Panel > Settings > Administrators"
                echo "  - Require two-factor authentication: ENABLED"
                echo "  - Enforce strong authentication methods (WebAuthn, Duo Push)"
                echo ""
                echo "Recommended admin role distribution:"
                echo "  - Owner: 1-${var.admin_role_limit_owners} accounts maximum"
                echo "  - Administrator: Limited to operations team"
                echo "  - Application Manager: Per-app management only"
                echo "  - User Manager: Help desk operations"
                echo "  - Read-Only: Audit and compliance"
                echo "  - Help Desk: Tier-1 support"
              EOT
            }
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-duo-1.2-protect-admin-credentials.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-1.2-protect-admin-credentials.tf"
    excerpts:
      terraform:
        content: |
            # Validate that Duo credentials are provided via variables (not hardcoded)
            resource "null_resource" "duo_credential_hygiene_check" {
            triggers = {
              run_always = timestamp()
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 1.2: Credential Hygiene Validation ==="
                echo ""
                echo "Verifying Duo credential security posture..."
                echo ""
          
                ISSUES=0
          
                # Check that credentials are not in plaintext tfvars
                if [ -f terraform.tfvars ]; then
                  if grep -q "duo_secret_key" terraform.tfvars 2>/dev/null; then
                    echo "WARNING: duo_secret_key found in terraform.tfvars"
                    echo "  Recommendation: Use TF_VAR_duo_secret_key environment variable instead"
                    ISSUES=$((ISSUES + 1))
                  fi
                  if grep -q "duo_integration_key" terraform.tfvars 2>/dev/null; then
                    echo "WARNING: duo_integration_key found in terraform.tfvars"
                    echo "  Recommendation: Use TF_VAR_duo_integration_key environment variable instead"
                    ISSUES=$((ISSUES + 1))
                  fi
                fi
          
                # Check that .gitignore excludes tfvars
                if [ -f .gitignore ]; then
                  if ! grep -q "terraform.tfvars" .gitignore 2>/dev/null; then
                    echo "WARNING: terraform.tfvars not in .gitignore"
                    ISSUES=$((ISSUES + 1))
                  fi
                else
                  echo "WARNING: No .gitignore found -- terraform.tfvars may be committed"
                  ISSUES=$((ISSUES + 1))
                fi
          
                if [ "$ISSUES" -eq 0 ]; then
                  echo "PASS: No credential hygiene issues detected"
                else
                  echo ""
                  echo "FAIL: $ISSUES credential hygiene issue(s) found"
                fi
          
                echo ""
                echo "Best practices for Duo secret key management:"
                echo "  1. Use environment variables: export TF_VAR_duo_secret_key=..."
                echo "  2. Use a secrets manager: vault kv get -field=skey secret/duo"
                echo "  3. Never commit secrets to source control"
                echo "  4. Rotate keys immediately if compromise is suspected"
                echo "  5. Limit API credential scope to minimum required permissions"
              EOT
            }
            }
  cli:
    lang: "bash"
    filename: "hth-duo-1.02-secret-key-handling.sh"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/cli/hth-duo-1.02-secret-key-handling.sh"
    excerpts:
      cli-secret-key-handling:
        content: |
            # Bad: Hardcoded in script
            SKEY="your-secret-key"
          
            # Good: Environment variable
            SKEY=$DUO_SECRET_KEY
          
            # Better: Secrets manager
            SKEY=$(vault kv get -field=skey secret/duo/application)

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-duo-2.1-configure-global-policy.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-2.1-configure-global-policy.tf"
    excerpts:
      terraform:
        content: |
            # Configure Duo Global Policy via Admin API
            resource "null_resource" "duo_global_policy" {
            triggers = {
              new_user_action  = var.global_policy_new_user_action
              profile_level    = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 2.1: Configuring Global Policy ==="
                echo ""
                echo "Global Policy Settings:"
                echo "  Authentication policy: Enforce MFA"
                echo "  New user policy: ${var.global_policy_new_user_action}"
                echo "  Profile level: ${var.profile_level}"
                echo ""
          
                API_HOST="${var.duo_api_hostname}"
          
                # Set global policy via Duo Admin API
                # POST /admin/v1/policies/global
                curl -s -X POST \
                  "https://$${API_HOST}/admin/v1/policies/global" \
                  -d "authentication_policy=enforce" \
                  -d "new_user_policy=$(echo '${var.global_policy_new_user_action}' | tr '[:upper:]' '[:lower:]')" \
                  2>/dev/null && echo "Global policy updated successfully" \
                  || echo "Note: Global policy update requires valid Duo Admin API credentials"
          
                echo ""
                echo "Validation checklist:"
                echo "  [x] Authentication policy set to: Enforce MFA"
                echo "  [x] New user policy set to: ${var.global_policy_new_user_action}"
                echo "  [ ] Verify in Duo Admin Panel > Policies > Global Policy"
              EOT
            }
            }
          
            # ISE network access policy set enforcing Duo MFA for all network access
            resource "ise_network_access_policy_set" "duo_mfa_enforcement" {
            name        = var.duo_ise_policy_set_name
            description = "HTH Duo 2.1: Enforce Duo MFA for all network access"
            state       = "enabled"
            default     = false
            rank        = 1
          
            condition_type        = "ConditionReference"
            condition_is_negate   = false
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-duo-2.2-eliminate-bypass-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-2.2-eliminate-bypass-access.tf"
    excerpts:
      terraform:
        content: |
            # Audit and report on users with bypass status
            resource "null_resource" "duo_audit_bypass_users" {
            triggers = {
              run_always = timestamp()
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 2.2: Auditing Bypass Users ==="
                echo ""
          
                API_HOST="${var.duo_api_hostname}"
          
                # Fetch users with bypass status via Duo Admin API
                # GET /admin/v1/users?status=bypass
                curl -s -X GET \
                  "https://$${API_HOST}/admin/v1/users" \
                  -d "status=bypass" \
                  | python3 -c "
            import sys, json
            try:
              data = json.load(sys.stdin)
              users = data.get('response', [])
              bypass_users = [u for u in users if u.get('status') == 'bypass']
              print(f'Bypass users found: {len(bypass_users)}')
              if len(bypass_users) > 0:
                  print('WARNING: The following users have bypass status:')
                  for u in bypass_users:
                      print(f\"  - {u.get('realname', 'Unknown')} ({u.get('username')})\")
                      print(f\"    Status: {u.get('status')}\")
                      print(f\"    Last login: {u.get('last_login', 'Never')}\")
                  print()
                  print('Recommended actions:')
                  print('  1. Remove bypass for users who no longer need it')
                  print('  2. Set expiration on any remaining bypass accounts')
                  print('  3. Document business justification for each bypass')
              else:
                  print('PASS: No users with bypass status found')
            except Exception as e:
              print(f'Note: Duo Admin API query requires valid credentials ({e})')
            " 2>/dev/null || echo "Note: Bypass audit requires valid Duo Admin API credentials"
          
                echo ""
                echo "Bypass elimination checklist:"
                echo "  [ ] All bypass users reviewed and justified"
                echo "  [ ] Bypass expiration set for temporary exceptions"
                echo "  [ ] Group-level bypass policies reviewed"
                echo "  [ ] Monthly bypass review process established"
              EOT
            }
            }

"2.3":
  terraform:
    lang: "hcl"
    filename: "hth-duo-2.3-require-phishing-resistant-mfa.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-2.3-require-phishing-resistant-mfa.tf"
    excerpts:
      terraform:
        content: |
            # Enable Verified Push and restrict to strong authentication methods (L2+)
            resource "null_resource" "duo_phishing_resistant_mfa" {
            count = var.profile_level >= 2 ? 1 : 0
          
            triggers = {
              verified_push      = var.verified_push_enabled
              disable_sms        = var.disable_sms_passcodes
              disable_phone      = var.disable_phone_callback
              profile_level      = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 2.3: Configuring Phishing-Resistant MFA ==="
                echo ""
                echo "Profile Level: ${var.profile_level} (L2+ required)"
                echo ""
          
                API_HOST="${var.duo_api_hostname}"
          
                # Configure Verified Push via Duo Admin API
                echo "Enabling Verified Duo Push (number matching)..."
                curl -s -X POST \
                  "https://$${API_HOST}/admin/v1/policies/global" \
                  -d "verified_push=${var.verified_push_enabled}" \
                  2>/dev/null && echo "  Verified Push: enabled" \
                  || echo "  Note: Requires valid Duo Admin API credentials"
          
                # Disable SMS passcodes if configured
                if [ "${var.disable_sms_passcodes}" = "true" ]; then
                  echo "Disabling SMS passcodes..."
                  curl -s -X POST \
                    "https://$${API_HOST}/admin/v1/policies/global" \
                    -d "sms_passcodes=false" \
                    2>/dev/null && echo "  SMS passcodes: disabled" \
                    || echo "  Note: Requires valid Duo Admin API credentials"
                fi
          
                # Disable phone callback if configured
                if [ "${var.disable_phone_callback}" = "true" ]; then
                  echo "Disabling phone callback..."
                  curl -s -X POST \
                    "https://$${API_HOST}/admin/v1/policies/global" \
                    -d "phone_callback=false" \
                    2>/dev/null && echo "  Phone callback: disabled" \
                    || echo "  Note: Requires valid Duo Admin API credentials"
                fi
          
                echo ""
                echo "Authentication method hierarchy (strongest to weakest):"
                echo "  1. WebAuthn (FIDO2 Security Keys) -- phishing-resistant"
                echo "  2. WebAuthn (Platform Authenticators) -- phishing-resistant"
                echo "  3. Verified Duo Push (number matching) -- fatigue-resistant"
                echo "  4. Duo Push (standard) -- vulnerable to fatigue attacks"
                echo "  5. SMS passcodes -- vulnerable to SIM swap"
                echo "  6. Phone callback -- vulnerable to social engineering"
                echo ""
                echo "L2 recommendation: Enable methods 1-3, disable 5-6"
                echo "L3 recommendation: Enable methods 1-2 only (WebAuthn)"
              EOT
            }
            }
          
            # ISE allowed protocols configuration requiring strong authentication
            resource "ise_allowed_protocols" "duo_phishing_resistant" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name                     = "HTH-Duo-Phishing-Resistant-Protocols"
            description              = "HTH Duo 2.3: Allowed protocols for phishing-resistant MFA"
            process_host_lookup      = true
            allow_pap_ascii          = false
            allow_chap               = false
            allow_ms_chap_v1         = false
            allow_ms_chap_v2         = false
            allow_eap_md5            = false
            allow_eap_tls            = true
            allow_leap               = false
            allow_peap               = true
            allow_eap_fast           = true
            allow_eap_ttls           = true
            allow_teap               = true
            eap_tls_l_bit            = false
            allow_preferred_eap_protocol = false
            }

"2.4":
  terraform:
    lang: "hcl"
    filename: "hth-duo-2.4-configure-authorized-networks.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-2.4-configure-authorized-networks.tf"
    excerpts:
      terraform:
        content: |
            # ISE network device group for Duo-authorized corporate networks
            resource "ise_network_device_group" "duo_authorized_networks" {
            count = var.profile_level >= 2 && length(var.authorized_networks_cidrs) > 0 ? 1 : 0
          
            name        = "HTH-Duo-Authorized-Networks"
            description = "HTH Duo 2.4: Corporate networks for Duo network-aware policies"
            root_group  = "Location"
            }
          
            # Configure authorized networks in Duo via Admin API
            resource "null_resource" "duo_authorized_networks" {
            count = var.profile_level >= 2 && length(var.authorized_networks_cidrs) > 0 ? 1 : 0
          
            triggers = {
              cidrs       = join(",", var.authorized_networks_cidrs)
              require_mfa = var.authorized_networks_require_mfa
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 2.4: Configuring Authorized Networks ==="
                echo ""
                echo "Authorized network CIDRs:"
                for cidr in ${join(" ", var.authorized_networks_cidrs)}; do
                  echo "  - $cidr"
                done
                echo ""
                echo "MFA from authorized networks: ${var.authorized_networks_require_mfa ? "REQUIRED" : "OPTIONAL (not recommended)"}"
                echo ""
          
                if [ "${var.authorized_networks_require_mfa}" = "false" ]; then
                  echo "WARNING: Allowing access without MFA from trusted networks"
                  echo "  reduces security posture. Consider requiring MFA always."
                fi
          
                echo ""
                echo "Network policy best practices:"
                echo "  1. Always require MFA, even from trusted networks"
                echo "  2. Use authorized networks to reduce friction, not bypass security"
                echo "  3. Monitor for authentication from unknown networks"
                echo "  4. Review network definitions quarterly"
              EOT
            }
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-duo-3.1-manage-inactive-accounts.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-3.1-manage-inactive-accounts.tf"
    excerpts:
      terraform:
        content: |
            # Audit inactive and pending-activation Duo user accounts
            resource "null_resource" "duo_audit_inactive_accounts" {
            triggers = {
              inactive_threshold = var.inactive_days_threshold
              run_always         = timestamp()
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 3.1: Auditing Inactive Accounts ==="
                echo ""
                echo "Inactive threshold: ${var.inactive_days_threshold} days"
                echo ""
          
                API_HOST="${var.duo_api_hostname}"
                THRESHOLD_DAYS=${var.inactive_days_threshold}
                THRESHOLD_EPOCH=$(date -d "-$${THRESHOLD_DAYS} days" +%s 2>/dev/null || date -v-$${THRESHOLD_DAYS}d +%s 2>/dev/null)
          
                # Fetch all users via Duo Admin API
                # GET /admin/v1/users
                curl -s -X GET \
                  "https://$${API_HOST}/admin/v1/users" \
                  | python3 -c "
            import sys, json, time
          
            THRESHOLD = int('${var.inactive_days_threshold}')
            threshold_ts = time.time() - (THRESHOLD * 86400)
          
            try:
              data = json.load(sys.stdin)
              users = data.get('response', [])
          
              pending = [u for u in users if u.get('status') == 'pending_activation']
              inactive = [u for u in users if u.get('last_login') and u.get('last_login') < threshold_ts]
          
              print(f'Total users: {len(users)}')
              print(f'Pending activation (never enrolled): {len(pending)}')
              print(f'Inactive (>{THRESHOLD} days): {len(inactive)}')
              print()
          
              if pending:
                  print('Users pending activation:')
                  for u in pending:
                      print(f\"  - {u.get('realname', 'Unknown')} ({u.get('username')})\")
                  print()
          
              if inactive:
                  print(f'Users inactive >{THRESHOLD} days:')
                  for u in inactive:
                      last = time.strftime('%Y-%m-%d', time.localtime(u.get('last_login', 0)))
                      print(f\"  - {u.get('realname', 'Unknown')} ({u.get('username')}): last login {last}\")
                  print()
          
              if not pending and not inactive:
                  print('PASS: No inactive or pending accounts found')
            except Exception as e:
              print(f'Note: Duo Admin API query requires valid credentials ({e})')
            " 2>/dev/null || echo "Note: Inactive account audit requires valid Duo Admin API credentials"
          
                echo ""
                echo "Remediation steps:"
                echo "  1. Verify pending users are still employed"
                echo "  2. Resend enrollment or delete stale pending accounts"
                echo "  3. Disable inactive accounts until re-verification"
                echo "  4. Establish monthly account review process"
              EOT
            }
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-duo-3.2-configure-user-enrollment.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-3.2-configure-user-enrollment.tf"
    excerpts:
      terraform:
        content: |
            # Configure enrollment link security via Duo Admin API
            resource "null_resource" "duo_enrollment_config" {
            triggers = {
              link_expiry_hours = var.enrollment_link_expiry_hours
              profile_level     = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 3.2: Configuring User Enrollment Security ==="
                echo ""
          
                API_HOST="${var.duo_api_hostname}"
                EXPIRY_HOURS=${var.enrollment_link_expiry_hours}
                EXPIRY_SECONDS=$((EXPIRY_HOURS * 3600))
          
                echo "Enrollment settings:"
                echo "  Link expiration: $${EXPIRY_HOURS} hours ($${EXPIRY_SECONDS} seconds)"
                echo "  Profile level: ${var.profile_level}"
                echo ""
          
                # Configure enrollment settings via Duo Admin API
                # POST /admin/v1/settings
                curl -s -X POST \
                  "https://$${API_HOST}/admin/v1/settings" \
                  -d "enrollment_universal_prompt_enabled=true" \
                  -d "user_managers_can_put_users_in_bypass=false" \
                  2>/dev/null && echo "Enrollment settings updated" \
                  || echo "Note: Enrollment config requires valid Duo Admin API credentials"
          
                echo ""
                echo "Enrollment security checklist:"
                echo "  [x] Enrollment link expiration: $${EXPIRY_HOURS} hours"
                echo "  [ ] Send enrollment via verified email addresses only"
                echo "  [ ] Monitor for unusual enrollment patterns"
                if [ "${var.profile_level}" -ge 2 ]; then
                  echo "  [ ] L2: Require identity verification before enrollment"
                  echo "  [ ] L2: Validate users against HR system"
                fi
                if [ "${var.profile_level}" -ge 3 ]; then
                  echo "  [ ] L3: Consider in-person enrollment for privileged users"
                fi
              EOT
            }
            }
          
            # ISE internal user group for enrollment-pending Duo users
            resource "ise_user_identity_group" "duo_pending_enrollment" {
            name        = "HTH-Duo-Pending-Enrollment"
            description = "HTH Duo 3.2: Users awaiting Duo MFA enrollment"
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-duo-4.1-configure-trusted-endpoints.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-4.1-configure-trusted-endpoints.tf"
    excerpts:
      terraform:
        content: |
            # ISE endpoint identity group for Duo-trusted devices
            resource "ise_endpoint_identity_group" "duo_trusted_devices" {
            count = var.profile_level >= 2 && var.trusted_endpoints_enabled ? 1 : 0
          
            name        = "HTH-Duo-Trusted-Devices"
            description = "HTH Duo 4.1: Endpoints verified by Duo Trusted Endpoints"
            }
          
            # ISE endpoint identity group for untrusted devices
            resource "ise_endpoint_identity_group" "duo_untrusted_devices" {
            count = var.profile_level >= 2 && var.trusted_endpoints_enabled ? 1 : 0
          
            name        = "HTH-Duo-Untrusted-Devices"
            description = "HTH Duo 4.1: Endpoints not verified by device management"
            }
          
            # ISE authorization profile for trusted endpoints
            resource "ise_authorization_profile" "duo_trusted_access" {
            count = var.profile_level >= 2 && var.trusted_endpoints_enabled ? 1 : 0
          
            name        = "HTH-Duo-Trusted-Access"
            description = "HTH Duo 4.1: Full access for Duo-verified trusted endpoints"
            access_type = "ACCESS_ACCEPT"
            }
          
            # ISE authorization profile for untrusted endpoints
            resource "ise_authorization_profile" "duo_untrusted_deny" {
            count = var.profile_level >= 2 && var.trusted_endpoints_enabled && var.block_untrusted_devices ? 1 : 0
          
            name        = "HTH-Duo-Untrusted-Deny"
            description = "HTH Duo 4.1: Deny access for untrusted endpoints"
            access_type = "ACCESS_REJECT"
            }
          
            # Configure Trusted Endpoints policy via Duo Admin API
            resource "null_resource" "duo_trusted_endpoints_policy" {
            count = var.profile_level >= 2 && var.trusted_endpoints_enabled ? 1 : 0
          
            triggers = {
              trusted_enabled     = var.trusted_endpoints_enabled
              block_untrusted     = var.block_untrusted_devices
              profile_level       = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 4.1: Configuring Trusted Endpoints ==="
                echo ""
                echo "Settings:"
                echo "  Trusted Endpoints: ENABLED"
                echo "  Block untrusted devices: ${var.block_untrusted_devices}"
                echo "  Profile level: ${var.profile_level}"
                echo ""
                echo "Prerequisites verified:"
                echo "  [ ] Duo Advantage or Premier plan active"
                echo "  [ ] Device management solution integrated (Intune, JAMF, etc.)"
                echo ""
                echo "Configuration steps:"
                echo "  1. Navigate to Duo Admin Panel > Trusted Endpoints"
                echo "  2. Add integration for your device management platform"
                echo "  3. Configure device policy under Policies > Edit policy > Devices"
                echo "  4. Set 'Require devices to be trusted'"
                if [ "${var.block_untrusted_devices}" = "true" ]; then
                  echo "  5. Set 'Block untrusted devices' (strict mode)"
                else
                  echo "  5. Set 'Allow with warning' for untrusted devices"
                fi
              EOT
            }
            }

"4.2":
  terraform:
    lang: "hcl"
    filename: "hth-duo-4.2-monitor-device-registration.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-4.2-monitor-device-registration.tf"
    excerpts:
      terraform:
        content: |
            # ISE endpoint custom attribute for Duo device registration tracking
            resource "ise_endpoint_custom_attribute" "duo_registration_date" {
            name        = "HTH-Duo-Registration-Date"
            description = "HTH Duo 4.2: Date device was registered with Duo"
            type        = "String"
            }
          
            resource "ise_endpoint_custom_attribute" "duo_registration_user" {
            name        = "HTH-Duo-Registration-User"
            description = "HTH Duo 4.2: User who registered the device in Duo"
            type        = "String"
            }
          
            # Audit device registrations via Duo Admin API
            resource "null_resource" "duo_audit_device_registrations" {
            triggers = {
              run_always = timestamp()
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 4.2: Auditing Device Registrations ==="
                echo ""
          
                API_HOST="${var.duo_api_hostname}"
          
                # Fetch recent device registrations via Duo Admin API
                # GET /admin/v1/info/authentication_log
                curl -s -X GET \
                  "https://$${API_HOST}/admin/v2/logs/authentication" \
                  -d "mintime=$(date -d '-7 days' +%s 2>/dev/null || date -v-7d +%s 2>/dev/null)000" \
                  | python3 -c "
            import sys, json
            try:
              data = json.load(sys.stdin)
              logs = data.get('response', {}).get('authlogs', [])
              enrollments = [l for l in logs if 'enrollment' in l.get('reason', '').lower()]
              print(f'Authentication events (last 7 days): {len(logs)}')
              print(f'Enrollment/registration events: {len(enrollments)}')
              if enrollments:
                  print()
                  print('Recent device registrations:')
                  for e in enrollments[:10]:
                      print(f\"  - User: {e.get('user', {}).get('name', 'Unknown')}\")
                      print(f\"    Device: {e.get('access_device', {}).get('hostname', 'Unknown')}\")
                      print(f\"    Result: {e.get('result', 'Unknown')}\")
              else:
                  print('No new device registrations in last 7 days')
            except Exception as e:
              print(f'Note: Device audit requires valid Duo Admin API credentials ({e})')
            " 2>/dev/null || echo "Note: Device registration audit requires valid Duo Admin API credentials"
          
                echo ""
                echo "Device monitoring checklist:"
                echo "  [ ] Alerts enabled for new device registrations"
                echo "  [ ] Authentication logs reviewed for registration events"
                echo "  [ ] SIEM integration configured for correlation"
                if [ "${var.profile_level}" -ge 2 ]; then
                  echo "  [ ] L2: Trust Monitor enabled for anomaly detection"
                fi
              EOT
            }
            }

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-duo-5.1-configure-application-policies.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-5.1-configure-application-policies.tf"
    excerpts:
      terraform:
        content: |
            # ISE network access policy set for critical Duo-protected applications
            resource "ise_network_access_policy_set" "duo_critical_apps" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name        = "HTH-Duo-Critical-Applications"
            description = "HTH Duo 5.1: Strictest MFA policy for admin portals and financial systems"
            state       = "enabled"
            default     = false
            rank        = 2
          
            condition_type        = "ConditionReference"
            condition_is_negate   = false
            }
          
            # ISE network access policy set for standard Duo-protected applications
            resource "ise_network_access_policy_set" "duo_standard_apps" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name        = "HTH-Duo-Standard-Applications"
            description = "HTH Duo 5.1: Baseline MFA policy for general business applications"
            state       = "enabled"
            default     = false
            rank        = 3
          
            condition_type        = "ConditionReference"
            condition_is_negate   = false
            }
          
            # ISE authorization profile for critical application access
            resource "ise_authorization_profile" "duo_critical_app_access" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name        = "HTH-Duo-Critical-App-Access"
            description = "HTH Duo 5.1: Authorization for critical application access with strict MFA"
            access_type = "ACCESS_ACCEPT"
            }
          
            # Configure tiered application policies via Duo Admin API
            resource "null_resource" "duo_application_policies" {
            count = var.profile_level >= 2 ? 1 : 0
          
            triggers = {
              profile_level = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 5.1: Configuring Application-Specific Policies ==="
                echo ""
                echo "Application tier definitions:"
                echo ""
                echo "CRITICAL Applications Policy:"
                echo "  - New user policy: Deny access"
                echo "  - Authentication: Enforce MFA"
                echo "  - Methods: WebAuthn only"
                echo "  - Networks: Require MFA always"
                echo "  - Examples: Admin portals, financial systems"
                echo ""
                echo "HIGH Applications Policy:"
                echo "  - New user policy: Deny access"
                echo "  - Authentication: Enforce MFA"
                echo "  - Methods: WebAuthn + Verified Push"
                echo "  - Networks: Require MFA always"
                echo "  - Examples: Customer data access, email"
                echo ""
                echo "STANDARD Applications Policy:"
                echo "  - New user policy: Require enrollment"
                echo "  - Authentication: Enforce MFA"
                echo "  - Methods: All enabled methods"
                echo "  - Networks: Standard configuration"
                echo "  - Examples: General business applications"
                echo ""
                echo "Apply via Duo Admin Panel:"
                echo "  1. Policies > New Policy for each tier"
                echo "  2. Applications > Select app > Assign policy"
              EOT
            }
            }

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-duo-5.2-secure-windows-logon-rdp.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-5.2-secure-windows-logon-rdp.tf"
    excerpts:
      terraform:
        content: |
            # ISE device admin policy set for Duo-protected Windows/RDP access
            resource "ise_device_admin_policy_set" "duo_windows_rdp" {
            name        = "HTH-Duo-Windows-RDP"
            description = "HTH Duo 5.2: Device admin policy for Windows Logon and RDP with Duo MFA"
            state       = "enabled"
            default     = false
            rank        = 1
          
            condition_type        = "ConditionReference"
            condition_is_negate   = false
            }
          
            # Configure Windows Logon/RDP application settings via Duo Admin API
            resource "null_resource" "duo_windows_rdp_config" {
            triggers = {
              fail_mode       = var.rdp_fail_mode
              offline_enabled = var.rdp_offline_access_enabled
              offline_expiry  = var.rdp_offline_expiry_hours
              offline_logins  = var.rdp_offline_max_logins
              profile_level   = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 5.2: Configuring Windows Logon/RDP ==="
                echo ""
                echo "Windows Logon/RDP Settings:"
                echo "  New user policy: DENY (users must be pre-enrolled)"
                echo "  Fail mode: ${var.rdp_fail_mode}"
                echo "  Offline access: ${var.rdp_offline_access_enabled}"
                if [ "${var.rdp_offline_access_enabled}" = "true" ]; then
                  echo "  Offline expiration: ${var.rdp_offline_expiry_hours} hours"
                  echo "  Max offline logins: ${var.rdp_offline_max_logins}"
                fi
                echo ""
          
                if [ "${var.rdp_fail_mode}" = "OPEN" ]; then
                  echo "WARNING: Fail mode is OPEN -- users can access without MFA"
                  echo "  if Duo cloud is unreachable. Consider CLOSED for higher security."
                else
                  echo "INFO: Fail mode is CLOSED -- access blocked if Duo is unreachable."
                  echo "  This is more secure but may impact availability."
                fi
          
                echo ""
                echo "Deployment checklist:"
                echo "  [ ] Duo Authentication for Windows Logon installer deployed"
                echo "  [ ] Application configured in Duo Admin Panel"
                echo "  [ ] New user policy set to: Deny access"
                echo "  [ ] Fail mode set to: ${var.rdp_fail_mode}"
                if [ "${var.rdp_offline_access_enabled}" = "true" ]; then
                  echo "  [ ] Offline access configured with ${var.rdp_offline_expiry_hours}h expiry"
                  echo "  [ ] Offline login limit set to ${var.rdp_offline_max_logins}"
                else
                  echo "  [ ] Offline access: DISABLED"
                fi
                echo "  [ ] Test RDP login with Duo MFA before production rollout"
              EOT
            }
            }

"6.1":
  terraform:
    lang: "hcl"
    filename: "hth-duo-6.1-enable-logging-and-alerting.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-6.1-enable-logging-and-alerting.tf"
    excerpts:
      terraform:
        content: |
            # ISE identity source sequence including Duo for centralized auth logging
            resource "ise_identity_source_sequence" "duo_logging" {
            name                         = "HTH-Duo-Auth-Logging-Sequence"
            description                  = "HTH Duo 6.1: Identity source sequence for Duo authentication logging"
            break_on_store_fail          = true
            certificate_authentication_profile = ""
            }
          
            # Configure SIEM integration via Duo Admin API log export
            resource "null_resource" "duo_siem_integration" {
            count = var.siem_integration_enabled ? 1 : 0
          
            triggers = {
              siem_enabled  = var.siem_integration_enabled
              profile_level = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 6.1: Configuring Logging and SIEM Integration ==="
                echo ""
          
                API_HOST="${var.duo_api_hostname}"
          
                # Verify Admin API access for log export
                echo "Verifying Duo Admin API access for log export..."
                curl -s -X GET \
                  "https://$${API_HOST}/admin/v1/info/summary" \
                  | python3 -c "
            import sys, json
            try:
              data = json.load(sys.stdin)
              info = data.get('response', {})
              print(f\"Duo account: {info.get('account_name', 'Unknown')}\")
              print(f\"API hostname: ${var.duo_api_hostname}\")
              print(f\"Admin API: accessible\")
            except Exception as e:
              print(f'Note: Admin API verification requires valid credentials ({e})')
            " 2>/dev/null || echo "Note: SIEM integration requires valid Duo Admin API credentials"
          
                echo ""
                echo "Log export endpoints:"
                echo "  Authentication logs: GET /admin/v2/logs/authentication"
                echo "  Administrator logs:  GET /admin/v1/logs/administrator"
                echo "  Telephony logs:      GET /admin/v1/logs/telephony"
                echo ""
                echo "SIEM integration options:"
                echo "  - Splunk: Duo add-on for Splunk available"
                echo "  - Azure Sentinel: Custom connector via Admin API"
                echo "  - Other SIEM: REST API polling recommended"
                echo ""
                echo "Recommended polling interval: 5 minutes"
              EOT
            }
            }
          
            # Enable Trust Monitor for anomaly detection (Advantage/Premier)
            resource "null_resource" "duo_trust_monitor" {
            count = var.trust_monitor_enabled ? 1 : 0
          
            triggers = {
              trust_monitor = var.trust_monitor_enabled
              profile_level = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 6.1: Enabling Trust Monitor ==="
                echo ""
                echo "Trust Monitor provides anomaly detection for:"
                echo "  - Unusual authentication patterns"
                echo "  - New device registrations from suspicious locations"
                echo "  - Authentication from known threat sources"
                echo ""
                echo "Prerequisites:"
                echo "  [ ] Duo Advantage or Premier plan required"
                echo "  [ ] Navigate to: Devices > Trust Monitor"
                echo "  [ ] Enable anomaly detection"
                echo "  [ ] Configure alerting for suspicious activity"
                echo ""
                echo "Note: Trust Monitor will be replaced by Cisco Identity"
                echo "      Intelligence after September 2025."
              EOT
            }
            }

"6.3":
  terraform:
    lang: "hcl"
    filename: "hth-duo-6.3-session-hijacking-protection.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/duo/terraform/hth-duo-6.3-session-hijacking-protection.tf"
    excerpts:
      terraform:
        content: |
            # ISE device admin condition for session timeout enforcement
            resource "ise_device_admin_condition" "duo_session_timeout" {
            count = var.profile_level >= 2 ? 1 : 0
          
            name            = "HTH-Duo-Session-Timeout"
            description     = "HTH Duo 6.3: Condition for enforcing session timeout on Duo-protected resources"
            condition_type  = "ConditionAttributes"
            is_negate       = false
            attribute_name  = "Session-Timeout"
            attribute_value = tostring(var.session_timeout_minutes * 60)
            operator        = "lessThan"
            dictionary_name = "RADIUS"
            }
          
            # Configure session protection via Duo Admin API
            resource "null_resource" "duo_session_protection" {
            count = var.profile_level >= 2 ? 1 : 0
          
            triggers = {
              session_timeout    = var.session_timeout_minutes
              reauth_sensitive   = var.reauthentication_for_sensitive_actions
              profile_level      = var.profile_level
            }
          
            provisioner "local-exec" {
              interpreter = ["bash", "-c"]
              command     = <<-EOT
                echo "=== HTH Duo 6.3: Configuring Session Hijacking Protection ==="
                echo ""
                echo "Session protection settings:"
                echo "  Session timeout: ${var.session_timeout_minutes} minutes"
                echo "  Re-authentication for sensitive actions: ${var.reauthentication_for_sensitive_actions}"
                echo "  Profile level: ${var.profile_level}"
                echo ""
          
                echo "Session security controls:"
                echo "  1. Continuous authentication enabled"
                echo "  2. Session timeout: ${var.session_timeout_minutes} minutes"
                if [ "${var.reauthentication_for_sensitive_actions}" = "true" ]; then
                  echo "  3. Re-authentication: REQUIRED for sensitive actions"
                else
                  echo "  3. Re-authentication: not enforced (consider enabling)"
                fi
                echo "  4. Session anomaly monitoring: enabled via Trust Monitor"
                echo ""
                echo "Session hijacking indicators to monitor:"
                echo "  - Session used from different IP than authentication"
                echo "  - Session used from different device fingerprint"
                echo "  - Session used after long idle period"
                echo "  - Multiple concurrent sessions from single user"
                echo ""
                echo "Implementation steps:"
                echo "  [ ] Configure session policies with appropriate timeouts"
                echo "  [ ] Enable re-authentication for sensitive actions"
                echo "  [ ] Monitor for session anomalies in SIEM"
                echo "  [ ] Review session duration policies quarterly"
              EOT
            }
            }

