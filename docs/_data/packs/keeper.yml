# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-18T04:06:22Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-1.01-protect-administrator-accounts.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-1.01-protect-administrator-accounts.tf"
    excerpts:
      terraform:
        content: |
            # Store break-glass admin credentials securely in a Keeper shared folder
            resource "secretsmanager_login" "break_glass_admin" {
            count = var.break_glass_account_email != "" ? 1 : 0
          
            folder_uid = var.break_glass_folder_uid
            title      = "Break-Glass Admin - ${var.break_glass_account_email}"
          
            login    = var.break_glass_account_email
            password = var.break_glass_initial_password
            url      = "https://keepersecurity.com/vault"
          
            notes = <<-EOT
              BREAK-GLASS ADMIN ACCOUNT
              =========================
              Purpose: Emergency access when all other admin accounts are unavailable.
              Procedure: See break-glass runbook in your incident response documentation.
              MFA: Enrolled with hardware security key stored in physical safe.
              Last verified: Managed by Terraform - do not edit manually.
              Profile Level: L1 (Baseline)
            EOT
            }
          
            # Validate that minimum admin count is met (plan-time check via variable validation)
            # Runtime verification requires Commander CLI -- see null_resource below
            resource "terraform_data" "admin_redundancy_check" {
            count = length(var.admin_usernames) >= 2 ? 1 : 0
          
            input = {
              admin_count          = length(var.admin_usernames)
              admins               = join(", ", var.admin_usernames)
              break_glass_enrolled = var.break_glass_account_email != "" ? "yes" : "no"
            }
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-1.02-ip-allowlisting-admins.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-1.02-ip-allowlisting-admins.tf"
    excerpts:
      terraform:
        content: |
            # Apply IP allowlist enforcement policy to admin roles
            # Requires Keeper Commander CLI: pip3 install keepercommander
            resource "terraform_data" "admin_ip_allowlist" {
            count = var.profile_level >= 2 && length(var.admin_allowed_ips) > 0 ? 1 : 0
          
            input = {
              allowed_ips   = var.admin_allowed_ips
              profile_level = var.profile_level
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 1.2: IP Allowlisting for Admins (L2)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure IP allowlist in Keeper Admin Console"
                echo ""
                echo "  1. Navigate to: Admin Console > Admin > Roles"
                echo "  2. Select the Keeper Administrator role"
                echo "  3. Go to: Enforcement Policies > IP Allowlist"
                echo "  4. Add the following IPs:"
                %{for ip in var.admin_allowed_ips~}
                echo "     - ${ip}"
                %{endfor~}
                echo ""
                echo "  5. Repeat for all custom admin roles"
                echo "  6. Test access from allowed IPs"
                echo "  7. Verify blocked from other IPs"
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander enterprise-role --ip-allowlist '${join(",", var.admin_allowed_ips)}'"
                echo "============================================================"
              EOT
            }
            }
          
            # Store IP allowlist configuration as a record for audit trail
            resource "secretsmanager_login" "ip_allowlist_record" {
            count = var.profile_level >= 2 && length(var.admin_allowed_ips) > 0 ? 1 : 0
          
            folder_uid = var.security_config_folder_uid
            title      = "HTH Admin IP Allowlist Configuration"
          
            login = "admin-ip-policy"
            url   = "https://keepersecurity.com/console"
          
            notes = <<-EOT
              ADMIN IP ALLOWLIST CONFIGURATION
              =================================
              Profile Level: L2 (Hardened)
              Applied to: All administrative roles
          
              Allowed IP Addresses/CIDRs:
              ${join("\n    ", var.admin_allowed_ips)}
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 1.2
            EOT
            }

"1.3":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-1.03-administrative-event-alerts.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-1.03-administrative-event-alerts.tf"
    excerpts:
      terraform:
        content: |
            # Document SIEM integration configuration for administrative event alerts
            resource "terraform_data" "admin_event_alerts" {
            input = {
              siem_endpoint    = var.siem_endpoint
              alert_recipients = var.alert_recipients
              monitored_events = [
                "admin_login",
                "role_modification",
                "policy_change",
                "user_provisioned",
                "user_deprovisioned",
                "failed_login_attempt",
                "2fa_change",
                "record_shared",
                "admin_privilege_change",
              ]
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 1.3: Administrative Event Alerts (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure alerts in Keeper Admin Console"
                echo ""
                echo "  1. Navigate to: Admin Console > Reporting & Alerts"
                echo "  2. Enable alerts for:"
                echo "     - Admin login events"
                echo "     - Role modifications"
                echo "     - Policy changes"
                echo "     - User provisioning/deprovisioning"
                echo ""
                %{if var.siem_endpoint != ""~}
                echo "  3. Configure SIEM integration:"
                echo "     Endpoint: ${var.siem_endpoint}"
                echo ""
                %{endif~}
                %{if length(var.alert_recipients) > 0~}
                echo "  4. Configure notification recipients:"
                %{for email in var.alert_recipients~}
                echo "     - ${email}"
                %{endfor~}
                %{endif~}
                echo ""
                echo "============================================================"
              EOT
            }
            }
          
            # Store alert configuration as an auditable record
            resource "secretsmanager_login" "alert_config_record" {
            count = var.siem_endpoint != "" ? 1 : 0
          
            folder_uid = var.security_config_folder_uid
            title      = "HTH Administrative Event Alert Configuration"
          
            login = "siem-integration"
            url   = var.siem_endpoint
          
            notes = <<-EOT
              ADMINISTRATIVE EVENT ALERT CONFIGURATION
              ==========================================
              Profile Level: L1 (Baseline)
          
              SIEM Endpoint: ${var.siem_endpoint}
              Alert Recipients: ${join(", ", var.alert_recipients)}
          
              Monitored Events:
              - Admin login events
              - Role modifications
              - Policy changes
              - User provisioning/deprovisioning
              - Failed login attempts
              - 2FA changes
              - Record sharing
              - Admin privilege changes
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 1.3
            EOT
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-2.01-master-password-requirements.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-2.01-master-password-requirements.tf"
    excerpts:
      terraform:
        content: |
            # Configure master password enforcement policy
            resource "terraform_data" "master_password_policy" {
            input = {
              min_length      = var.master_password_min_length
              require_upper   = var.master_password_require_upper
              require_lower   = var.master_password_require_lower
              require_digits  = var.master_password_require_digits
              require_special = var.master_password_require_special
              profile_level   = var.profile_level
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 2.1: Master Password Requirements (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure password policy in Keeper Admin Console"
                echo ""
                echo "  1. Navigate to: Admin Console > Admin > Roles"
                echo "  2. Select role to configure"
                echo "  3. Click Enforcement Policies"
                echo "  4. Navigate to Master Password section"
                echo "  5. Configure:"
                echo "     - Minimum length: ${var.master_password_min_length} characters"
                echo "     - Require uppercase: ${var.master_password_require_upper}"
                echo "     - Require lowercase: ${var.master_password_require_lower}"
                echo "     - Require digits: ${var.master_password_require_digits}"
                echo "     - Require special characters: ${var.master_password_require_special}"
                echo "     - Password history: Enable (prevent reuse)"
                echo ""
                echo "  6. Apply to all user roles"
                echo "  7. Allow grace period for compliance"
                echo "  8. Monitor compliance dashboard"
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander enterprise-role --enforcement \\"
                echo "    master_password_minimum_length=${var.master_password_min_length} \\"
                echo "    master_password_restrict_days_before_reuse=365"
                echo "============================================================"
              EOT
            }
            }
          
            # Store password policy configuration for audit trail
            resource "secretsmanager_login" "password_policy_record" {
            folder_uid = var.security_config_folder_uid
            title      = "HTH Master Password Policy Configuration"
          
            login = "password-policy"
            url   = "https://keepersecurity.com/console"
          
            notes = <<-EOT
              MASTER PASSWORD ENFORCEMENT POLICY
              ====================================
              Profile Level: L1 (Baseline)
          
              Minimum Length: ${var.master_password_min_length} characters
              Require Uppercase: ${var.master_password_require_upper}
              Require Lowercase: ${var.master_password_require_lower}
              Require Digits: ${var.master_password_require_digits}
              Require Special Characters: ${var.master_password_require_special}
              Password History: Enabled (prevent reuse)
          
              Recommended Settings by Profile:
              - L1 (Baseline): 16+ characters, mixed case + numbers + symbols
              - L2 (Hardened): 20+ characters, all complexity requirements
              - L3 (Maximum):  24+ characters, all complexity, 90-day review
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 2.1
            EOT
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-2.02-enforce-two-factor-authentication.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-2.02-enforce-two-factor-authentication.tf"
    excerpts:
      terraform:
        content: |
            # Configure 2FA enforcement policy
            resource "terraform_data" "tfa_enforcement" {
            input = {
              tfa_required      = var.tfa_required
              allowed_methods   = var.tfa_allowed_methods
              disable_sms       = var.tfa_disable_sms
              profile_level     = var.profile_level
              dual_2fa_required = var.profile_level >= 3
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 2.2: Enforce Two-Factor Authentication (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure 2FA in Keeper Admin Console"
                echo ""
                echo "  1. Navigate to: Role > Enforcement Policies > Two-Factor Authentication"
                echo "  2. Enable 'Require 2FA'"
                echo "  3. Set prompting frequency: Every login"
                echo "  4. Configure allowed 2FA methods:"
                %{for method in var.tfa_allowed_methods~}
                echo "     - ${method}"
                %{endfor~}
                echo ""
                %{if var.tfa_disable_sms~}
                echo "  5. DISABLE SMS-based 2FA (SIM swap vulnerability)"
                %{endif~}
                echo ""
                %{if var.profile_level >= 3~}
                echo "  L3 REQUIREMENT: Enable dual 2FA"
                echo "  - Configure 2FA on identity provider side"
                echo "  - ALSO configure 2FA on Keeper side"
                echo "  - Both layers must be active for SSO users"
                echo ""
                %{endif~}
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander enterprise-role --enforcement \\"
                echo "    two_factor_authentication_required=true \\"
                echo "    two_factor_duration=login"
                echo "============================================================"
              EOT
            }
            }
          
            # Store 2FA policy configuration for audit trail
            resource "secretsmanager_login" "tfa_policy_record" {
            folder_uid = var.security_config_folder_uid
            title      = "HTH Two-Factor Authentication Policy"
          
            login = "2fa-policy"
            url   = "https://keepersecurity.com/console"
          
            notes = <<-EOT
              TWO-FACTOR AUTHENTICATION ENFORCEMENT
              ========================================
              Profile Level: L1 (Baseline)
          
              2FA Required: ${var.tfa_required}
              Prompting Frequency: Every login
              Allowed Methods: ${join(", ", var.tfa_allowed_methods)}
              SMS Disabled: ${var.tfa_disable_sms}
          
              Recommended Methods (by security strength):
              1. FIDO2/WebAuthn (hardware keys) -- phishing-resistant
              2. TOTP Authenticator (Google Authenticator, Authy)
              3. Keeper DNA (Apple Watch) -- biometric
              4. Duo Security (if integrated)
              5. RSA SecurID (if integrated)
              AVOID: SMS (vulnerable to SIM swap attacks)
          
              L3 Requirement: Dual 2FA (IdP + Keeper) = ${var.profile_level >= 3}
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 2.2
            EOT
            }

"2.3":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-2.03-sharing-export-restrictions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-2.03-sharing-export-restrictions.tf"
    excerpts:
      terraform:
        content: |
            # Configure sharing restrictions -- L2 tightens to org-only
            resource "terraform_data" "sharing_restrictions" {
            input = {
              restrict_to_org = var.profile_level >= 2 ? true : var.restrict_sharing_to_org
              disable_export  = var.profile_level >= 2 ? true : var.disable_export
              profile_level   = var.profile_level
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 2.3: Sharing and Export Restrictions (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure sharing policy in Keeper Admin Console"
                echo ""
                echo "  1. Navigate to: Role > Enforcement Policies > Sharing"
                echo "  2. Configure:"
                %{if var.profile_level >= 2~}
                echo "     - Allow sharing: Within organization only (L2)"
                echo "     - Allow external sharing: DISABLED"
                %{else~}
                echo "     - Allow sharing: Enabled with controls"
                echo "     - Allow external sharing: Require approval"
                %{endif~}
                echo "     - One-time share: Configure expiration"
                echo ""
                echo "  3. Navigate to: Enforcement Policies > Export"
                echo "  4. Configure:"
                %{if var.profile_level >= 2~}
                echo "     - Allow export: DISABLED (L2)"
                echo "     - Allow printing: DISABLED (L2)"
                %{else~}
                echo "     - Allow export: Enabled (L1 baseline)"
                echo "     - Allow printing: Enabled (L1 baseline)"
                %{endif~}
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander enterprise-role --enforcement \\"
                %{if var.profile_level >= 2~}
                echo "    restrict_sharing=org_only \\"
                echo "    restrict_export=true \\"
                echo "    restrict_printing=true"
                %{else~}
                echo "    restrict_sharing=allow_with_controls \\"
                echo "    restrict_export=false"
                %{endif~}
                echo "============================================================"
              EOT
            }
            }
          
            # Store sharing policy for audit trail
            resource "secretsmanager_login" "sharing_policy_record" {
            folder_uid = var.security_config_folder_uid
            title      = "HTH Sharing and Export Restrictions"
          
            login = "sharing-policy"
            url   = "https://keepersecurity.com/console"
          
            notes = <<-EOT
              SHARING AND EXPORT RESTRICTIONS
              =================================
              Profile Level: L1+ (Baseline)
              Current Profile: L${var.profile_level}
          
              Sharing Policy:
              - Restrict to organization: ${var.profile_level >= 2 ? "YES (L2)" : var.restrict_sharing_to_org}
              - External sharing: ${var.profile_level >= 2 ? "DISABLED" : "Require approval"}
              - One-time share: Configured with expiration
          
              Export Policy:
              - Allow export: ${var.profile_level >= 2 ? "DISABLED (L2)" : "Enabled"}
              - Allow printing: ${var.profile_level >= 2 ? "DISABLED (L2)" : "Enabled"}
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 2.3
            EOT
            }

"2.4":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-2.04-restrict-browser-extensions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-2.04-restrict-browser-extensions.tf"
    excerpts:
      terraform:
        content: |
            # Document approved browser extension policy (L2+)
            resource "terraform_data" "browser_extension_policy" {
            count = var.profile_level >= 2 ? 1 : 0
          
            input = {
              profile_level       = var.profile_level
              approved_extensions = var.approved_browser_extensions
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 2.4: Restrict Browser Extensions (L2)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure browser extension policy via MDM"
                echo ""
                echo "  1. Use device management (MDM) to:"
                echo "     - Allow only Keeper browser extension"
                echo "     - Block unapproved extensions"
                echo "     - Remove unknown extensions"
                echo ""
                echo "  2. Approved Extension IDs:"
                echo "     - Chrome: bfogiafebfohielmmehodmfbbebbbpei (Keeper)"
                %{for ext in var.approved_browser_extensions~}
                echo "     - ${ext}"
                %{endfor~}
                echo ""
                echo "  3. Communicate policy to users"
                echo "  4. Schedule regular audit of installed extensions"
                echo ""
                echo "MDM Configuration (Google Workspace example):"
                echo "  Admin Console > Devices > Chrome > Apps & extensions"
                echo "  Set 'Allow/block mode' to 'Allow approved apps'"
                echo "============================================================"
              EOT
            }
            }
          
            # Store approved extension whitelist for audit trail
            resource "secretsmanager_login" "extension_policy_record" {
            count = var.profile_level >= 2 ? 1 : 0
          
            folder_uid = var.security_config_folder_uid
            title      = "HTH Browser Extension Policy"
          
            login = "extension-policy"
            url   = "https://keepersecurity.com/console"
          
            notes = <<-EOT
              BROWSER EXTENSION RESTRICTION POLICY
              =======================================
              Profile Level: L2 (Hardened)
          
              Approved Extensions:
              - Keeper Password Manager (bfogiafebfohielmmehodmfbbebbbpei)
              ${join("\n    ", var.approved_browser_extensions)}
          
              Enforcement Method: MDM / Endpoint Management
              Policy: Block all unapproved browser extensions
              Audit Frequency: Monthly
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 2.4
            EOT
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-3.01-biometric-authentication.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-3.01-biometric-authentication.tf"
    excerpts:
      terraform:
        content: |
            # Configure biometric authentication enforcement
            resource "terraform_data" "biometric_authentication" {
            input = {
              biometrics_enabled     = true
              biometric_timeout_mins = var.biometric_timeout_minutes
              require_periodic_mp    = true
              profile_level          = var.profile_level
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 3.1: Biometric Authentication (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure biometrics in Keeper Admin Console"
                echo ""
                echo "  1. Navigate to: Role > Enforcement Policies > Biometrics"
                echo "  2. Configure allowed biometric methods:"
                echo "     - Windows Hello"
                echo "     - Touch ID"
                echo "     - Face ID"
                echo "     - Android biometrics"
                echo ""
                echo "  3. Configure biometric policy:"
                echo "     - Biometric timeout: ${var.biometric_timeout_minutes} minutes"
                echo "     - Require master password periodically: YES"
                echo "     - Fallback authentication: Master password"
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander enterprise-role --enforcement \\"
                echo "    allow_biometrics=true \\"
                echo "    biometric_timeout=${var.biometric_timeout_minutes}"
                echo "============================================================"
              EOT
            }
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-3.02-account-recovery.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-3.02-account-recovery.tf"
    excerpts:
      terraform:
        content: |
            # Configure account recovery enforcement policy
            resource "terraform_data" "account_recovery" {
            input = {
              admin_assisted_recovery = true
              self_service_recovery   = var.profile_level <= 1
              profile_level           = var.profile_level
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 3.2: Account Recovery (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure recovery in Keeper Admin Console"
                echo ""
                echo "  1. Navigate to: Role > Enforcement Policies > Account Recovery"
                echo "  2. Enable appropriate recovery methods:"
                echo ""
                echo "     Admin-assisted recovery: ENABLED (recommended)"
                echo "       - Configure approval workflow"
                echo "       - Require verification steps"
                echo "       - Log all recovery events"
                echo ""
                %{if var.profile_level <= 1~}
                echo "     Self-service recovery: ENABLED (L1)"
                echo "       - With appropriate verification"
                echo "       - Consider disabling at L2+"
                %{else~}
                echo "     Self-service recovery: DISABLED (L2+)"
                echo "       - Admin-assisted only for tighter control"
                %{endif~}
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander enterprise-role --enforcement \\"
                echo "    allow_admin_recovery=true \\"
                echo "    allow_self_recovery=${var.profile_level <= 1 ? "true" : "false"}"
                echo "============================================================"
              EOT
            }
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-4.01-saml-sso.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-4.01-saml-sso.tf"
    excerpts:
      terraform:
        content: |
            # Configure SAML SSO integration (L2+)
            resource "terraform_data" "saml_sso" {
            count = var.profile_level >= 2 && var.sso_entity_id != "" ? 1 : 0
          
            input = {
              entity_id     = var.sso_entity_id
              sso_url       = var.sso_url
              profile_level = var.profile_level
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 4.1: SAML SSO Configuration (L2)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure SSO in Keeper Admin Console"
                echo ""
                echo "  Step 1: Configure SSO Connect Cloud"
                echo "  1. Navigate to: Admin Console > SSO Configuration"
                echo "  2. Click 'Add SSO Configuration'"
                echo "  3. Configure SAML settings:"
                echo "     - Entity ID: ${var.sso_entity_id}"
                echo "     - SSO URL: ${var.sso_url}"
                echo "     - Certificate: (uploaded separately)"
                echo ""
                echo "  Step 2: Configure Identity Provider"
                echo "  1. Create SAML application in IdP"
                echo "  2. Upload Keeper metadata"
                echo "  3. Configure attribute mappings:"
                echo "     - Email (required)"
                echo "     - First name, last name (optional)"
                echo "  4. Configure groups for role mapping"
                echo ""
                echo "  Step 3: SECURE THE SSO CONFIGURATION"
                echo "  [CRITICAL] Lock down IdP with MFA"
                echo "  [CRITICAL] Follow IdP security best practices"
                echo "  [CRITICAL] Ensure IdP admin accounts are secured"
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander enterprise-sso --add \\"
                echo "    --entity-id '${var.sso_entity_id}' \\"
                echo "    --sso-url '${var.sso_url}'"
                echo "============================================================"
              EOT
            }
            }
          
            # Store SSO configuration metadata for audit trail
            resource "secretsmanager_login" "sso_config_record" {
            count = var.profile_level >= 2 && var.sso_entity_id != "" ? 1 : 0
          
            folder_uid = var.security_config_folder_uid
            title      = "HTH SAML SSO Configuration"
          
            login = "sso-saml-config"
            url   = var.sso_url
          
            notes = <<-EOT
              SAML SSO CONFIGURATION
              ========================
              Profile Level: L2 (Hardened)
          
              Entity ID: ${var.sso_entity_id}
              SSO URL: ${var.sso_url}
              Certificate: Uploaded via Admin Console
          
              Attribute Mappings:
              - Email (required)
              - First name (optional)
              - Last name (optional)
          
              Security Checklist:
              [ ] IdP locked down with MFA
              [ ] IdP admin accounts secured
              [ ] IdP follows security best practices
              [ ] Keeper admin accounts excluded from SSO (break-glass)
          
              Prerequisites:
              - Keeper SSO Connect Cloud license
              - SAML 2.0 compatible identity provider
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 4.1
            EOT
            }

"4.2":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-4.02-just-in-time-provisioning.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-4.02-just-in-time-provisioning.tf"
    excerpts:
      terraform:
        content: |
            # Configure Just-in-Time provisioning (L2+)
            resource "terraform_data" "jit_provisioning" {
            count = var.profile_level >= 2 ? 1 : 0
          
            input = {
              jit_enabled      = true
              scim_enabled     = var.scim_endpoint != ""
              default_role     = var.jit_default_role
              profile_level    = var.profile_level
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 4.2: Just-in-Time Provisioning (L2)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure provisioning in Keeper Admin Console"
                echo ""
                echo "  Step 1: Enable JIT Provisioning"
                echo "  1. Navigate to: SSO Configuration > Provisioning"
                echo "  2. Enable 'Just-in-Time provisioning'"
                echo "  3. Configure default role: ${var.jit_default_role}"
                echo ""
                %{if var.scim_endpoint != ""~}
                echo "  Step 2: Configure SCIM"
                echo "  1. Enable SCIM provisioning endpoint"
                echo "  2. SCIM endpoint: ${var.scim_endpoint}"
                echo "  3. Integrate with IdP SCIM client"
                echo "  4. Configure user lifecycle management:"
                echo "     - Create on assignment"
                echo "     - Deactivate on removal"
                echo "     - Sync group memberships"
                %{else~}
                echo "  Step 2: SCIM (Optional)"
                echo "  Consider configuring SCIM for automated lifecycle management"
                echo "  including automatic deprovisioning when users leave."
                %{endif~}
                echo ""
                echo "============================================================"
              EOT
            }
            }
          
            # Store SCIM configuration for audit trail
            resource "secretsmanager_login" "scim_config_record" {
            count = var.profile_level >= 2 && var.scim_endpoint != "" ? 1 : 0
          
            folder_uid = var.security_config_folder_uid
            title      = "HTH SCIM Provisioning Configuration"
          
            login = "scim-config"
            url   = var.scim_endpoint
          
            notes = <<-EOT
              SCIM PROVISIONING CONFIGURATION
              ==================================
              Profile Level: L2 (Hardened)
          
              JIT Provisioning: Enabled
              SCIM Endpoint: ${var.scim_endpoint}
              Default Role: ${var.jit_default_role}
          
              Lifecycle Management:
              - Create user on IdP assignment
              - Deactivate user on IdP removal
              - Sync group memberships
              - Map IdP groups to Keeper roles
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 4.2
            EOT
            }

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-5.01-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-5.01-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # Configure audit logging and SIEM integration
            resource "terraform_data" "audit_logging" {
            input = {
              siem_endpoint  = var.siem_endpoint
              retention_days = var.audit_log_retention_days
              profile_level  = var.profile_level
              key_events = [
                "failed_login_attempts",
                "2fa_changes",
                "record_sharing",
                "admin_privilege_changes",
                "policy_modifications",
                "user_provisioning",
                "user_deprovisioning",
                "vault_export_attempts",
              ]
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 5.1: Audit Logging (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Configure audit logging in Keeper Admin Console"
                echo ""
                echo "  Step 1: Access Reporting"
                echo "  1. Navigate to: Admin Console > Reporting & Alerts"
                echo "  2. Review available reports:"
                echo "     - Login activity"
                echo "     - Record access"
                echo "     - Sharing activity"
                echo "     - Admin actions"
                echo ""
                %{if var.siem_endpoint != ""~}
                echo "  Step 2: Configure SIEM Integration"
                echo "  1. Navigate to: Reporting & Alerts > SIEM Integration"
                echo "  2. Configure export destination: ${var.siem_endpoint}"
                echo "  3. Select events to stream:"
                echo "     - Failed login attempts"
                echo "     - 2FA changes"
                echo "     - Record sharing"
                echo "     - Admin privilege changes"
                echo "     - Policy modifications"
                %{endif~}
                echo ""
                echo "  Log Retention: ${var.audit_log_retention_days} days"
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander audit-log --format=syslog \\"
                echo "    --target='${var.siem_endpoint}'"
                echo "============================================================"
              EOT
            }
            }

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-5.02-security-audit.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-5.02-security-audit.tf"
    excerpts:
      terraform:
        content: |
            # Configure Security Audit monitoring and thresholds
            resource "terraform_data" "security_audit" {
            input = {
              min_security_score = var.profile_level >= 3 ? 90 : var.profile_level >= 2 ? 80 : 70
              profile_level      = var.profile_level
              audit_metrics = [
                "overall_security_score",
                "password_strength_distribution",
                "reused_passwords",
                "2fa_adoption_rate",
                "weak_password_count",
              ]
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 5.2: Security Audit Monitoring (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Review Security Audit in Keeper Admin Console"
                echo ""
                echo "  Step 1: Access Security Audit"
                echo "  1. Navigate to: Admin Console > Security Audit"
                echo "  2. Review dashboard metrics:"
                echo "     - Overall security score (target: ${var.profile_level >= 3 ? "90" : var.profile_level >= 2 ? "80" : "70"}+)"
                echo "     - Password strength distribution"
                echo "     - Reused passwords (target: 0)"
                echo "     - 2FA adoption (target: 100%)"
                echo ""
                echo "  Step 2: Identify and Remediate Issues"
                echo "  1. Review users with weak passwords"
                echo "  2. Identify reused credentials"
                echo "  3. Track 2FA compliance gaps"
                echo "  4. Notify non-compliant users"
                echo "  5. Set improvement targets"
                echo ""
                echo "  Recommended Audit Frequency:"
                echo "     - L1: Monthly review"
                echo "     - L2: Bi-weekly review"
                echo "     - L3: Weekly review with automated alerts"
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander security-audit-report --format=json"
                echo "============================================================"
              EOT
            }
            }

"5.3":
  terraform:
    lang: "hcl"
    filename: "hth-keeper-5.03-breachwatch.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/keeper/terraform/hth-keeper-5.03-breachwatch.tf"
    excerpts:
      terraform:
        content: |
            # Enable BreachWatch for compromised credential detection
            resource "terraform_data" "breachwatch" {
            input = {
              breachwatch_enabled = var.breachwatch_enabled
              profile_level       = var.profile_level
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "============================================================"
                echo "HTH Keeper 5.3: BreachWatch Integration (L1)"
                echo "============================================================"
                echo ""
                echo "ACTION REQUIRED: Enable BreachWatch in Keeper Admin Console"
                echo ""
                echo "  Step 1: Enable BreachWatch"
                echo "  1. Navigate to: Admin Console > BreachWatch"
                echo "  2. Enable for organization"
                echo "  3. Configure alert settings"
                echo ""
                echo "  Step 2: Respond to Alerts"
                echo "  When compromised credentials are detected:"
                echo "  1. Notify affected users immediately"
                echo "  2. Require password change"
                echo "  3. Investigate exposure source"
                echo "  4. Document incident response"
                echo ""
                echo "  Plan Compatibility:"
                echo "  - Business: Add-on required"
                echo "  - Enterprise: Add-on required"
                echo "  - Enterprise Plus: Included"
                echo ""
                echo "Or use Keeper Commander CLI:"
                echo "  keeper-commander breachwatch --enable"
                echo "  keeper-commander breachwatch --scan"
                echo "============================================================"
              EOT
            }
            }
          
            # Store BreachWatch configuration for audit trail
            resource "secretsmanager_login" "breachwatch_config_record" {
            count = var.breachwatch_enabled ? 1 : 0
          
            folder_uid = var.security_config_folder_uid
            title      = "HTH BreachWatch Configuration"
          
            login = "breachwatch-config"
            url   = "https://keepersecurity.com/console"
          
            notes = <<-EOT
              BREACHWATCH CONFIGURATION
              ===========================
              Profile Level: L1 (Baseline)
          
              BreachWatch Enabled: ${var.breachwatch_enabled}
          
              Incident Response Procedure:
              1. Alert triggers when credential found in breach database
              2. Security team notified via configured alerts
              3. Affected user notified to change password immediately
              4. Investigate scope of exposure
              5. Document in incident tracking system
          
              License Requirement:
              - Business: Add-on
              - Enterprise: Add-on
              - Enterprise Plus: Included
          
              Last updated: Managed by Terraform
              Control: HTH Keeper 5.3
            EOT
            }

