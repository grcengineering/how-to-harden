# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-19T16:14:18Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-1.01-enable-authentication.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-1.01-enable-authentication.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration to enable authentication and disable anonymous access
            resource "local_file" "enable_authentication" {
            filename = "${path.module}/generated/casc-enable-authentication.yaml"
            content  = yamlencode({
              jenkins = {
                securityRealm = {
                  local = {
                    allowsSignup = false
                    users = [
                      for user in var.admin_users : {
                        id       = user
                        password = "CHANGE_ME_ON_FIRST_LOGIN"
                      }
                    ]
                  }
                }
                authorizationStrategy = {
                  globalMatrix = {
                    permissions = [
                      "Overall/Administer:admin",
                      "Overall/Read:authenticated",
                    ]
                  }
                }
              }
            })
          
            file_permission = "0644"
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-1.02-configure-sso.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-1.02-configure-sso.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration for SAML SSO (L2+)
            resource "local_file" "configure_saml_sso" {
            count = var.profile_level >= 2 && var.sso_type == "saml" ? 1 : 0
          
            filename = "${path.module}/generated/casc-saml-sso.yaml"
            content  = yamlencode({
              jenkins = {
                securityRealm = {
                  saml = {
                    idpMetadataConfiguration = {
                      url = var.saml_idp_metadata_url
                    }
                    usernameAttributeName     = var.saml_username_attribute
                    emailAttributeName        = var.saml_email_attribute
                    groupsAttributeName       = var.saml_group_attribute
                    maximumAuthenticationLifetime = 86400
                    binding                   = "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
                  }
                }
              }
            })
          
            file_permission = "0644"
            }
          
            # JCasC configuration for LDAP authentication (L2+)
            resource "local_file" "configure_ldap" {
            count = var.profile_level >= 2 && var.sso_type == "ldap" ? 1 : 0
          
            filename = "${path.module}/generated/casc-ldap.yaml"
            content  = yamlencode({
              jenkins = {
                securityRealm = {
                  ldap = {
                    configurations = [
                      {
                        server                  = var.ldap_server_url
                        rootDN                  = var.ldap_root_dn
                        userSearchBase          = var.ldap_user_search_base
                        userSearch              = var.ldap_user_search_filter
                        groupSearchBase         = var.ldap_group_search_base
                        inhibitInferRootDN      = false
                        managerDN               = var.ldap_manager_dn
                        managerPasswordSecret   = var.ldap_manager_password
                      }
                    ]
                    disableMailAddressResolver = false
                    disableRolePrefixing       = true
                  }
                }
              }
            })
          
            file_permission = "0644"
            }

"1.3":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-1.03-disable-remember-me.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-1.03-disable-remember-me.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration to disable Remember Me (L2+)
            resource "local_file" "disable_remember_me" {
            count = var.profile_level >= 2 ? 1 : 0
          
            filename = "${path.module}/generated/casc-disable-remember-me.yaml"
            content  = yamlencode({
              jenkins = {
                disableRememberMe = true
              }
            })
          
            file_permission = "0644"
            }
          
            # Groovy init script to disable Remember Me (alternative deployment method)
            resource "local_file" "disable_remember_me_groovy" {
            count = var.profile_level >= 2 ? 1 : 0
          
            filename = "${path.module}/generated/init.groovy.d/disable-remember-me.groovy"
            content  = <<-GROOVY
              // HTH Jenkins Control 1.3: Disable Remember Me
              // Profile Level: L2 (Hardened)
              import jenkins.model.Jenkins
          
              def instance = Jenkins.instance
              instance.setDisableRememberMe(true)
              instance.save()
              println("[HTH] Remember Me has been disabled")
            GROOVY
          
            file_permission = "0644"
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-2.01-configure-matrix-security.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-2.01-configure-matrix-security.tf"
    excerpts:
      terraform:
        content: |
            # Team-isolated folders with matrix authorization permissions
            resource "jenkins_folder" "team_folder" {
            for_each = var.team_folders
          
            name         = each.key
            display_name = replace(title(each.key), "-", " ")
            description  = each.value.description
          
            dynamic "security" {
              for_each = length(each.value.permissions) > 0 ? [1] : []
              content {
                inheritance_strategy = "org.jenkinsci.plugins.matrixauth.inheritance.NonInheritingStrategy"
                permissions          = each.value.permissions
              }
            }
            }
          
            # JCasC for global matrix authorization strategy
            resource "local_file" "matrix_authorization" {
            filename = "${path.module}/generated/casc-matrix-authorization.yaml"
            content  = yamlencode({
              jenkins = {
                authorizationStrategy = {
                  projectMatrix = {
                    permissions = concat(
                      # Admin permissions
                      [for user in var.admin_users : "Overall/Administer:${user}"],
                      # Authenticated users get read-only by default
                      [
                        "Overall/Read:authenticated",
                        "Job/Read:authenticated",
                      ]
                    )
                  }
                }
              }
            })
          
            file_permission = "0644"
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-2.02-configure-project-matrix.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-2.02-configure-project-matrix.tf"
    excerpts:
      terraform:
        content: |
            # Project-isolated folders with strict non-inheriting permissions (L2+)
            resource "jenkins_folder" "project_folder" {
            for_each = var.profile_level >= 2 ? var.project_folders : {}
          
            name         = each.key
            display_name = replace(title(each.key), "-", " ")
            description  = each.value.description
            folder       = each.value.parent_folder
          
            security {
              # Block permission inheritance so only explicitly granted users have access
              inheritance_strategy = "org.jenkinsci.plugins.matrixauth.inheritance.NonInheritingStrategy"
              permissions          = each.value.permissions
            }
            }

"2.3":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-2.03-configure-rbac.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-2.03-configure-rbac.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration for role-based authorization strategy (L2+)
            resource "local_file" "rbac_configuration" {
            count = var.profile_level >= 2 && var.enable_rbac ? 1 : 0
          
            filename = "${path.module}/generated/casc-rbac.yaml"
            content  = yamlencode({
              jenkins = {
                authorizationStrategy = {
                  roleBased = {
                    roles = {
                      global = [
                        {
                          name        = "admin"
                          description = "Full administrative access"
                          permissions = [
                            "Overall/Administer",
                          ]
                          entries = [
                            for user in var.admin_users : { user = user }
                          ]
                        },
                        {
                          name        = "developer"
                          description = "Build and read permissions for all jobs"
                          permissions = [
                            "Overall/Read",
                            "Job/Build",
                            "Job/Read",
                            "Job/Workspace",
                            "Run/Replay",
                            "Run/Update",
                          ]
                          entries = [
                            for user in var.developer_users : { user = user }
                          ]
                        },
                        {
                          name        = "viewer"
                          description = "Read-only access to jobs and builds"
                          permissions = [
                            "Overall/Read",
                            "Job/Read",
                          ]
                          entries = [
                            for user in var.viewer_users : { user = user }
                          ]
                        },
                      ]
                      items = [
                        for role in var.rbac_item_roles : {
                          name        = role.name
                          description = role.description
                          pattern     = role.pattern
                          permissions = role.permissions
                          entries     = [for user in role.users : { user = user }]
                        }
                      ]
                    }
                  }
                }
              }
            })
          
            file_permission = "0644"
            }

"2.4":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-2.04-restrict-script-console.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-2.04-restrict-script-console.tf"
    excerpts:
      terraform:
        content: |
            # Groovy init script to audit and log Script Console access
            resource "local_file" "script_console_audit" {
            filename = "${path.module}/generated/init.groovy.d/audit-script-console.groovy"
            content  = <<-GROOVY
              // HTH Jenkins Control 2.4: Restrict Script Console Access
              // Profile Level: L1 (Baseline)
              // Logs all Script Console usage for audit trail
              import jenkins.model.Jenkins
              import java.util.logging.Logger
          
              def logger = Logger.getLogger("jenkins.security.script-console")
          
              // Verify that only designated admins have Overall/Administer
              def authStrategy = Jenkins.instance.getAuthorizationStrategy()
              logger.info("[HTH] Authorization strategy: $${authStrategy.getClass().getName()}")
              logger.info("[HTH] Script Console access audit initialized")
              logger.info("[HTH] Only users with Overall/Administer can access Script Console")
          
              println("[HTH] Script Console audit logging enabled")
            GROOVY
          
            file_permission = "0644"
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-3.01-agent-controller-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-3.01-agent-controller-access.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration to enable Agent-to-Controller access control
            resource "local_file" "agent_controller_access" {
            filename = "${path.module}/generated/casc-agent-controller-access.yaml"
            content  = yamlencode({
              jenkins = {
                remotingSecurity = {
                  enabled = true
                }
              }
              security = {
                apiToken = {
                  creationOfLegacyToken = false
                  tokenGenerationOnCreationEnabled = false
                  usageStatisticsEnabled = true
                }
              }
            })
          
            file_permission = "0644"
            }
          
            # Groovy init script to verify and enforce agent-controller security
            resource "local_file" "agent_controller_access_groovy" {
            filename = "${path.module}/generated/init.groovy.d/agent-controller-access.groovy"
            content  = <<-GROOVY
              // HTH Jenkins Control 3.1: Enable Agent to Controller Access Control
              // Profile Level: L1 (Baseline)
              import jenkins.model.Jenkins
              import jenkins.security.s2m.AdminWhitelistRule
          
              def rule = Jenkins.instance.getInjector().getInstance(AdminWhitelistRule.class)
              rule.setMasterKillSwitch(false)
              Jenkins.instance.save()
              println("[HTH] Agent-to-Controller access control enabled")
            GROOVY
          
            file_permission = "0644"
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-3.02-disable-builds-on-controller.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-3.02-disable-builds-on-controller.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration to disable builds on the controller node
            resource "local_file" "disable_builds_on_controller" {
            filename = "${path.module}/generated/casc-disable-controller-builds.yaml"
            content  = yamlencode({
              jenkins = {
                numExecutors = var.controller_executors
                labelString  = var.controller_label
                mode         = "EXCLUSIVE"
              }
            })
          
            file_permission = "0644"
            }
          
            # Groovy init script to set controller executors to 0
            resource "local_file" "disable_controller_builds_groovy" {
            filename = "${path.module}/generated/init.groovy.d/disable-controller-builds.groovy"
            content  = <<-GROOVY
              // HTH Jenkins Control 3.2: Disable Builds on Controller
              // Profile Level: L1 (Baseline)
              import jenkins.model.Jenkins
              import hudson.model.Node
          
              def instance = Jenkins.instance
              instance.setNumExecutors(${var.controller_executors})
              instance.setLabelString("${var.controller_label}")
              instance.setMode(Node.Mode.EXCLUSIVE)
              instance.save()
              println("[HTH] Controller executors set to ${var.controller_executors}, label: ${var.controller_label}")
            GROOVY
          
            file_permission = "0644"
            }

"3.3":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-3.03-ephemeral-agents.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-3.03-ephemeral-agents.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration for Kubernetes ephemeral agents (L2+)
            resource "local_file" "ephemeral_agents_k8s" {
            count = var.profile_level >= 2 && var.cloud_agent_type == "kubernetes" ? 1 : 0
          
            filename = "${path.module}/generated/casc-ephemeral-agents-k8s.yaml"
            content  = yamlencode({
              jenkins = {
                clouds = [
                  {
                    kubernetes = {
                      name                  = "kubernetes"
                      serverUrl             = var.k8s_server_url
                      namespace             = var.k8s_namespace
                      jenkinsUrl            = var.jenkins_server_url
                      retentionTimeout      = 5
                      connectTimeout        = 5
                      readTimeout           = 15
                      containerCapStr       = var.k8s_max_containers
                      podRetention          = "never"
                      templates = [
                        {
                          name      = "secure-agent"
                          label     = var.secure_pipeline_agent_label
                          nodeUsageMode = "EXCLUSIVE"
                          containers = [
                            {
                              name            = "jnlp"
                              image           = var.agent_image
                              resourceLimitCpu    = var.agent_cpu_limit
                              resourceLimitMemory = var.agent_memory_limit
                              workingDir      = "/home/jenkins/agent"
                            }
                          ]
                          idleMinutes = 0
                          yamlMergeStrategy = "override"
                        }
                      ]
                    }
                  }
                ]
              }
            })
          
            file_permission = "0644"
            }
          
            # JCasC configuration for Docker ephemeral agents (L2+)
            resource "local_file" "ephemeral_agents_docker" {
            count = var.profile_level >= 2 && var.cloud_agent_type == "docker" ? 1 : 0
          
            filename = "${path.module}/generated/casc-ephemeral-agents-docker.yaml"
            content  = yamlencode({
              jenkins = {
                clouds = [
                  {
                    docker = {
                      name = "docker"
                      dockerApi = {
                        dockerHost = {
                          uri = var.docker_host_uri
                        }
                      }
                      templates = [
                        {
                          labelString   = var.secure_pipeline_agent_label
                          dockerTemplateBase = {
                            image = var.agent_image
                          }
                          remoteFs     = "/home/jenkins/agent"
                          instanceCapStr = var.docker_max_instances
                          retentionStrategy = {
                            idleMinutes = 0
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            })
          
            file_permission = "0644"
            }

"3.4":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-3.04-secure-agent-communication.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-3.04-secure-agent-communication.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration to enforce secure agent protocols
            resource "local_file" "secure_agent_communication" {
            filename = "${path.module}/generated/casc-secure-agent-protocols.yaml"
            content  = yamlencode({
              jenkins = {
                agentProtocols = [
                  "JNLP4-connect",
                ]
                slaveAgentPort = var.agent_inbound_port
              }
              security = {
                # Disable CLI over remoting (use SSH or HTTP API instead)
                csp = {
                  # Content Security Policy for Jenkins UI
                }
              }
            })
          
            file_permission = "0644"
            }
          
            # Groovy init script to enforce JNLP4 only and disable legacy protocols
            resource "local_file" "secure_agent_protocols_groovy" {
            filename = "${path.module}/generated/init.groovy.d/secure-agent-protocols.groovy"
            content  = <<-GROOVY
              // HTH Jenkins Control 3.4: Secure Agent Communication
              // Profile Level: L1 (Baseline)
              import jenkins.model.Jenkins
          
              def instance = Jenkins.instance
          
              // Enable only JNLP4 (TLS-encrypted) protocol
              Set<String> agentProtocols = new HashSet<>()
              agentProtocols.add("JNLP4-connect")
              instance.setAgentProtocols(agentProtocols)
          
              // Set fixed inbound agent port (required for firewall rules)
              instance.setSlaveAgentPort(${var.agent_inbound_port})
          
              instance.save()
              println("[HTH] Agent protocols restricted to JNLP4-connect (TLS)")
              println("[HTH] Inbound agent port set to ${var.agent_inbound_port}")
            GROOVY
          
            file_permission = "0644"
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-4.01-enable-csrf-protection.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-4.01-enable-csrf-protection.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration to enable CSRF protection
            resource "local_file" "enable_csrf_protection" {
            filename = "${path.module}/generated/casc-csrf-protection.yaml"
            content  = yamlencode({
              security = {
                crumbIssuer = {
                  standard = {
                    excludeClientIPFromCrumb = var.csrf_proxy_compatibility
                  }
                }
              }
              jenkins = {
                # Disable CLI remoting to reduce attack surface
                disableRememberMe = false
              }
            })
          
            file_permission = "0644"
            }
          
            # Groovy init script to verify CSRF protection is enabled
            resource "local_file" "csrf_protection_groovy" {
            filename = "${path.module}/generated/init.groovy.d/csrf-protection.groovy"
            content  = <<-GROOVY
              // HTH Jenkins Control 4.1: Enable CSRF Protection
              // Profile Level: L1 (Baseline)
              import jenkins.model.Jenkins
              import hudson.security.csrf.DefaultCrumbIssuer
          
              def instance = Jenkins.instance
          
              // Enable Default Crumb Issuer with proxy compatibility
              instance.setCrumbIssuer(new DefaultCrumbIssuer(${var.csrf_proxy_compatibility}))
              instance.save()
              println("[HTH] CSRF protection enabled (proxy compatibility: ${var.csrf_proxy_compatibility})")
            GROOVY
          
            file_permission = "0644"
            }

"4.2":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-4.02-secure-credentials.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-4.02-secure-credentials.tf"
    excerpts:
      terraform:
        content: |
            # Credential domain folders for scoped secret management
            resource "jenkins_folder" "credential_domain" {
            for_each = var.credential_domains
          
            name         = each.key
            display_name = replace(title(replace(each.key, "-", " ")), " ", " ")
            description  = each.value.description
          
            security {
              # Non-inheriting permissions: only folder members access folder credentials
              inheritance_strategy = "org.jenkinsci.plugins.matrixauth.inheritance.NonInheritingStrategy"
              permissions = concat(
                # Admins get full access
                [for user in var.admin_users : "hudson.model.Item.Build:${user}"],
                [for user in var.admin_users : "hudson.model.Item.Read:${user}"],
                [for user in var.admin_users : "hudson.model.Item.Configure:${user}"],
                [for user in var.admin_users : "com.cloudbees.plugins.credentials.CredentialsProvider.View:${user}"],
                [for user in var.admin_users : "com.cloudbees.plugins.credentials.CredentialsProvider.Create:${user}"],
                [for user in var.admin_users : "com.cloudbees.plugins.credentials.CredentialsProvider.Update:${user}"],
              )
            }
            }

"4.3":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-4.03-pipeline-sandbox.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-4.03-pipeline-sandbox.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration to enforce pipeline sandbox restrictions
            resource "local_file" "pipeline_sandbox" {
            filename = "${path.module}/generated/casc-pipeline-sandbox.yaml"
            content  = yamlencode({
              security = {
                globalJobDslSecurityConfiguration = {
                  useScriptSecurity = true
                }
              }
              unclassified = {
                globalLibraries = {
                  libraries = []
                }
              }
            })
          
            file_permission = "0644"
            }
          
            # Groovy init script to enforce sandbox and clear unsafe approvals
            resource "local_file" "pipeline_sandbox_groovy" {
            filename = "${path.module}/generated/init.groovy.d/pipeline-sandbox.groovy"
            content  = <<-GROOVY
              // HTH Jenkins Control 4.3: Implement Pipeline Sandbox
              // Profile Level: L1 (Baseline)
              import org.jenkinsci.plugins.scriptsecurity.scripts.ScriptApproval
              import java.util.logging.Logger
          
              def logger = Logger.getLogger("jenkins.security.pipeline-sandbox")
          
              def approval = ScriptApproval.get()
              def pendingCount = approval.getPendingScripts().size()
          
              if (pendingCount > 0) {
                logger.warning("[HTH] $${pendingCount} pending script approvals detected - review required")
              }
          
              logger.info("[HTH] Pipeline sandbox enforcement verified")
              println("[HTH] Pipeline sandbox is active - scripts run in restricted mode")
            GROOVY
          
            file_permission = "0644"
            }

"4.4":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-4.04-secure-jenkinsfile.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-4.04-secure-jenkinsfile.tf"
    excerpts:
      terraform:
        content: |
            # Secure pipeline template job (L2+)
            resource "jenkins_job" "secure_pipeline_template" {
            count = var.profile_level >= 2 && var.create_secure_pipeline_template ? 1 : 0
          
            name   = "hth-secure-pipeline-template"
            folder = length(var.team_folders) > 0 ? jenkins_folder.team_folder[keys(var.team_folders)[0]].id : null
          
            template = templatefile("${path.module}/templates/secure-pipeline-config.xml", {
              agent_label    = var.secure_pipeline_agent_label
              timeout_hours  = var.build_timeout_hours
              builds_to_keep = var.builds_to_keep
            })
            }
          
            # Generate the secure pipeline config.xml template
            resource "local_file" "secure_pipeline_config_xml" {
            count = var.profile_level >= 2 && var.create_secure_pipeline_template ? 1 : 0
          
            filename = "${path.module}/templates/secure-pipeline-config.xml"
            content  = <<-XML
              <flow-definition plugin="workflow-job">
                <description>HTH Secure Pipeline Template - demonstrates hardened Jenkinsfile practices</description>
                <keepDependencies>false</keepDependencies>
                <properties>
                  <org.jenkinsci.plugins.workflow.job.properties.DisableConcurrentBuildsJobProperty/>
                  <jenkins.model.BuildDiscarderProperty>
                    <strategy class="hudson.tasks.LogRotator">
                      <numToKeep>${var.builds_to_keep}</numToKeep>
                    </strategy>
                  </jenkins.model.BuildDiscarderProperty>
                </properties>
                <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps">
                  <script>
              pipeline {
                  agent {
                      label '${var.secure_pipeline_agent_label}'
                  }
                  options {
                      timeout(time: ${var.build_timeout_hours}, unit: 'HOURS')
                      buildDiscarder(logRotator(numToKeepStr: '${var.builds_to_keep}'))
                      disableConcurrentBuilds()
                  }
                  stages {
                      stage('Build') {
                          steps {
                              sh 'echo "Build stage - replace with actual build commands"'
                          }
                      }
                      stage('Test') {
                          steps {
                              sh 'echo "Test stage - replace with actual test commands"'
                          }
                      }
                      stage('Deploy') {
                          when {
                              branch 'main'
                          }
                          steps {
                              withCredentials([usernamePassword(
                                  credentialsId: 'deploy-creds',
                                  usernameVariable: 'USER',
                                  passwordVariable: 'PASS'
                              )]) {
                                  sh 'echo "Deploy stage - replace with actual deploy commands"'
                              }
                          }
                      }
                  }
                  post {
                      always {
                          cleanWs()
                      }
                  }
              }
                  </script>
                  <sandbox>true</sandbox>
                </definition>
                <triggers/>
                <disabled>true</disabled>
              </flow-definition>
            XML
          
            file_permission = "0644"
            }

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-5.01-enable-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-5.01-enable-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration for audit trail logging
            resource "local_file" "audit_logging" {
            filename = "${path.module}/generated/casc-audit-logging.yaml"
            content  = yamlencode({
              unclassified = {
                audit-trail = {
                  logBuildCause = true
                  pattern       = ".*/(?:configSubmit|doDelete|postBuildResult|enable|disable|cancelQueue|stop|toggleLogKeep|doWipeOutWorkspace|createItem|createView|toggleOffline|cancelQuietDown|quietDown|restart|exit|safeExit).*"
                  loggers = concat(
                    [
                      {
                        file = {
                          log     = var.audit_log_path
                          limit   = var.audit_log_size_mb
                          count   = var.audit_log_rotate_count
                        }
                      }
                    ],
                    var.syslog_server != "" ? [
                      {
                        syslog = {
                          syslogServerHostname = var.syslog_server
                          syslogServerPort     = var.syslog_port
                          facility             = "LOCAL0"
                          messageHostname      = "jenkins"
                        }
                      }
                    ] : []
                  )
                }
              }
            })
          
            file_permission = "0644"
            }
          
            # Security monitoring view for audit visibility
            resource "jenkins_view" "security_monitoring" {
            count = var.create_security_views ? 1 : 0
          
            name              = "Security-Monitoring"
            assigned_projects = var.monitored_projects
            }

"5.2":
  terraform:
    lang: "hcl"
    filename: "hth-jenkins-5.02-keep-jenkins-updated.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/jenkins/terraform/hth-jenkins-5.02-keep-jenkins-updated.tf"
    excerpts:
      terraform:
        content: |
            # JCasC configuration for update center settings
            resource "local_file" "update_center_config" {
            filename = "${path.module}/generated/casc-update-center.yaml"
            content  = yamlencode({
              jenkins = {
                updateCenter = {
                  sites = [
                    {
                      id  = "default"
                      url = "https://updates.jenkins.io/update-center.json"
                    }
                  ]
                }
              }
            })
          
            file_permission = "0644"
            }
          
            # Groovy init script to check for security updates on startup
            resource "local_file" "check_updates_groovy" {
            filename = "${path.module}/generated/init.groovy.d/check-security-updates.groovy"
            content  = <<-GROOVY
              // HTH Jenkins Control 5.2: Keep Jenkins Updated
              // Profile Level: L1 (Baseline)
              import jenkins.model.Jenkins
              import java.util.logging.Logger
          
              def logger = Logger.getLogger("jenkins.security.update-check")
          
              def instance = Jenkins.instance
              def updateCenter = instance.getUpdateCenter()
          
              // Log current Jenkins version
              logger.info("[HTH] Jenkins version: $${Jenkins.VERSION}")
          
              // Check for core updates
              updateCenter.getSites().each { site ->
                def updates = site.getUpdates()
                if (updates != null && updates.size() > 0) {
                  logger.warning("[HTH] $${updates.size()} plugin updates available")
                  updates.each { update ->
                    if (update.hasWarnings()) {
                      logger.severe("[HTH] SECURITY UPDATE: $${update.name} $${update.version}")
                    }
                  }
                }
              }
          
              println("[HTH] Security update check completed")
            GROOVY
          
            file_permission = "0644"
            }

