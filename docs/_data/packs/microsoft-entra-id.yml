# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-18T20:47:34Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-1.01-enforce-phishing-resistant-mfa.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-1.01-enforce-phishing-resistant-mfa.tf"
    excerpts:
      terraform:
        content: |
            # Configure authentication methods policy with phishing-resistant MFA
            resource "azuread_authentication_methods_policy" "main" {
            display_name = "Default Authentication Methods Policy"
          
            # Enable FIDO2 security keys for all users
            fido2 {
              state              = "enabled"
              allowed_aaguids    = var.fido2_allowed_aaguids
              self_service_registration_enabled = true
              key_restrictions {
                enforcement_type = length(var.fido2_allowed_aaguids) > 0 ? "allow" : "block"
                aaguids          = var.fido2_allowed_aaguids
              }
            }
          
            # Enable Microsoft Authenticator with number matching and app context
            microsoft_authenticator {
              state = "enabled"
              feature_settings {
                display_app_information_required_state {
                  state = "enabled"
                }
                number_matching_required_state {
                  state = "enabled"
                }
                display_location_information_required_state {
                  state = "enabled"
                }
              }
            }
          
            # Disable SMS authentication (vulnerable to SIM swapping)
            sms {
              state = var.disable_sms_authentication ? "disabled" : "enabled"
            }
            }
          
            # Authentication strength policy for phishing-resistant methods
            resource "azuread_authentication_strength_policy" "phishing_resistant" {
            display_name = "HTH Phishing-Resistant MFA"
            description  = "Requires FIDO2, Windows Hello, or certificate-based authentication"
          
            allowed_combinations = [
              "fido2",
              "windowsHelloForBusiness",
              "x509CertificateMultiFactor",
            ]
            }

"1.2":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-1.02-configure-emergency-access-accounts.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-1.02-configure-emergency-access-accounts.tf"
    excerpts:
      terraform:
        content: |
            # Create emergency access (break-glass) accounts
            resource "azuread_user" "emergency_admin" {
            count = var.emergency_account_count
          
            user_principal_name = "${var.emergency_account_upn_prefix}-${format("%02d", count.index + 1)}@${var.domain_name}"
            display_name        = "Emergency Admin ${format("%02d", count.index + 1)}"
            mail_nickname       = "${var.emergency_account_upn_prefix}-${format("%02d", count.index + 1)}"
            account_enabled     = true
          
            # Password is managed outside Terraform -- generate a 64+ character
            # random password and store it in a physically secure location (safe/vault).
            # Terraform manages the account lifecycle, not the credential.
            password                    = random_password.emergency[count.index].result
            force_password_change       = false
            disable_password_expiration = true
            disable_strong_password     = false
          
            lifecycle {
              ignore_changes = [password]
            }
            }
          
            # Generate initial passwords for emergency accounts
            resource "random_password" "emergency" {
            count = var.emergency_account_count
          
            length           = 64
            special          = true
            override_special = "!@#$%&*()-_=+[]{}|;:,.<>?"
            }
          
            # Look up the Global Administrator role
            data "azuread_directory_role" "global_admin" {
            display_name = "Global Administrator"
            }
          
            # Assign Global Administrator role to emergency accounts
            resource "azuread_directory_role_assignment" "emergency_global_admin" {
            count = var.emergency_account_count
          
            role_id             = data.azuread_directory_role.global_admin.template_id
            principal_object_id = azuread_user.emergency_admin[count.index].object_id
            }
          
            # Create a group for emergency accounts (used for Conditional Access exclusions)
            resource "azuread_group" "emergency_access" {
            display_name     = "HTH Emergency Access Accounts"
            description      = "Break-glass accounts excluded from Conditional Access policies"
            security_enabled = true
            mail_enabled     = false
          
            members = azuread_user.emergency_admin[*].object_id
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-2.01-block-legacy-authentication.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-2.01-block-legacy-authentication.tf"
    excerpts:
      terraform:
        content: |
            # Conditional Access policy to block legacy authentication protocols
            # (Basic Auth, POP, IMAP, SMTP AUTH) that cannot enforce MFA
            resource "azuread_conditional_access_policy" "block_legacy_auth" {
            display_name = "HTH: Block legacy authentication"
            state        = var.legacy_auth_policy_state
          
            conditions {
              users {
                included_users = ["All"]
                excluded_groups = [azuread_group.emergency_access.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              client_app_types = ["exchangeActiveSync", "other"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["block"]
            }
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-2.02-require-mfa-for-all-users.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-2.02-require-mfa-for-all-users.tf"
    excerpts:
      terraform:
        content: |
            # Conditional Access policy requiring MFA for all interactive sign-ins
            resource "azuread_conditional_access_policy" "require_mfa_all_users" {
            display_name = "HTH: Require MFA for all users"
            state        = var.mfa_policy_state
          
            conditions {
              users {
                included_users  = ["All"]
                excluded_groups = [azuread_group.emergency_access.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              client_app_types = ["browser", "mobileAppsAndDesktopClients"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["mfa"]
            }
            }

"2.3":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-2.03-require-compliant-devices-for-admins.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-2.03-require-compliant-devices-for-admins.tf"
    excerpts:
      terraform:
        content: |
            # Conditional Access policy requiring compliant or Hybrid Azure AD joined
            # devices for all privileged admin access to Microsoft admin portals
            resource "azuread_conditional_access_policy" "require_compliant_device_admins" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Require compliant device for admins"
            state        = "enabled"
          
            conditions {
              users {
                included_roles  = length(var.admin_role_ids) > 0 ? var.admin_role_ids : [
                  # Default: target common privileged roles
                  data.azuread_directory_role.global_admin.template_id,
                ]
                excluded_groups = [azuread_group.emergency_access.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              client_app_types = ["browser", "mobileAppsAndDesktopClients"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["compliantDevice", "domainJoinedDevice"]
            }
            }

"2.4":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-2.04-block-high-risk-sign-ins.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-2.04-block-high-risk-sign-ins.tf"
    excerpts:
      terraform:
        content: |
            # Conditional Access policy to block high-risk sign-ins using
            # Entra ID Protection machine learning detection (requires P2 license)
            resource "azuread_conditional_access_policy" "block_high_risk_signins" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Block high-risk sign-ins"
            state        = var.high_risk_policy_state
          
            conditions {
              users {
                included_users  = ["All"]
                excluded_groups = [azuread_group.emergency_access.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              client_app_types = ["browser", "mobileAppsAndDesktopClients"]
          
              sign_in_risk_levels = ["high"]
            }
          
            grant_controls {
              operator          = "OR"
              built_in_controls = ["block"]
            }
            }
          
            # Conditional Access policy requiring MFA + password change for medium-risk sign-ins
            resource "azuread_conditional_access_policy" "remediate_medium_risk_signins" {
            count = var.profile_level >= 2 ? 1 : 0
          
            display_name = "HTH: Require MFA for medium-risk sign-ins"
            state        = var.high_risk_policy_state
          
            conditions {
              users {
                included_users  = ["All"]
                excluded_groups = [azuread_group.emergency_access.object_id]
              }
          
              applications {
                included_applications = ["All"]
              }
          
              client_app_types = ["browser", "mobileAppsAndDesktopClients"]
          
              sign_in_risk_levels = ["medium"]
            }
          
            grant_controls {
              operator          = "AND"
              built_in_controls = ["mfa", "passwordChange"]
            }
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-3.01-enable-just-in-time-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-3.01-enable-just-in-time-access.tf"
    excerpts:
      terraform:
        content: |
            # Create PIM eligible assignments for Global Administrator role.
            # Eliminates standing admin privileges by requiring just-in-time activation
            # with MFA, justification, and optional approval.
            #
            # NOTE: Full PIM role settings (activation duration, approval workflow,
            # MFA on activation) require Microsoft Graph API or the admin center.
            # Terraform manages eligible assignments; configure role settings via
            # the Entra admin center or PowerShell.
            resource "azuread_directory_role_eligibility_schedule_request" "pim_global_admin" {
            count = var.profile_level >= 2 ? length(var.pim_eligible_user_ids) : 0
          
            role_definition_id = data.azuread_directory_role.global_admin.template_id
            principal_id       = var.pim_eligible_user_ids[count.index]
            directory_scope_id = "/"
            justification      = "HTH: PIM eligible assignment for Just-In-Time access"
          
            schedule_info {
              expiration {
                duration = "P${var.pim_eligibility_duration_days}D"
                type     = "afterDuration"
              }
            }
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-3.02-configure-access-reviews.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-3.02-configure-access-reviews.tf"
    excerpts:
      terraform:
        content: |
            # Recurring access review for the Global Administrator role.
            # Ensures continued business need for privileged access by requiring
            # periodic reviewer attestation. Non-attested access is auto-removed.
            #
            # NOTE: The azuread provider has limited access review support.
            # This resource uses the azuread_access_review_schedule_definition
            # if available, otherwise configure via admin center or Graph API.
          
            # Access review for Global Administrator eligible assignments
            resource "azuread_privileged_access_group_assignment_schedule_request" "access_review_placeholder" {
            count = var.profile_level >= 2 && length(var.access_review_reviewer_ids) > 0 ? 0 : 0
          
            # Placeholder: Terraform azuread provider does not natively support
            # access review schedule definitions. Use one of these alternatives:
            #
            # Option 1: Microsoft Graph API (recommended)
            #   POST https://graph.microsoft.com/v1.0/identityGovernance/accessReviews/definitions
            #   {
            #     "displayName": "HTH: Global Admin Access Review",
            #     "scope": {
            #       "query": "/roleManagement/directory/roleAssignmentScheduleInstances?$filter=(roleDefinitionId eq '<global-admin-role-id>')",
            #       "queryType": "MicrosoftGraph"
            #     },
            #     "reviewers": [{ "query": "/users/<reviewer-id>", "queryType": "MicrosoftGraph" }],
            #     "settings": {
            #       "mailNotificationsEnabled": true,
            #       "reminderNotificationsEnabled": true,
            #       "justificationRequiredOnApproval": true,
            #       "defaultDecisionEnabled": true,
            #       "defaultDecision": "Deny",
            #       "autoApplyDecisionsEnabled": true,
            #       "recurrence": {
            #         "pattern": { "type": "absoluteMonthly", "interval": 3 },
            #         "range": { "type": "noEnd" }
            #       }
            #     }
            #   }
            #
            # Option 2: PowerShell (see guide Section 3.2)
            #
            # Option 3: Entra admin center
            #   Identity governance > Access reviews > + New access review
          
            group_id        = ""
            principal_id    = ""
            assignment_type = "member"
            justification   = "placeholder"
            }
          
            # Output a reminder for manual configuration
            locals {
            access_review_config = var.profile_level >= 2 ? {
              status              = "MANUAL_CONFIGURATION_REQUIRED"
              target_role         = "Global Administrator"
              review_frequency    = var.access_review_frequency
              reviewer_ids        = var.access_review_reviewer_ids
              auto_remove_denied  = true
              instructions        = "Configure via Entra admin center: Identity governance > Access reviews"
            } : null
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-4.01-restrict-user-consent-to-applications.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-4.01-restrict-user-consent-to-applications.tf"
    excerpts:
      terraform:
        content: |
            # Disable user consent to third-party applications.
            # Prevents OAuth consent phishing by requiring admin approval for
            # all new application access requests.
            resource "azuread_authorization_policy" "consent_policy" {
            display_name = "Authorization Policy"
          
            # Disable user consent -- users cannot grant OAuth permissions
            default_user_role_permissions {
              allowed_to_create_apps             = false
              allowed_to_create_security_groups  = true
              allowed_to_create_tenants          = false
              allowed_to_read_bitlocker_keys_for_owned_device = true
              allowed_to_read_other_users        = true
          
              # Empty list = no user consent policies assigned = user consent disabled
              permission_grant_policies_assigned = []
            }
            }
          
            # Configure admin consent workflow so users can request access
            # and designated reviewers approve or deny.
            #
            # NOTE: The admin consent workflow configuration requires Microsoft Graph API
            # or the Entra admin center. Terraform manages the authorization policy;
            # configure the consent workflow reviewers via:
            #   Applications > Enterprise applications > Consent and permissions > Admin consent settings
            #
            # Graph API equivalent:
            #   PATCH https://graph.microsoft.com/v1.0/policies/adminConsentRequestPolicy
            #   {
            #     "isEnabled": true,
            #     "notifyReviewers": true,
            #     "remindersEnabled": true,
            #     "requestDurationInDays": 30,
            #     "reviewers": [
            #       { "query": "/users/<reviewer-id>", "queryType": "MicrosoftGraph" }
            #     ]
            #   }
            locals {
            admin_consent_workflow = {
              enabled              = true
              reviewer_ids         = var.admin_consent_reviewer_ids
              request_duration     = 30
              notify_reviewers     = true
              reminders_enabled    = true
              manual_configuration = "Configure reviewers via Entra admin center: Applications > Enterprise applications > Consent and permissions"
            }
            }

"4.2":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-4.02-review-and-restrict-application-permissions.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-4.02-review-and-restrict-application-permissions.tf"
    excerpts:
      terraform:
        content: |
            # Data source to enumerate all service principals (enterprise applications)
            # for permission auditing. Use this to identify apps with dangerous permissions
            # such as Mail.ReadWrite, Directory.ReadWrite.All, full_access_as_app.
            #
            # NOTE: Terraform is not the ideal tool for ongoing permission auditing.
            # This control provides data sources for initial discovery; recurring
            # audits should use PowerShell scripts or SSPM tooling.
          
            # Retrieve all service principals for audit
            data "azuread_service_principals" "all_apps" {
            count = var.profile_level >= 2 ? 1 : 0
          
            return_all = true
            }
          
            # Identify high-risk Microsoft Graph permissions for audit output
            locals {
            high_risk_permissions = var.profile_level >= 2 ? [
              "Mail.ReadWrite",
              "Mail.ReadWrite.All",
              "Files.ReadWrite.All",
              "Directory.ReadWrite.All",
              "Application.ReadWrite.All",
              "RoleManagement.ReadWrite.Directory",
              "full_access_as_app",
            ] : []
          
            app_permission_audit = var.profile_level >= 2 ? {
              status                = "AUDIT_DATA_AVAILABLE"
              total_service_principals = length(try(data.azuread_service_principals.all_apps[0].service_principals, []))
              high_risk_permissions = local.high_risk_permissions
              instructions          = "Review each app's API permissions in Entra admin center: Applications > App registrations > [App] > API permissions"
              remediation           = "Remove unnecessary permissions or delete unused applications"
            } : null
            }

"5.1":
  terraform:
    lang: "hcl"
    filename: "hth-microsoft-entra-id-5.01-enable-sign-in-and-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/microsoft-entra-id/terraform/hth-microsoft-entra-id-5.01-enable-sign-in-and-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # Configure diagnostic settings to export Entra ID sign-in and audit logs.
            #
            # NOTE: Diagnostic settings for Entra ID require the Azure Monitor provider
            # (azurerm), not the AzureAD provider. This control documents the configuration
            # and provides a reference implementation. If you are also managing Azure
            # resources, add the azurerm provider to providers.tf and uncomment below.
            #
            # Uncomment and configure when using the azurerm provider:
            #
            # resource "azurerm_monitor_aad_diagnostic_setting" "entra_id_logs" {
            #   name                       = "hth-entra-id-logging"
            #   log_analytics_workspace_id = var.log_analytics_workspace_id
            #
            #   enabled_log {
            #     category = "SignInLogs"
            #     retention_policy {
            #       enabled = true
            #       days    = 90
            #     }
            #   }
            #
            #   enabled_log {
            #     category = "AuditLogs"
            #     retention_policy {
            #       enabled = true
            #       days    = 90
            #     }
            #   }
            #
            #   enabled_log {
            #     category = "NonInteractiveUserSignInLogs"
            #     retention_policy {
            #       enabled = true
            #       days    = 90
            #     }
            #   }
            #
            #   enabled_log {
            #     category = "ServicePrincipalSignInLogs"
            #     retention_policy {
            #       enabled = true
            #       days    = 90
            #     }
            #   }
            #
            #   enabled_log {
            #     category = "ManagedIdentitySignInLogs"
            #     retention_policy {
            #       enabled = true
            #       days    = 90
            #     }
            #   }
            #
            #   enabled_log {
            #     category = "RiskyUsers"
            #     retention_policy {
            #       enabled = true
            #       days    = 90
            #     }
            #   }
            #
            #   enabled_log {
            #     category = "UserRiskEvents"
            #     retention_policy {
            #       enabled = true
            #       days    = 90
            #     }
            #   }
            # }
          
            locals {
            logging_config = {
              status                   = var.log_analytics_workspace_id != "" ? "REQUIRES_AZURERM_PROVIDER" : "NOT_CONFIGURED"
              workspace_id             = var.log_analytics_workspace_id
              recommended_log_categories = [
                "SignInLogs",
                "AuditLogs",
                "NonInteractiveUserSignInLogs",
                "ServicePrincipalSignInLogs",
                "ManagedIdentitySignInLogs",
                "RiskyUsers",
                "UserRiskEvents",
              ]
              recommended_retention_days = 90
              instructions = var.log_analytics_workspace_id != "" ? "Add azurerm provider and uncomment the diagnostic setting resource" : "Set log_analytics_workspace_id variable and add azurerm provider"
              alert_rules = [
                "Global Admin role assignment",
                "Conditional Access policy changes",
                "New OAuth app registration",
                "Risky sign-in detected",
                "Emergency account sign-in",
              ]
            }
            }

