# AUTO-GENERATED by scripts/sync-packs-to-data.sh â€” do not edit manually
# Generated: 2026-02-19T19:39:51Z

"1.1":
  terraform:
    lang: "hcl"
    filename: "hth-pagerduty-1.01-configure-saml-sso.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/pagerduty/terraform/hth-pagerduty-1.01-configure-saml-sso.tf"
    excerpts:
      terraform:
        content: |
            # Look up the current PagerDuty account for SSO configuration reference
            data "pagerduty_user" "account_owner" {
            email = data.pagerduty_user_contact_method.owner_lookup.email
            }
          
            # Note: PagerDuty SSO/SAML configuration is not natively supported as a
            # Terraform resource. The provider does not expose a pagerduty_sso or
            # pagerduty_saml resource. SSO must be configured via the PagerDuty UI
            # or REST API.
            #
            # This file uses a null_resource with a local-exec provisioner to call the
            # PagerDuty REST API for SSO configuration when IdP details are provided.
          
            resource "null_resource" "configure_saml_sso" {
            count = var.sso_login_url != "" && var.sso_certificate != "" ? 1 : 0
          
            triggers = {
              sso_login_url  = var.sso_login_url
              sso_certificate = sha256(var.sso_certificate)
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                curl -s -X PUT \
                  "https://api.pagerduty.com/users/me" \
                  -H "Authorization: Token token=${var.pagerduty_api_token}" \
                  -H "Content-Type: application/json" \
                  -H "Accept: application/vnd.pagerduty+json;version=2" \
                  -d '{}' > /dev/null
          
                echo "[HTH] SAML SSO configuration must be completed via the PagerDuty UI."
                echo "[HTH] IdP SSO URL: ${var.sso_login_url}"
                echo "[HTH] Certificate fingerprint: $(echo '${var.sso_certificate}' | sha256sum | cut -d' ' -f1)"
                echo "[HTH] Steps:"
                echo "[HTH]   1. Navigate to Account Settings > Single Sign-On"
                echo "[HTH]   2. Enter the IdP SSO URL provided above"
                echo "[HTH]   3. Upload the IdP certificate"
                echo "[HTH]   4. Test and enable SSO"
              EOT
            }
            }

"1.3":
  terraform:
    lang: "hcl"
    filename: "hth-pagerduty-1.03-configure-account-owner-fallback.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/pagerduty/terraform/hth-pagerduty-1.03-configure-account-owner-fallback.tf"
    excerpts:
      terraform:
        content: |
            # The Account Owner always retains email/password login even when SSO is
            # enabled. This cannot be disabled. This control ensures the Account Owner
            # credentials are protected and the recovery procedure is documented.
          
            resource "null_resource" "account_owner_fallback" {
            triggers = {
              always_run = timestamp()
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "[HTH] Account Owner Fallback Access Check:"
                echo "[HTH]"
          
                # Identify the account owner
                OWNER=$(curl -s \
                  "https://api.pagerduty.com/users?include[]=roles" \
                  -H "Authorization: Token token=${var.pagerduty_api_token}" \
                  -H "Content-Type: application/json" \
                  -H "Accept: application/vnd.pagerduty+json;version=2" \
                  | jq -r '[.users[] | select(.role == "owner")] | .[0] | "\(.name) <\(.email)>"')
          
                echo "[HTH]   Account Owner: $OWNER"
                echo "[HTH]"
                echo "[HTH]   Security Requirements:"
                echo "[HTH]     - Use strong password (20+ characters)"
                echo "[HTH]     - Store credentials in enterprise password vault"
                echo "[HTH]     - Account Owner can log in during SSO outage"
                echo "[HTH]     - Account Owner can temporarily enable password login for all users"
                echo "[HTH]"
                echo "[HTH]   Document your recovery procedure and store it securely."
              EOT
            }
            }

"2.1":
  terraform:
    lang: "hcl"
    filename: "hth-pagerduty-2.01-configure-user-provisioning.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/pagerduty/terraform/hth-pagerduty-2.01-configure-user-provisioning.tf"
    excerpts:
      terraform:
        content: |
            # Note: On-demand SAML provisioning is automatic when SSO is enabled.
            # Users are created on first SSO login with attributes from the IdP.
            #
            # This file provides a validation check to confirm provisioning is active
            # by verifying the account has SSO-provisioned users.
          
            data "pagerduty_user" "provisioning_check" {
            email = "check@example.com"
          
            # This data source will fail if the user does not exist.
            # It serves as a pattern for validating provisioned users.
            # Replace with an actual SSO-provisioned user email for verification.
            count = 0
            }
          
            # Output a reminder about SAML attribute mapping
            resource "null_resource" "provisioning_reminder" {
            triggers = {
              always_run = timestamp()
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "[HTH] User Provisioning Configuration Reminder:"
                echo "[HTH]   - With SSO enabled, users are created on first login"
                echo "[HTH]   - Configure IdP to send: email, name, role attributes"
                echo "[HTH]   - IMPORTANT: SAML attributes are only used at initial creation"
                echo "[HTH]   - Changes in IdP do NOT automatically sync to PagerDuty"
                echo "[HTH]   - For ongoing sync, enable SCIM provisioning (Control 2.2, L2)"
              EOT
            }
            }

"2.2":
  terraform:
    lang: "hcl"
    filename: "hth-pagerduty-2.02-configure-scim-provisioning.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/pagerduty/terraform/hth-pagerduty-2.02-configure-scim-provisioning.tf"
    excerpts:
      terraform:
        content: |
            # Note: PagerDuty SCIM provisioning is configured via the PagerDuty UI
            # (Account Settings > SCIM). The Terraform provider does not expose a
            # native SCIM configuration resource.
            #
            # This file validates SCIM readiness and outputs configuration guidance
            # when profile_level >= 2.
          
            resource "null_resource" "configure_scim" {
            count = var.profile_level >= 2 ? 1 : 0
          
            triggers = {
              profile_level = var.profile_level
              scim_token    = sha256(var.scim_token)
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "[HTH] SCIM Provisioning Configuration (L2):"
                echo "[HTH]   1. Navigate to Account Settings > SCIM"
                echo "[HTH]   2. Generate SCIM API token"
                echo "[HTH]   3. Copy SCIM base URL: https://app.pagerduty.com/scim/v2"
                echo "[HTH]   4. Configure IdP SCIM integration with:"
                echo "[HTH]      - Base URL: https://app.pagerduty.com/scim/v2"
                echo "[HTH]      - Bearer Token: (generated in step 2)"
                echo "[HTH]   5. Enable user deprovisioning in IdP"
                echo "[HTH]   6. Test: create user in IdP, verify appears in PagerDuty"
                echo "[HTH]   7. Test: remove user in IdP, verify deprovisioned in PagerDuty"
                if [ -n "${var.scim_token}" ]; then
                  echo "[HTH] SCIM token provided -- validating connectivity..."
                  STATUS=$(curl -s -o /dev/null -w "%%{http_code}" \
                    "https://app.pagerduty.com/scim/v2/Users?count=1" \
                    -H "Authorization: Bearer ${var.scim_token}" \
                    -H "Content-Type: application/scim+json")
                  if [ "$STATUS" = "200" ]; then
                    echo "[HTH] SCIM endpoint reachable (HTTP 200)"
                  else
                    echo "[HTH] WARNING: SCIM endpoint returned HTTP $STATUS"
                  fi
                else
                  echo "[HTH] No SCIM token provided -- skipping connectivity check"
                fi
              EOT
            }
            }

"3.1":
  terraform:
    lang: "hcl"
    filename: "hth-pagerduty-3.01-configure-role-based-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/pagerduty/terraform/hth-pagerduty-3.01-configure-role-based-access.tf"
    excerpts:
      terraform:
        content: |
            # Create teams for RBAC structure
            # Teams enable granular access control and on-call management
            resource "pagerduty_team" "teams" {
            for_each = { for idx, team in var.team_definitions : team.name => team }
          
            name        = each.value.name
            description = each.value.description
            }
          
            # Assign observer role to designated users (Business/Enterprise plans)
            # Observer = read_only_user in PagerDuty API terminology
            resource "pagerduty_user" "observer_role" {
            for_each = var.profile_level >= 2 ? toset(var.observer_user_ids) : toset([])
          
            # Note: pagerduty_user requires creating or importing users.
            # To change an existing user's role, use a data source + API call.
            # This resource pattern is for documentation; use the API script
            # or ClickOps to modify existing user roles.
            name  = "observer-placeholder-${each.key}"
            email = "observer-${each.key}@placeholder.local"
            role  = "read_only_user"
          
            lifecycle {
              ignore_changes = [name, email]
            }
            }

"3.2":
  terraform:
    lang: "hcl"
    filename: "hth-pagerduty-3.02-limit-admin-access.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/pagerduty/terraform/hth-pagerduty-3.02-limit-admin-access.tf"
    excerpts:
      terraform:
        content: |
            # Validate that admin count does not exceed the configured maximum.
            # PagerDuty best practice: limit admins to 2-3 users.
          
            # Fetch all users to audit admin count
            data "pagerduty_users" "all" {}
          
            # Check: fail the plan if too many admin user IDs are provided
            resource "null_resource" "admin_count_check" {
            count = length(var.admin_user_ids) > var.max_admin_count ? 1 : 0
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "[HTH] WARNING: ${length(var.admin_user_ids)} admin user IDs provided."
                echo "[HTH] Maximum recommended: ${var.max_admin_count}"
                echo "[HTH] Review and reduce admin assignments to meet least privilege."
                exit 1
              EOT
            }
            }
          
            # Audit current admin users via API
            resource "null_resource" "audit_admins" {
            triggers = {
              always_run = timestamp()
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "[HTH] Auditing PagerDuty admin users..."
                ADMINS=$(curl -s \
                  "https://api.pagerduty.com/users?include[]=roles" \
                  -H "Authorization: Token token=${var.pagerduty_api_token}" \
                  -H "Content-Type: application/json" \
                  -H "Accept: application/vnd.pagerduty+json;version=2" \
                  | jq '[.users[] | select(.role == "admin" or .role == "owner")] | length')
                echo "[HTH] Current admin/owner count: $ADMINS"
                echo "[HTH] Maximum recommended: ${var.max_admin_count}"
                if [ "$ADMINS" -gt "${var.max_admin_count}" ]; then
                  echo "[HTH] FINDING: Admin count exceeds recommended maximum."
                  echo "[HTH] ACTION: Demote non-essential admins to Manager or Responder role."
                else
                  echo "[HTH] PASS: Admin count within acceptable range."
                fi
              EOT
            }
            }

"4.1":
  terraform:
    lang: "hcl"
    filename: "hth-pagerduty-4.01-configure-audit-logging.tf"
    source_url: "https://github.com/grcengineering/how-to-harden/blob/main/packs/pagerduty/terraform/hth-pagerduty-4.01-configure-audit-logging.tf"
    excerpts:
      terraform:
        content: |
            # PagerDuty audit records are available at Account Settings > Audit Records.
            # This control configures a webhook extension to forward audit-relevant
            # events to a SIEM for centralized monitoring and retention.
          
            # Create a generic "audit" service to receive webhook events
            resource "pagerduty_service" "audit_logging" {
            count = var.audit_log_webhook_url != "" ? 1 : 0
          
            name                    = "HTH Audit Log Collector"
            description             = "Service for collecting and forwarding audit events to SIEM"
            auto_resolve_timeout    = "null"
            acknowledgement_timeout = "null"
          
            escalation_policy = pagerduty_escalation_policy.audit_logging[0].id
          
            alert_creation = "create_alerts_and_incidents"
          
            incident_urgency_rule {
              type    = "constant"
              urgency = "low"
            }
            }
          
            # Minimal escalation policy for the audit service
            resource "pagerduty_escalation_policy" "audit_logging" {
            count = var.audit_log_webhook_url != "" ? 1 : 0
          
            name      = "HTH Audit Log Escalation"
            num_loops = 0
          
            rule {
              escalation_delay_in_minutes = 30
          
              target {
                type = "user_reference"
                id   = data.pagerduty_users.all.users[0].id
              }
            }
            }
          
            # Webhook extension to forward events to SIEM
            resource "pagerduty_extension" "audit_webhook" {
            count = var.audit_log_webhook_url != "" ? 1 : 0
          
            name               = var.audit_webhook_name
            type               = "generic_v2_webhook_inbound_integration"
            endpoint_url       = var.audit_log_webhook_url
            extension_schema   = data.pagerduty_extension_schema.webhook[0].id
            extension_objects  = [pagerduty_service.audit_logging[0].id]
            }
          
            data "pagerduty_extension_schema" "webhook" {
            count = var.audit_log_webhook_url != "" ? 1 : 0
            name  = "Generic V2 Webhook"
            }
          
            # Audit log export reminder
            resource "null_resource" "audit_log_guidance" {
            triggers = {
              always_run = timestamp()
            }
          
            provisioner "local-exec" {
              command = <<-EOT
                echo "[HTH] Audit Logging Configuration:"
                echo "[HTH]   - PagerDuty audit records: Account Settings > Audit Records"
                echo "[HTH]   - API endpoint: GET https://api.pagerduty.com/audit/records"
                echo "[HTH]   - Retention: PagerDuty retains audit records per plan limits"
                echo "[HTH]   - Export: Use API to pull records into SIEM for long-term retention"
                echo "[HTH]"
                echo "[HTH] Verification:"
                RECORD_COUNT=$(curl -s \
                  "https://api.pagerduty.com/audit/records?limit=1" \
                  -H "Authorization: Token token=${var.pagerduty_api_token}" \
                  -H "Content-Type: application/json" \
                  -H "Accept: application/vnd.pagerduty+json;version=2" \
                  | jq '.records | length // 0')
                echo "[HTH]   Audit records accessible: $([ "$RECORD_COUNT" -ge 0 ] && echo 'YES' || echo 'NO')"
              EOT
            }
            }

