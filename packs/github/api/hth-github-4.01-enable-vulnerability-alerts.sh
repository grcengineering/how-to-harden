#!/usr/bin/env bash
# HTH GitHub Control 4.01: Enable Vulnerability Alerts on All Repositories
# Profile: L1 | NIST: RA-5, SI-5
# https://howtoharden.com/guides/github/#41-enable-vulnerability-alerts
source "$(dirname "$0")/common.sh"

banner "4.01: Enable Vulnerability Alerts"
should_apply 1 || { increment_skipped; summary; exit 0; }

REPO="${GITHUB_REPO:-how-to-harden}"
info "4.01 Checking vulnerability alerts on ${GITHUB_ORG}/${REPO}..."

# Idempotency check -- GET vulnerability-alerts returns 204 if enabled, 404 if disabled
# HTH Guide Excerpt: begin api-check-vulnerability-alerts
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X GET \
  "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
  -H "${AUTH_HEADER}" \
  -H "Accept: application/vnd.github+json" \
  -H "X-GitHub-Api-Version: 2022-11-28")
# HTH Guide Excerpt: end api-check-vulnerability-alerts

if [ "${HTTP_CODE}" = "204" ]; then
  pass "4.01 Vulnerability alerts are already enabled"
  increment_applied
  summary
  exit 0
fi

warn "4.01 Vulnerability alerts are not enabled (HTTP ${HTTP_CODE})"

# HTH Guide Excerpt: begin api-enable-vulnerability-alerts
# Enable Dependabot vulnerability alerts on the repository
info "4.01 Enabling vulnerability alerts..."
ENABLE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
  "${GH_API}/repos/${GITHUB_ORG}/${REPO}/vulnerability-alerts" \
  -H "${AUTH_HEADER}" \
  -H "Accept: application/vnd.github+json" \
  -H "X-GitHub-Api-Version: 2022-11-28")
# HTH Guide Excerpt: end api-enable-vulnerability-alerts

if [ "${ENABLE_CODE}" = "204" ]; then
  pass "4.01 Vulnerability alerts enabled"
  increment_applied
else
  fail "4.01 Failed to enable vulnerability alerts (HTTP ${ENABLE_CODE})"
  increment_failed
fi

summary
