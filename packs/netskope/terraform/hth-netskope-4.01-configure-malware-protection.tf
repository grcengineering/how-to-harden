# =============================================================================
# HTH Netskope Control 4.1: Configure Malware Protection
# Profile Level: L1 (Baseline)
# Frameworks: CIS 10.1 | NIST SI-3
# Source: https://howtoharden.com/guides/netskope/#41-configure-malware-protection
# =============================================================================

# HTH Guide Excerpt: begin terraform
# Configure threat protection to detect and prevent malware in cloud traffic.
# Sandboxing requires SSE Professional or Enterprise license.

resource "null_resource" "malware_protection" {
  triggers = {
    sandbox_enabled = var.sandbox_enabled
    profile_level   = var.profile_level
  }

  provisioner "local-exec" {
    command = <<-EOT
      curl -s -X PUT \
        "${var.netskope_tenant_url}/api/v2/policy/threat-protection/settings" \
        -H "Netskope-Api-Token: ${var.netskope_api_key}" \
        -H "Content-Type: application/json" \
        -d '{
          "malware_scan_upload": true,
          "malware_scan_download": true,
          "malware_scan_web": true,
          "known_malware_action": "block",
          "suspicious_files_action": "sandbox",
          "phishing_url_action": "block"
        }'
    EOT
  }
}

# Configure cloud sandbox for unknown file analysis
resource "null_resource" "cloud_sandbox" {
  count = var.sandbox_enabled ? 1 : 0

  triggers = {
    file_types = join(",", var.sandbox_file_types)
  }

  provisioner "local-exec" {
    command = <<-EOT
      curl -s -X PUT \
        "${var.netskope_tenant_url}/api/v2/policy/threat-protection/sandbox" \
        -H "Netskope-Api-Token: ${var.netskope_api_key}" \
        -H "Content-Type: application/json" \
        -d '{
          "enabled": true,
          "file_types": ${jsonencode(var.sandbox_file_types)},
          "pending_action": "quarantine",
          "timeout_action": "block"
        }'
    EOT
  }
}
# HTH Guide Excerpt: end terraform
