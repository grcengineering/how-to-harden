# =============================================================================
# HTH JFrog Control 4.2: CVE Remediation Workflow
# Profile Level: L1 (Baseline)
# Frameworks: NIST RA-5, SI-2
# Source: https://howtoharden.com/guides/jfrog/#42-cve-remediation-workflow
# =============================================================================

# HTH Guide Excerpt: begin terraform

# License compliance policy to block restrictive licenses
resource "artifactory_xray_license_policy" "license_compliance" {
  name        = "hth-license-compliance"
  description = "HTH: Block artifacts with banned licenses"
  type        = "license"

  rule {
    name     = "banned-licenses"
    priority = 1

    criteria {
      banned_licenses = ["GPL-3.0", "AGPL-3.0", "SSPL-1.0"]
      allow_unknown   = false
    }

    actions {
      block_download {
        active    = true
        unscanned = false
      }
      fail_build = true
    }
  }
}

# L2: Stricter license policy that also blocks unknown licenses
resource "artifactory_xray_license_policy" "strict_license" {
  count = var.profile_level >= 2 ? 1 : 0

  name        = "hth-strict-license-compliance"
  description = "HTH: Block artifacts with unknown or banned licenses (L2+)"
  type        = "license"

  rule {
    name     = "strict-banned-licenses"
    priority = 1

    criteria {
      banned_licenses = ["GPL-3.0", "AGPL-3.0", "SSPL-1.0", "GPL-2.0", "LGPL-3.0"]
      allow_unknown   = false
    }

    actions {
      block_download {
        active    = true
        unscanned = true
      }
      fail_build = true
    }
  }
}

# HTH Guide Excerpt: end terraform
