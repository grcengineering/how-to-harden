# HTH Okta Code Pack — SIEM Detection Queries
# https://howtoharden.com/guides/okta/
#
# All detection queries extracted from the Okta Hardening Guide.
# Each entry includes the original Okta System Log filter expression
# and/or a SIEM-compatible SQL query for use in Splunk, Snowflake,
# BigQuery, Elastic, or any SQL-based SIEM.
#
# Usage:
#   - okta_log_filter: Use directly in Okta System Log API or Admin Console
#   - siem_sql: Adapt table/column names to your SIEM schema
#
# Guide version: 0.3.0
# Last updated: 2026-02-10

queries:
  # ---------------------------------------------------------------------------
  # Section 1: Authentication & Access Controls
  # ---------------------------------------------------------------------------

  - id: okta-mfa-auth-events
    title: "FIDO2/WebAuthn MFA Authentication Events"
    section: "1.1"
    profile_level: 1
    severity: medium
    description: >
      Monitors authentication events using FIDO2/WebAuthn MFA factors.
      Use to verify phishing-resistant MFA adoption and detect fallback
      to weaker factors.
    okta_log_filter: >
      eventType eq "user.authentication.auth_via_mfa"
      AND debugContext.debugData.factor eq "FIDO2_WEBAUTHN"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, client.ipAddress,
             debugContext.debugData.factor, outcome.result, published
      FROM okta_system_log
      WHERE eventType = 'user.authentication.auth_via_mfa'
        AND debugContext.debugData.factor = 'FIDO2_WEBAUTHN'
      ORDER BY published DESC
    tags: [detection, authentication, mfa, fido2]

  - id: okta-default-policy-auth
    title: "Authentication via Default Policy (MFA Bypass Risk)"
    section: "1.9"
    profile_level: 1
    severity: high
    description: >
      Detects authentication attempts evaluated by the immutable Default
      Authentication Policy, which permits password-only login with no MFA.
      Any hit indicates an application is not assigned to a custom policy
      and is vulnerable to single-factor access.
    okta_log_filter: >
      eventType eq "policy.evaluate_sign_on"
      AND debugContext.debugData.policyType eq "ACCESS_POLICY"
      AND target.displayName eq "Default Policy"
    siem_sql: |
      -- Alert: Authentication via Default Policy (MFA bypass)
      SELECT actor.displayName, client.ipAddress, outcome.result, published
      FROM okta_system_log
      WHERE eventType = 'policy.evaluate_sign_on'
        AND debugContext.debugData.behaviors LIKE '%Default Policy%'
      ORDER BY published DESC
    tags: [detection, mfa-bypass, policy, critical]

  - id: okta-recovery-untrusted-network
    title: "Password Recovery from Untrusted Network"
    section: "1.10"
    profile_level: 1
    severity: high
    description: >
      Detects password recovery attempts originating from proxy networks
      or non-corporate IP addresses. Recovery from untrusted networks
      is a top account hijack technique.
    okta_log_filter: >
      eventType eq "user.account.reset_password"
      AND securityContext.isProxy eq true
    siem_sql: |
      -- Alert: Password recovery from non-corporate IP
      SELECT actor.displayName, client.ipAddress,
             client.geographicalContext.city,
             client.geographicalContext.country,
             outcome.result, published
      FROM okta_system_log
      WHERE eventType IN (
        'user.account.reset_password',
        'user.credential.forgot_password'
      )
        AND client.ipAddress NOT IN (SELECT ip FROM corporate_ip_ranges)
      ORDER BY published DESC
    tags: [detection, account-takeover, recovery, network]

  - id: okta-weak-recovery-method
    title: "SMS/Voice/Question Recovery Attempt (Weak Factor)"
    section: "1.10"
    profile_level: 1
    severity: high
    description: >
      Detects password recovery attempts using weak factors (SMS, voice
      call, or security question) that should be disabled after hardening.
      Any occurrence after hardening indicates configuration drift or bypass.
    okta_log_filter: >
      eventType eq "user.account.reset_password"
      AND debugContext.debugData.factor IN ("SMS", "CALL", "QUESTION")
    siem_sql: |
      -- Alert: SMS/Voice recovery attempt (should not occur after hardening)
      SELECT actor.displayName, client.ipAddress, outcome.result, published
      FROM okta_system_log
      WHERE eventType = 'user.account.reset_password'
        AND debugContext.debugData.factor IN ('SMS', 'CALL', 'QUESTION')
      ORDER BY published DESC
    tags: [detection, recovery, sms, weak-factor]

  - id: okta-suspicious-activity-report
    title: "User Reported Suspicious Activity (HIGH PRIORITY)"
    section: "1.11"
    profile_level: 1
    severity: critical
    description: >
      Fires when an end user clicks "Report Suspicious Activity" in a
      notification email. This is a high-fidelity signal that should
      trigger immediate incident response. Correlate with recent
      authentication and factor enrollment events for the reporting user.
    okta_log_filter: >
      eventType eq "user.account.report_suspicious_activity_by_enduser"
    siem_sql: |
      -- HIGH PRIORITY: User reported suspicious activity
      SELECT actor.displayName, actor.alternateId, client.ipAddress,
             client.geographicalContext.city,
             client.geographicalContext.country,
             outcome.result, published
      FROM okta_system_log
      WHERE eventType = 'user.account.report_suspicious_activity_by_enduser'
      ORDER BY published DESC
    tags: [detection, user-report, incident, critical]

  - id: okta-authenticator-change
    title: "Authenticator Enrolled or Reset (Persistence Detection)"
    section: "1.11"
    profile_level: 1
    severity: medium
    description: >
      Detects authenticator enrollment, activation, and password changes.
      Attackers who gain temporary access immediately register their own
      MFA factors to maintain persistence. Correlate with suspicious
      activity reports.
    okta_log_filter: >
      eventType sw "user.mfa.factor"
      OR eventType eq "user.account.update_password"
    siem_sql: |
      -- MEDIUM PRIORITY: Authenticator enrolled from unrecognized location
      SELECT actor.displayName, target.displayName AS authenticator_type,
             client.ipAddress, client.userAgent.rawUserAgent, published
      FROM okta_system_log
      WHERE eventType IN (
        'user.mfa.factor.activate',
        'user.mfa.factor.enroll',
        'system.mfa.factor.activate'
      )
      ORDER BY published DESC
    tags: [detection, mfa, persistence, authenticator]

  # ---------------------------------------------------------------------------
  # Section 2: Network Access Controls
  # ---------------------------------------------------------------------------

  - id: okta-anonymizer-detected
    title: "Traffic from Anonymizer/Tor Network"
    section: "2.3"
    profile_level: 2
    severity: high
    description: >
      Detects authentication attempts from anonymizing proxies or Tor
      exit nodes. Attackers use anonymizers to hide origin during
      credential stuffing and session replay.
    okta_log_filter: >
      eventType eq "security.threat.detected"
      AND debugContext.debugData.threatSuspected eq "ANONYMIZER"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, client.ipAddress,
             debugContext.debugData.threatSuspected,
             outcome.result, published
      FROM okta_system_log
      WHERE eventType = 'security.threat.detected'
        AND debugContext.debugData.threatSuspected = 'ANONYMIZER'
      ORDER BY published DESC
    tags: [detection, network, anonymizer, tor]

  # ---------------------------------------------------------------------------
  # Section 3: OAuth & Integration Security
  # ---------------------------------------------------------------------------

  - id: okta-scim-user-operations
    title: "SCIM User Create/Update Operations"
    section: "3.2"
    profile_level: 2
    severity: medium
    description: >
      Monitors SCIM provisioning operations that create or modify users
      in downstream applications. Compromised SCIM tokens enable
      backdoor account creation across connected SaaS apps.
    okta_log_filter: >
      eventType eq "system.scim.user.create"
      OR eventType eq "system.scim.user.update"
    siem_sql: |
      SELECT actor.displayName, target.displayName,
             target.type, eventType, client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'system.scim.user.create',
        'system.scim.user.update'
      )
      ORDER BY published DESC
    tags: [detection, scim, provisioning, integration]

  - id: okta-oauth-consent-grant
    title: "OAuth Application Consent Grant"
    section: "3.3"
    profile_level: 2
    severity: medium
    description: >
      Detects when users grant OAuth consent to third-party applications.
      Malicious apps can request broad scopes to access organizational
      data through consent phishing attacks.
    okta_log_filter: >
      eventType eq "app.oauth2.consent.grant"
      OR eventType eq "app.oauth2.as.consent.grant"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId,
             target.displayName AS app_name,
             debugContext.debugData.requestedScopes,
             client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'app.oauth2.consent.grant',
        'app.oauth2.as.consent.grant'
      )
      ORDER BY published DESC
    tags: [detection, oauth, consent, shadow-it]

  - id: okta-api-token-lifecycle
    title: "API Token Create/Revoke Events"
    section: "3.4"
    profile_level: 1
    severity: high
    description: >
      Monitors API token lifecycle events including creation, revocation,
      and OAuth token grants. New token creation should be rare and
      require justification.
    okta_log_filter: >
      eventType eq "system.api_token.create"
      OR eventType eq "system.api_token.revoke"
      OR eventType eq "app.oauth2.token.grant"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, eventType,
             target.displayName, client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'system.api_token.create',
        'system.api_token.revoke',
        'app.oauth2.token.grant'
      )
      ORDER BY published DESC
    tags: [detection, api-token, nhi, lifecycle]

  # ---------------------------------------------------------------------------
  # Section 4: Session Management
  # ---------------------------------------------------------------------------

  - id: okta-admin-session-invalidated
    title: "Admin Session Invalidated (ASN/IP Binding)"
    section: "4.3"
    profile_level: 1
    severity: high
    description: >
      Detects admin sessions invalidated due to ASN or IP binding.
      This fires when session network characteristics change, which
      may indicate session hijacking or token replay from attacker
      infrastructure.
    okta_log_filter: >
      eventType eq "user.session.invalidate"
      AND debugContext.debugData.reason eq "ADMIN_SESSION_BINDING"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, client.ipAddress,
             debugContext.debugData.reason, outcome.result, published
      FROM okta_system_log
      WHERE eventType = 'user.session.invalidate'
        AND debugContext.debugData.reason = 'ADMIN_SESSION_BINDING'
      ORDER BY published DESC
    tags: [detection, session, admin, hijacking]

  - id: okta-protected-action-events
    title: "Protected Action Challenge/Success"
    section: "4.3"
    profile_level: 1
    severity: medium
    description: >
      Monitors Protected Actions step-up authentication events.
      These fire when admins perform critical operations that require
      re-authentication (IdP changes, MFA resets, policy modifications).
    okta_log_filter: >
      eventType eq "system.protected_action.challenge"
      OR eventType eq "system.protected_action.success"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, eventType,
             target.displayName, client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'system.protected_action.challenge',
        'system.protected_action.success'
      )
      ORDER BY published DESC
    tags: [detection, protected-action, admin, step-up]

  # ---------------------------------------------------------------------------
  # Section 5: Monitoring & Detection
  # ---------------------------------------------------------------------------

  - id: okta-impossible-travel
    title: "Impossible Travel Detection"
    section: "5.1"
    profile_level: 1
    severity: high
    description: >
      Detects SSO authentication events where the user's geographic
      country changes within a short time window, indicating credential
      theft or session replay.
    siem_sql: |
      -- Detect impossible travel
      SELECT user, sourceIp, geo_country, timestamp
      FROM okta_logs
      WHERE eventType = 'user.authentication.sso'
        AND geo_country_change_within_1hr = true
    tags: [detection, impossible-travel, anomaly, sso]

  - id: okta-brute-force
    title: "Brute Force / Password Spray Detection"
    section: "5.1"
    profile_level: 1
    severity: high
    description: >
      Detects brute force attacks by identifying users with more than
      10 failed authentication attempts within a 5-minute window.
    siem_sql: |
      -- Detect brute force
      SELECT user, count(*) as attempts
      FROM okta_logs
      WHERE eventType = 'user.authentication.failed'
        AND timestamp > now() - interval '5 minutes'
      GROUP BY user
      HAVING count(*) > 10
    tags: [detection, brute-force, password-spray, authentication]

  - id: okta-admin-role-changes
    title: "Admin Role Assignment Changes"
    section: "5.1"
    profile_level: 1
    severity: high
    description: >
      Detects changes to admin role assignments and admin group
      membership. Privilege escalation via unauthorized role changes
      is a key post-compromise technique.
    siem_sql: |
      -- Detect admin role changes
      SELECT actor, target, eventType, timestamp
      FROM okta_logs
      WHERE eventType LIKE 'system.role%'
        OR eventType LIKE 'group.user_membership%admin%'
    tags: [detection, admin, role-change, privilege-escalation]

  - id: okta-threat-detected-high
    title: "High/Critical Threat Detected (ITP)"
    section: "5.3"
    profile_level: 2
    severity: critical
    description: >
      Detects high and critical risk threats identified by Okta Identity
      Threat Protection (ITP). These represent active session anomalies,
      impossible travel, or credential compromise intelligence that
      require immediate investigation.
    okta_log_filter: >
      eventType eq "security.threat.detected"
      OR eventType eq "security.session.risk_change"
    siem_sql: |
      SELECT actor.displayName, client.ipAddress, outcome.result,
             debugContext.debugData.riskLevel,
             debugContext.debugData.riskReasons
      FROM okta_system_log
      WHERE eventType = 'security.threat.detected'
        AND debugContext.debugData.riskLevel IN ('HIGH', 'CRITICAL')
      ORDER BY published DESC
    tags: [detection, itp, threat, risk, critical]

  - id: okta-behavior-detection
    title: "Behavior Detection Rule Triggered"
    section: "5.4"
    profile_level: 2
    severity: medium
    description: >
      Detects when Okta behavior detection rules fire, including new
      device, new location, new IP, velocity anomalies (impossible
      travel), and IP reputation signals.
    okta_log_filter: >
      eventType eq "security.behavior_detection.triggered"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, client.ipAddress,
             client.geographicalContext.city,
             client.geographicalContext.country,
             debugContext.debugData.behaviors,
             outcome.result, published
      FROM okta_system_log
      WHERE eventType = 'security.behavior_detection.triggered'
      ORDER BY published DESC
    tags: [detection, behavior, anomaly, new-device, new-location]

  - id: okta-idp-lifecycle-create
    title: "Identity Provider Created (CRITICAL)"
    section: "5.5"
    profile_level: 1
    severity: critical
    description: >
      Detects creation or activation of new Identity Providers. An
      attacker with admin access can create a malicious IdP to
      impersonate any user without credentials or MFA. This is a
      high-impact, low-volume event that demands immediate investigation.
    okta_log_filter: >
      eventType sw "system.idp.lifecycle"
    siem_sql: |
      -- Alert: New Identity Provider Created (CRITICAL)
      SELECT actor.displayName, actor.alternateId,
             target[0].displayName, target[0].type,
             client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'system.idp.lifecycle.create',
        'system.idp.lifecycle.activate'
      )
    tags: [detection, idp, cross-tenant, impersonation, critical]

  - id: okta-routing-rule-modified
    title: "IdP Routing Rule Modified (HIGH)"
    section: "5.5"
    profile_level: 1
    severity: high
    description: >
      Detects creation or modification of IDP discovery routing rules.
      Attackers modify routing rules to direct authentication through
      a malicious IdP for cross-tenant impersonation attacks.
    siem_sql: |
      -- Alert: Routing Rule Modified (HIGH)
      SELECT actor.displayName, target[0].displayName, published
      FROM okta_system_log
      WHERE eventType IN ('policy.lifecycle.create', 'policy.lifecycle.update')
        AND debugContext.debugData.policyType = 'IDP_DISCOVERY'
    tags: [detection, idp, routing, policy, cross-tenant]

  # ---------------------------------------------------------------------------
  # Section 7.4 — Change Management Configuration Events
  # ---------------------------------------------------------------------------

  - id: okta-policy-lifecycle-changes
    title: "Policy Lifecycle Changes"
    section: "7.4"
    profile_level: 2
    severity: medium
    description: >
      Monitors all policy lifecycle events including creation, modification,
      and deletion of authentication policies, sign-on policies, and their
      rules. Correlate with change management records to detect unauthorized
      configuration changes.
    okta_log_filter: >
      eventType sw "policy.lifecycle"
      OR eventType sw "policy.rule"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, eventType,
             target.displayName AS policy_name,
             client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'policy.lifecycle.create',
        'policy.lifecycle.update',
        'policy.lifecycle.delete',
        'policy.rule.create',
        'policy.rule.update'
      )
      ORDER BY published DESC
    tags: [detection, change-management, policy, configuration]

  - id: okta-application-lifecycle-changes
    title: "Application Lifecycle Changes"
    section: "7.4"
    profile_level: 2
    severity: medium
    description: >
      Monitors application creation and modification events to detect
      unauthorized integrations. New applications may introduce OAuth scopes,
      SCIM provisioning, or federation trust that expand the attack surface.
    okta_log_filter: >
      eventType sw "application.lifecycle"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, eventType,
             target.displayName AS app_name,
             client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'application.lifecycle.create',
        'application.lifecycle.update'
      )
      ORDER BY published DESC
    tags: [detection, change-management, application, integration]

  - id: okta-network-zone-changes
    title: "Network Zone Lifecycle Changes"
    section: "7.4"
    profile_level: 2
    severity: high
    description: >
      Monitors creation and modification of network zones. An attacker with
      admin access could add their own IP ranges to trusted zones, bypassing
      IP-based access controls and network restriction policies.
    okta_log_filter: >
      eventType sw "zone.lifecycle"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, eventType,
             target.displayName AS zone_name,
             client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'zone.lifecycle.create',
        'zone.lifecycle.update'
      )
      ORDER BY published DESC
    tags: [detection, change-management, network-zone, ip-bypass]

  - id: okta-group-membership-changes
    title: "Group Membership Changes"
    section: "7.4"
    profile_level: 2
    severity: medium
    description: >
      Monitors group membership additions and removals, especially for
      privileged groups (admin groups, security groups). Unauthorized group
      membership changes can grant access to applications and admin roles.
    okta_log_filter: >
      eventType eq "group.user_membership.add"
      OR eventType eq "group.user_membership.remove"
    siem_sql: |
      SELECT actor.displayName, eventType,
             target[0].displayName AS group_name,
             target[1].displayName AS user_name,
             client.ipAddress, published
      FROM okta_system_log
      WHERE eventType IN (
        'group.user_membership.add',
        'group.user_membership.remove'
      )
      ORDER BY published DESC
    tags: [detection, change-management, group, privilege-escalation]

  - id: okta-admin-role-lifecycle
    title: "Admin Role Creation and Assignment"
    section: "7.4"
    profile_level: 2
    severity: high
    description: >
      Monitors creation of new admin roles and role assignments. Custom roles
      with excessive permissions or unexpected role grants may indicate
      privilege escalation attempts.
    okta_log_filter: >
      eventType eq "system.role.create"
    siem_sql: |
      SELECT actor.displayName, actor.alternateId, eventType,
             target.displayName AS role_name,
             client.ipAddress, published
      FROM okta_system_log
      WHERE eventType = 'system.role.create'
      ORDER BY published DESC
    tags: [detection, change-management, admin-role, privilege-escalation]
